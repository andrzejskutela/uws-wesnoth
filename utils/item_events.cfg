#define QQUWS_ITEM_EVENTS
	{END_OF_EFFECT_EVENT}
	# kamikaze is separate from the register table because it's required in too many edge cases
	{REGISTER_KAMIKAZE}
	{REGISTER_ZERO_XP}
	
	[event]
		name=register_uws_event
		first_time_only=no
		
		[if]
			[not]
				[variable]
					name=uws_game.registered_uws_specials
					contains=$register_uws_special
				[/variable]
			[/not]
			[then]
				{VARIABLE uws_game.registered_uws_specials "$register_uws_special|,$uws_game.registered_uws_specials"}
				
				[switch]
					variable=register_uws_special
					
					[case]
						value=campaign_unique_specials
						{REGISTER_REQUIRES_ESCORTING}
					[/case]
					
					[case]
						value=magic_res_item
						{REGISTER_MAGIC_NEGATION}
					[/case]
					
					[case]
						value=cold_res_item
						{REGISTER_COLD_MASTERY_AURA}
						{REGISTER_CHILLING_COLD}
					[/case]

					[case]
						value=cold_weapon_item
						{REGISTER_ICE_LOCK}
						{REGISTER_FROSTBITE}
					[/case]
					
					[case]
						value=phys_res_item
						{REGISTER_ARMOR_SCIENCE}
					[/case]
					
					[case]
						value=impact_res_item
						{REGISTER_IMPACT_MASTERY_AURA}
						{REGISTER_LEATHER_COVER}
					[/case]

					[case]
						value=impact_weapon_item
						{REGISTER_STUN}
						{REGISTER_CRUSHING_BLOW}
					[/case]
					
					[case]
						value=fire_res_item
						{REGISTER_FIRE_MASTERY_AURA}
						{REGISTER_FIERY_FAMILIAR}
					[/case]

					[case]
						value=fire_weapon_item
						{REGISTER_FIRE_CLEAVE}
						{REGISTER_BLINDING_SPARKS}
					[/case]
					
					[case]
						value=arcane_res_item
						{REGISTER_ARCANE_MASTERY_AURA}
						{REGISTER_DRAGON_PRIDE}
						{REGISTER_DRAGON_PRIDE_STONE}
					[/case]

					[case]
						value=arcane_weapon_item
						{REGISTER_REVERSED_POLARITY}
						{REGISTER_TEST_OF_FAITH}
					[/case]
					
					[case]
						value=blade_res_item
						{REGISTER_BLADE_MASTERY_AURA}
						{REGISTER_BATTLE_CRY}
					[/case]

					[case]
						value=blade_weapon_item
						{REGISTER_BATTLE_TRANCE}
					[/case]
					
					[case]
						value=pierce_res_item
						{REGISTER_PIERCE_MASTERY_AURA}
					[/case]

					[case]
						value=pierce_weapon_item
						{REGISTER_IMPALE}
						{REGISTER_PARALYSE}
					[/case]

					[case]
						value=hp_low_item
						{REGISTER_UNPOISONABLE_AURA}
						{REGISTER_POISON_AOE}
						{REGISTER_ALCOHOL_FUMES}
						{REGISTER_DAMAGE_ON_DEATH}
					[/case]

					[case]
						value=hp_med_item
						{REGISTER_UNDRAINABLE_AURA}
						{REGISTER_AOE_DRAIN}
						{REGISTER_FIGHT_ENDURANCE}
					[/case]
					
					[case]
						value=hp_high_item
						{REGISTER_TREATS_WOUNDED}
						{REGISTER_BLOODLINE}
					[/case]

					[case]
						value=steadfast_item
						{REGISTER_SHIELD_MASTER}
					[/case]

					[case]
						value=regen_item
						{REGISTER_FIGHT_REGEN}
					[/case]
					
					[case]
						value=melee_dmg_item
						{REGISTER_BATTLE_FURY}
					[/case]
					
					[case]
						value=ranged_acc_item
						{REGISTER_ASSASSINATION}
					[/case]

					[case]
						value=melee_parry_item
						{REGISTER_COUNTERBALANCE}
						{REGISTER_PEACEFUL_WARRIOR}
					[/case]

					[case]
						value=melee_poison_item
						{REGISTER_SUPER_POISON}
					[/case]
					
					[case]
						value=melee_slow_item
						{REGISTER_SLOW_AURA}
						{REGISTER_CHRONOSPHERE}
					[/case]

					[case]
						value=mp_item
						{REGISTER_UNSLOWABLE_AURA}
						{REGISTER_MOTILITY_MASTERY_AOE}
					[/case]
					
					[case]
						value=feeding_item
						{REGISTER_MAGICAL_FEEDING}
						{REGISTER_SUMMONS}
					[/case]

					[case]
						value=leadership_item
						{REGISTER_LEADS_BY_EXAMPLE}
						{REGISTER_GREAT_LEADER}
					[/case]

					[case]
						value=drain_item
						{REGISTER_NON_LIVING_DRAINS}
					[/case]

					[case]
						value=defense_item
						{REGISTER_TERRAIN_KNOWLEDGE}
						{REGISTER_TERRAIN_MASTERY}
					[/case]
					
					[case]
						value=skirm_item
						{REGISTER_BATTLE_FERVOR}
						{REGISTER_ENEMY_CONTROL}
					[/case]
					
					[case]
						value=first_strike_item
						{REGISTER_PREEMPTIVE_STRIKE}
					[/case]
					
					[case]
						value=fear_item
						{REGISTER_NECROMANCERS_BANE}
					[/case]

					[case]
						value=discouragement_item
						{REGISTER_CORRUPTION}
					[/case]

					[case]
						value=burns_item
						{REGISTER_SECRET_FIRE}
						{REGISTER_FIRE_VISION}
					[/case]
					
					[case]
						value=golden_armor_item
						{REGISTER_REFLECTS_DAMAGE}
					[/case]

					[case]
						value=heal_item
						{REGISTER_HEALS_ALL}
					[/case]
					
					[case]
						value=freezing_gem_item
						{REGISTER_FREEZING_GEM}
						{REGISTER_ICY_SHACKLES}
					[/case]
					
					[case]
						value=armor_destruction_item
						{REGISTER_ARMOR_DESTRUCTION}
					[/case]
					
					[case]
						value=double_attack_item
						{REGISTER_DOUBLE_ATTACK}
						{REGISTER_SHARPSHOOTER}
					[/case]
					
					[case]
						value=hitn_run_item
						{REGISTER_HIT_AND_RUN}
						{REGISTER_ASSASSINS_STRIKE}
					[/case]
					
					[case]
						value=rat_pack_item
						{REGISTER_RATS}
						{REGISTER_RAT_HEAL_MENU_ITEM}
						{REGISTER_BLACK_PLAGUE}
					[/case]
					
					[case]
						value=icewind_aura_item
						{REGISTER_ICEWIND_AURA}
					[/case]

					[case]
						value=book_item
						{REGISTER_BATTLE_STUDY}
						{REGISTER_COMBAT_TEACHER}
						{REGISTER_INTELLIGENCE_INCREASE}
					[/case]
					
					[case]
						value=dragon_protection_item
						{REGISTER_DRAGONS_PROTECTION}
					[/case]
					
					[case]
						value=final_showdown_special
						{REGISTER_FINAL_SHOWDOWN}
					[/case]
					
					[case]
						value=endurance_special
						{REGISTER_ENDURANCE}
					[/case]
					
					[case]
						value=aura_of_death_special
						{REGISTER_AURA_OF_DEATH}
					[/case]
					
					[case]
						value=infernal_possession_special
						{REGISTER_INFERNAL_POSSESSION}
					[/case]
					
					[case]
						value=mind_raid_special
						{REGISTER_MIND_RAID}
					[/case]
					
					[case]
						value=explodes_special
						{REGISTER_EXPLODES}
					[/case]
					
					[case]
						value=sickness_special
						{REGISTER_SICKNESS}
					[/case]
					
					[case]
						value=astral_imprisonment_special
						{REGISTER_ASTRAL_IMPRISONMENT}
					[/case]
					
					[case]
						value=retribution_special
						{REGISTER_RETRIBUTION}
					[/case]
					
					[case]
						value=enemy_overwhelm_special
						{REGISTER_ENEMY_OVERWHELM}
					[/case]
					
					[case]
						value=arcane_trickstery_special
						{REGISTER_ARCANE_TRICKSTERY}
					[/case]
					
					[case]
						value=interrupts_special
						{REGISTER_INTERRUPTS}
					[/case]
					
					[case]
						value=medusa_spirit_special
						{REGISTER_MEDUSA_SPIRIT}
					[/case]
					
					[case]
						value=carnage_special
						{REGISTER_CARNAGE}
					[/case]

					[case]
						value=bloodlust_special
						{REGISTER_BLOODLUST}
					[/case]
					
					[case]
						value=possessed_by_blood_special
						{REGISTER_POSSESSED_BY_BLOOD}
					[/case]

					[case]
						value=defensive_mastery_special
						{REGISTER_DEFENSIVE_MASTERY}
					[/case]

					[case]
						value=reflects_magic_special
						{REGISTER_REFLECTS_MAGIC}
					[/case]

					[case]
						value="dark_pact_special"
						{REGISTER_DARK_PACT}
					[/case]

					[case]
						value="spore_explosion_special"
						{REGISTER_SPORE_EXPLOSION}
					[/case]

					[case]
						value="fungoids_spores_special"
						{REGISTER_FUNGOIDS_SPORES}
					[/case]

					[case]
						value="fungoids_spawn_special"
						{REGISTER_FUNGOIDS_SPAWN}
					[/case]

					[case]
						value="sound_of_madness_special"
						{REGISTER_SOUND_OF_MADNESS}
					[/case]

					[case]
						value="last_word_special"
						{REGISTER_LAST_WORD}
					[/case]

					[case]
						value="staff_of_power_special"
						{REGISTER_STAFF_OF_POWER}
					[/case]

					[case]
						value="darkness_inside_special"
						{REGISTER_DARKNESS_INSIDE}
					[/case]

					[case]
						value="soul_catcher_special"
						{REGISTER_SOUL_CATCHER}
					[/case]

					[case]
						value="curse_of_the_dead_special"
						{REGISTER_CURSE_OF_THE_DEAD}
					[/case]

					[case]
						value="whisper_of_the_grave_special"
						{REGISTER_WHISPER_OF_THE_GRAVE}
					[/case]

					[case]
						value="dragon_breath_special"
						{REGISTER_DRAGON_BREATH}
					[/case]

					[case]
						value="aura_of_decay_special"
						{REGISTER_AURA_OF_DECAY}
					[/case]

					[case]
						value="fateful_special"
						{REGISTER_FATEFUL}
					[/case]

					[case]
						value="slowing_wave_special"
						{REGISTER_SLOWING_WAVE}
					[/case]

					[case]
						value="glory_of_the_sin_special"
						{REGISTER_GLORY_OF_THE_SIN}
					[/case]

					[case]
						value="night_instigator_special"
						{REGISTER_NIGHT_INSTIGATOR}
					[/case]

					[case]
						value=weapon_hit_and_run_special
						{REGISTER_WEAPON_HIT_AND_RUN}
					[/case]

					[case]
						value=sticky_tongue_special
						{REGISTER_STICKY_TONGUE}
					[/case]

					[case]
						value=digest_the_dead_special
						{REGISTER_DIGEST_THE_DEAD}
					[/case]

					[case]
						value=imprisoner_of_souls_special
						{REGISTER_IMPRISONER_OF_SOULS}
					[/case]

					[case]
						value=protected_by_darkness_special
						{REGISTER_PROTECTED_BY_DARKNESS}
					[/case]

					[case]
						value=area_slow_special
						{REGISTER_AREA_SLOW}
					[/case]

					[case]
						value=battle_rage_special
						{REGISTER_BATTLE_RAGE}
					[/case]

					[case]
						value=heavy_stun_special
						{REGISTER_HEAVY_STUN}
					[/case]

					[case]
						value=area_damage_special
						{REGISTER_AREA_DAMAGE}
					[/case]

					[case]
						value=viscious_mockery_special
						{REGISTER_VISCIOUS_MOCKERY}
					[/case]

					[case]
						value=leviathans_call_special
						{REGISTER_LEVIATHANS_CALL}
					[/case]

					[case]
						value=insurance_special
						{REGISTER_INSURANCE}
					[/case]

					[case]
						value=reanimates_special
						{REGISTER_REANIMATES}
					[/case]

					[case]
						value=stone_skin_special
						{REGISTER_STONE_SKIN}
					[/case]

					[case]
						value=astral_vampire_special
						{REGISTER_ASTRAL_VAMPIRE}
					[/case]

					[case]
						value=energetical_shield_special
						{REGISTER_ENERGETICAL_SHIELD}
					[/case]

					[case]
						value=moonsong_special
						{REGISTER_MOONSONG}
					[/case]

					[case]
						value=sunsong_special
						{REGISTER_SUNSONG}
					[/case]

					[case]
						value=fight_recuperation_special
						{REGISTER_FIGHT_RECUPERATION}
					[/case]

					[case]
						value=fight_recovery_special
						{REGISTER_FIGHT_RECOVERY}
					[/case]

					[case]
						value=amla_fight_recovery_special
						{REGISTER_AMLA_FIGHT_RECOVERY}
					[/case]

					[case]
						value=shroud_of_invisibility_special
						{REGISTER_SHROUD_OF_INVISIBILITY}
					[/case]

					[case]
						value=drums_of_war_special
						{REGISTER_DRUMS_OF_WAR}
					[/case]

					[case]
						value=concentration_special
						{REGISTER_CONCENTRATION}
					[/case]

					[case]
						value=random_damage_special
						{REGISTER_RANDOM_DAMAGE}
					[/case]

					[case]
						value=inner_cold_special
						{REGISTER_INNER_COLD}
					[/case]

					[case]
						value=earthquake_special
						{REGISTER_EARTHQUAKE}
					[/case]

					[case]
						value=ethereal_body_special
						{REGISTER_ETHEREAL_BODY}
					[/case]

					[case]
						value=true_flame_special
						{REGISTER_TRUE_FLAME}
					[/case]

					[case]
						value=extinguished_spark_special
						{REGISTER_EXTINGUISHED_SPARK}
					[/case]

					[case]
						value=sunrise_regen_special
						{REGISTER_SUNRISE_REGEN}
					[/case]

					[case]
						value=weaken_special
						{REGISTER_WEAKENING_ATTACK}
					[/case]

					[case]
						value=stillness_aura_special
						{REGISTER_STILLNESS_AURA}
					[/case]

					[case]
						value=inferno_special
						{REGISTER_INFERNO}
					[/case]

					[case]
						value=visceral_pain_special
						{REGISTER_VISCERAL_PAIN}
					[/case]

					[case]
						value=mind_tricks_special
						{REGISTER_MIND_TRICKS}
					[/case]

					[case]
						value=paralysing_venom_special
						{REGISTER_PARALYSING_VENOM}
					[/case]

					[case]
						value=corpse_feast_special
						{REGISTER_CORPSE_FEAST}
					[/case]

					[case]
						value=crit_strike_special
						{REGISTER_CRIT_STRIKE}
					[/case]

					[case]
						value=tax_collector_special
						{REGISTER_TAX_COLLECTOR}
					[/case]

					[case]
						value=debilitating_poison_special
						{REGISTER_DEBILITATING_POISON}
					[/case]

					[case]
						value=gun_reload_special
						{REGISTER_GUN_RELOAD}
					[/case]
				[/switch]
			[/then]
		[/if]
	[/event]
	
	[event]
		name=register_specials_for_new_uws_unit
		first_time_only=no
		
		[switch]
			variable=unit.type
			
			[case]
				value=QQ_atronachs
				
				{VARIABLE register_uws_special "sickness_special"}
				[fire_event]
					name=register_uws_event
				[/fire_event]
			[/case]
			
			[case]
				value=QQ_grand_scholar
				
				{VARIABLE register_uws_special "astral_imprisonment_special"}
				[fire_event]
					name=register_uws_event
				[/fire_event]
				
				{VARIABLE register_uws_special "blade_weapon_item"}
				[fire_event]
					name=register_uws_event
				[/fire_event]

				{VARIABLE register_uws_special "imprisoner_of_souls_special"}
				[fire_event]
					name=register_uws_event
				[/fire_event]

				{VARIABLE register_uws_special "protected_by_darkness_special"}
				[fire_event]
					name=register_uws_event
				[/fire_event]

				{VARIABLE register_uws_special "area_slow_special"}
				[fire_event]
					name=register_uws_event
				[/fire_event]
			[/case]
			
			[case]
				value=QQ_Tormented_Horror
				
				{VARIABLE register_uws_special "sickness_special"}
				[fire_event]
					name=register_uws_event
				[/fire_event]
			[/case]
			
			[case]
				value=QQ_destroyer
				
				{VARIABLE register_uws_special "impact_weapon_item"}
				[fire_event]
					name=register_uws_event
				[/fire_event]
			[/case]
			
			[case]
				value=QQ_Ashagoth
				
				{VARIABLE register_uws_special "astral_imprisonment_special"}
				[fire_event]
					name=register_uws_event
				[/fire_event]
			[/case]

			[case]
				value=QQ_boneblade_terror
				
				{VARIABLE register_uws_special "defensive_mastery_special"}
				[fire_event]
					name=register_uws_event
				[/fire_event]

				{VARIABLE register_uws_special "reflects_magic_special"}
				[fire_event]
					name=register_uws_event
				[/fire_event]
			[/case]

			[case]
				value=QQ_bone_horror

				[modify_unit]
					[filter]
						id=$unit.id
					[/filter]

					[variables]
						fear_reduction=15
						fear_kill_reduction=20
						fear_radius=5
						fear_increase_max_level=1
						weaken_reduction=30
					[/variables]
				[/modify_unit]
				
				{VARIABLE register_uws_special "weaken_special"}
				[fire_event]
					name=register_uws_event
				[/fire_event]
				
				{VARIABLE register_uws_special "fear_item"}
				[fire_event]
					name=register_uws_event
				[/fire_event]

				{VARIABLE register_uws_special "dark_pact_special"}
				[fire_event]
					name=register_uws_event
				[/fire_event]
			[/case]

			[case]
				value=QQ_abyssal_fungoid
				
				{VARIABLE register_uws_special "spore_explosion_special"}
				[fire_event]
					name=register_uws_event
				[/fire_event]

				{VARIABLE register_uws_special "fungoids_spores_special"}
				[fire_event]
					name=register_uws_event
				[/fire_event]

				{VARIABLE register_uws_special "fungoids_spawn_special"}
				[fire_event]
					name=register_uws_event
				[/fire_event]
			[/case]

			[case]
				value=QQ_Archwitch
				
				{VARIABLE register_uws_special "sound_of_madness_special"}
				[fire_event]
					name=register_uws_event
				[/fire_event]
			[/case]

			[case]
				value=QQ_adjudicator
				
				{VARIABLE register_uws_special "last_word_special"}
				[fire_event]
					name=register_uws_event
				[/fire_event]

				{VARIABLE register_uws_special "staff_of_power_special"}
				[fire_event]
					name=register_uws_event
				[/fire_event]
			[/case]

			[case]
				value=QQ_blackness
				
				{VARIABLE register_uws_special "darkness_inside_special"}
				[fire_event]
					name=register_uws_event
				[/fire_event]

				{VARIABLE register_uws_special "soul_catcher_special"}
				[fire_event]
					name=register_uws_event
				[/fire_event]
			[/case]

			[case]
				value=QQ_death
				
				{VARIABLE register_uws_special "curse_of_the_dead_special"}
				[fire_event]
					name=register_uws_event
				[/fire_event]

				{VARIABLE register_uws_special "whisper_of_the_grave_special"}
				[fire_event]
					name=register_uws_event
				[/fire_event]
			[/case]

			[case]
				value=QQ_dragon_rider
				
				{VARIABLE register_uws_special "dragon_breath_special"}
				[fire_event]
					name=register_uws_event
				[/fire_event]
			[/case]

			[case]
				value=QQ_eternal_bones
				
				{VARIABLE register_uws_special "aura_of_decay_special"}
				[fire_event]
					name=register_uws_event
				[/fire_event]

				{VARIABLE register_uws_special "fateful_special"}
				[fire_event]
					name=register_uws_event
				[/fire_event]

				{VARIABLE register_uws_special "slowing_wave_special"}
				[fire_event]
					name=register_uws_event
				[/fire_event]

				{VARIABLE register_uws_special "glory_of_the_sin_special"}
				[fire_event]
					name=register_uws_event
				[/fire_event]
			[/case]

			[case]
				value=QQ_flying_nightmare
				
				{VARIABLE register_uws_special "sticky_tongue_special"}
				[fire_event]
					name=register_uws_event
				[/fire_event]

				{VARIABLE register_uws_special "digest_the_dead_special"}
				[fire_event]
					name=register_uws_event
				[/fire_event]
			[/case]

			[case]
				value=QQ_grand_sultan_of_fire

				[modify_unit]
					[filter]
						id=$unit.id
					[/filter]

					[variables]
						battle_rage_increase=3
					[/variables]
				[/modify_unit]
				
				{VARIABLE register_uws_special "battle_rage_special"}
				[fire_event]
					name=register_uws_event
				[/fire_event]

				{VARIABLE register_uws_special "heavy_stun_special"}
				[fire_event]
					name=register_uws_event
				[/fire_event]

				{VARIABLE register_uws_special "area_damage_special"}
				[fire_event]
					name=register_uws_event
				[/fire_event]

				{VARIABLE register_uws_special "viscious_mockery_special"}
				[fire_event]
					name=register_uws_event
				[/fire_event]
			[/case]

			[case]
				value=QQ_dark_witness

				[modify_unit]
					[filter]
						id=$unit.id
					[/filter]

					[variables]
						weaken_reduction=30
					[/variables]
				[/modify_unit]
				
				{VARIABLE register_uws_special "weaken_special"}
				[fire_event]
					name=register_uws_event
				[/fire_event]
			[/case]

			[case]
				value=QQ_ice_mammoth

				[modify_unit]
					[filter]
						id=$unit.id
					[/filter]

					[variables]
						slow_aura_damage=6
					[/variables]
				[/modify_unit]

				{VARIABLE register_uws_special "melee_slow_item"}
				[fire_event]
					name=register_uws_event
				[/fire_event]
			[/case]

			[case]
				value=QQ_naga_grand_priest

				{VARIABLE register_uws_special "leviathans_call_special"}
				[fire_event]
					name=register_uws_event
				[/fire_event]
			[/case]

			[case]
				value=QQ_wereworm

				{VARIABLE register_uws_special "earthquake_special"}
				[fire_event]
					name=register_uws_event
				[/fire_event]
			[/case]

			[case]
				value=QQ_tundra_shaman

				[modify_unit]
					[filter]
						id=$unit.id
					[/filter]

					[variables]
						summons_chance=60
						summons_list="Ghost"
						summons_settings="tunturi_shaman"
					[/variables]
				[/modify_unit]

				{VARIABLE register_uws_special "feeding_item"}
				[fire_event]
					name=register_uws_event
				[/fire_event]
			[/case]

			[case]
				value=QQ_empty_shadow

				[modify_unit]
					[filter]
						id=$unit.id
					[/filter]

					[status]
						qquws_active_ethereal_body=no
					[/status]
				[/modify_unit]

				{VARIABLE register_uws_special "ethereal_body_special"}
				[fire_event]
					name=register_uws_event
				[/fire_event]
			[/case]

			[case]
				value=QQ_elite_protector

				[modify_unit]
					[filter]
						id=$unit.id
					[/filter]

					[variables]
						qquws_shield_master_chance=32
						sharpshooter_chance=50
						sharpshooter_fraction=70
					[/variables]

					[status]
						qquws_shield_master_active=no
					[/status]
				[/modify_unit]

				{VARIABLE register_uws_special "steadfast_item"}
				[fire_event]
					name=register_uws_event
				[/fire_event]

				{VARIABLE register_uws_special "double_attack_item"}
				[fire_event]
					name=register_uws_event
				[/fire_event]
			[/case]

			[case]
				value=QQ_naga_royal_executioner

				[modify_unit]
					[filter]
						id=$unit.id
					[/filter]

					[variables]
						armor_destruction_factor=17
					[/variables]
				[/modify_unit]

				{VARIABLE register_uws_special "armor_destruction_item"}
				[fire_event]
					name=register_uws_event
				[/fire_event]
			[/case]

			[case]
				value=QQ_enflamed_spirit

				[modify_unit]
					[filter]
						id=$unit.id
					[/filter]

					[variables]
						secret_fire_adjacent=20
						secret_fire_defending=12
					[/variables]
				[/modify_unit]

				{VARIABLE register_uws_special "burns_item"}
				[fire_event]
					name=register_uws_event
				[/fire_event]

				{VARIABLE register_uws_special "area_damage_special"}
				[fire_event]
					name=register_uws_event
				[/fire_event]

				{VARIABLE register_uws_special "true_flame_special"}
				[fire_event]
					name=register_uws_event
				[/fire_event]

				{VARIABLE register_uws_special "extinguished_spark_special"}
				[fire_event]
					name=register_uws_event
				[/fire_event]
			[/case]

			[case]
				value=QQ_sunrise_guard

				{VARIABLE register_uws_special "sunrise_regen_special"}
				[fire_event]
					name=register_uws_event
				[/fire_event]
			[/case]

			[case]
				value=QQ_harbinger_of_chaos

				{VARIABLE register_uws_special "area_damage_special"}
				[fire_event]
					name=register_uws_event
				[/fire_event]

				{VARIABLE register_uws_special "inferno_special"}
				[fire_event]
					name=register_uws_event
				[/fire_event]

				{VARIABLE register_uws_special "visceral_pain_special"}
				[fire_event]
					name=register_uws_event
				[/fire_event]
			[/case]

			[case]
				value=QQ_arachna_queen

				[modify_unit]
					[filter]
						id=$unit.id
					[/filter]

					[variables]
						super_poison_extra_dmg=28
						super_poison_inflicts_unhealable=yes
					[/variables]
				[/modify_unit]

				{VARIABLE register_uws_special "melee_poison_item"}
				[fire_event]
					name=register_uws_event
				[/fire_event]

				{VARIABLE register_uws_special "paralysing_venom_special"}
				[fire_event]
					name=register_uws_event
				[/fire_event]

				{VARIABLE register_uws_special "corpse_feast_special"}
				[fire_event]
					name=register_uws_event
				[/fire_event]
			[/case]

			[case]
				value=QQ_orc_decapitator

				[modify_unit]
					[filter]
						id=$unit.id
					[/filter]

					[variables]
						assassination_factor=2
					[/variables]
				[/modify_unit]
				
				{VARIABLE register_uws_special "ranged_acc_item"}
				[fire_event]
					name=register_uws_event
				[/fire_event]

				{VARIABLE register_uws_special "bloodlust_special"}
				[fire_event]
					name=register_uws_event
				[/fire_event]
			[/case]

			[case]
				value=QQ_thundercrown

				[modify_unit]
					[filter]
						id=$unit.id
					[/filter]

					[status]
						gun_reload_ready=yes
					[/status]
				[/modify_unit]
				
				{VARIABLE register_uws_special "gun_reload_special"}
				[fire_event]
					name=register_uws_event
				[/fire_event]
			[/case]
		[/switch]
	[/event]
	
	[event]
		name=register_required_item_events
		first_time_only=yes
		
		[if]
			[variable]
				name=uws_game.is_campaign
				boolean_equals=yes
			[/variable]
			[then]
				{VARIABLE register_uws_special "campaign_unique_specials"}
				[fire_event]
					name=register_uws_event
				[/fire_event]
			[/then]
		[/if]
		
		[set_variables]
			name=tmp_items_to_iterate
			mode=replace
			
			[split]
				list=$used_items_list
				key=name
				separator=","
				remove_empty=yes
			[/split]
		[/set_variables]
		
		[foreach]
			array=tmp_items_to_iterate
			variable=tmp_item
			readonly=yes
			
			[do]
				{VARIABLE register_uws_special "$tmp_item.name|_item"}
				[fire_event]
					name=register_uws_event
				[/fire_event]
			[/do]
		[/foreach]
		
		{CLEAR_VARIABLE tmp_items_to_iterate,tmp_item,register_uws_special}
	[/event]
#enddef

#define END_OF_EFFECT_EVENT
	[event]
		name=side turn
		first_time_only=no

		[for]
			variable=i
			array=qquws_lasting_effect_information
			[do]
				{VARIABLE effect_is_consumed no}
				[if]
					[variable]
						name=qquws_lasting_effect_information[$i].end_of_effect_turn
						numerical_equals=$turn_number
					[/variable]
					[and]
						[variable]
							name=qquws_lasting_effect_information[$i].side
							numerical_equals=$side_number
						[/variable]
					[/and]
					[then]
						[switch]
							variable=qquws_lasting_effect_information[$i].effect_type
							
							[case]
								value=petrification
								
								[modify_unit]
									[filter]
										id=$qquws_lasting_effect_information[$i].id
									[/filter]
									
									[status]
										slowed=yes
										petrified=no
										unhealable=no
									[/status]
								[/modify_unit]
								
								{CLEAR_VARIABLE qquws_lasting_effect_information[$i]}
								{VARIABLE_OP i sub 1}
								{VARIABLE effect_is_consumed yes}
							[/case]
							
							[case]
								value=sickness
								
								[if]
									[have_unit]
										id=$qquws_lasting_effect_information[$i].id
										count=1
									[/have_unit]
									[then]
										[modify_unit]
											[filter]
												id=$qquws_lasting_effect_information[$i].id
											[/filter]
											
											[status]
												unhealable=no
												poisoned=yes
												slowed=no
											[/status]
										[/modify_unit]
										
										[remove_object]
											id=$qquws_lasting_effect_information[$i].id
											object_id=uws_sickness_bitten_object
										[/remove_object]
										
										[store_unit]
											[filter]
												id=$qquws_lasting_effect_information[$i].id
											[/filter]
											
											variable=sick_unit
											mode=always_clear
										[/store_unit]
										
										[floating_text]
											x,y=$sick_unit.x,$sick_unit.y
											text="<span color='#00ff00'>Feeling better!</span>"
										[/floating_text]
									[/then]
								[/if]
								
								{CLEAR_VARIABLE qquws_lasting_effect_information[$i]}
								{VARIABLE_OP i sub 1}
								{VARIABLE effect_is_consumed yes}
							[/case]

							[case]
								value=venom
								
								[if]
									[have_unit]
										id=$qquws_lasting_effect_information[$i].id
										count=1
									[/have_unit]
									[then]
										[modify_unit]
											[filter]
												id=$qquws_lasting_effect_information[$i].id
											[/filter]
											
											[status]
												unhealable=no
												slowed=no
											[/status]
										[/modify_unit]
										
										[remove_object]
											id=$qquws_lasting_effect_information[$i].id
											object_id=uws_venom_bitten_object
										[/remove_object]
										
										[store_unit]
											[filter]
												id=$qquws_lasting_effect_information[$i].id
											[/filter]
											
											variable=sick_unit
											mode=always_clear
										[/store_unit]
										
										[floating_text]
											x,y=$sick_unit.x,$sick_unit.y
											text="<span color='#00ff00' size='large'>Healthy again!</span>"
										[/floating_text]
									[/then]
								[/if]
								
								{CLEAR_VARIABLE qquws_lasting_effect_information[$i]}
								{VARIABLE_OP i sub 1}
								{VARIABLE effect_is_consumed yes}
							[/case]

							[case]
								value=curse_of_the_dead
								
								[if]
									[have_unit]
										id=$qquws_lasting_effect_information[$i].id
										count=1
									[/have_unit]
									[then]
										[modify_unit]
											[filter]
												id=$qquws_lasting_effect_information[$i].id
											[/filter]
											
											[status]
												unhealable=no
												poisoned=no
											[/status]
										[/modify_unit]
										
										[remove_trait]
											id=$qquws_lasting_effect_information[$i].id
											trait_id=uws_curse_of_the_dead_trait
										[/remove_trait]
										
										[store_unit]
											[filter]
												id=$qquws_lasting_effect_information[$i].id
											[/filter]
											
											variable=sick_unit
											mode=always_clear
										[/store_unit]
										
										[floating_text]
											x,y=$sick_unit.x,$sick_unit.y
											text="<span color='#00ff00' size='large'>Healthy again!</span>"
										[/floating_text]
									[/then]
								[/if]
								
								{CLEAR_VARIABLE qquws_lasting_effect_information[$i]}
								{VARIABLE_OP i sub 1}
								{VARIABLE effect_is_consumed yes}
							[/case]

							[case]
								value=sticky_tongue

								[remove_trait]
									id=$qquws_lasting_effect_information[$i].id
									trait_id=qquws_sticky_tongue_trait
								[/remove_trait]

								{CLEAR_VARIABLE qquws_lasting_effect_information[$i]}
								{VARIABLE_OP i sub 1}
								{VARIABLE effect_is_consumed yes}
							[/case]

							[case]
								value=invulnerability
								
								[modify_unit]
									[filter]
										id=$qquws_lasting_effect_information[$i].id
									[/filter]
									
									[status]
										invulnerable=no
									[/status]
								[/modify_unit]
								
								{CLEAR_VARIABLE qquws_lasting_effect_information[$i]}
								{VARIABLE_OP i sub 1}
								{VARIABLE effect_is_consumed yes}
							[/case]

							[case]
								value=leviathans_call

								[remove_trait]
									id=$qquws_lasting_effect_information[$i].id
									trait_id=qquws_leviathan_trait
								[/remove_trait]

								[modify_unit]
									[filter]
										id=$qquws_lasting_effect_information[$i].id
									[/filter]
									
									[status]
										slowed=yes
									[/status]
								[/modify_unit]

								[harm_unit]
									[filter]
										id=$qquws_lasting_effect_information[$i].id
									[/filter]
									
									amount=999
									alignment=neutral
									kill=no
									animate=yes
									experience=no
								[/harm_unit]

								{CLEAR_VARIABLE qquws_lasting_effect_information[$i]}
								{VARIABLE_OP i sub 1}
								{VARIABLE effect_is_consumed yes}
							[/case]
						[/switch]
					[/then]
				[/if]
				
				[if]
					[variable]
						name=effect_is_consumed
						boolean_equals=no
					[/variable]
					[then]
						[switch]
							variable=qquws_lasting_effect_information[$i].effect_type
							
							[case]
								value=sickness
								
								[if]
									[have_unit]
										id=$qquws_lasting_effect_information[$i].id
										count=1
									[/have_unit]
									[then]
										[modify_unit]
											[filter]
												id=$qquws_lasting_effect_information[$i].id
											[/filter]
											
											[status]
												slowed=yes
												unhealable=yes
												poisoned=yes
											[/status]
										[/modify_unit]
										
										[if]
											[variable]
												name=qquws_lasting_effect_information[$i].side
												equals=$side_number
											[/variable]
											[then]
												[harm_unit]
													[filter]
														id=$qquws_lasting_effect_information[$i].id
														formula="if(hitpoints > 1, 1, 0)"
													[/filter]
													
													amount=8
													alignment=neutral
													kill=no
													animate=yes
													experience=no
												[/harm_unit]
											[/then]
										[/if]
									[/then]
								[/if]
							[/case]

							[case]
								value=venom
								
								[if]
									[have_unit]
										id=$qquws_lasting_effect_information[$i].id
										count=1
									[/have_unit]
									[then]
										[modify_unit]
											[filter]
												id=$qquws_lasting_effect_information[$i].id
											[/filter]
											
											[status]
												slowed=yes
												unhealable=yes
												poisoned=yes
											[/status]
										[/modify_unit]
									[/then]
								[/if]
							[/case]

							[case]
								value=curse_of_the_dead
								
								[if]
									[have_unit]
										id=$qquws_lasting_effect_information[$i].id
										count=1
									[/have_unit]
									[then]
										[modify_unit]
											[filter]
												id=$qquws_lasting_effect_information[$i].id
											[/filter]
											
											[status]
												unhealable=yes
												poisoned=yes
											[/status]
										[/modify_unit]
										
										[if]
											[variable]
												name=qquws_lasting_effect_information[$i].side
												equals=$side_number
											[/variable]
											[then]
												[harm_unit]
													[filter]
														id=$qquws_lasting_effect_information[$i].id
														formula="if(hitpoints > 1, 1, 0)"
													[/filter]
													
													amount=12
													alignment=neutral
													kill=no
													animate=yes
													experience=no
												[/harm_unit]
											[/then]
										[/if]
									[/then]
								[/if]
							[/case]
						[/switch]
					[/then]
				[/if]
			[/do]
		[/for]
	[/event]
#enddef

#define UNIT_BASED_GLOBAL_ALLY_BUFF TRAIT_ID PARENT_ABILITY_ID APPLY_EVENT_NAME TRAIT_NAME TRAIT_DESCRIPTION TRAIT_EFFECTS BEFORE_APPLY_TRAIT
	[event]
		name=unit placed
		first_time_only=no
		
		[filter]
			[not]
				trait={TRAIT_ID}
			[/not]
		[/filter]
		
		{VARIABLE apply_global_buff no}
		[if]
			[variable]
				name=uws_game.is_pvp
				boolean_equals=yes
			[/variable]
			[then]
				[if]
					[have_unit]
						side=$unit.side
						ability={PARENT_ABILITY_ID}
					[/have_unit]
					[then]
						{VARIABLE apply_global_buff yes}
					[/then]
				[/if]
			[/then]
			[else]
				[if]
					[have_unit]
						ability={PARENT_ABILITY_ID}
						
						[filter_side]
							[allied_with]
								side=$unit.side
							[/allied_with]
						[/filter_side]
					[/have_unit]
					[then]
						{VARIABLE apply_global_buff yes}
					[/then]
				[/if]
			[/else]
		[/if]
		
		[if]
			[variable]
				name=apply_global_buff
				boolean_equals=yes
			[/variable]
			[then]
				{BEFORE_APPLY_TRAIT}

				[modify_unit]
					[filter]
						id=$unit.id
					[/filter]
					
					[trait]
						id={TRAIT_ID}
						name={TRAIT_NAME}
						description={TRAIT_DESCRIPTION}
						
						{TRAIT_EFFECTS}
					[/trait]
				[/modify_unit]
			[/then]
		[/if]
	[/event]
	
	[event]
		name={APPLY_EVENT_NAME}
		first_time_only=no

		{VARIABLE apply_to_side $item_promotion_unit_side}
		[if]
			[variable]
				name=apply_to_side
				equals=""
			[/variable]
			[then]
				{VARIABLE apply_to_side $side_number}
			[/then]
		[/if]
		
		{VARIABLE apply_global_buff no}
		[if]
			[have_unit]
				side=$apply_to_side
				ability={PARENT_ABILITY_ID}
			[/have_unit]
			[then]
				{VARIABLE apply_global_buff yes}
			[/then]
		[/if]
		
		[if]
			[variable]
				name=apply_global_buff
				boolean_equals=yes
			[/variable]
			[then]
				[if]
					[variable]
						name=uws_game.is_pvp
						boolean_equals=yes
					[/variable]
					[then]
						[remove_trait]
							side=$apply_to_side
							trait_id={TRAIT_ID}
						[/remove_trait]

						{BEFORE_APPLY_TRAIT}
						
						[modify_unit]
							[filter]
								[not]
									trait={TRAIT_ID}
								[/not]
								
								[not]
									ability={PARENT_ABILITY_ID}
								[/not]
					
								side=$apply_to_side
							[/filter]
							
							[trait]
								id={TRAIT_ID}
								name={TRAIT_NAME}
								description={TRAIT_DESCRIPTION}
								
								{TRAIT_EFFECTS}
							[/trait]
						[/modify_unit]
					[/then]
					[else]
						[remove_trait]
							[filter_side]
								[allied_with]
									side=$apply_to_side
								[/allied_with]
							[/filter_side]
							
							trait_id={TRAIT_ID}
						[/remove_trait]

						{BEFORE_APPLY_TRAIT}
						
						[modify_unit]
							[filter]
								[not]
									trait={TRAIT_ID}
								[/not]
								
								[not]
									ability={PARENT_ABILITY_ID}
								[/not]
					
								[filter_side]
									[allied_with]
										side=$apply_to_side
									[/allied_with]
								[/filter_side]
							[/filter]
							
							[trait]
								id={TRAIT_ID}
								name={TRAIT_NAME}
								description={TRAIT_DESCRIPTION}
								
								{TRAIT_EFFECTS}
							[/trait]
						[/modify_unit]
					[/else]
				[/if]
			[/then]
			[else]
				[if]
					[variable]
						name=uws_game.is_pvp
						boolean_equals=yes
					[/variable]
					[then]
						[remove_trait]
							side=$apply_to_side
							trait_id={TRAIT_ID}
						[/remove_trait]
					[/then]
					[else]
						[remove_trait]
							[filter_side]
								[allied_with]
									side=$apply_to_side
								[/allied_with]
							[/filter_side]
							
							trait_id={TRAIT_ID}
						[/remove_trait]
					[/else]
				[/if]
			[/else]
		[/if]
	[/event]
	
	[event]
		name=die
		first_time_only=no
		
		[filter]
			ability={PARENT_ABILITY_ID}
		[/filter]
		
		[if]
			[variable]
				name=uws_game.is_pvp
				boolean_equals=yes
			[/variable]
			[then]
				[if]
					[have_unit]
						side=$unit.side
						ability={PARENT_ABILITY_ID}
						[not]
							id=$unit.id
						[/not]
						
						count=0
					[/have_unit]
					[then]
						[remove_trait]
							side=$unit.side
							trait_id={TRAIT_ID}
						[/remove_trait]
					[/then]
				[/if]
			[/then]
			[else]
				[if]
					[have_unit]
						ability={PARENT_ABILITY_ID}
						
						[filter_side]
							[allied_with]
								side=$unit.side
							[/allied_with]
						[/filter_side]
						
						[not]
							id=$unit.id
						[/not]
						
						count=0
					[/have_unit]
					[then]
						[remove_trait]
							[filter_side]
								[allied_with]
									side=$unit.side
								[/allied_with]
							[/filter_side]
							
							trait_id={TRAIT_ID}
						[/remove_trait]
					[/then]
				[/if]
			[/else]
		[/if]
	[/event]
#enddef

#define REGISTER_MAGICAL_FEEDING
	[event]
		name=die
		first_time_only=no
		
		[filter_second]
			ability=qquws_feeding
		[/filter_second]
		
		{VARIABLE add_hp_bonus $unit.level}
		[if]
			[variable]
				name=add_hp_bonus
				equals=0
			[/variable]
			[then]
				{VARIABLE add_hp_bonus 1}
			[/then]
		[/if]
		
		[if]
			[variable]
				name=add_hp_bonus
				greater_than=$second_unit.variables.feeding_cap
			[/variable]
			[then]
				{VARIABLE add_hp_bonus $second_unit.variables.feeding_cap}
			[/then]
		[/if]
		
		[modify_unit]
			[filter]
				id=$second_unit.id
			[/filter]
				
			[object]
				silent=yes

				[effect]
				    apply_to=hitpoints
				    increase=$add_hp_bonus
				    increase_total=$add_hp_bonus
				[/effect]
			[/object]
		[/modify_unit]
		
		[floating_text]
			x,y=$second_unit.x,$second_unit.y
			text="<span color='#42bd19' size='large'>+$add_hp_bonus|hp</span>"
		[/floating_text]
	[/event]
#enddef

#define REGISTER_POSSESSED_BY_BLOOD
	[event]
		name=attack end
		first_time_only=no
		
		[filter]
			ability=qquws_possessed_by_blood
		[/filter]
		
		[fire_event]
			name=handle_possessed_by_blood
			[primary_unit]
				id=$unit.id
			[/primary_unit]
		[/fire_event]
	[/event]
	
	[event]
		name=attack end
		first_time_only=no
		
		[filter_second]
			ability=qquws_possessed_by_blood
		[/filter_second]
		
		[fire_event]
			name=handle_possessed_by_blood
			[primary_unit]
				id=$second_unit.id
			[/primary_unit]
		[/fire_event]
	[/event]
	
	[event]
		name=handle_possessed_by_blood
		first_time_only=no
		
		[if]
			[variable]
				name=unit.hitpoints
				greater_than=0
			[/variable]
			[then]
				[modify_unit]
					[filter]
						id=$unit.id
					[/filter]
						
					[object]
						silent=yes
						duration=turn end
						
						[effect]
						    apply_to=attack
						    increase_damage=15%
						[/effect]
						[effect]
						    apply_to=overlay
						    add=misc/new-battle2.png
						[/effect]
					[/object]
				[/modify_unit]
				
				[floating_text]
					x,y=$unit.x,$unit.y
					text="<span color='#d9686d' size='medium'>+15% dmg</span>"
				[/floating_text]
			[/then]
		[/if]
	[/event]
#enddef

#define REGISTER_FREEZING_GEM
	[event]
		name=attacker hits
		first_time_only=no
		
		[filter_attack]
			special_id=qquws_freezing_gem
		[/filter_attack]
		
		{VARIABLE freezing_touch_amount $unit.variables.freezing_touch_amount}
		
		[fire_event]
			name=handle_freezing_gem
			[primary_unit]
				id=$second_unit.id
			[/primary_unit]
		[/fire_event]
	[/event]
	
	[event]
		name=defender hits
		first_time_only=no
		
		[filter_second_attack]
			special_id=qquws_freezing_gem
		[/filter_second_attack]
		
		{VARIABLE freezing_touch_amount $second_unit.variables.freezing_touch_amount}
		
		[fire_event]
			name=handle_freezing_gem
			[primary_unit]
				id=$unit.id
			[/primary_unit]
		[/fire_event]
	[/event]
	
	[event]
		name=handle_freezing_gem
		first_time_only=no
		
		[if]
			[variable]
				name=unit.hitpoints
				greater_than=0
			[/variable]
			[then]
				[modify_unit]
					[filter]
						id=$unit.id
					[/filter]
						
					[object]
						silent=yes
						duration=turn end
						
						[effect]
						    apply_to=freezing_gem_defense
						    [defense]
								flat=$freezing_touch_amount
								frozen=$freezing_touch_amount
								forest=$freezing_touch_amount
								hills=$freezing_touch_amount
								village=$freezing_touch_amount
								swamp_water=$freezing_touch_amount
								sand=$freezing_touch_amount
								reef=$freezing_touch_amount
								cave=$freezing_touch_amount
								fungus=$freezing_touch_amount
								mountains=$freezing_touch_amount
								castle=$freezing_touch_amount
								sand=$freezing_touch_amount
								shallow_water=$freezing_touch_amount
						    [/defense]
						[/effect]
						
						[effect]
						    apply_to=overlay
						    add=halo/uws/freezing_touch.png
						[/effect]
					[/object]
				[/modify_unit]
				
				[floating_text]
					x,y=$unit.x,$unit.y
					text="<span color='#77cbe0' size='medium'>-$freezing_touch_amount defense</span>"
				[/floating_text]
			[/then]
		[/if]
	[/event]
#enddef

#define REGISTER_ARMOR_DESTRUCTION
	[event]
		name=attacker hits
		first_time_only=no
		
		[filter_attack]
			special_id=qquws_armor_destruction
		[/filter_attack]
		
		{VARIABLE armor_destruction_amount $unit.variables.armor_destruction_amount}
		{VARIABLE attack_weapon_type $weapon.type}
		
		[fire_event]
			name=handle_armor_destruction
			[primary_unit]
				id=$second_unit.id
			[/primary_unit]
		[/fire_event]
	[/event]
	
	[event]
		name=attacker hits
		first_time_only=no
		
		[filter_attack]
			special_id=qquws_enemy_only_armor_destruction
		[/filter_attack]
		
		{VARIABLE armor_destruction_amount $damage_inflicted}
		{VARIABLE_OP armor_destruction_amount multiply $unit.variables.armor_destruction_factor}
		{VARIABLE_OP armor_destruction_amount divide 100}
		{VARIABLE_OP armor_destruction_amount round ceil}
		
		[if]
			[variable]
				name=armor_destruction_amount
				greater_than=0
			[/variable]
			[then]
				{VARIABLE attack_weapon_type $weapon.type}
		
				[fire_event]
					name=handle_armor_destruction
					[primary_unit]
						id=$second_unit.id
					[/primary_unit]
				[/fire_event]
			[/then]
		[/if]
	[/event]
	
	[event]
		name=handle_armor_destruction
		first_time_only=no
		
		[if]
			[variable]
				name=unit.hitpoints
				greater_than=0
			[/variable]
			[then]
				{VARIABLE reduced_resistance 0}
				
				[modify_unit]
					[filter]
						id=$unit.id
					[/filter]
						
					[object]
						silent=yes
						
						[effect]
						    apply_to=remove_resistance
						    type=$attack_weapon_type
						    amount=$armor_destruction_amount
						[/effect]
					[/object]
				[/modify_unit]
				
				[if]
					[variable]
						name=reduced_resistance
						greater_than=0
					[/variable]
					[then]
						[floating_text]
							x,y=$unit.x,$unit.y
							text="<span color='#975da1' size='medium'>-$reduced_resistance $attack_weapon_type res</span>"
						[/floating_text]
					[/then]
				[/if]
			[/then]
		[/if]
	[/event]
#enddef

#define REGISTER_DOUBLE_ATTACK
	[event]
		name=attack end
		first_time_only=no
		
		[filter_attack]
			special_id=qquws_double_attack
		[/filter_attack]
		
		[if]
			[variable]
				name=unit.variables.is_second_attack
				boolean_equals=yes
			[/variable]
			[then]
				[remove_object]
					find_in=unit
					object_id=qquws_double_attack_object
				[/remove_object]

				[remove_object]
					find_in=unit
					object_id=qquws_double_attack_item_object
				[/remove_object]

				{VARIABLE attacks_required $unit.variables.double_attack_required}
		
				[modify_unit]
					[filter]
						id=$unit.id
					[/filter]
					
					[variables]
						double_attack_bank=0
						is_second_attack=no
					[/variables]

					[object]
						id=qquws_double_attack_item_object
						take_only_once=no
						silent=yes
						[effect]
						    apply_to=attack
						    range=ranged
						    [set_specials]
						    	mode=append
						     	[dummy]
									id=qquws_double_attack
									name="double attack (0\$attacks_required|)"
									description="When charged, this unit can attack twice in a single turn."
									active_on=offense
							 	[/dummy]
						    [/set_specials]
						[/effect]
					[/object]
				[/modify_unit]
			[/then]
			[else]
				{VARIABLE attacks_required $unit.variables.double_attack_required}
				{VARIABLE attacks_done $unit.variables.double_attack_bank}
				{VARIABLE_OP attacks_done add 1}
				
				[if]
					[variable]
						name=attacks_done
						greater_than=$attacks_required
					[/variable]
					[then]
						{VARIABLE attacks_done $attacks_required}
					[/then]
				[/if]

				[remove_object]
					find_in=unit
					object_id=qquws_double_attack_item_object
				[/remove_object]
				
				[modify_unit]
					[filter]
						id=$unit.id
					[/filter]
					
					[variables]
						double_attack_bank=$attacks_done
					[/variables]
					
					[object]
						id=qquws_double_attack_item_object
						take_only_once=no
						silent=yes

						[effect]
						    apply_to=attack
						    range=ranged
						    [set_specials]
						    	mode=append
						     	[dummy]
									id=qquws_double_attack
									name="double attack ($attacks_done\$attacks_required|)"
									description="When charged, this unit can attack twice in a single turn."
									active_on=offense
							 	[/dummy]
						    [/set_specials]
						[/effect]
					[/object]
				[/modify_unit]
				
				[if]
					[variable]
						name=attacks_done
						greater_than_equal_to=$attacks_required
					[/variable]
					[then]
						[modify_unit]
							[filter]
								id=$unit.id
							[/filter]
							
							[variables]
								is_second_attack=yes
							[/variables]
							
							attacks_left=1

							[object]
								id=qquws_double_attack_object
								take_only_once=no
								duration=turn end
								silent=yes
								
								[filter]
									id=$unit.id
								[/filter]
								[effect]
									apply_to=remove_attacks
									[not]
										special_id=qquws_double_attack
									[/not]
								[/effect]
							[/object]
						[/modify_unit]
						
						[floating_text]
							x,y=$unit.x,$unit.y
							text="<span color='#ff6224' size='medium'>Second attack available</span>"
						[/floating_text]
					[/then]
				[/if]
			[/else]
		[/if]
	[/event]
	
	[event]
		name=side turn end
		first_time_only=no
		
		[modify_unit]
			[filter]
				side=$side_number
				[has_attack]
					special_id=qquws_double_attack
				[/has_attack]
			[/filter]
			
			[variables]
				is_second_attack=no
			[/variables]
		[/modify_unit]
	[/event]
#enddef

#define REGISTER_HIT_AND_RUN
	[event]
		name=attack end
		first_time_only=no
		
		[filter]
			x,y=$x1,$y1
			ability=qquws_hit_and_run
			
			[not]
				ability=qquws_status_time_dilation_active
			[/not]
		[/filter]
		
		[if]
			[variable]
				name=second_unit.hitpoints
				greater_than=0
			[/variable]
			[then]
				{VARIABLE_OP unit.moves add $unit.variables.hit_and_run_amount}
				{VARIABLE display_mp $unit.variables.hit_and_run_amount}
			[/then]
			[else]
				{VARIABLE_OP unit.moves add $unit.variables.hit_and_run_kill_amount}
				{VARIABLE display_mp $unit.variables.hit_and_run_kill_amount}
			[/else]
		[/if]

		[unstore_unit]
			variable=unit
			color="0,255,0"
			text="+$display_mp movepoints"
			find_vacant=no
		[/unstore_unit]
	[/event]
	
	[event]
		name=die
		first_time_only=no
		
		[filter_second]
			x,y=$x2,$y2
			ability=qquws_kill_and_run
			side=$side_number
		[/filter_second]
		
		{VARIABLE_OP second_unit.moves add $second_unit.variables.hit_and_run_amount}
		[unstore_unit]
			variable=second_unit
			color="0,255,0"
			text="+$second_unit.variables.hit_and_run_amount movepoints"
			find_vacant=no
		[/unstore_unit]
	[/event]
#enddef

#define REGISTER_HEALS_ALL
	[event]
		name=turn refresh
		first_time_only=no
		
		[if]
			[have_unit]
				side=$side_number
				status=heals_all
			[/have_unit]
			[then]
				[store_unit]
					[filter]
						side=$side_number
						status=heals_all
					[/filter]
					
					variable=global_healers
					mode=always_clear
				[/store_unit]
				
				[foreach]
					array=global_healers
					variable=global_healer
					readonly=yes
					
					[do]
						[if]
							[variable]
								name=uws_game.is_pvp
								boolean_equals=yes
							[/variable]
							[then]
								[heal_unit]
									[filter]
										side=$side_number
									[/filter]
									
									amount=$global_healer.variables.heals_all_amount
									restore_statuses=$global_healer.variables.heals_restore_statuses
									animate=yes
								[/heal_unit]
							[/then]
							[else]
								[heal_unit]
									[filter]
										[filter_side]
											[allied_with]
												side=$side_number
											[/allied_with]
										[/filter_side]
									[/filter]
									
									amount=$global_healer.variables.heals_all_amount
									restore_statuses=$global_healer.variables.heals_restore_statuses
									animate=yes
								[/heal_unit]
							[/else]
						[/if]
					[/do]
				[/foreach]
				
				{CLEAR_VARIABLE global_healers}
			[/then]
		[/if]
	[/event]
#enddef

#define REGISTER_RATS
	[event]
		name=new turn
		first_time_only=no
		
		[if]
			[have_unit]
				status=spawns_rats
			[/have_unit]
			[then]
				[store_unit]
					[filter]
						status=spawns_rats
					[/filter]
					
					variable=rats_breeders
					mode=always_clear
				[/store_unit]
				
				[foreach]
					array=rats_breeders
					variable=rats_breeder
					readonly=no
					
					[do]
						{VARIABLE rats_countdown $rats_breeder.variables.rats_countdown}
						[if]
							[variable]
								name=rats_countdown
								equals=""
							[/variable]
							[then]
								# if the item is first picked then spawn the first rat in the next turn
								{VARIABLE rats_countdown 1}
							[/then]
						[/if]
						
						{VARIABLE_OP rats_countdown sub 1}
						
						[if]
							[variable]
								name=rats_countdown
								equals=0
							[/variable]
							[then]
								{VARIABLE rats_description "This unit is able to breed tasty rats once every $rats_frequency turn(s) (max 4 bred rats).$rats_breeder.variables.rats_extra_info

A fresh rat will spawn this turn"}
							[/then]
							[else]
								{VARIABLE rats_description "This unit is able to breed tasty rats once every $rats_frequency turn(s) (max 4 bred rats).$rats_breeder.variables.rats_extra_info

A fresh rat will spawn in $rats_countdown turn(s)"}
							[/else]
						[/if]
						
						[modify_unit]
							[filter]
								id=$rats_breeder.id
							[/filter]
							
							[variables]
								rats_countdown=$rats_countdown
							[/variables]
						[/modify_unit]
						
						[object]
							silent=yes
							
							[filter]
								id=$rats_breeder.id
							[/filter]

							[effect]
								apply_to=remove_ability
								[abilities]
									[dummy]
										id=qquws_breeds_rats
									[/dummy]
								[/abilities]
							[/effect]
							[effect]
								apply_to=new_ability
								[abilities]
									[dummy]
										id=qquws_breeds_rats
										name="breeds rats"
										description=$rats_description
									[/dummy]
								[/abilities]
							[/effect]
						[/object]
					[/do]
				[/foreach]
				
				{CLEAR_VARIABLE rats_breeders}
			[/then]
		[/if]
	[/event]
	
	[event]
		name=turn refresh
		first_time_only=no
		
		[filter_side]
			side=$uws_game.filter_human_sides
		[/filter_side]
		
		[if]
			[have_unit]
				side=$side_number
				status=spawns_rats
			[/have_unit]
			[then]
				[store_unit]
					[filter]
						side=$side_number
						status=spawns_rats
					[/filter]
					
					variable=rats_breeders
					mode=always_clear
				[/store_unit]

				[foreach]
					array=rats_breeders
					variable=rats_breeder
					readonly=no
					
					[do]
						[if]
							[variable]
								name=rats_breeder.variables.rats_countdown
								numerical_equals=0
							[/variable]
							[then]
								[if]
									[have_unit]
										side=$side_number
										ability=qquws_bred_rat
										count=4-999
									[/have_unit]
									[then]
										{VARIABLE rats_description "This unit is able to breed tasty rats once every $rats_frequency turn(s) (max 4 bred rats).$rats_breeder.variables.rats_extra_info

Limit of 4 rats is exceeded. A single delicious rat is waiting in the spawn queue."}
										[modify_unit]
											[filter]
												id=$rats_breeder.id
											[/filter]
											
											[variables]
												rats_countdown=1
											[/variables]
										[/modify_unit]
									[/then]
									[else]
										{VARIABLE rats_description "This unit is able to breed tasty rats once every $rats_frequency turn(s) (max 4 bred rats).$rats_breeder.variables.rats_extra_info

A fresh and tasty rat has been spawned."}

										{VARIABLE_OP special_rat_chance rand 0..99}
										{VARIABLE apply_special_rat_bonus no}
										{VARIABLE regular_rat_bonus yes}

										[if]
											[variable]
												name=special_rat_chance
												less_than=$rats_breeder.variables.rats_special_chance
											[/variable]
											[then]
												{VARIABLE apply_special_rat_bonus yes}
												{VARIABLE regular_rat_bonus no}
											[/then]
										[/if]

										[unit]
											type="Giant Rat"
											x=$rats_breeder.x
											y=$rats_breeder.y
											side=$side_number
											passable=yes
											upkeep=loyal
											animate=yes

											[status]
												is_bred_rat=yes
												needs_rat_bonus=$apply_special_rat_bonus
												needs_regular_rat_bonus=$regular_rat_bonus
											[/status]
											
											[modifications]
												[object]
													silent=yes
													
													[effect]
														apply_to=new_ability
														[abilities]
															[dummy]
																id=qquws_bred_rat
																name="bred rat"
																description="This is a bred rat. Culinary delicacy."
															[/dummy]
														[/abilities]
													[/effect]
												[/object]
											[/modifications]
										[/unit]
										
										[modify_unit]
											[filter]
												id=$rats_breeder.id
											[/filter]
											
											[variables]
												rats_countdown=$rats_breeder.variables.rats_frequency
											[/variables]
										[/modify_unit]
									[/else]
								[/if]
								
								[object]
									silent=yes
									
									[filter]
										id=$rats_breeder.id
									[/filter]

									[effect]
										apply_to=remove_ability
										[abilities]
											[dummy]
												id=qquws_breeds_rats
											[/dummy]
										[/abilities]
									[/effect]
									[effect]
										apply_to=new_ability
										[abilities]
											[dummy]
												id=qquws_breeds_rats
												name="breeds rats"
												description=$rats_description
											[/dummy]
										[/abilities]
									[/effect]
								[/object]
							[/then]
						[/if]
					[/do]
				[/foreach]
				
				{CLEAR_VARIABLE rats_breeders}
			[/then]
		[/if]
	[/event]

	[event]
		name=unit placed
		first_time_only=no

		[filter]
			type="Giant Rat"
			status=needs_rat_bonus
		[/filter]
		
		{VARIABLE_OP quiet_bonus_key rand "RAT_KAMI,RAT_HEALER,RAT_BPLAGUE,RAT_SNEAKY"}
		{VARIABLE quiet_bonus_unit_id $unit.id}

		[fire_event]
			name=handle_new_rat
		[/fire_event]
	[/event]

	[event]
		name=unit placed
		first_time_only=no

		[filter]
			type="Giant Rat"
			status=needs_regular_rat_bonus
		[/filter]

		{VARIABLE quiet_bonus_key none}
		{VARIABLE quiet_bonus_unit_id $unit.id}

		[fire_event]
			name=handle_new_rat
		[/fire_event]
	[/event]

	[event]
		name=handle_new_rat
		first_time_only=no

		[if]
			[have_unit]
				side=$side_number
				trait=qquws_rat_proliferation_trait
				count=0
			[/have_unit]
			[then]
				{VARIABLE quiet_bonus_key RAT_GENETIC}

				[store_unit]
					[filter]
						side=$side_number
						ability=qquws_breeds_rats
					[/filter]

					variable=rat_breeder
					mode=always_clear
				[/store_unit]

				{VARIABLE rat_bonus_breeder_rank $rat_breeder.variables.promotion_level}
			[/then]
		[/if]

		[if]
			[have_unit]
				ability=qquws_rat_god
				side=$side_number
			[/have_unit]
			[then]
				{VARIABLE new_rat_bonus_level 8}
			[/then]
			[else]
				[if]
					[have_unit]
						ability=qquws_rat_avatar
						side=$side_number
					[/have_unit]
					[then]
						{VARIABLE new_rat_bonus_level 7}
					[/then]
					[else]
						[if]
							[have_unit]
								ability=qquws_rat_pope
								side=$side_number
							[/have_unit]
							[then]
								{VARIABLE new_rat_bonus_level 6}
							[/then]
							[else]
								[if]
									[have_unit]
										ability=qquws_rat_king
										side=$side_number
									[/have_unit]
									[then]
										{VARIABLE new_rat_bonus_level 5}
									[/then]
									[else]
										[if]
											[have_unit]
												ability=qquws_rat_prince
												side=$side_number
											[/have_unit]
											[then]
												{VARIABLE new_rat_bonus_level 4}
											[/then]
											[else]
												[if]
													[have_unit]
														ability=qquws_rat_duke
														side=$side_number
													[/have_unit]
													[then]
														{VARIABLE new_rat_bonus_level 3}
													[/then]
													[else]
														[if]
															[have_unit]
																ability=qquws_rat_general
																side=$side_number
															[/have_unit]
															[then]
																{VARIABLE new_rat_bonus_level 2}
															[/then]
															[else]
																[if]
																	[have_unit]
																		ability=qquws_rat_sergeant
																		side=$side_number
																	[/have_unit]
																	[then]
																		{VARIABLE new_rat_bonus_level 1}
																	[/then]
																	[else]
																		{VARIABLE new_rat_bonus_level 0}
																	[/else]
																[/if]
															[/else]
														[/if]
													[/else]
												[/if]
											[/else]
										[/if]
									[/else]
								[/if]
							[/else]
						[/if]
					[/else]
				[/if]
			[/else]
		[/if]	

		[switch]
			variable=new_rat_bonus_level

			[case]
				value=0

				{VARIABLE new_rat_kamikaze_dmg 12}
				{VARIABLE new_rat_impact_dmg 10}
				{VARIABLE new_rat_healing 8}
				{VARIABLE new_rat_black_plague_acc 0}
				{VARIABLE new_rat_ninja_def 0}
				{VARIABLE new_rat_presence_enabled no}
				{VARIABLE new_rat_semi_healing 4}
				{VARIABLE new_rat_extra_dmg 0}
				{VARIABLE new_rat_extra_hp 0}
			[/case]

			[case]
				value=1

				{VARIABLE new_rat_kamikaze_dmg 14}
				{VARIABLE new_rat_impact_dmg 11}
				{VARIABLE new_rat_healing 10}
				{VARIABLE new_rat_black_plague_acc 2}
				{VARIABLE new_rat_ninja_def 2}
				{VARIABLE new_rat_presence_enabled yes}
				{VARIABLE new_rat_presence_type "a sergeant"}
				{VARIABLE new_rat_semi_healing 5}
				{VARIABLE new_rat_extra_dmg 1}
				{VARIABLE new_rat_extra_hp 1}
			[/case]

			[case]
				value=2

				{VARIABLE new_rat_kamikaze_dmg 16}
				{VARIABLE new_rat_impact_dmg 12}
				{VARIABLE new_rat_healing 12}
				{VARIABLE new_rat_black_plague_acc 4}
				{VARIABLE new_rat_ninja_def 4}
				{VARIABLE new_rat_presence_enabled yes}
				{VARIABLE new_rat_presence_type "a general"}
				{VARIABLE new_rat_semi_healing 6}
				{VARIABLE new_rat_extra_dmg 1}
				{VARIABLE new_rat_extra_hp 4}
			[/case]

			[case]
				value=3

				{VARIABLE new_rat_kamikaze_dmg 20}
				{VARIABLE new_rat_impact_dmg 14}
				{VARIABLE new_rat_healing 16}
				{VARIABLE new_rat_black_plague_acc 8}
				{VARIABLE new_rat_ninja_def 8}
				{VARIABLE new_rat_presence_enabled yes}
				{VARIABLE new_rat_presence_type "a duke"}
				{VARIABLE new_rat_semi_healing 8}
				{VARIABLE new_rat_extra_dmg 1}
				{VARIABLE new_rat_extra_hp 7}
			[/case]

			[case]
				value=4

				{VARIABLE new_rat_kamikaze_dmg 24}
				{VARIABLE new_rat_impact_dmg 16}
				{VARIABLE new_rat_healing 20}
				{VARIABLE new_rat_black_plague_acc 12}
				{VARIABLE new_rat_ninja_def 12}
				{VARIABLE new_rat_presence_enabled yes}
				{VARIABLE new_rat_presence_type "a prince"}
				{VARIABLE new_rat_semi_healing 10}
				{VARIABLE new_rat_extra_dmg 2}
				{VARIABLE new_rat_extra_hp 9}
			[/case]

			[case]
				value=5

				{VARIABLE new_rat_kamikaze_dmg 28}
				{VARIABLE new_rat_impact_dmg 20}
				{VARIABLE new_rat_healing 24}
				{VARIABLE new_rat_black_plague_acc 16}
				{VARIABLE new_rat_ninja_def 16}
				{VARIABLE new_rat_presence_enabled yes}
				{VARIABLE new_rat_presence_type "the king"}
				{VARIABLE new_rat_semi_healing 12}
				{VARIABLE new_rat_extra_dmg 2}
				{VARIABLE new_rat_extra_hp 14}
			[/case]

			[case]
				value=6

				{VARIABLE new_rat_kamikaze_dmg 34}
				{VARIABLE new_rat_impact_dmg 24}
				{VARIABLE new_rat_healing 30}
				{VARIABLE new_rat_black_plague_acc 20}
				{VARIABLE new_rat_ninja_def 20}
				{VARIABLE new_rat_presence_enabled yes}
				{VARIABLE new_rat_presence_type "the pope"}
				{VARIABLE new_rat_semi_healing 14}
				{VARIABLE new_rat_extra_dmg 3}
				{VARIABLE new_rat_extra_hp 17}
			[/case]

			[case]
				value=7

				{VARIABLE new_rat_kamikaze_dmg 40}
				{VARIABLE new_rat_impact_dmg 28}
				{VARIABLE new_rat_healing 36}
				{VARIABLE new_rat_black_plague_acc 25}
				{VARIABLE new_rat_ninja_def 25}
				{VARIABLE new_rat_presence_enabled yes}
				{VARIABLE new_rat_presence_type "the avatar"}
				{VARIABLE new_rat_semi_healing 16}
				{VARIABLE new_rat_extra_dmg 4}
				{VARIABLE new_rat_extra_hp 19}
			[/case]

			[case]
				value=8

				{VARIABLE new_rat_kamikaze_dmg 48}
				{VARIABLE new_rat_impact_dmg 32}
				{VARIABLE new_rat_healing 44}
				{VARIABLE new_rat_black_plague_acc 30}
				{VARIABLE new_rat_ninja_def 30}
				{VARIABLE new_rat_presence_enabled yes}
				{VARIABLE new_rat_presence_type "the god"}
				{VARIABLE new_rat_semi_healing 20}
				{VARIABLE new_rat_extra_dmg 5}
				{VARIABLE new_rat_extra_hp 24}
			[/case]
		[/switch]

		[fire_event]
			name=apply_quiet_bonus
		[/fire_event]

		[modify_unit]
			[filter]
				id=$unit.id
			[/filter]

			[variables]
				is_zero_xp_unit=yes
			[/variables]
			
			[status]
				needs_rat_bonus=no
			[/status]

			[trait]
				id=qquws_zero_xp
				name="no xp"
				description="This unit gives no xp and doesn't increase the kill count when killed."
			[/trait]
		[/modify_unit]

		[if]
			[variable]
				name=new_rat_presence_enabled
				boolean_equals=yes
			[/variable]
			[and]
				[variable]
					name=quiet_bonus_key
					not_equals=RAT_GENETIC
				[/variable]
			[/and]
			[then]
				[modify_unit]
					[filter]
						id=$unit.id
					[/filter]
					
					[trait]
						id=qquws_rat_presence_info
						name="presence of $new_rat_presence_type"
						description="This rat's fightining skills are increased by the presence of the royalty.

Special rat skills are improved"

						[effect]
							apply_to=attack
							range=melee
							increase_damage=$new_rat_extra_dmg
						[/effect]
						[effect]
							apply_to=hitpoints
							increase=$new_rat_extra_hp
							increase_total=$new_rat_extra_hp
						[/effect]
					[/trait]
				[/modify_unit]
			[/then]
		[/if]

		[if]
			[variable]
				name=quiet_bonus_key
				not_equals=RAT_HEALER
			[/variable]
			[and]
				[variable]
					name=quiet_bonus_key
					not_equals=RAT_GENETIC
				[/variable]
			[/and]
			[then]
				{VARIABLE quiet_bonus_key RAT_SEMI_HEALER}
				{VARIABLE quiet_bonus_unit_id $unit.id}

				[fire_event]
					name=apply_quiet_bonus
				[/fire_event]
			[/then]
		[/if]
	[/event]

	[event]
		name=unit placed
		first_time_only=no

		[filter]
			type="Giant Rat"
		[/filter]

		[filter_condition]
			[variable]
				name=rodent_proliferation_enabled
				boolean_equals=yes
			[/variable]
		[/filter_condition]

		{VARIABLE rat_proliferation_all_available_debuffs "damage:2m22,hitpoints:1m999,accuracy:10m10,defense:10m10,strikes:1m2,royal_rat:1m8,poison:1m1,skirm:1m1,marksman:1m1,regen:6m12,res:15m30,mp:2m2,drains:1m2"}
		[qquws_calculate_buff_list]
			list=$rodent_proliferation_parent_buffs
			all_available=$rat_proliferation_all_available_debuffs
			output_list_var=rp_debuffs_list
		[/qquws_calculate_buff_list]

		{VARIABLE_OP proliferation_factor rand "0,0,1,1,1,2,2,2,2,2,2,3,3,3,4,5"}
		[if]
			[variable]
				name=rodent_proliferation_allow_sterile
				boolean_equals=no
			[/variable]
			[then]
				{VARIABLE proliferation_factor 1}
			[/then]
		[/if]

		[if]
			[variable]
				name=rodent_proliferation_is_god
				boolean_equals=yes
			[/variable]
			[then]
				{VARIABLE proliferation_factor 0}
			[/then]
		[/if]

		[if]
			[variable]
				name=proliferation_factor
				greater_than=0
			[/variable]
			[then]
				[modify_unit]
					[filter]
						id=$unit.id
					[/filter]

					[variables]
						rat_proliferation_bonus=$rp_debuffs_list
						rat_proliferation_max_children=$proliferation_factor
						rat_proliferation_children=0
					[/variables]

					[status]
						proliferation_is_active=yes
					[/status]

					[object]
						silent=yes

						[effect]
							apply_to=new_ability
							[abilities]
								[dummy]
									id=qquws_inbred_rat
									name="inbred rat"
									description="This is an inbred rat. Not as tasty as other rats, in fact a bit unappetizing, but useful in other aspects."
								[/dummy]
							[/abilities]
						[/effect]
						[effect]
						    apply_to=overlay
						    add=halo/uws/rodent.png
						[/effect]
						[effect]
						    apply_to=attack
						    [set_specials]
						    	mode=append
							    [plague]
							        id=qquws_rodent_proliferation
							        name="rodent proliferation (0/$proliferation_factor)"
							        description="When a living unit is killed with this attack, that unit is replaced with a new rodent that takes the strong genes of the killer. This rat can have a maximum of $proliferation_factor child(ren)."
							        type="Giant Rat"
							        [filter_self]
							        	status=proliferation_is_active
							        [/filter_self]
							    [/plague]
						     [/set_specials]
						[/effect]
					[/object]
				[/modify_unit]
			[/then]
			[else]
				[if]
					[variable]
						name=rodent_proliferation_is_god
						boolean_equals=yes
					[/variable]
					[then]
						[modify_unit]
							[filter]
								id=$unit.id
							[/filter]

							[variables]
								rat_proliferation_bonus=$rp_debuffs_list
								rat_proliferation_max_children=$proliferation_factor
								rat_proliferation_children=0
							[/variables]

							[status]
								proliferation_is_active=no
							[/status]

							[object]
								silent=yes

								[effect]
									apply_to=new_ability
									[abilities]
										[dummy]
											id=qquws_ultimate_rat
											name="ultimate rodent form"
											description="This rat has become the God, one with the Absolute. No higher form can exist. Get on your knees you peasant and worship the God!"
										[/dummy]
									[/abilities]
								[/effect]
								[effect]
								    apply_to=halo
								    halo="halo/uws/god.png"
								[/effect]
							[/object]
						[/modify_unit]
					[/then]
					[else]
						[modify_unit]
							[filter]
								id=$unit.id
							[/filter]

							[variables]
								rat_proliferation_bonus=$rp_debuffs_list
								rat_proliferation_max_children=$proliferation_factor
								rat_proliferation_children=0
							[/variables]

							[status]
								proliferation_is_active=no
							[/status]

							[object]
								silent=yes

								[effect]
									apply_to=new_ability
									[abilities]
										[dummy]
											id=qquws_inbred_rat
											name="inbred rat"
											description="This is an inbred rat. Not as tasty as other rats, in fact a bit unappetizing, but useful in other aspects."
										[/dummy]
									[/abilities]
								[/effect]
								[effect]
								    apply_to=overlay
								    add=halo/uws/rodent.png
								[/effect]
								[effect]
								    apply_to=attack
								    [set_specials]
								    	mode=append
									    [dummy]
									        id=qquws_sterile_rodent
									        name="<span color='#bfaf19'>sterile rodent</span>"
									        description="This rodent is sterile due to extensive inbreeding and therefore unable to proliferate."
									        [filter_self]
									        	status=proliferation_is_active
									        [/filter_self]
									    [/dummy]
								     [/set_specials]
								[/effect]
							[/object]
						[/modify_unit]
					[/else]
				[/if]
			[/else]
		[/if]

		[set_variables]
			name=modify_unit_info
			mode=replace
			[value]
				[filter]
					id=$unit.id
				[/filter]

				[variables]
					is_zero_xp_unit=yes
				[/variables]

				[trait]
					id=qquws_rat_proliferation_trait
					name="pedigree rat"
					description="This rat descends from a pure line of ancient rat ancestry."
				[/trait]

				[trait]
					id=qquws_zero_xp
					name="no xp"
					description="This unit gives no xp and doesn't increase the kill count when killed."
				[/trait]
			[/value]
		[/set_variables]

		[set_variables]
			name=rat_proliferation_debuff_list
			mode=replace
			[split]
				list=$rp_debuffs_list
				key=el
				separator=","
			[/split]
		[/set_variables]

		{VARIABLE debuff_info ""}
		{VARIABLE debuff_effect_iterator 0}
		[foreach]
			array=rat_proliferation_debuff_list
			variable=debuff
			readonly=yes

			[do]
				{VARIABLE debuff_key $debuff.el}
				{VARIABLE debuff_value 0}
				[if]
					[variable]
						name=debuff_key
						contains=":"
					[/variable]
					[then]
						{VARIABLE debuff_value "$( substring( '$debuff_key', find_string('$debuff_key', ':') + 1) )"}
						{VARIABLE debuff_key "$( substring( '$debuff_key', 0, find_string('$debuff_key', ':')) )"}
					[/then]
				[/if]

				[switch]
					variable=debuff_key

					[case]
						value=damage

						{VARIABLE modify_unit_info[0].trait.effect[$debuff_effect_iterator].apply_to "attack"}
						{VARIABLE modify_unit_info[0].trait.effect[$debuff_effect_iterator].increase_damage "$debuff_value"}
						{VARIABLE_OP debuff_effect_iterator add 1}
					[/case]

					[case]
						value=hitpoints

						{VARIABLE hitpoints_increase "$( if($debuff_value < 20, [1,2,5,9,14,20,27,35,42,47,51,55,60,67,75,82,88,93,97,101][$debuff_value], floor(105.0 + 3.5 * ($debuff_value - 20) )  ) )"}
						{VARIABLE modify_unit_info[0].trait.effect[$debuff_effect_iterator].apply_to "hitpoints"}
						{VARIABLE modify_unit_info[0].trait.effect[$debuff_effect_iterator].increase "$hitpoints_increase"}
						{VARIABLE modify_unit_info[0].trait.effect[$debuff_effect_iterator].increase_total "$hitpoints_increase"}
						{VARIABLE_OP debuff_effect_iterator add 1}
					[/case]

					[case]
						value=mp

						{VARIABLE modify_unit_info[0].trait.effect[$debuff_effect_iterator].apply_to "movement"}
						{VARIABLE modify_unit_info[0].trait.effect[$debuff_effect_iterator].increase "$debuff_value"}
						{VARIABLE_OP debuff_effect_iterator add 1}
					[/case]

					[case]
						value=accuracy

						{VARIABLE modify_unit_info[0].trait.effect[$debuff_effect_iterator].apply_to "attack"}
						{VARIABLE modify_unit_info[0].trait.effect[$debuff_effect_iterator].increase_accuracy "$debuff_value"}
						{VARIABLE_OP debuff_effect_iterator add 1}
					[/case]

					[case]
						value=defense

						{VARIABLE modify_unit_info[0].trait.effect[$debuff_effect_iterator].apply_to "defense"}
						{VARIABLE modify_unit_info[0].trait.effect[$debuff_effect_iterator].replace no}
						{VARIABLE modify_unit_info[0].trait.effect[$debuff_effect_iterator].defense.flat "-$debuff_value"}
						{VARIABLE modify_unit_info[0].trait.effect[$debuff_effect_iterator].defense.frozen "-$debuff_value"}
						{VARIABLE modify_unit_info[0].trait.effect[$debuff_effect_iterator].defense.forest "-$debuff_value"}
						{VARIABLE modify_unit_info[0].trait.effect[$debuff_effect_iterator].defense.hills "-$debuff_value"}
						{VARIABLE modify_unit_info[0].trait.effect[$debuff_effect_iterator].defense.mountains "-$debuff_value"}
						{VARIABLE modify_unit_info[0].trait.effect[$debuff_effect_iterator].defense.village "-$debuff_value"}
						{VARIABLE modify_unit_info[0].trait.effect[$debuff_effect_iterator].defense.swamp_water "-$debuff_value"}
						{VARIABLE modify_unit_info[0].trait.effect[$debuff_effect_iterator].defense.shallow_water "-$debuff_value"}
						{VARIABLE modify_unit_info[0].trait.effect[$debuff_effect_iterator].defense.deep_water "-$debuff_value"}
						{VARIABLE modify_unit_info[0].trait.effect[$debuff_effect_iterator].defense.reef "-$debuff_value"}
						{VARIABLE modify_unit_info[0].trait.effect[$debuff_effect_iterator].defense.castle "-$debuff_value"}
						{VARIABLE modify_unit_info[0].trait.effect[$debuff_effect_iterator].defense.cave "-$debuff_value"}
						{VARIABLE modify_unit_info[0].trait.effect[$debuff_effect_iterator].defense.sand "-$debuff_value"}
						{VARIABLE modify_unit_info[0].trait.effect[$debuff_effect_iterator].defense.fungus "-$debuff_value"}
						{VARIABLE_OP debuff_effect_iterator add 1}
						{VARIABLE debuff_info "$debuff_info
Defense everywhere +$debuff_value|%"}
					[/case]

					[case]
						value=res

						{VARIABLE modify_unit_info[0].trait.effect[$debuff_effect_iterator].apply_to "resistance"}
						{VARIABLE modify_unit_info[0].trait.effect[$debuff_effect_iterator].replace no}
						{VARIABLE modify_unit_info[0].trait.effect[$debuff_effect_iterator].resistance.blade "-$debuff_value"}
						{VARIABLE modify_unit_info[0].trait.effect[$debuff_effect_iterator].resistance.impact "-$debuff_value"}
						{VARIABLE modify_unit_info[0].trait.effect[$debuff_effect_iterator].resistance.pierce "-$debuff_value"}
						{VARIABLE modify_unit_info[0].trait.effect[$debuff_effect_iterator].resistance.arcane "-$debuff_value"}
						{VARIABLE modify_unit_info[0].trait.effect[$debuff_effect_iterator].resistance.fire "-$debuff_value"}
						{VARIABLE modify_unit_info[0].trait.effect[$debuff_effect_iterator].resistance.cold "-$debuff_value"}
						{VARIABLE_OP debuff_effect_iterator add 1}
						{VARIABLE debuff_info "$debuff_info
Resistance +$debuff_value|%"}
					[/case]

					[case]
						value=strikes

						{VARIABLE modify_unit_info[0].trait.effect[$debuff_effect_iterator].apply_to "attack"}
						{VARIABLE modify_unit_info[0].trait.effect[$debuff_effect_iterator].increase_attacks "$debuff_value"}
						{VARIABLE_OP debuff_effect_iterator add 1}
					[/case]

					[case]
						value=poison

						{VARIABLE modify_unit_info[0].trait.effect[$debuff_effect_iterator].apply_to "attack"}
						{VARIABLE modify_unit_info[0].trait.effect[$debuff_effect_iterator].set_specials.mode "append"}
						{VARIABLE modify_unit_info[0].trait.effect[$debuff_effect_iterator].set_specials.poison.id "poison"}
						{VARIABLE modify_unit_info[0].trait.effect[$debuff_effect_iterator].set_specials.poison.name "poison"}
						{VARIABLE modify_unit_info[0].trait.effect[$debuff_effect_iterator].set_specials.poison.description "This attack poisons living targets. Poisoned units lose 8 HP every turn until they are cured or are reduced to 1 HP. Poison cannot, of itself, kill a unit."}
						{VARIABLE_OP debuff_effect_iterator add 1}
						{VARIABLE debuff_info "$debuff_info
Poison attack"}
					[/case]

					[case]
						value=marksman

						{VARIABLE modify_unit_info[0].trait.effect[$debuff_effect_iterator].apply_to "attack"}
						{VARIABLE modify_unit_info[0].trait.effect[$debuff_effect_iterator].set_specials.mode "append"}
						{VARIABLE modify_unit_info[0].trait.effect[$debuff_effect_iterator].set_specials.chance_to_hit.id "marksman"}
						{VARIABLE modify_unit_info[0].trait.effect[$debuff_effect_iterator].set_specials.chance_to_hit.name "marksman"}
						{VARIABLE modify_unit_info[0].trait.effect[$debuff_effect_iterator].set_specials.chance_to_hit.description "When used offensively, this attack always has at least a 60% chance to hit."}
						{VARIABLE modify_unit_info[0].trait.effect[$debuff_effect_iterator].set_specials.chance_to_hit.value 60}
						{VARIABLE modify_unit_info[0].trait.effect[$debuff_effect_iterator].set_specials.chance_to_hit.cumulative yes}
						{VARIABLE modify_unit_info[0].trait.effect[$debuff_effect_iterator].set_specials.chance_to_hit.active_on offense}
						{VARIABLE_OP debuff_effect_iterator add 1}
						{VARIABLE debuff_info "$debuff_info
Marksman"}
					[/case]

					[case]
						value=skirm

						{VARIABLE modify_unit_info[0].trait.effect[$debuff_effect_iterator].apply_to "new_ability"}
						{VARIABLE modify_unit_info[0].trait.effect[$debuff_effect_iterator].abilities.skirmisher[0].id "skirmisher"}
						{VARIABLE modify_unit_info[0].trait.effect[$debuff_effect_iterator].abilities.skirmisher[0].name "skirmisher"}
						{VARIABLE modify_unit_info[0].trait.effect[$debuff_effect_iterator].abilities.skirmisher[0].description "This unit is skilled in moving past enemies quickly, and ignores all enemy Zones of Control."}
						{VARIABLE_OP debuff_effect_iterator add 1}
						{VARIABLE debuff_info "$debuff_info
Skirmisher"}
					[/case]

					[case]
						value=regen

						{VARIABLE modify_unit_info[0].trait.effect[$debuff_effect_iterator].apply_to "remove_ability"}
						{VARIABLE modify_unit_info[0].trait.effect[$debuff_effect_iterator].abilities.regenerate[0].id "regenerates"}
						{VARIABLE_OP debuff_effect_iterator add 1}

						{VARIABLE modify_unit_info[0].trait.effect[$debuff_effect_iterator].apply_to "new_ability"}
						{VARIABLE modify_unit_info[0].trait.effect[$debuff_effect_iterator].abilities.regenerate[0].id "regenerates"}
						{VARIABLE modify_unit_info[0].trait.effect[$debuff_effect_iterator].abilities.regenerate[0].name "regenerates $debuff_value"}
						{VARIABLE modify_unit_info[0].trait.effect[$debuff_effect_iterator].abilities.regenerate[0].value $debuff_value}
						{VARIABLE modify_unit_info[0].trait.effect[$debuff_effect_iterator].abilities.regenerate[0].affect_self yes}
						{VARIABLE modify_unit_info[0].trait.effect[$debuff_effect_iterator].abilities.regenerate[0].poison "cured"}
						{VARIABLE modify_unit_info[0].trait.effect[$debuff_effect_iterator].abilities.regenerate[0].description "The unit will heal itself $debuff_value HP per turn. If it is poisoned, it will remove the poison instead of healing."}
						{VARIABLE_OP debuff_effect_iterator add 1}
						{VARIABLE debuff_info "$debuff_info
Regen +$debuff_value"}
					[/case]

					[case]
						value=drains

						[switch]
							variable=debuff_value

							[case]
								value=1

								{VARIABLE modify_unit_info[0].trait.effect[$debuff_effect_iterator].apply_to "attack"}
								{VARIABLE modify_unit_info[0].trait.effect[$debuff_effect_iterator].set_specials.mode "append"}
								{VARIABLE modify_unit_info[0].trait.effect[$debuff_effect_iterator].set_specials.drains.id "drains"}
								{VARIABLE modify_unit_info[0].trait.effect[$debuff_effect_iterator].set_specials.drains.name "drains 40"}
								{VARIABLE modify_unit_info[0].trait.effect[$debuff_effect_iterator].set_specials.drains.description "This unit drains health from living units, healing itself 40% of the amount of damage it deals (rounded down)."}
								{VARIABLE modify_unit_info[0].trait.effect[$debuff_effect_iterator].set_specials.drains.value 40}
								{VARIABLE debuff_info "$debuff_info
Drains 40"}
							[/case]

							[case]
								value=2

								{VARIABLE modify_unit_info[0].trait.effect[$debuff_effect_iterator].apply_to "attack"}
								{VARIABLE modify_unit_info[0].trait.effect[$debuff_effect_iterator].set_specials.mode "append"}
								{VARIABLE modify_unit_info[0].trait.effect[$debuff_effect_iterator].set_specials.drains.id "drains"}
								{VARIABLE modify_unit_info[0].trait.effect[$debuff_effect_iterator].set_specials.drains.name "drains 65"}
								{VARIABLE modify_unit_info[0].trait.effect[$debuff_effect_iterator].set_specials.drains.description "This unit drains health from living units, healing itself 65% of the amount of damage it deals (rounded down)."}
								{VARIABLE modify_unit_info[0].trait.effect[$debuff_effect_iterator].set_specials.drains.value 65}
								{VARIABLE debuff_info "$debuff_info
Drains 65"}
							[/case]
						[/switch]

						{VARIABLE_OP debuff_effect_iterator add 1}
					[/case]

					[case]
						value=royal_rat

						[switch]
							variable=debuff_value

							[case]
								value=1

								{VARIABLE modify_unit_info[0].trait.effect[$debuff_effect_iterator].apply_to "new_ability"}
								{VARIABLE modify_unit_info[0].trait.effect[$debuff_effect_iterator].abilities.dummy[0].id "qquws_rat_sergeant"}
								{VARIABLE modify_unit_info[0].trait.effect[$debuff_effect_iterator].abilities.dummy[0].name "rat sergeant"}
								{VARIABLE modify_unit_info[0].trait.effect[$debuff_effect_iterator].abilities.dummy[0].description "Servant of the Royal Rodent Family, the role of the Sergeant is to keep the order and high morale of the fellow rats. Having the Rat Sergeant in your ranks provides:

<span color='#11ff11'>+1 damage</span>, <span color='#11ff11'>+1 hp</span> to all bred rats
kamikaze rats deal <span color='#11ff11'>+2 damage</span>
disease rats gain <span color='#11ff11'>+2% accuracy</span>
ninja rats gain <span color='#11ff11'>+2% defense everywhere</span>
all rats taste better
edible rats <span color='#11ff11'>+2 healing</span>
other rats <span color='#11ff11'>+1 healing</span>
rat ambassador <span color='#11ff11'>+25% hp</span>"}

								{VARIABLE debuff_info "$debuff_info
Rat Sergeant"}
								{VARIABLE_OP debuff_effect_iterator add 1}
								{VARIABLE modify_unit_info[0].trait.effect[$debuff_effect_iterator].apply_to "image_mod"}
								{VARIABLE modify_unit_info[0].trait.effect[$debuff_effect_iterator].add "~CS(-15,0,-45)"}
							[/case]

							[case]
								value=2

								{VARIABLE modify_unit_info[0].trait.effect[$debuff_effect_iterator].apply_to "new_ability"}
								{VARIABLE modify_unit_info[0].trait.effect[$debuff_effect_iterator].abilities.dummy[0].id "qquws_rat_general"}
								{VARIABLE modify_unit_info[0].trait.effect[$debuff_effect_iterator].abilities.dummy[0].name "rat general"}
								{VARIABLE modify_unit_info[0].trait.effect[$debuff_effect_iterator].abilities.dummy[0].description "Servant of the Royal Rodent Family, the role of the General is to fulfill the Will of the Royal Rodent Family. Having the Rat General in your ranks provides:

<span color='#11ff11'>+1 damage</span>, <span color='#11ff11'>+4 hp</span> to all bred rats
kamikaze rats deal <span color='#11ff11'>+4 damage</span>
disease rats gain <span color='#11ff11'>+4% accuracy</span>
ninja rats gain <span color='#11ff11'>+4% defense everywhere</span>
all rats taste better
edible rats <span color='#11ff11'>+4 healing</span>
other rats <span color='#11ff11'>+2 healing</span>
rat ambassador <span color='#11ff11'>+25% hp</span>, <span color='#11ff11'>+1mp</span>"}

								{VARIABLE debuff_info "$debuff_info
Rat General"}
								{VARIABLE_OP debuff_effect_iterator add 1}
								{VARIABLE modify_unit_info[0].trait.effect[$debuff_effect_iterator].apply_to "image_mod"}
								{VARIABLE modify_unit_info[0].trait.effect[$debuff_effect_iterator].add "~SCALE_INTO_SHARP(84,84)"}
							[/case]

							[case]
								value=3

								{VARIABLE modify_unit_info[0].trait.effect[$debuff_effect_iterator].apply_to "new_ability"}
								{VARIABLE modify_unit_info[0].trait.effect[$debuff_effect_iterator].abilities.dummy[0].id "qquws_rat_duke"}
								{VARIABLE modify_unit_info[0].trait.effect[$debuff_effect_iterator].abilities.dummy[0].name "rat duke"}
								{VARIABLE modify_unit_info[0].trait.effect[$debuff_effect_iterator].abilities.dummy[0].description "Member of the Royal Rodent Family, the role of the Duke is to command the legions of rats. Having the Rat Duke in your ranks provides:

<span color='#11ff11'>+1 damage</span>, <span color='#11ff11'>+7 hp</span> to all bred rats
kamikaze rats deal <span color='#11ff11'>+8 damage</span>
disease rats gain <span color='#11ff11'>+8% accuracy</span>
ninja rats gain <span color='#11ff11'>+8% defense everywhere</span>
all rats taste better
edible rats <span color='#11ff11'>+8 healing</span>
other rats <span color='#11ff11'>+4 healing</span>
rat ambassador <span color='#11ff11'>+25% hp</span>, <span color='#11ff11'>+1mp</span>, <span color='#11ff11'>+10% magical res</span>"}

								{VARIABLE debuff_info "$debuff_info
Rat Duke"}
								{VARIABLE_OP debuff_effect_iterator add 1}
								{VARIABLE modify_unit_info[0].trait.effect[$debuff_effect_iterator].apply_to "image_mod"}
								{VARIABLE modify_unit_info[0].trait.effect[$debuff_effect_iterator].add "~SCALE_INTO_SHARP(84,84)~CS(-15,40,40)"}
							[/case]

							[case]
								value=4

								{VARIABLE modify_unit_info[0].trait.effect[$debuff_effect_iterator].apply_to "new_ability"}
								{VARIABLE modify_unit_info[0].trait.effect[$debuff_effect_iterator].abilities.dummy[0].id "qquws_rat_prince"}
								{VARIABLE modify_unit_info[0].trait.effect[$debuff_effect_iterator].abilities.dummy[0].name "rat prince"}
								{VARIABLE modify_unit_info[0].trait.effect[$debuff_effect_iterator].abilities.dummy[0].description "Member of the Royal Rodent Family, the role of the Prince is to strategically plan the future of the Ratdom. Having the Rat Prince in your ranks provides:

<span color='#11ff11'>+2 damage</span>, <span color='#11ff11'>+9 hp</span> to all bred rats
kamikaze rats deal <span color='#11ff11'>+12 damage</span>
disease rats gain <span color='#11ff11'>+12% accuracy</span>
ninja rats gain <span color='#11ff11'>+12% defense everywhere</span>
all rats taste better
edible rats <span color='#11ff11'>+12 healing</span>
other rats <span color='#11ff11'>+6 healing</span>
rat ambassador <span color='#11ff11'>+25% hp</span>, <span color='#11ff11'>+1mp</span>, <span color='#11ff11'>+10% res</span>"}

								{VARIABLE debuff_info "$debuff_info
Rat Prince"}
								{VARIABLE_OP debuff_effect_iterator add 1}
								{VARIABLE modify_unit_info[0].trait.effect[$debuff_effect_iterator].apply_to "image_mod"}
								{VARIABLE modify_unit_info[0].trait.effect[$debuff_effect_iterator].add "~SCALE_INTO_SHARP(84,84)~CS(5,5,50)"}
							[/case]

							[case]
								value=5

								{VARIABLE modify_unit_info[0].trait.effect[$debuff_effect_iterator].apply_to "new_ability"}
								{VARIABLE modify_unit_info[0].trait.effect[$debuff_effect_iterator].abilities.dummy[0].id "qquws_rat_king"}
								{VARIABLE modify_unit_info[0].trait.effect[$debuff_effect_iterator].abilities.dummy[0].name "rat king"}
								{VARIABLE modify_unit_info[0].trait.effect[$debuff_effect_iterator].abilities.dummy[0].description "Member of the Royal Rodent Family, the role of the King is to protect the Ratdom and secure it's future. Having the Rat King in your ranks provides:

<span color='#11ff11'>+2 damage</span>, <span color='#11ff11'>+14 hp</span> to all bred rats
kamikaze rats deal <span color='#11ff11'>+16 damage</span>
disease rats gain <span color='#11ff11'>+16% accuracy</span>
ninja rats gain <span color='#11ff11'>+16% defense everywhere</span>
all rats taste better
edible rats <span color='#11ff11'>+16 healing</span>
other rats <span color='#11ff11'>+8 healing</span>
rat ambassador <span color='#11ff11'>+25% hp</span>, <span color='#11ff11'>+1mp</span>, <span color='#11ff11'>+10% res</span>, <span color='#11ff11'>+10% def</span>"}

								{VARIABLE debuff_info "$debuff_info
Rat King"}
								{VARIABLE_OP debuff_effect_iterator add 1}
								{VARIABLE modify_unit_info[0].trait.effect[$debuff_effect_iterator].apply_to "image_mod"}
								{VARIABLE modify_unit_info[0].trait.effect[$debuff_effect_iterator].add "~SCALE_INTO_SHARP(90,90)~CS(25,0,60)"}
							[/case]

							[case]
								value=6

								{VARIABLE modify_unit_info[0].trait.effect[$debuff_effect_iterator].apply_to "new_ability"}
								{VARIABLE modify_unit_info[0].trait.effect[$debuff_effect_iterator].abilities.dummy[0].id "qquws_rat_pope"}
								{VARIABLE modify_unit_info[0].trait.effect[$debuff_effect_iterator].abilities.dummy[0].name "rat pope"}
								{VARIABLE modify_unit_info[0].trait.effect[$debuff_effect_iterator].abilities.dummy[0].description "Member of the Royal Rodent Family, the role of the Pope is to control the society and strenghten the position of the Royal Family. Having the Rat Pope in your ranks provides:

<span color='#11ff11'>+3 damage</span>, <span color='#11ff11'>+17 hp</span> to all bred rats
kamikaze rats deal <span color='#11ff11'>+22 damage</span>
disease rats gain <span color='#11ff11'>+20% accuracy</span>
ninja rats gain <span color='#11ff11'>+20% defense everywhere</span>
all rats taste better
edible rats <span color='#11ff11'>+22 healing</span>
other rats <span color='#11ff11'>+10 healing</span>
rat ambassador <span color='#11ff11'>+25% hp</span>, <span color='#11ff11'>+1mp</span>, <span color='#11ff11'>+10% res</span>, <span color='#11ff11'>+10% def</span>, <span color='#11ff11'>+25% dmg</span>"}

								{VARIABLE debuff_info "$debuff_info
Rat Pope"}
								{VARIABLE_OP debuff_effect_iterator add 1}
								{VARIABLE modify_unit_info[0].trait.effect[$debuff_effect_iterator].apply_to "image_mod"}
								{VARIABLE modify_unit_info[0].trait.effect[$debuff_effect_iterator].add "~SCALE_INTO_SHARP(90,90)~CS(35,-35,35)"}
							[/case]

							[case]
								value=7

								{VARIABLE modify_unit_info[0].trait.effect[$debuff_effect_iterator].apply_to "new_ability"}
								{VARIABLE modify_unit_info[0].trait.effect[$debuff_effect_iterator].abilities.dummy[0].id "qquws_rat_avatar"}
								{VARIABLE modify_unit_info[0].trait.effect[$debuff_effect_iterator].abilities.dummy[0].name "rat avatar"}
								{VARIABLE modify_unit_info[0].trait.effect[$debuff_effect_iterator].abilities.dummy[0].description "Mythological Rodent of the Celestial Order, the role of the Avatar is to lead the Ratdom to the mythical battle of Ratnarog! Having the Rat Avatar in your ranks provides:

<span color='#11ff11'>+4 damage</span>, <span color='#11ff11'>+19 hp</span> to all bred rats
kamikaze rats deal <span color='#11ff11'>+28 damage</span>
disease rats gain <span color='#11ff11'>+25% accuracy</span>
ninja rats gain <span color='#11ff11'>+25% defense everywhere</span>
all rats taste better
edible rats <span color='#11ff11'>+28 healing</span>
other rats <span color='#11ff11'>+12 healing</span>
rat ambassador <span color='#11ff11'>+25% hp</span>, <span color='#11ff11'>+1mp</span>, <span color='#11ff11'>+10% res</span>, <span color='#11ff11'>+10% def</span>, <span color='#11ff11'>+25% dmg</span>, <span color='#11ff11'>+1 strike</span>"}

								{VARIABLE debuff_info "$debuff_info
Rat Avatar"}
								{VARIABLE_OP debuff_effect_iterator add 1}
								{VARIABLE modify_unit_info[0].trait.effect[$debuff_effect_iterator].apply_to "image_mod"}
								{VARIABLE modify_unit_info[0].trait.effect[$debuff_effect_iterator].add "~SCALE_INTO_SHARP(96,96)~CS(0,50,50)"}
							[/case]

							[case]
								value=8

								{VARIABLE modify_unit_info[0].trait.effect[$debuff_effect_iterator].apply_to "new_ability"}
								{VARIABLE modify_unit_info[0].trait.effect[$debuff_effect_iterator].abilities.dummy[0].id "qquws_rat_god"}
								{VARIABLE modify_unit_info[0].trait.effect[$debuff_effect_iterator].abilities.dummy[0].name "rat god"}
								{VARIABLE modify_unit_info[0].trait.effect[$debuff_effect_iterator].abilities.dummy[0].description "The Ultimate Rodent Aspect of the Absolute, the role of the God is to maintain the balance of the forces subtle and gross of the world. Having the Rat God in your ranks provides:

<span color='#11ff11'>+5 damage</span>, <span color='#11ff11'>+24 hp</span> to all bred rats
kamikaze rats deal <span color='#11ff11'>+36 damage</span>
disease rats gain <span color='#11ff11'>+30% accuracy</span>
ninja rats gain <span color='#11ff11'>+30% defense everywhere</span>
all rats taste better
edible rats <span color='#11ff11'>+36 healing</span>
other rats <span color='#11ff11'>+16 healing</span>
rat ambassador <span color='#11ff11'>+25% hp</span>, <span color='#11ff11'>+1mp</span>, <span color='#11ff11'>+10% res</span>, <span color='#11ff11'>+10% def</span>, <span color='#11ff11'>+25% dmg</span>, <span color='#11ff11'>+1 strike</span>, <span color='#11ff11'>blessing of the rat god</span>"}

								{VARIABLE debuff_info "$debuff_info
Rat God"}
							[/case]
						[/switch]

						{VARIABLE_OP debuff_effect_iterator add 1}
					[/case]
				[/switch]
			[/do]
		[/foreach]

		{VARIABLE modify_unit_info[0].trait.description "$modify_unit_info[0].trait.description
$debuff_info"}

		[insert_tag]
			name=modify_unit
			variable=modify_unit_info
		[/insert_tag]

		{VARIABLE_OP rodent_proliferation_children add 1}
		[if]
			[variable]
				name=rodent_proliferation_children
				less_than=$rodent_proliferation_max_children
			[/variable]
			[then]
				[modify_unit]
					[filter]
						id=$rodent_proliferation_parent
					[/filter]

					[variables]
						rat_proliferation_children=$rodent_proliferation_children
					[/variables]

					[status]
						proliferation_is_active=yes
					[/status]

					[object]
						silent=yes

						[effect]
						    apply_to=attack
						    remove_specials=qquws_rodent_proliferation
						    [set_specials]
						    	mode=append
							    [plague]
							        id=qquws_rodent_proliferation
							        name="rodent proliferation ($rodent_proliferation_children/$rodent_proliferation_max_children)"
							        description="When a living unit is killed with this attack, that unit is replaced with a new rodent that takes the strong genes of the killer. This rat can have a maximum of $rodent_proliferation_max_children child(ren)."
							        type="Giant Rat"
							        [filter_self]
							        	status=proliferation_is_active
							        [/filter_self]
							    [/plague]
						     [/set_specials]
						[/effect]
					[/object]
				[/modify_unit]
			[/then]
			[else]
				[modify_unit]
					[filter]
						id=$rodent_proliferation_parent
					[/filter]

					[variables]
						rat_proliferation_children=$rodent_proliferation_children
					[/variables]

					[status]
						proliferation_is_active=no
					[/status]

					[object]
						silent=yes

						[effect]
						    apply_to=attack
						    remove_specials=qquws_rodent_proliferation
						    [set_specials]
						    	mode=append
							    [dummy]
							        id=qquws_rodent_inactive_proliferation
							        name="<span color='#bfaf19'>rodent proliferation ($rodent_proliferation_children/$rodent_proliferation_max_children)</span>"
							        description="This rat has reached the maximum of $rodent_proliferation_max_children child(ren). Killing more enemies will not result in more rats."
							    [/dummy]
						     [/set_specials]
						[/effect]
					[/object]
				[/modify_unit]
			[/else]
		[/if]
		
		{VARIABLE rodent_proliferation_enabled no}
		{VARIABLE rodent_proliferation_parent_buffs ""}
		{VARIABLE rodent_proliferation_parent ""}
	[/event]

	[event]
		name=die
		first_time_only=no
		
		[filter_second_attack]
			special_id=qquws_rodent_proliferation
		[/filter_second_attack]

		[filter]
			[not]
				status=unplagueable
			[/not]
		[/filter]
		
		{VARIABLE rodent_proliferation_enabled yes}
		{VARIABLE rodent_proliferation_max_children $second_unit.variables.rat_proliferation_max_children}
		{VARIABLE rodent_proliferation_children $second_unit.variables.rat_proliferation_children}
		{VARIABLE rodent_proliferation_parent_buffs $second_unit.variables.rat_proliferation_bonus}
		{VARIABLE rodent_proliferation_parent $second_unit.id}
		{VARIABLE rodent_proliferation_allow_sterile yes}
		{VARIABLE rodent_proliferation_is_god no}

		[if]
			[have_unit]
				id=$second_unit.id
				ability=qquws_rat_avatar
			[/have_unit]
			[then]
				{VARIABLE rodent_proliferation_allow_sterile no}
			[/then]
			[else]
				[if]
					[have_unit]
						id=$second_unit.id
						ability=qquws_rat_god
					[/have_unit]
					[then]
						{VARIABLE rodent_proliferation_is_god yes}
					[/then]
				[/if]
			[/else]
		[/if]
	[/event]

	[event]
		name=turn refresh
		first_time_only=no

		[filter_side]
			[has_unit]
				side=$side_number
				ability=qquws_rat_ambassador
			[/has_unit]
		[/filter_side]

		[if]
			[have_unit]
				ability=qquws_rat_god
				side=$side_number
			[/have_unit]
			[then]
				{VARIABLE new_rat_bonus_level 8}
			[/then]
			[else]
				[if]
					[have_unit]
						ability=qquws_rat_avatar
						side=$side_number
					[/have_unit]
					[then]
						{VARIABLE new_rat_bonus_level 7}
					[/then]
					[else]
						[if]
							[have_unit]
								ability=qquws_rat_pope
								side=$side_number
							[/have_unit]
							[then]
								{VARIABLE new_rat_bonus_level 6}
							[/then]
							[else]
								[if]
									[have_unit]
										ability=qquws_rat_king
										side=$side_number
									[/have_unit]
									[then]
										{VARIABLE new_rat_bonus_level 5}
									[/then]
									[else]
										[if]
											[have_unit]
												ability=qquws_rat_prince
												side=$side_number
											[/have_unit]
											[then]
												{VARIABLE new_rat_bonus_level 4}
											[/then]
											[else]
												[if]
													[have_unit]
														ability=qquws_rat_duke
														side=$side_number
													[/have_unit]
													[then]
														{VARIABLE new_rat_bonus_level 3}
													[/then]
													[else]
														[if]
															[have_unit]
																ability=qquws_rat_general
																side=$side_number
															[/have_unit]
															[then]
																{VARIABLE new_rat_bonus_level 2}
															[/then]
															[else]
																[if]
																	[have_unit]
																		ability=qquws_rat_sergeant
																		side=$side_number
																	[/have_unit]
																	[then]
																		{VARIABLE new_rat_bonus_level 1}
																	[/then]
																	[else]
																		{VARIABLE new_rat_bonus_level 0}
																	[/else]
																[/if]
															[/else]
														[/if]
													[/else]
												[/if]
											[/else]
										[/if]
									[/else]
								[/if]
							[/else]
						[/if]
					[/else]
				[/if]
			[/else]
		[/if]

		[store_unit]
            [filter]
            	side=$side_number
                ability=qquws_rat_ambassador
            [/filter]
            variable=ambassador
        [/store_unit]

        [if]
        	[variable]
        		name=new_rat_bonus_level
        		not_equals=$ambassador.variables.rat_representation_level
        	[/variable]
        	[then]
				[remove_trait]
					id=$ambassador.id
					trait_id=qquws_rat_ambassador_buff
				[/remove_trait]

				[switch]
					variable=new_rat_bonus_level

					[case]
						value=1

						[modify_unit]
							[filter]
								id=$ambassador.id
							[/filter]

							[variables]
								rat_representation_level=$new_rat_bonus_level
							[/variables]

							[trait]
								id=qquws_rat_ambassador_buff
								name="ambassador"
								description="You are at the start of your career and you don't represent much. However, having in your ranks Rat Sergeant helps your credibility a bit and thus provides:"
								[effect]
									apply_to=hitpoints
								    increase="25%"
								    increase_total="25%"
								[/effect]
							[/trait]
						[/modify_unit]
					[/case]

					[case]
						value=2

						[modify_unit]
							[filter]
								id=$ambassador.id
							[/filter]

							[variables]
								rat_representation_level=$new_rat_bonus_level
							[/variables]

							[trait]
								id=qquws_rat_ambassador_buff
								name="ambassador"
								description="You slowly improve your position and gain contacts in position of power. Having the Rat General on your side provides:"
								[effect]
									apply_to=hitpoints
								    increase="25%"
								    increase_total="25%"
								[/effect]
								[effect]
								    apply_to=movement
								    increase=1
								[/effect]
							[/trait]
						[/modify_unit]
					[/case]

					[case]
						value=3

						[modify_unit]
							[filter]
								id=$ambassador.id
							[/filter]

							[variables]
								rat_representation_level=$new_rat_bonus_level
							[/variables]

							[trait]
								id=qquws_rat_ambassador_buff
								name="ambassador"
								description="Climbing the echelons of the rodent society you now represent the Rat Duke. This honour gives you:
<span color='#00ff00'>+10%</span> magical resistance"
								[effect]
									apply_to=hitpoints
								    increase="25%"
								    increase_total="25%"
								[/effect]
								[effect]
								    apply_to=movement
								    increase=1
								[/effect]
								[effect]
								    apply_to=resistance
								    replace=no
								    [resistance]
										arcane=-10
										cold=-10
										fire=-10
								    [/resistance]
								[/effect]
							[/trait]
						[/modify_unit]
					[/case]

					[case]
						value=4

						[modify_unit]
							[filter]
								id=$ambassador.id
							[/filter]

							[variables]
								rat_representation_level=$new_rat_bonus_level
							[/variables]

							[trait]
								id=qquws_rat_ambassador_buff
								name="ambassador"
								description="You have been recognised by the Royal Rodent Family for your service and now you represent the Rat Prince. This is a prestigious position and thus provides:
<span color='#00ff00'>+10%</span> all resistance"
								[effect]
									apply_to=hitpoints
								    increase="25%"
								    increase_total="25%"
								[/effect]
								[effect]
								    apply_to=movement
								    increase=1
								[/effect]
								[effect]
								    apply_to=resistance
								    replace=no
								    [resistance]
										arcane=-10
										cold=-10
										fire=-10
										secret=-10
										blade=-10
										impact=-10
										pierce=-10
								    [/resistance]
								[/effect]
							[/trait]
						[/modify_unit]
					[/case]

					[case]
						value=5

						[modify_unit]
							[filter]
								id=$ambassador.id
							[/filter]

							[variables]
								rat_representation_level=$new_rat_bonus_level
							[/variables]

							[trait]
								id=qquws_rat_ambassador_buff
								name="ambassador"
								description="As the official diplomat of the Royal Crown you gain power and recognition and thus this title gives you:
<span color='#00ff00'>+10%</span> all resistance
<span color='#00ff00'>+10%</span> defense"
								[effect]
									apply_to=hitpoints
								    increase="25%"
								    increase_total="25%"
								[/effect]
								[effect]
								    apply_to=movement
								    increase=1
								[/effect]
								[effect]
								    apply_to=resistance
								    replace=no
								    [resistance]
										arcane=-10
										cold=-10
										fire=-10
										secret=-10
										blade=-10
										impact=-10
										pierce=-10
								    [/resistance]
								[/effect]
								[effect]
									apply_to=defense
									replace=no
									[defense]
										flat=-10
										frozen=-10
										forest=-10
										hills=-10
										mountains=-10
										village=-10
										swamp_water=-10
										shallow_water=-10
										deep_water=-10
										reef=-10
										castle=-10
										cave=-10
										sand=-10
										fungus=-10
									[/defense]
								[/effect]
							[/trait]
						[/modify_unit]
					[/case]

					[case]
						value=6

						[modify_unit]
							[filter]
								id=$ambassador.id
							[/filter]

							[variables]
								rat_representation_level=$new_rat_bonus_level
							[/variables]

							[trait]
								id=qquws_rat_ambassador_buff
								name="ambassador"
								description="As the right hand of the Rat Pope you poses a virtually unlimited power in the Rodent Society. This position thus gives you:
<span color='#00ff00'>+10%</span> all resistance
<span color='#00ff00'>+10%</span> defense"
								[effect]
									apply_to=hitpoints
								    increase="25%"
								    increase_total="25%"
								[/effect]
								[effect]
								    apply_to=movement
								    increase=1
								[/effect]
								[effect]
								    apply_to=resistance
								    replace=no
								    [resistance]
										arcane=-10
										cold=-10
										fire=-10
										secret=-10
										blade=-10
										impact=-10
										pierce=-10
								    [/resistance]
								[/effect]
								[effect]
									apply_to=defense
									replace=no
									[defense]
										flat=-10
										frozen=-10
										forest=-10
										hills=-10
										mountains=-10
										village=-10
										swamp_water=-10
										shallow_water=-10
										deep_water=-10
										reef=-10
										castle=-10
										cave=-10
										sand=-10
										fungus=-10
									[/defense]
								[/effect]
								[effect]
								    apply_to=attack
								    increase_damage="25%"
								[/effect]
							[/trait]
						[/modify_unit]
					[/case]

					[case]
						value=7

						[modify_unit]
							[filter]
								id=$ambassador.id
							[/filter]

							[variables]
								rat_representation_level=$new_rat_bonus_level
							[/variables]

							[trait]
								id=qquws_rat_ambassador_buff
								name="ambassador"
								description="Your voice is the voice of the Rat Avatar. Your power transcends the Ratdom and all it's earthly matters. Thus you get:
<span color='#00ff00'>+10%</span> all resistance
<span color='#00ff00'>+10%</span> defense"
								[effect]
									apply_to=hitpoints
								    increase="25%"
								    increase_total="25%"
								[/effect]
								[effect]
								    apply_to=movement
								    increase=1
								[/effect]
								[effect]
								    apply_to=resistance
								    replace=no
								    [resistance]
										arcane=-10
										cold=-10
										fire=-10
										secret=-10
										blade=-10
										impact=-10
										pierce=-10
								    [/resistance]
								[/effect]
								[effect]
									apply_to=defense
									replace=no
									[defense]
										flat=-10
										frozen=-10
										forest=-10
										hills=-10
										mountains=-10
										village=-10
										swamp_water=-10
										shallow_water=-10
										deep_water=-10
										reef=-10
										castle=-10
										cave=-10
										sand=-10
										fungus=-10
									[/defense]
								[/effect]
								[effect]
								    apply_to=attack
								    increase_damage="25%"
								    increase_attacks=1
								[/effect]
							[/trait]
						[/modify_unit]
					[/case]

					[case]
						value=8

						[modify_unit]
							[filter]
								id=$ambassador.id
							[/filter]

							[variables]
								rat_representation_level=$new_rat_bonus_level
							[/variables]

							[trait]
								id=qquws_rat_ambassador_buff
								name="ambassador"
								description="By representing the God you become like God. You have become the object of worship of countless ranks of rats. Your position in the Ratdom is undisputed and thus provides:
<span color='#00ff00'>blessing of the rat god</span>
<span color='#00ff00'>+10%</span> all resistance
<span color='#00ff00'>+10%</span> defense"
								[effect]
									apply_to=hitpoints
								    increase="25%"
								    increase_total="25%"
								[/effect]
								[effect]
								    apply_to=movement
								    increase=1
								[/effect]
								[effect]
								    apply_to=resistance
								    replace=no
								    [resistance]
										arcane=-10
										cold=-10
										fire=-10
										secret=-10
										blade=-10
										impact=-10
										pierce=-10
								    [/resistance]
								[/effect]
								[effect]
									apply_to=defense
									replace=no
									[defense]
										flat=-10
										frozen=-10
										forest=-10
										hills=-10
										mountains=-10
										village=-10
										swamp_water=-10
										shallow_water=-10
										deep_water=-10
										reef=-10
										castle=-10
										cave=-10
										sand=-10
										fungus=-10
									[/defense]
								[/effect]
								[effect]
								    apply_to=attack
								    increase_damage="25%"
								    increase_attacks=1
								    [set_specials]
										mode=append
										remove_specials=magical,AE_mag_magical_defensive,AE_mag_magical_offensive,AE_mag_precision,AE_mag_enchanted,AE_mag_precision_offensive,AE_fut_ubiquitous,eoma_precision,eoma_enchanted,eoma_magical_offensive,eoma_magical_defensive,eoma_precision_offensive,marksman,AE_mag_alwayshits,eoma_alwayshits,AE_mag_marksman_greater,AE_mag_revenge2,AE_mag_skilled
										[chance_to_hit]
									        id=qquws_blessing_of_the_rat_god
									        name="blessing of the rat god"
									        description="This unit has always 100% chance to hit."
									        value=100
        									cumulative=no
									    [/chance_to_hit]
									[/set_specials]
								[/effect]
							[/trait]
						[/modify_unit]
					[/case]
				[/switch]
        	[/then]
        [/if]
	[/event]
#enddef

#define REGISTER_RAT_HEAL_MENU_ITEM
	[set_menu_item]
        id=qquws_cook_a_rat
        description="Cook a Rat"
        image=items/ball-green.png~CROP(21,23,27,24)~SCALE(20,20)

        [filter_location]
            [filter]
                side=$side_number
            [/filter]
            [filter_adjacent_location]
                [filter]
                    ability=qquws_edible_rat
                    [filter_side]
                    	[allied_with]
                    		side=$side_number
                    	[/allied_with]
                    [/filter_side]
                [/filter]
            [/filter_adjacent_location]
        [/filter_location]

        [command]
			[store_unit]
				[filter]
					ability=qquws_edible_rat
					[filter_adjacent]
						x,y=$x1,$y1
					[/filter_adjacent]
				[/filter]
				variable=edible_rat
			[/store_unit]

            [if]
            	[variable]
            		name=edible_rat.length
            		equals=1
            	[/variable]
            	[then]
		            [heal_unit]
		                [filter]
		                    x,y=$x1,$y1
		                [/filter]
		                amount=$edible_rat[0].variables.rat_healing_amount
		                animate=yes
		                restore_statuses=$edible_rat[0].variables.rat_healing_statuses
		            [/heal_unit]

		            [kill]
		                id=$edible_rat[0].id
		                animate=yes
		                fire_event=yes
		            [/kill]

		            [redraw]
		            [/redraw]

		            {CLEAR_VARIABLE edible_rat}
		        [/then]
		        [else]
		        	[message]
		        		speaker=narrator
		        		message="Too many rats are surrounding your unit and it's hard to decide which one is the yummiest. In order to use this ability your unit must be adjacent to only one edible rat."
		        		side_for=$side_number
		        		image="portraits/monsters/giant-rat.webp"
		        		caption="Lord George, Envoy of the Royal Rodent Family"
		        	[/message]
		        [/else]
		    [/if]
        [/command]
    [/set_menu_item]
#enddef

#define REGISTER_BLACK_PLAGUE
    [event]
		name=attacker hits
		first_time_only=no
		
		[filter_attack]
			special_id=qquws_black_plague
		[/filter_attack]

		[filter_second]
			[not]
				trait=qquws_black_plague_infected_trait
			[/not]

			[not]
				status=not_living
			[/not]
		[/filter_second]
		
		[if]
			[variable]
				name=second_unit.hitpoints
				greater_than=0
			[/variable]
			[then]
				[modify_unit]
					[filter]
						id=$second_unit.id
					[/filter]

					[status]
						poisoned=yes
						unhealable=yes
					[/status]
					
					[variables]
						black_plague_debuff_list=unhealable,poison:4,damage:15
					[/variables]

					[trait]
						id=qquws_black_plague_infected_trait
						name="<span color='#ff0000'>black plague</span>"
						description="This unit is infected with black plague. It has 25% chance of recovery at the beginning of each turn.

unhealable
poison -4"

						[effect]
							apply_to=attack
						    increase_damage=-15%
						[/effect]
					[/trait]
				[/modify_unit]

				[floating_text]
					x,y=$second_unit.x,$second_unit.y
					text="<span color='#ff0000'>Black Plague!</span>"
				[/floating_text]

				[harm_unit]
					[filter]
						id=$second_unit.id
					[/filter]
					
					amount=4
					alignment=neutral
					kill=yes
					animate=yes
					experience=no
				[/harm_unit]
			[/then]
		[/if]
	[/event]
	
	[event]
		name=defender hits
		first_time_only=no
		
		[filter_second_attack]
			special_id=qquws_black_plague
		[/filter_second_attack]

		[filter]
			[not]
				trait=qquws_black_plague_infected_trait
			[/not]

			[not]
				status=not_living
			[/not]
		[/filter]
		
		[if]
			[variable]
				name=unit.hitpoints
				greater_than=0
			[/variable]
			[then]
				[modify_unit]
					[filter]
						id=$unit.id
					[/filter]

					[status]
						poisoned=yes
						unhealable=yes
					[/status]
					
					[variables]
						black_plague_debuff_list=unhealable,poison:4,damage:15
					[/variables]

					[trait]
						id=qquws_black_plague_infected_trait
						name="<span color='#ff0000'>black plague</span>"
						description="This unit is infected with black plague. It has 25% chance of recovery at the beginning of each turn.

unhealable
poison -4"

						[effect]
							apply_to=attack
						    increase_damage=-15%
						[/effect]
					[/trait]
				[/modify_unit]

				[floating_text]
					x,y=$unit.x,$unit.y
					text="<span color='#ff0000'>Black Plague!</span>"
				[/floating_text]

				[harm_unit]
					[filter]
						id=$unit.id
					[/filter]
					
					amount=4
					alignment=neutral
					kill=yes
					animate=yes
					experience=no
				[/harm_unit]
			[/then]
		[/if]
	[/event]

	[event]
		name=turn refresh
		first_time_only=no

		[filter_condition]
			[have_unit]
				side=$side_number
				trait=qquws_black_plague_infected_trait
			[/have_unit]
		[/filter_condition]
		
		[store_unit]
			[filter]
				side=$side_number
				trait=qquws_black_plague_infected_trait
			[/filter]
			
			variable=black_plagued_units
			mode=always_clear
		[/store_unit]

		[foreach]
			array=black_plagued_units
			variable=bp_unit
			readonly=yes
			
			[do]
				{VARIABLE_OP bp_chance rand 0..99}
				{VARIABLE bp_compare 25}
				[if]
					[have_unit]
						id=$bp_unit.id
						trait=immune_to_specials
					[/have_unit]
					[then]
						{VARIABLE bp_compare 60}
					[/then]
				[/if]

				[if]
					[variable]
						name=bp_chance
						less_than=$bp_compare
					[/variable]
					[then]
						[remove_trait]
							id=$bp_unit.id
							trait_id=qquws_black_plague_infected_trait
						[/remove_trait]

						[floating_text]
							x,y=$bp_unit.x,$bp_unit.y
							text="<span color='#00ff00'>Healed!</span>"
						[/floating_text]

						[heal_unit]
			                [filter]
			                    id=$bp_unit.id
			                [/filter]

			                amount=2
			                animate=yes
			                restore_statuses=yes
			            [/heal_unit]
					[/then]
					[else]
						{VARIABLE bp_all_available_debuffs "unhealable,poison:4m12,defense,damage:15m45"}
						[qquws_calculate_buff_list]
							list=$bp_unit.variables.black_plague_debuff_list
							all_available=$bp_all_available_debuffs
							output_list_var=bp_debuffs_list
						[/qquws_calculate_buff_list]

						[set_variables]
							name=modify_unit_info
							mode=replace
							[value]
								[filter]
									id=$bp_unit.id
								[/filter]

								[variables]
									black_plague_debuff_list=$bp_debuffs_list
								[/variables]

								[trait]
									id=qquws_black_plague_infected_trait
									name="<span color='#ff0000'>black plague</span>"
									description="This unit is infected with black plague. It has 25% chance of recovery at the beginning of each turn."
								[/trait]
							[/value]
						[/set_variables]

						[set_variables]
							name=black_plague_debuff_list
							mode=replace
							[split]
								list=$bp_debuffs_list
								key=el
								separator=","
							[/split]
						[/set_variables]

						{VARIABLE debuff_info ""}
						{VARIABLE debuff_effect_iterator 0}
						{VARIABLE bp_poison_value 0}
						[foreach]
							array=black_plague_debuff_list
							variable=black_plague_debuff
							readonly=yes

							[do]
								{VARIABLE debuff_key $black_plague_debuff.el}
								{VARIABLE debuff_value 0}
								[if]
									[variable]
										name=debuff_key
										contains=":"
									[/variable]
									[then]
										{VARIABLE debuff_value "$( substring( '$debuff_key', find_string('$debuff_key', ':') + 1) )"}
										{VARIABLE debuff_key "$( substring( '$debuff_key', 0, find_string('$debuff_key', ':')) )"}
									[/then]
								[/if]

								[switch]
									variable=debuff_key

									[case]
										value=unhealable

										{VARIABLE modify_unit_info[0].status.unhealable yes}
										{VARIABLE debuff_info "$debuff_info
unhealable"}
									[/case]

									[case]
										value=poison

										{VARIABLE modify_unit_info[0].status.poisoned yes}
										{VARIABLE bp_poison_value $debuff_value}
										{VARIABLE debuff_info "$debuff_info
poisoned $debuff_value"}
									[/case]

									[case]
										value=defense

										{VARIABLE modify_unit_info[0].trait.effect[$debuff_effect_iterator].apply_to "defense"}
										{VARIABLE modify_unit_info[0].trait.effect[$debuff_effect_iterator].replace no}
										{VARIABLE modify_unit_info[0].trait.effect[$debuff_effect_iterator].defense.flat 10}
										{VARIABLE modify_unit_info[0].trait.effect[$debuff_effect_iterator].defense.frozen 10}
										{VARIABLE modify_unit_info[0].trait.effect[$debuff_effect_iterator].defense.forest 10}
										{VARIABLE modify_unit_info[0].trait.effect[$debuff_effect_iterator].defense.hills 10}
										{VARIABLE modify_unit_info[0].trait.effect[$debuff_effect_iterator].defense.mountains 10}
										{VARIABLE modify_unit_info[0].trait.effect[$debuff_effect_iterator].defense.village 10}
										{VARIABLE modify_unit_info[0].trait.effect[$debuff_effect_iterator].defense.swamp_water 10}
										{VARIABLE modify_unit_info[0].trait.effect[$debuff_effect_iterator].defense.shallow_water 10}
										{VARIABLE modify_unit_info[0].trait.effect[$debuff_effect_iterator].defense.deep_water 10}
										{VARIABLE modify_unit_info[0].trait.effect[$debuff_effect_iterator].defense.reef 10}
										{VARIABLE modify_unit_info[0].trait.effect[$debuff_effect_iterator].defense.castle 10}
										{VARIABLE modify_unit_info[0].trait.effect[$debuff_effect_iterator].defense.cave 10}
										{VARIABLE modify_unit_info[0].trait.effect[$debuff_effect_iterator].defense.sand 10}
										{VARIABLE modify_unit_info[0].trait.effect[$debuff_effect_iterator].defense.fungus 10}
										{VARIABLE_OP debuff_effect_iterator add 1}
										{VARIABLE debuff_info "$debuff_info
defense everywhere -10%"}
									[/case]

									[case]
										value=damage

										{VARIABLE modify_unit_info[0].trait.effect[$debuff_effect_iterator].apply_to "attack"}
										{VARIABLE modify_unit_info[0].trait.effect[$debuff_effect_iterator].increase_damage "-$debuff_value|%"}
										{VARIABLE_OP debuff_effect_iterator add 1}
									[/case]
								[/switch]
							[/do]
						[/foreach]

						{VARIABLE modify_unit_info[0].trait.description "$modify_unit_info[0].trait.description
$debuff_info"}

						[remove_trait]
							id=$bp_unit.id
							trait_id=qquws_black_plague_infected_trait
						[/remove_trait]

						[insert_tag]
							name=modify_unit
							variable=modify_unit_info
						[/insert_tag]

						[harm_unit]
							[filter]
								id=$bp_unit.id
							[/filter]
							
							amount=$bp_poison_value
							alignment=neutral
							kill=yes
							animate=yes
							experience=no
						[/harm_unit]
					[/else]
				[/if]
			[/do]
		[/foreach]
	[/event]
#enddef

#define REGISTER_ICEWIND_AURA
	[event]
		name=turn refresh
		first_time_only=no

		[if]
			[have_unit]
				side=$side_number
				ability=qquws_icewind_aura
			[/have_unit]
			[then]
				[store_unit]
					[filter]
						side=$side_number
						ability=qquws_icewind_aura
					[/filter]
					
					variable=icewind_aura_units
					mode=always_clear
				[/store_unit]
				
				[foreach]
					array=icewind_aura_units
					variable=icewind_aura_unit
					readonly=yes
					
					[do]
						{VARIABLE unit_levels "0,1,2,3,4,5,6,7"}
						[switch]
							variable=icewind_aura_unit.level
							
							[case]
								value=0
								{VARIABLE unit_levels "0"}
							[/case]
							[case]
								value=1
								{VARIABLE unit_levels "0,1"}
							[/case]
							[case]
								value=2
								{VARIABLE unit_levels "0,1,2"}
							[/case]
							[case]
								value=3
								{VARIABLE unit_levels "0,1,2,3"}
							[/case]
							[case]
								value=4
								{VARIABLE unit_levels "0,1,2,3,4"}
							[/case]
							[case]
								value=5
								{VARIABLE unit_levels "0,1,2,3,4,5"}
							[/case]
							[case]
								value=6
								{VARIABLE unit_levels "0,1,2,3,4,5,6"}
							[/case]
						[/switch]

						{VARIABLE icewind_info " It's movepoints are reduced by 30%"}
						[if]
							[variable]
								name=icewind_aura_unit.variables.icewind_defense
								greater_than=0
							[/variable]
							[then]
								{VARIABLE icewind_info "$icewind_info|, defenses by $icewind_aura_unit.variables.icewind_defense"}
							[/then]
						[/if]

						{VARIABLE received_dmg_multiply 1}
						[if]
							[variable]
								name=icewind_aura_unit.variables.icewind_received_dmg
								greater_than=0
							[/variable]
							[then]
								{VARIABLE received_dmg_multiply "$( 1.00 + (0.01 * $icewind_aura_unit.variables.icewind_received_dmg) )"}
								{VARIABLE icewind_info "$icewind_info and receives $icewind_aura_unit.variables.icewind_received_dmg|% more damage in defense from all enemies"}
							[/then]
						[/if]
						
						[modify_unit]
							[filter]
								[filter_location]
									x,y=$icewind_aura_unit.x,$icewind_aura_unit.y
									radius=$icewind_aura_unit.variables.icewind_radius
									[filter_radius]
										terrain="!,_off^_usr,X*,M*^X*"
									[/filter_radius]
									[filter_vision]
										visible=yes
										respect_fog=yes
									[/filter_vision]
								[/filter_location]
								
								[filter_side]
									[enemy_of]
										side=$side_number
									[/enemy_of]
								[/filter_side]
								
								level=$unit_levels
								x=2-99
								formula="if(max_moves > 3, 1, 0)"
							[/filter]
								
							[object]
								silent=yes
								duration=turn end
								
								[effect]
								    apply_to=movement
								    increase=-30%
								[/effect]
								[effect]
								    apply_to=defense
								    replace=no
								    [defense]
										flat=$icewind_aura_unit.variables.icewind_defense
										frozen=$icewind_aura_unit.variables.icewind_defense
										forest=$icewind_aura_unit.variables.icewind_defense
										hills=$icewind_aura_unit.variables.icewind_defense
										village=$icewind_aura_unit.variables.icewind_defense
										swamp_water=$icewind_aura_unit.variables.icewind_defense
										shallow_water=$icewind_aura_unit.variables.icewind_defense
										castle=$icewind_aura_unit.variables.icewind_defense
										cave=$icewind_aura_unit.variables.icewind_defense
										sand=$icewind_aura_unit.variables.icewind_defense
										fungus=$icewind_aura_unit.variables.icewind_defense
										mountains=$icewind_aura_unit.variables.icewind_defense
										castle=$icewind_aura_unit.variables.icewind_defense
										sand=$icewind_aura_unit.variables.icewind_defense
								    [/defense]
								[/effect]
								[effect]
									apply_to=new_ability
									[abilities]
										[damage]
											id=qquws_icewind_debuff
											name="<span color='#4ad4d4'>icewind</span>"
											apply_to=opponent
											multiply=$received_dmg_multiply
											description="This unit is affected by the chilling icewinds. $icewind_info|."
											affect_self=yes
											affect_allies=no
											affect_enemies=no
											active_on=defense
										[/damage]
									[/abilities]
								[/effect]
								[effect]
								    apply_to=overlay
								    add=halo/uws/icewind.png
								[/effect]
							[/object]
						[/modify_unit]
						
						[if]
							[variable]
								name=icewind_aura_unit.variables.icewind_damage
								greater_than=0
							[/variable]
							[then]
								[harm_unit]
									[filter]
										[filter_location]
											x,y=$icewind_aura_unit.x,$icewind_aura_unit.y
											radius=$icewind_aura_unit.variables.icewind_radius
											[filter_radius]
												terrain="!,_off^_usr,X*,M*^X*"
											[/filter_radius]
											[filter_vision]
												visible=yes
												respect_fog=yes
											[/filter_vision]
										[/filter_location]
										
										[filter_side]
											[enemy_of]
												side=$side_number
											[/enemy_of]
										[/filter_side]
										
										level=$unit_levels
										x=2-99
									[/filter]
									
									amount=$icewind_aura_unit.variables.icewind_damage
									damage_type=cold
									alignment=neutral
									kill=no
									animate=yes
									experience=no
									delay=0
								[/harm_unit]
							[/then]
						[/if]
					[/do]
				[/foreach]
				
				{CLEAR_VARIABLE icewind_aura_units}
			[/then]
		[/if]
	[/event]
#enddef

#define REGISTER_REFLECTS_DAMAGE
	[event]
		name=attack
		first_time_only=no

		[filter_second]
			ability=qquws_reflects_damage
		[/filter_second]

		[modify_unit]
			[filter]
				id=$second_unit.id
			[/filter]

			[object]
				silent=yes
				id=reflects_dmg_object
				take_only_once=no

				[effect]
					apply_to=halo
					halo="halo/uws/reflects_[1~6].png:120"
				[/effect]
				[effect]
					apply_to=image_mod
					add="~CS(90,20,50)"
				[/effect]
			[/object]
		[/modify_unit]
	[/event]

	[event]
		name=attack
		first_time_only=no

		[filter]
			ability=qquws_reflects_damage
		[/filter]

		[modify_unit]
			[filter]
				id=$unit.id
			[/filter]

			[object]
				silent=yes
				id=reflects_dmg_object
				take_only_once=no

				[effect]
					apply_to=halo
					halo="halo/uws/reflects_[1~6].png:120"
				[/effect]
				[effect]
					apply_to=image_mod
					add="~CS(90,20,50)"
				[/effect]
			[/object]
		[/modify_unit]
	[/event]

	[event]
		name=attack end
		first_time_only=no

		[filter_second]
			ability=qquws_reflects_damage
		[/filter_second]

		[remove_object]
			id=$second_unit.id
			object_id=reflects_dmg_object
		[/remove_object]
	[/event]

	[event]
		name=attack end
		first_time_only=no

		[filter]
			ability=qquws_reflects_damage
		[/filter]

		[remove_object]
			id=$unit.id
			object_id=reflects_dmg_object
		[/remove_object]
	[/event]

	[event]
		name=attacker hits
		first_time_only=no
		
		[filter_second]
			ability=qquws_reflects_damage
		[/filter_second]
		
		{VARIABLE damage_dealt $damage_inflicted}
		[if]
			[variable]
				name=weapon.range
				equals=melee
			[/variable]
			[then]
				{VARIABLE_OP damage_dealt multiply $second_unit.variables.reflects_melee_factor}
			[/then]
			[else]
				{VARIABLE_OP damage_dealt multiply $second_unit.variables.reflects_ranged_factor}
			[/else]
		[/if]

		{VARIABLE_OP damage_dealt round ceil}
		
		[if]
			[variable]
				name=damage_dealt
				greater_than=0
			[/variable]
			[then]
				[harm_unit]
					[filter]
						id=$unit.id
					[/filter]
					
					amount=$damage_dealt
					damage_type=$weapon.type
					alignment=neutral
					kill=no
					animate=yes
					experience=no
					delay=0
				[/harm_unit]
			[/then]
		[/if]
	[/event]
	
	[event]
		name=defender hits
		first_time_only=no
		
		[filter]
			ability=qquws_reflects_damage
		[/filter]
		
		{VARIABLE damage_dealt $damage_inflicted}
		[if]
			[variable]
				name=weapon.range
				equals=melee
			[/variable]
			[then]
				{VARIABLE_OP damage_dealt multiply $unit.variables.reflects_melee_factor}
			[/then]
			[else]
				{VARIABLE_OP damage_dealt multiply $unit.variables.reflects_ranged_factor}
			[/else]
		[/if]
		
		{VARIABLE_OP damage_dealt round ceil}
		
		[if]
			[variable]
				name=damage_dealt
				greater_than=0
			[/variable]
			[then]
				[harm_unit]
					[filter]
						id=$second_unit.id
					[/filter]
					
					amount=$damage_dealt
					damage_type=$second_weapon.type
					alignment=neutral
					kill=no
					animate=yes
					experience=no
					delay=0
				[/harm_unit]
			[/then]
		[/if]
	[/event]
#enddef

#define REGISTER_SUMMONS
	[event]
		name=turn refresh
		first_time_only=no
		
		[filter_side]
			[has_unit]
				side=$side_number
				ability=qquws_raises_undead
			[/has_unit]
		[/filter_side]
		
		[if]
			[have_unit]
				side=$side_number
				ability=qquws_raises_undead
			[/have_unit]
			[then]
				[store_unit]
					[filter]
						side=$side_number
						ability=qquws_raises_undead
					[/filter]
					
					variable=summoners
					mode=always_clear
				[/store_unit]
				
				[foreach]
					array=summoners
					variable=summoner
					readonly=yes
					
					[do]
						{VARIABLE_OP rand_chance rand 0..99}
						
						[if]
							[variable]
								name=rand_chance
								less_than=$summoner.variables.summons_chance
							[/variable]
							[then]
								{VARIABLE_OP summon_unit_type rand $summoner.variables.summons_list}
								
								[switch]
									variable=summoner.variables.summons_settings

									[case]
										value="tunturi_shaman"
										{VARIABLE_OP random_hp_factor rand 8,8,9,12,15,18}
										{VARIABLE_OP random_dmg_factor rand 7,8,12,13,18,20}
										{VARIABLE_OP random_mp rand 1,1,0,0,0,-1,-1,-2}
										{VARIABLE_OP random_res_factor rand 15,0,0,-10,-20,-30}
									[/case]
									[case]
										value="von_naga"
										{VARIABLE_OP random_hp_factor rand 6,7,8,9,10,10,10,10,10,10,12,13,15,16,18,24,36}
										{VARIABLE_OP random_dmg_factor rand 7,8,10,10,10,10,10,10,10,12,14,16,20,25}
										{VARIABLE random_mp 0}
										{VARIABLE random_res_factor 0}
									[/case]
									[else]
										{VARIABLE_OP random_hp_factor rand 3,4,5,6,6,7,7,7,8,8,9,11,12,13,14,16,17,20,25}
										{VARIABLE_OP random_dmg_factor rand 4,5,6,7,8,8,9,11,12,13,15,17,20}
										{VARIABLE_OP random_mp rand 3,2,1,1,1,0,0,0,0,0,-1,-1,-1,-1,-2}
										{VARIABLE_OP random_res_factor rand 50,30,25,20,15,10,5,0,0,0,0,0,0,-5,-5,-10,-15,-20}
									[/else]
								[/switch]

								{VARIABLE_OP random_hp_factor multiply 10}
								{VARIABLE hp_factor_readable $random_hp_factor}
								{VARIABLE_OP random_hp_factor sub 100}
								
								{VARIABLE_OP random_dmg_factor multiply 10}
								{VARIABLE dmg_factor_readable $random_dmg_factor}
								{VARIABLE_OP random_dmg_factor sub 100}

								{VARIABLE summoned_extra_info ""}

								[if]
									[variable]
										name=random_mp
										not_equals=0
									[/variable]
									[then]
										{VARIABLE sign "$random_mp"}
										{VARIABLE sign_color "#ff0000"}
										[if]
											[variable]
												name=random_mp
												greater_than=0
											[/variable]
											[then]
												{VARIABLE sign "+$random_mp"}
												{VARIABLE sign_color "#00ff00"}
											[/then]
										[/if]

										{VARIABLE summoned_extra_info "
<span color='$sign_color'>$sign moves</span>"}
									[/then]
								[/if]

								[if]
									[variable]
										name=random_res_factor
										not_equals=0
									[/variable]
									[then]
										{VARIABLE sign "-$random_res_factor"}
										{VARIABLE sign_color "#ff0000"}
										[if]
											[variable]
												name=random_res_factor
												less_than=0
											[/variable]
											[then]
												{VARIABLE sign "$( -1 * $random_res_factor )"}
												{VARIABLE sign "+$sign"}
												{VARIABLE sign_color "#00ff00"}
											[/then]
										[/if]

										{VARIABLE summoned_extra_info "$summoned_extra_info
<span color='$sign_color'>$sign|%</span> all resistances"}
									[/then]
								[/if]

								{VARIABLE_OP random_res_factor mulitply -1}
								
								[unit]
									type=$summon_unit_type
									x=$summoner.x
									y=$summoner.y
									side=$side_number
									passable=yes
									upkeep=loyal
									animate=yes
									
									[status]
										is_summoned=yes
									[/status]

									[variables]
										is_zero_xp_unit=yes
									[/variables]
									
									[modifications]
										[object]
											silent=yes

											# outside of trait because 0 is still displayed, as in +0 moves
											[effect]
											    apply_to=movement
											    increase=$random_mp
											[/effect]
										[/object]
									
										[trait]
											id=qquws_summoned
											name="<span color='#96845d'>summoned</span>"
											description="This unit was summoned by the scholar of the underworld.$summoned_extra_info"

											[effect]
											    apply_to=hitpoints
											    increase="$random_hp_factor|%"
											    increase_total="$random_hp_factor|%"
											[/effect]
											[effect]
											    apply_to=attack
											    increase_damage="$random_dmg_factor|%"
											[/effect]
											[effect]
											    apply_to=resistance
											    replace=no
											    [resistance]
													blade=$random_res_factor
													impact=$random_res_factor
													pierce=$random_res_factor
													cold=$random_res_factor
													fire=$random_res_factor
													arcane=$random_res_factor
											    [/resistance]
											[/effect]
										[/trait]

										[trait]
											id=qquws_zero_xp
											name="no xp"
											description="This unit gives no xp and doesn't increase the kill count when killed."
										[/trait]
									[/modifications]
								[/unit]
							[/then]
						[/if]
					[/do]
				[/foreach]
				
				{CLEAR_VARIABLE summoners}
			[/then]
		[/if]
	[/event]
#enddef

#define REGISTER_MAGIC_NEGATION
	{UNIT_BASED_GLOBAL_ALLY_BUFF qquws_protected_from_magic_trait qquws_negates_magic apply_magic_negation_to_all_allies "protected from magic" "This units benefits from magic negation. It's arcane, cold and fire resistances are up by $global_buff_unit.variables.negates_magic_value|%." (
		[effect]
			apply_to=resistance
			replace=no
			[resistance]
				arcane=-$global_buff_unit.variables.negates_magic_value
				fire=-$global_buff_unit.variables.negates_magic_value
				cold=-$global_buff_unit.variables.negates_magic_value
			[/resistance]
		[/effect]
	) (
		[if]
			[variable]
				name=uws_game.is_pvp
				boolean_equals=yes
			[/variable]
			[then]
				[store_unit]
					[filter]
						side=$unit.side
						ability=qquws_negates_magic
					[/filter]
					
					variable=global_buff_unit
					mode=always_clear
				[/store_unit]
			[/then]
			[else]
				[store_unit]
					[filter]
						ability=qquws_negates_magic
						
						[filter_side]
							[allied_with]
								side=$unit.side
							[/allied_with]
						[/filter_side]
					[/filter]
					
					variable=global_buff_unit
					mode=always_clear
				[/store_unit]
			[/else]
		[/if]
	)}
#enddef

#define REGISTER_ARMOR_SCIENCE
	[event]
		name=turn refresh
		first_time_only=no
		
		[filter_side]
			side=$uws_game.filter_apply_global_specials_sides
		[/filter_side]
		
		[if]
			[have_unit]
				[filter_side]
					[enemy_of]
						side=$side_number
					[/enemy_of]
				[/filter_side]
				
				ability=qquws_armor_science
			[/have_unit]
			[then]
				{VARIABLE apply_to_side $side_number}
				
				[fire_event]
					name=apply_armor_science
				[/fire_event]
			[/then]
		[/if]
	[/event]
	
	[event]
		name=unit placed
		first_time_only=no
		
		[filter]
			side=$uws_game.filter_apply_global_specials_sides
		[/filter]
		
		[if]
			[have_unit]
				[filter_side]
					[enemy_of]
						side=$unit.side
					[/enemy_of]
				[/filter_side]
				
				ability=qquws_armor_science
			[/have_unit]
			[then]
				{VARIABLE apply_to_side $unit.side}
				
				[fire_event]
					name=apply_armor_science
				[/fire_event]
			[/then]
		[/if]
	[/event]
	
	[event]
		name=apply_armor_science
		first_time_only=no
		
		[store_unit]
			[filter]
				[filter_side]
					[enemy_of]
						side=$apply_to_side
					[/enemy_of]
				[/filter_side]
				
				ability=qquws_armor_science
			[/filter]
			
			variable=armor_masters
			mode=always_clear
		[/store_unit]
		
		[foreach]
			array=armor_masters
			variable=armor_master
			readonly=yes
			
			[do]
				[modify_unit]
					[filter]
						side=$apply_to_side
						
						[not]
							trait=qquws_dimished_armor_trait
						[/not]
						
						[filter_location]
							x,y=$armor_master.x,$armor_master.y
							radius=$armor_master.max_moves
							[filter_radius]
								terrain="!,_off^_usr,X*,M*^X*"
							[/filter_radius]
							[filter_vision]
								visible=yes
								respect_fog=yes
							[/filter_vision]
						[/filter_location]
					[/filter]

					[trait]
						id=qquws_dimished_armor_trait
						name="<span color='#c7af85'>flawed armor $armor_master.variables.armor_science_value|</span>"
						description="This unit's armor has been studied by your armor scientist and flaws were found."

						[effect]
							apply_to=resistance
							replace=no
							[resistance]
								blade=$armor_master.variables.armor_science_value
								impact=$armor_master.variables.armor_science_value
								pierce=$armor_master.variables.armor_science_value
							[/resistance]
						[/effect]
					[/trait]
				[/modify_unit]
			[/do]
		[/foreach]
		
		{CLEAR_VARIABLE armor_masters}
	[/event]
#enddef

#define REGISTER_ICE_LOCK
	[event]
		name=attacker hits
		first_time_only=no
		
		[filter_attack]
			special_id=qquws_frozen_grip
		[/filter_attack]

		[if]
			[variable]
				name=second_unit.hitpoints
				greater_than=0
			[/variable]
			[then]
				{VARIABLE self_defense $unit.variables.frozen_grip_self_defense}
				{VARIABLE self_res $unit.variables.frozen_grip_self_res}
				[modify_unit]
					[filter]
						id=$unit.id
					[/filter]
					
					[object]
						silent=yes
						duration=turn
						
						[effect]
						    apply_to=defense
						    replace=no
						    [defense]
								flat=$self_defense
								frozen=$self_defense
								forest=$self_defense
								hills=$self_defense
								village=$self_defense
								swamp_water=$self_defense
								shallow_water=$self_defense
								castle=$self_defense
								cave=$self_defense
								sand=$self_defense
								fungus=$self_defense
								mountains=$self_defense
								castle=$self_defense
								sand=$self_defense
						    [/defense]
						[/effect]
						[effect]
						    apply_to=resistance
						    replace=no
						    [resistance]
								arcane=-$self_res
								blade=-$self_res
								cold=-$self_res
								fire=-$self_res
								impact=-$self_res
								pierce=-$self_res
								secret=-$self_res
								insects=-$self_res
						    [/resistance]
						[/effect]
						[effect]
						    apply_to=remove_attacks
						[/effect]
						[effect]
						    apply_to=movement
						    set=0
						[/effect]
						[effect]
						    apply_to=image_mod
						    add="~BL(1.5)~CS(5,5,15)"
						[/effect]
						[effect]
							apply_to=new_ability
							[abilities]
								[dummy]
									id=qquws_frozen_grip_locked_self
									name="<span color='#99d5e0'>frozen grip</span>"
									description="This unit is locked in a frozen grip. If the locked enemy dies, this unit gets experience and increased kill count"
								[/dummy]
							[/abilities]
						[/effect]
					[/object]
				[/modify_unit]

				{VARIABLE enemy_defense $unit.variables.frozen_grip_enemy_defense}
				{VARIABLE enemy_strikes $unit.variables.frozen_grip_enemy_strikes}
				[if]
					[have_unit]
						id=$second_unit.id
						trait=immune_to_specials
					[/have_unit]
					[then]
						{VARIABLE_OP enemy_defense sub 8}
						{VARIABLE_OP enemy_strikes sub 13}
					[/then]
				[/if]
				
				[modify_unit]
					[filter]
						id=$second_unit.id
					[/filter]
					
					[object]
						silent=yes
						duration=turn end
						
						[effect]
						    apply_to=defense
						    replace=no
						    [defense]
								flat=$enemy_defense
								frozen=$enemy_defense
								forest=$enemy_defense
								hills=$enemy_defense
								village=$enemy_defense
								swamp_water=$enemy_defense
								shallow_water=$enemy_defense
								castle=$enemy_defense
								cave=$enemy_defense
								sand=$enemy_defense
								fungus=$enemy_defense
								mountains=$enemy_defense
								castle=$enemy_defense
								sand=$enemy_defense
						    [/defense]
						[/effect]
						[effect]
						    apply_to=attack
						    increase_attacks="-$enemy_strikes|%"
						[/effect]
						[effect]
						    apply_to=movement
						    set=0
						[/effect]
						[effect]
						    apply_to=image_mod
						    add="~BL(1.5)~CS(20,20,65)"
						[/effect]
						[effect]
							apply_to=new_ability
							[abilities]
								[dummy]
									id=qquws_frozen_grip_locked_enemy
									name="<span color='#99d5e0'>frozen grip</span>"
									description="This unit is locked in a frozen grip."
								[/dummy]
							[/abilities]
						[/effect]
					[/object]
				[/modify_unit]
			[/then]
		[/if]
	[/event]
	
	[event]
		name=attacker hits
		first_time_only=no
		
		[filter_attack]
			special_id=qquws_frozen_prison
		[/filter_attack]

		[filter_second]
			[not]
				ability=qquws_status_prison_locked_enemy
			[/not]
		[/filter_second]
		
		[if]
			[variable]
				name=second_unit.hitpoints
				greater_than=0
			[/variable]
			[then]
				{VARIABLE enemy_defense $unit.variables.frozen_prison_enemy_defense}
				{VARIABLE enemy_strikes $unit.variables.frozen_prison_enemy_strikes}
				[if]
					[have_unit]
						id=$second_unit.id
						trait=immune_to_specials
					[/have_unit]
					[then]
						{VARIABLE_OP enemy_defense sub 8}
						{VARIABLE_OP enemy_strikes sub 13}
					[/then]
				[/if]

				[modify_unit]
					[filter]
						id=$second_unit.id
					[/filter]
					
					[object]
						silent=yes
						duration=turn end
						
						[effect]
						    apply_to=defense
						    replace=no
						    [defense]
								flat=$enemy_defense
								frozen=$enemy_defense
								forest=$enemy_defense
								hills=$enemy_defense
								village=$enemy_defense
								swamp_water=$enemy_defense
								shallow_water=$enemy_defense
								castle=$enemy_defense
								cave=$enemy_defense
								sand=$enemy_defense
								fungus=$enemy_defense
								mountains=$enemy_defense
								castle=$enemy_defense
								sand=$enemy_defense
						    [/defense]
						[/effect]
						[effect]
						    apply_to=attack
						    increase_attacks="-$enemy_strikes|%"
						[/effect]
						[effect]
						    apply_to=movement
						    set=0
						[/effect]
						[effect]
						    apply_to=image_mod
						    add="~BL(2)~BW(255)"
						[/effect]
						[effect]
							apply_to=new_ability
							[abilities]
								[dummy]
									id=qquws_status_prison_locked_enemy
									name="<span color='#9660cc'>prison lock</span>"
									description="This unit is locked in the frozen prison."
								[/dummy]
							[/abilities]
						[/effect]
					[/object]
				[/modify_unit]
			[/then]
		[/if]
	[/event]

	[event]
		name=attack end
		first_time_only=no
		
		[filter_attack]
			special_id=qquws_frozen_prison
		[/filter_attack]

		[filter]
			[not]
				ability=qquws_frozen_prison_locked_self
			[/not]
		[/filter]

		[filter_second]
			ability=qquws_status_prison_locked_enemy
		[/filter_second]
		
		[if]
			[variable]
				name=second_unit.hitpoints
				greater_than=0
			[/variable]
			[then]
				[modify_unit]
					[filter]
						id=$unit.id
					[/filter]

					attacks_left=1
					
					[object]
						silent=yes
						duration=turn end
						
						[effect]
						    apply_to=image_mod
						    add="~CS(30,30,65)"
						[/effect]
						[effect]
							apply_to=new_ability
							[abilities]
								[dummy]
									id=qquws_frozen_prison_locked_self
									name="<span color='#9660cc'>icy imprisoner</span>"
									description="This unit imprisoned an enemy. It can attack the same enemy again with a non-cold attack, although with 33% reduced damage, or move away if still has movement points."
								[/dummy]
							[/abilities]
						[/effect]
						[effect]
						    apply_to=remove_attacks
						    type=cold
						[/effect]
						[effect]
						    apply_to=attack
						    increase_damage=-33%
						    [set_specials]
						    	mode=append
						    	[disable]
						    		id=qquws_allow_single_targe
						    		[filter_opponent]
						    			[not]
						    				id=$second_unit.id
						    			[/not]
						    		[/filter_opponent]
						    	[/disable]
						    [/set_specials]
						[/effect]
					[/object]
				[/modify_unit]

				[floating_text]
					x,y=$unit.x,$unit.y
					text="<span color='#adbcde'>action available</span>"
				[/floating_text]
			[/then]
		[/if]
	[/event]

	[event]
		name=die
		first_time_only=no

		[filter]
			ability=qquws_frozen_grip_locked_enemy

			[not]
				trait=qquws_zero_xp
			[/not]
		[/filter]

		[filter_second]
			[not]
				ability=qquws_frozen_grip_locked_self
			[/not]
		[/filter_second]

		[store_unit]
			[filter]
				ability=qquws_frozen_grip_locked_self

				[filter_adjacent]
					x=$unit.x
					y=$unit.y
					is_enemy=yes
				[/filter_adjacent]

				[not]
					id=$second_unit.id
				[/not]
			[/filter]
			
			variable=frozen_grip_unit
			mode=always_clear
		[/store_unit]

		[if]
			[variable]
				name=frozen_grip_unit.length
				equals=1
			[/variable]
			[then]
				{VARIABLE xp_given "$( if($unit.level = 0, 4, $unit.level * 8) )"}
				{VARIABLE unit_kills $frozen_grip_unit[0].variables.kills}
				[if]
					[variable]
						name=unit_kills
						equals=""
					[/variable]
					[then]
						{VARIABLE unit_kills 0}
					[/then]
				[/if]

				[modify_unit]
					[filter]
						id=$frozen_grip_unit[0].id
					[/filter]

					[variables]
						kills="$( $unit_kills + 1 )"
					[/variables]

					[effect]
						apply_to=experience
						increase=$xp_given
					[/effect]
				[/modify_unit]

				[floating_text]
					x,y=$frozen_grip_unit[0].x,$frozen_grip_unit[0].y
					text="<span color='#608dd1'>+$xp_given xp</span>"
				[/floating_text]

				[fire_event]
					name=promote_unit
					[primary_unit]
					    id=$frozen_grip_unit[0].id
					[/primary_unit]
				[/fire_event]
			[/then]
		[/if]
	[/event]
#enddef

#define REGISTER_IMPALE
	[event]
		name=attacker hits
		first_time_only=no
		
		[filter_attack]
			special_id=qquws_impale
		[/filter_attack]
		
		[filter_second]
			[not]
				trait=immune_to_specials
			[/not]
			
			[not]
				ability=qquws_status_impaled
			[/not]
		[/filter_second]
		
		[floating_text]
			x,y=$second_unit.x,$second_unit.y
			text="<span color='#c71628'>IMPALED!</span>"
		[/floating_text]
		
		{VARIABLE mask_image_width 72}
		{VARIABLE mask_image_height 72}
		[if]
			[variable]
				name=second_unit.variables.image_base_w
				greater_than=0
			[/variable]
			[then]
				{VARIABLE mask_image_width $second_unit.variables.image_base_w}
				{VARIABLE mask_image_height $second_unit.variables.image_base_h}
			[/then]
		[/if]
		
		[modify_unit]
			[filter]
				id=$second_unit.id
			[/filter]
			
			[object]
				silent=yes
				duration=turn end
				
				[effect]
				    apply_to=attack
				    increase_damage=-33%
				[/effect]
				[effect]
				    apply_to=movement
				    increase=-33%
				[/effect]
				[effect]
				    apply_to=image_mod
				    add="~MASK(halo/uws/impale.png~SCALE($mask_image_width,$mask_image_height))"
				[/effect]
				[effect]
					apply_to=new_ability
					[abilities]
						[dummy]
							id=qquws_status_impaled
							name="<span color='#bd3124'>impaled</span>"
							description="This unit was impaled. It's damage and movement are reduced by 33% until the end of it's turn."
						[/dummy]
					[/abilities]
				[/effect]
			[/object]
		[/modify_unit]
		
		[modify_unit]
			[filter]
				id=$second_unit.id
			[/filter]
			
			[object]
				silent=yes
				
				[effect]
				    apply_to=remove_resistance
				    type=pierce
				    amount=$unit.variables.impale_armor_reduce
				[/effect]
			[/object]
		[/modify_unit]
	[/event]
#enddef

#define REGISTER_BATTLE_TRANCE
	[event]
		name=attack
		first_time_only=no
		
		[filter_attack]
			special_id=qquws_battle_trance
		[/filter_attack]
		
		[foreach]
			array=unit.attack
			variable=units_weapon
			index_var=i
			readonly=yes
			
			[do]
				[if]
					[variable]
						name=units_weapon.name
						equals=qquws_w_berserkers_fury
					[/variable]
					[then]
						{VARIABLE battle_trance_attack_id $i}
						{VARIABLE battle_trance_base_damage $weapon.damage}
						[break][/break]
					[/then]
				[/if]
			[/do]
		[/foreach]
	[/event]
	
	[event]
		name=attacker hits
		first_time_only=no
		
		[filter_attack]
			special_id=qquws_battle_trance
		[/filter_attack]
		
		{VARIABLE_OP unit.attack[$battle_trance_attack_id].damage add 1}
		[unstore_unit]
		        variable=unit
		[/unstore_unit]
	[/event]
	
	[event]
		name=attack end
		first_time_only=no
		
		[filter_attack]
			special_id=qquws_battle_trance
		[/filter_attack]
		
		{VARIABLE unit.attack[$battle_trance_attack_id].damage $battle_trance_base_damage}
		[unstore_unit]
		        variable=unit
		[/unstore_unit]
		
		{CLEAR_VARIABLE battle_trance_attack_id}
		{CLEAR_VARIABLE battle_trance_base_damage}
	[/event]
	
	[event]
		name=attack
		first_time_only=no
		
		[filter_attack]
			special_id=qquws_overwhelm
		[/filter_attack]
		
		[foreach]
			array=unit.attack
			variable=units_weapon
			index_var=i
			readonly=yes
			
			[do]
				[if]
					[variable]
						name=units_weapon.name
						equals=$weapon.name
					[/variable]
					[then]
						{VARIABLE overwhelm_attack_id $i}
						{VARIABLE overwhelm_base_damage $weapon.damage}
						[break][/break]
					[/then]
				[/if]
			[/do]
		[/foreach]
		
		[foreach]
			array=second_unit.attack
			variable=units_weapon
			index_var=i
			readonly=yes
			
			[do]
				[if]
					[variable]
						name=units_weapon.name
						equals=$second_weapon.name
					[/variable]
					[then]
						{VARIABLE overwhelm_second_attack_id $i}
						{VARIABLE overwhelm_second_base_damage $second_weapon.damage}
						[break][/break]
					[/then]
				[/if]
			[/do]
		[/foreach]
	[/event]
	
	[event]
		name=attacker hits
		first_time_only=no
		
		[filter_attack]
			special_id=qquws_overwhelm
		[/filter_attack]
		
		{VARIABLE_OP unit.attack[$overwhelm_attack_id].damage add 1}
		[unstore_unit]
		        variable=unit
		[/unstore_unit]
		
		{VARIABLE second_attack_test $overwhelm_second_base_damage}
		{VARIABLE_OP second_attack_test multiply 0.6}
		{VARIABLE_OP second_attack_test add 1}
		{VARIABLE_OP second_s_attack_test multiply 0.8}
		{VARIABLE_OP second_s_attack_test add 1}
		
		[if]
			[variable]
				name=second_unit.attack[$overwhelm_second_attack_id].damage
				greater_than=$second_attack_test
			[/variable]
			[then]
				{VARIABLE_OP second_attack_test multiply 2}
				
				{VARIABLE damage_decrease_factor 1}
				[if]
					[variable]
						name=second_unit.attack[$overwhelm_second_attack_id].damage
						greater_than=$second_s_attack_test
					[/variable]
					[then]
						{VARIABLE damage_decrease_factor 2}
					[/then]
				[/if]
				
				{VARIABLE_OP second_unit.attack[$overwhelm_second_attack_id].damage sub $damage_decrease_factor}
				[unstore_unit]
					variable=second_unit
				[/unstore_unit]
			[/then]
		[/if]
	[/event]
	
	[event]
		name=attack end
		first_time_only=no
		
		[filter_attack]
			special_id=qquws_overwhelm
		[/filter_attack]
		
		{VARIABLE unit.attack[$overwhelm_attack_id].damage $overwhelm_base_damage}
		[unstore_unit]
		        variable=unit
		[/unstore_unit]
		
		{VARIABLE second_unit.attack[$overwhelm_second_attack_id].damage $overwhelm_second_base_damage}
		[unstore_unit]
		        variable=second_unit
		[/unstore_unit]
		
		{CLEAR_VARIABLE overwhelm_attack_id}
		{CLEAR_VARIABLE overwhelm_base_damage}
		{CLEAR_VARIABLE overwhelm_second_attack_id}
		{CLEAR_VARIABLE overwhelm_second_base_damage}
		{CLEAR_VARIABLE second_attack_test}
		
		[modify_unit]
			[filter]
				id=$second_unit.id
			[/filter]
			
			[object]
				silent=yes
				duration=turn end
				
				[effect]
				    apply_to=defense
				    replace=no
				    [defense]
						flat=10
						frozen=10
						forest=10
						hills=10
						village=10
						swamp_water=10
						shallow_water=10
						castle=10
						cave=10
						sand=10
						fungus=10
						mountains=10
						castle=10
						sand=10
				    [/defense]
				[/effect]
				[effect]
				    apply_to=attack
				    increase_accuracy=-10
				[/effect]
				[effect]
				    apply_to=image_mod
				    add="~SEPIA()"
				[/effect]
				[effect]
					apply_to=new_ability
					[abilities]
						[dummy]
							id=qquws_status_overwelmed
							name="<span color='#cf7851'>overwhelmed</span>"
							description="This unit is overwhelmed and has all defenses and weapon accuracy reduced by 10% for one turn."
						[/dummy]
					[/abilities]
				[/effect]
			[/object]
		[/modify_unit]
	[/event]
#enddef

#define REGISTER_MIND_TRICKS
	[event]
		name=attack
		first_time_only=no
		
		[filter]
			ability=qquws_mind_tricks
		[/filter]

		{VARIABLE mind_tricks_received_damage 0}
	[/event]

	[event]
		name=defender hits
		first_time_only=no
		
		[filter]
			ability=qquws_mind_tricks
		[/filter]
		
		{VARIABLE_OP mind_tricks_received_damage add $damage_inflicted}
	[/event]

	[event]
		name=attack end
		first_time_only=no
		
		[filter]
			ability=qquws_mind_tricks
		[/filter]

		{VARIABLE mind_tricks_use_base_damage $mind_tricks_received_damage}
		
		[fire_event]
			name=mind_tricks_apply
			[primary_unit]
				id=$unit.id
			[/primary_unit]
			
			[secondary_unit]
				id=$second_unit.id
			[/secondary_unit]
		[/fire_event]
	[/event]

	[event]
		name=attack
		first_time_only=no
		
		[filter_second]
			ability=qquws_mind_tricks
		[/filter_second]

		{VARIABLE mind_tricks_second_received_damage 0}
	[/event]

	[event]
		name=attacker hits
		first_time_only=no
		
		[filter_second]
			ability=qquws_mind_tricks
		[/filter_second]
		
		{VARIABLE_OP mind_tricks_second_received_damage add $damage_inflicted}
	[/event]

	[event]
		name=attack end
		first_time_only=no
		
		[filter_second]
			ability=qquws_mind_tricks
		[/filter_second]

		{VARIABLE mind_tricks_use_base_damage $mind_tricks_second_received_damage}
		
		[fire_event]
			name=mind_tricks_apply
			[primary_unit]
				id=$second_unit.id
			[/primary_unit]
			
			[secondary_unit]
				id=$unit.id
			[/secondary_unit]
		[/fire_event]
	[/event]
	
	[event]
		name=mind_tricks_apply
		first_time_only=no
		
		[if]
			[variable]
				name=unit.hitpoints
				greater_than=0
			[/variable]
			[and]
				[variable]
					name=second_unit.hitpoints
					greater_than=0
				[/variable]
			[/and]
			[then]
				{VARIABLE mind_tricks_deal_damage $mind_tricks_use_base_damage}
				{VARIABLE_OP mind_tricks_deal_damage multiply $unit.variables.mind_tricks_factor}
				{VARIABLE_OP mind_tricks_deal_damage round floor}
				
				[if]
					[variable]
						name=mind_tricks_deal_damage
						greater_than=0
					[/variable]
					[then]
						[floating_text]
							x,y=$unit.x,$unit.y
							text="<span color='#a8548d'>Mind Tricks!</span>"
						[/floating_text]

						[heal_unit]
							[filter]
								id=$unit.id
							[/filter]
							
							amount=$mind_tricks_deal_damage
							animate=yes
						[/heal_unit]
						
						[harm_unit]
							[filter]
								id=$second_unit.id
							[/filter]
							
							[filter_second]
								id=$unit.id
							[/filter_second]
							
							amount=$mind_tricks_deal_damage
							damage_type=arcane
							alignment=neutral
							kill=yes
							animate=yes
							experience=yes
						[/harm_unit]
					[/then]
				[/if]
			[/then]
		[/if]
		
		{CLEAR_VARIABLE mind_tricks_received_damage,mind_tricks_second_received_damage,mind_tricks_deal_damage,mind_tricks_use_base_damage}
	[/event]
#enddef

#define REGISTER_REVERSED_POLARITY
	[event]
		name=attacker hits
		first_time_only=no
		
		[filter_attack]
			special_id=qquws_reversed_polarity
		[/filter_attack]
		
		[filter_second]
			formula="hitpoints > 0"
		[/filter_second]
		
		{VARIABLE new_x $unit.x}
		{VARIABLE new_y $unit.y}
		
		{VARIABLE unit.x $second_unit.x}
		{VARIABLE unit.y $second_unit.y}
		
		{VARIABLE second_unit.x 0}
		{VARIABLE second_unit.y 0}
		
		[unstore_unit]
			variable=second_unit
		[/unstore_unit]
		
		[unstore_unit]
			variable=unit
		[/unstore_unit]
		
		{VARIABLE second_unit.x $new_x}
		{VARIABLE second_unit.y $new_y}
		
		[unstore_unit]
			variable=second_unit
		[/unstore_unit]

		{CLEAR_VARIABLE new_x}
		{CLEAR_VARIABLE new_y}
	[/event]
#enddef

#define REGISTER_ARCANE_TRICKSTERY
	[event]
		name=defender hits
		first_time_only=no
		
		[filter]
			ability=qquws_arcane_trickstery
		[/filter]
		
		[filter_second]
			[not]
				trait=immune_to_specials
			[/not]
		[/filter_second]
		
		[fire_event]
			name=apply_arcane_trickstery
			[primary_unit]
				id=$unit.id
			[/primary_unit]
			
			[secondary_unit]
				id=$second_unit.id
			[/secondary_unit]
		[/fire_event]
	[/event]
	
	[event]
		name=attacker hits
		first_time_only=no
		
		[filter_second]
			ability=qquws_arcane_trickstery
		[/filter_second]
		
		[filter]
			[not]
				trait=immune_to_specials
			[/not]
		[/filter]
		
		[fire_event]
			name=apply_arcane_trickstery
			[primary_unit]
				id=$second_unit.id
			[/primary_unit]
			
			[secondary_unit]
				id=$unit.id
			[/secondary_unit]
		[/fire_event]
	[/event]
	
	[event]
		name=apply_arcane_trickstery
		first_time_only=no
		
		[if]
			[variable]
				name=unit.hitpoints
				greater_than=0
			[/variable]
			[then]
				{VARIABLE arcane_trickstery_value $damage_inflicted}
				{VARIABLE_OP arcane_trickstery_value multiply $unit.variables.arcane_trickstery_factor}
				{VARIABLE_OP arcane_trickstery_value round floor}
				
				[if]
					[variable]
						name=arcane_trickstery_value
						greater_than=0
					[/variable]
					[then]
						[store_unit]
							[filter]
								[filter_location]
									x=$unit.x
									y=$unit.y
									radius=3
								[/filter_location]
								
								[not]
									trait=immune_to_specials
								[/not]
							[/filter]
							
							variable=units_within_radius
							mode=always_clear
						[/store_unit]
						
						{VARIABLE_OP random_unit_i rand 1..$units_within_radius.length}
						{VARIABLE_OP random_unit_i sub 1}
						
						[if]
							[have_unit]
								id=$units_within_radius[$random_unit_i].id
								[filter_side]
									[enemy_of]
										side=$unit.side
									[/enemy_of]
								[/filter_side]
								count=1
							[/have_unit]
							[then]
								# it is an enemy
								[harm_unit]
									[filter]
										id=$units_within_radius[$random_unit_i].id
									[/filter]
									
									[filter_second]
										id=$unit.id
									[/filter_second]
									
									amount=$arcane_trickstery_value
									damage_type=arcane
									alignment=neutral
									kill=no
									animate=yes
									experience=no
								[/harm_unit]
							[/then]
							[else]
								# [heal_unit] can't go above max hitpoints
								{VARIABLE_OP units_within_radius[$random_unit_i].hitpoints add $arcane_trickstery_value}
								[unstore_unit]
									variable=units_within_radius[$random_unit_i]
								[/unstore_unit]
								
								[floating_text]
									x,y=$units_within_radius[$random_unit_i].x,$units_within_radius[$random_unit_i].y
									text="<span color='#00ff00'>$arcane_trickstery_value</span>"
								[/floating_text]
							[/else]
						[/if]
						
						{CLEAR_VARIABLE $units_within_radius}
					[/then]
				[/if]
			[/then]
		[/if]
	[/event]
#enddef

#define REGISTER_STUN
	[event]
		name=attacker hits
		first_time_only=no
		
		[filter_attack]
			special_id=qquws_stun
		[/filter_attack]
		
		[filter_second]
			[not]
				ability=qquws_status_stunned
			[/not]

			[not]
				trait=immune_to_specials
			[/not]
		[/filter_second]
		
		[modify_unit]
			[filter]
				id=$second_unit.id
			[/filter]
			
			[object]
				silent=yes
				duration=turn end
				
				[effect]
					apply_to=zoc
					value=no
				[/effect]
				[effect]
					apply_to=image_mod
					add="~CS(50,50,0)"
				[/effect]
				[effect]
					apply_to=new_ability
					[abilities]
						[dummy]
							id=qquws_status_stunned
							name="<span color='#d1a758'>stunned</span>"
							description="This unit is stunned and has no zone of control."
						[/dummy]
					[/abilities]
				[/effect]
			[/object]
		[/modify_unit]
		
		[floating_text]
			x,y=$second_unit.x,$second_unit.y
			text="<span color='#d1a758'>stunned</span>"
		[/floating_text]
	[/event]
#enddef

#define REGISTER_CRUSHING_BLOW
	[event]
		name=attacker hits
		first_time_only=no
		
		[filter_attack]
			special_id=qquws_crushing_blow
		[/filter_attack]
		
		[filter_second]
			[not]
				ability=qquws_status_crushed
			[/not]
		[/filter_second]
		
		{VARIABLE mask_image_width 72}
		{VARIABLE mask_image_height 60}
		[if]
			[variable]
				name=second_unit.variables.image_base_w
				greater_than=0
			[/variable]
			[then]
				{VARIABLE mask_image_width $second_unit.variables.image_base_w}
				{VARIABLE mask_image_height $second_unit.variables.image_base_h}
				{VARIABLE_OP mask_image_height mulitply 0.8}
			[/then]
		[/if]
		
		[modify_unit]
			[filter]
				id=$second_unit.id
			[/filter]
			
			[object]
				silent=yes
				duration=turn end
				
				[effect]
				    apply_to=attack
				    increase_attacks=-1
				[/effect]
				[effect]
					apply_to=zoc
					value=no
				[/effect]
				[effect]
					apply_to=image_mod
					add="~SCALE($mask_image_width,$mask_image_height)~CS(50,50,0)"
				[/effect]
				[effect]
					apply_to=new_ability
					[abilities]
						[dummy]
							id=qquws_status_crushed
							name="<span color='#d1a758'>crushed</span>"
							description="This unit is crushed, has no zone of control and has 1 strike removed."
						[/dummy]
					[/abilities]
				[/effect]
			[/object]
		[/modify_unit]
		
		[floating_text]
			x,y=$second_unit.x,$second_unit.y
			text="<span color='#d1a758'>crushed</span>"
		[/floating_text]
	[/event]
	
	[event]
		name=attacker hits
		first_time_only=no
		
		[filter_attack]
			special_id=qquws_shatter_the_bones
		[/filter_attack]
		
		[filter_second]
			[not]
				ability=qquws_status_shattered
			[/not]
		[/filter_second]
		
		{VARIABLE mask_image_width 72}
		{VARIABLE mask_image_height 48}
		[if]
			[variable]
				name=second_unit.variables.image_base_w
				greater_than=0
			[/variable]
			[then]
				{VARIABLE mask_image_width $second_unit.variables.image_base_w}
				{VARIABLE mask_image_height $second_unit.variables.image_base_h}
				{VARIABLE_OP mask_image_height mulitply 0.6}
			[/then]
		[/if]
		
		[modify_unit]
			[filter]
				id=$second_unit.id
			[/filter]
			
			[object]
				silent=yes
				duration=turn end
				
				[effect]
				    apply_to=attack
				    increase_attacks=-51%
				[/effect]
				[effect]
					apply_to=zoc
					value=no
				[/effect]
				[effect]
					apply_to=image_mod
					add="~SCALE($mask_image_width,$mask_image_height)~CS(50,50,0)"
				[/effect]
				[effect]
					apply_to=new_ability
					[abilities]
						[dummy]
							id=qquws_status_shattered
							name="<span color='#d1a758'>shattered</span>"
							description="This unit is shattered, has no zone of control and has 50% strikes removed."
						[/dummy]
					[/abilities]
				[/effect]
			[/object]
		[/modify_unit]
		
		[floating_text]
			x,y=$second_unit.x,$second_unit.y
			text="<span color='#d1a758'>shattered</span>"
		[/floating_text]
	[/event]
#enddef

#define REGISTER_FINAL_SHOWDOWN
	[event]
		name=attack
		first_time_only=no
		
		[filter_attack]
			special_id=qquws_final_showdown
		[/filter_attack]
		
		[fire_event]
			name=qquws_final_showdown_prepare
			[primary_unit]
				id=$unit.id
			[/primary_unit]
			
			[secondary_unit]
				id=$second_unit.id
			[/secondary_unit]
			
			[primary_attack]
				name=$weapon.name
				damage=$weapon.damage
			[/primary_attack]
			
			[secondary_attack]
				name=$second_weapon.name
				damage=$second_weapon.damage
			[/secondary_attack]
		[/fire_event]
	[/event]
	
	[event]
		name=attack
		first_time_only=no
		
		[filter_second_attack]
			special_id=qquws_final_showdown
		[/filter_second_attack]
		
		[fire_event]
			name=qquws_final_showdown_prepare
			[primary_unit]
				id=$second_unit.id
			[/primary_unit]
			
			[secondary_unit]
				id=$unit.id
			[/secondary_unit]
			
			[primary_attack]
				name=$second_weapon.name
				damage=$second_weapon.damage
			[/primary_attack]
			
			[secondary_attack]
				name=$weapon.name
				damage=$weapon.damage
			[/secondary_attack]
		[/fire_event]
	[/event]
	
	[event]
		name=attacker hits
		first_time_only=no
		
		[filter_attack]
			special_id=qquws_final_showdown
		[/filter_attack]
		
		{VARIABLE_OP unit.attack[$final_showdown_attack_id].damage add 1}
		[unstore_unit]
		        variable=unit
		[/unstore_unit]
	[/event]
	
	[event]
		name=attacker hits
		first_time_only=no
		
		[filter_second_attack]
			special_id=qquws_final_showdown
		[/filter_second_attack]
		
		{VARIABLE_OP unit.attack[$final_showdown_second_attack_id].damage add 1}
		[unstore_unit]
		        variable=unit
		[/unstore_unit]
	[/event]
	
	[event]
		name=defender hits
		first_time_only=no
		
		[filter_attack]
			special_id=qquws_final_showdown
		[/filter_attack]
		
		{VARIABLE_OP second_unit.attack[$final_showdown_second_attack_id].damage add 1}
		[unstore_unit]
		        variable=second_unit
		[/unstore_unit]
	[/event]
	
	[event]
		name=defender hits
		first_time_only=no
		
		[filter_second_attack]
			special_id=qquws_final_showdown
		[/filter_second_attack]
		
		{VARIABLE_OP second_unit.attack[$final_showdown_attack_id].damage add 1}
		[unstore_unit]
		        variable=second_unit
		[/unstore_unit]
	[/event]
	
	[event]
		name=attack end
		first_time_only=no
		
		[filter_attack]
			special_id=qquws_final_showdown
		[/filter_attack]
		
		[fire_event]
			name=qquws_final_showdown_clear
			[primary_unit]
				id=$unit.id
			[/primary_unit]
			
			[secondary_unit]
				id=$second_unit.id
			[/secondary_unit]
		[/fire_event]
	[/event]
	
	[event]
		name=attack end
		first_time_only=no
		
		[filter_second_attack]
			special_id=qquws_final_showdown
		[/filter_second_attack]
		
		[fire_event]
			name=qquws_final_showdown_clear
			[primary_unit]
				id=$second_unit.id
			[/primary_unit]
			
			[secondary_unit]
				id=$unit.id
			[/secondary_unit]
		[/fire_event]
	[/event]
	
	[event]
		name=qquws_final_showdown_prepare
		first_time_only=no
		
		[foreach]
			array=unit.attack
			variable=units_weapon
			index_var=i
			readonly=yes
			
			[do]
				[if]
					[variable]
						name=units_weapon.name
						equals=$weapon.name
					[/variable]
					[then]
						{VARIABLE final_showdown_attack_id $i}
						{VARIABLE final_showdown_base_damage $weapon.damage}
						[break][/break]
					[/then]
				[/if]
			[/do]
		[/foreach]
		
		[foreach]
			array=second_unit.attack
			variable=units_weapon
			index_var=i
			readonly=yes
			
			[do]
				[if]
					[variable]
						name=units_weapon.name
						equals=$second_weapon.name
					[/variable]
					[then]
						{VARIABLE final_showdown_second_attack_id $i}
						{VARIABLE final_showdown_second_base_damage $second_weapon.damage}
						[break][/break]
					[/then]
				[/if]
			[/do]
		[/foreach]
	[/event]
	
	[event]
		name=qquws_final_showdown_clear
		first_time_only=no
		
		{VARIABLE unit.attack[$final_showdown_attack_id].damage $final_showdown_base_damage}
		[unstore_unit]
		        variable=unit
		[/unstore_unit]
		
		{CLEAR_VARIABLE final_showdown_attack_id}
		{CLEAR_VARIABLE final_showdown_base_damage}
		
		{VARIABLE second_unit.attack[$final_showdown_second_attack_id].damage $final_showdown_second_base_damage}
		[unstore_unit]
		        variable=second_unit
		[/unstore_unit]
		
		{CLEAR_VARIABLE final_showdown_second_attack_id}
		{CLEAR_VARIABLE final_showdown_second_base_damage}
	[/event]
#enddef

#define REGISTER_AURA_OF_DEATH
	[event]
		name=turn refresh
		first_time_only=no
		
		[filter_side]
			[has_unit]
				side=$side_number
				ability=qquws_aura_of_death
			[/has_unit]
		[/filter_side]
		
		[if]
			[have_unit]
				side=$side_number
				ability=qquws_aura_of_death
			[/have_unit]
			[then]
				[store_unit]
					[filter]
						side=$side_number
						ability=qquws_aura_of_death
					[/filter]
					
					variable=aura_of_death_units
					mode=always_clear
				[/store_unit]
				
				[foreach]
					array=aura_of_death_units
					variable=aura_of_death_unit
					readonly=yes
					
					[do]
						[harm_unit]
							[filter]
								[filter_location]
									x,y=$aura_of_death_unit.x,$aura_of_death_unit.y
									radius=$aura_of_death_unit.variables.aura_of_death_aoe
									[filter_radius]
										terrain="!,_off^_usr,X*,M*^X*"
									[/filter_radius]
									[filter_vision]
										visible=yes
										respect_fog=yes
									[/filter_vision]
								[/filter_location]
								
								[filter_side]
									[enemy_of]
										side=$side_number
									[/enemy_of]
								[/filter_side]
								
								x=2-99
							[/filter]
							
							amount=$aura_of_death_unit.variables.aura_of_death_damage
							damage_type=arcane
							alignment=neutral
							kill=no
							animate=yes
							experience=no
							delay=0
						[/harm_unit]
					[/do]
				[/foreach]
				
				{CLEAR_VARIABLE aura_of_death_units}
			[/then]
		[/if]
	[/event]
#enddef

#define REGISTER_INFERNAL_POSSESSION
	[event]
		name=die
		first_time_only=no
		
		[filter_second]
			side=$side_number
			ability=qquws_infernal_possession
		[/filter_second]

		[modify_unit]
			[filter]
				id=$second_unit.id
			[/filter]
			
			attacks_left=1
			moves=2
		[/modify_unit]
		
		[floating_text]
			x,y=$second_unit.x,$second_unit.y
			text="<span color='#e81410'>possessed!</span>"
		[/floating_text]
	[/event]
#enddef

#define REGISTER_ENEMY_OVERWHELM
	[event]
		name=attack
		first_time_only=no
		
		[filter_attack]
			special_id=qquws_enemy_overwhelm
		[/filter_attack]
		
		[foreach]
			array=unit.attack
			variable=units_weapon
			index_var=i
			readonly=yes
			
			[do]
				[if]
					[variable]
						name=units_weapon.name
						equals=$weapon.name
					[/variable]
					[then]
						{VARIABLE enemy_overwhelm_attack_id $i}
						{VARIABLE enemy_overwhelm_base_damage $weapon.damage}
						[break][/break]
					[/then]
				[/if]
			[/do]
		[/foreach]
		
		[foreach]
			array=second_unit.attack
			variable=units_weapon
			index_var=i
			readonly=yes
			
			[do]
				[if]
					[variable]
						name=units_weapon.name
						equals=$second_weapon.name
					[/variable]
					[then]
						{VARIABLE enemy_overwhelm_second_attack_id $i}
						{VARIABLE enemy_overwhelm_second_base_damage $second_weapon.damage}
						[break][/break]
					[/then]
				[/if]
			[/do]
		[/foreach]
	[/event]
	
	[event]
		name=attacker hits
		first_time_only=no
		
		[filter_attack]
			special_id=qquws_enemy_overwhelm
		[/filter_attack]
		
		{VARIABLE_OP unit.attack[$enemy_overwhelm_attack_id].damage add 3}
		[unstore_unit]
		        variable=unit
		[/unstore_unit]
		
		{VARIABLE second_attack_test $enemy_overwhelm_second_base_damage}
		{VARIABLE_OP second_attack_test multiply 0.33}
		{VARIABLE_OP second_attack_test add 1}
		
		[if]
			[variable]
				name=second_unit.attack[$enemy_overwhelm_second_attack_id].damage
				greater_than=$second_attack_test
			[/variable]
			[then]
				{VARIABLE_OP second_attack_test multiply 2}
				
				{VARIABLE damage_decrease_factor 1}
				[if]
					[variable]
						name=second_unit.attack[$enemy_overwhelm_second_attack_id].damage
						greater_than=$second_attack_test
					[/variable]
					[then]
						{VARIABLE damage_decrease_factor 3}
					[/then]
				[/if]
				
				{VARIABLE_OP second_unit.attack[$enemy_overwhelm_second_attack_id].damage sub $damage_decrease_factor}
				[unstore_unit]
					variable=second_unit
				[/unstore_unit]
			[/then]
		[/if]
	[/event]
	
	[event]
		name=attack end
		first_time_only=no
		
		[filter_attack]
			special_id=qquws_enemy_overwhelm
		[/filter_attack]
		
		{VARIABLE unit.attack[$enemy_overwhelm_attack_id].damage $enemy_overwhelm_base_damage}
		[unstore_unit]
		        variable=unit
		[/unstore_unit]
		
		{VARIABLE second_unit.attack[$enemy_overwhelm_second_attack_id].damage $enemy_overwhelm_second_base_damage}
		[unstore_unit]
		        variable=second_unit
		[/unstore_unit]
		
		{CLEAR_VARIABLE enemy_overwhelm_attack_id}
		{CLEAR_VARIABLE enemy_overwhelm_base_damage}
		{CLEAR_VARIABLE enemy_overwhelm_second_attack_id}
		{CLEAR_VARIABLE enemy_overwhelm_second_base_damage}
		{CLEAR_VARIABLE second_attack_test}
	[/event]
#enddef

#define REGISTER_KAMIKAZE
	[event]
		name=attack
		first_time_only=no
		
		[filter]
			ability=qquws_kamikaze
		[/filter]

		[modify_unit]
			[filter]
				id=$unit.id
			[/filter]

			[object]
				silent=yes

				[effect]
					apply_to=new_animation
					id="uws_kamikaze_kaboom"
					[animation]
						apply_to=attack
						[frame]
							offset="0~0.6:200"
							alpha=1:200,0
							halo="projectiles/muzzle-flash-n-1.png:200,projectiles/fireball-impact-[1~16].png~SCALE_INTO_SHARP(162,162):150"
							halo_x=16
							halo_y=0
						[/frame]
					[/animation]
				[/effect]
			[/object]
		[/modify_unit]

		[floating_text]
			x,y=$unit.x,$unit.y
			text="<span color='#ff0000'>KABOOM!</span>"
		[/floating_text]
	[/event]

	[event]
		name=attack end
		first_time_only=no
		
		[filter]
			ability=qquws_kamikaze
		[/filter]

		{VARIABLE new_terrain "^Dc"}
		{VARIABLE new_terrain_x $second_unit.x}
		{VARIABLE new_terrain_y $second_unit.y}

		[fire_event]
			name=update_single_tile
		[/fire_event]

		[kill]
			x,y=$unit.x,$unit.y
			animate=no
			fire_event=yes
		[/kill]
	[/event]
#enddef

#define REGISTER_ASTRAL_IMPRISONMENT
	[event]
		name=attacker hits
		first_time_only=no
		
		[filter_attack]
			special_id=qquws_astral_imprisonment
		[/filter_attack]
		
		[filter_second]
			[not]
				trait=immune_to_specials
			[/not]
			
			[not]
				ability=qquws_status_astral_imprisoned
			[/not]
		[/filter_second]
		
		[if]
			[variable]
				name=second_unit.hitpoints
				greater_than=0
			[/variable]
			[then]
				[modify_unit]
					[filter]
						id=$second_unit.id
					[/filter]
					
					[object]
						silent=yes
						duration=turn end
						
						[effect]
						    apply_to=remove_attacks
						[/effect]
						[effect]
							apply_to=new_ability
							[abilities]
								[dummy]
									id=qquws_status_astral_imprisoned
									name="<span color='#ab7b87'>imprisoned</span>"
									description="This unit is imprisoned."
								[/dummy]
							[/abilities]
						[/effect]
					[/object]
				[/modify_unit]
			[/then]
		[/if]
	[/event]
	
	[event]
		name=attack end
		first_time_only=no
		
		[filter_second]
			ability=qquws_status_astral_imprisoned
		[/filter_second]
		
		[if]
			[variable]
				name=second_unit.hitpoints
				greater_than=0
			[/variable]
			[then]
				[modify_unit]
					[filter]
						id=$second_unit.id
					[/filter]
					
					hitpoints=1
					[status]
						petrified=yes
						unhealable=yes
					[/status]
				[/modify_unit]
				
				[set_variables]
					name=qquws_lasting_effect_information
					mode=append
					[value]
					    id=$second_unit.id
					    side=$second_unit.side
					    end_of_effect_turn="$($turn_number| + 2)"
					    effect_type=petrification
					[/value]
				[/set_variables]
			[/then]
		[/if]
	[/event]
#enddef

#define REGISTER_DRAGONS_PROTECTION
	[event]
		name=attack
		first_time_only=no
		
		[filter]
			ability=qquws_dragon_protection
		[/filter]
		
		[if]
			[variable]
				name=second_unit.level
				less_than_equal_to=$unit.variables.dragon_protection_max_lvl
			[/variable]
			[and]
				[variable]
					name=unit.variables.dragon_protection_counter
					greater_than=0
				[/variable]
			[/and]
			[then]
				[object]
					silent=yes
					id=dragon_protection_enabled
					take_only_once=no
					
					[filter]
						id=$unit.id
					[/filter]
					
					[effect]
						apply_to=new_ability
						[abilities]
							[dummy]
								id=qquws_protected_dragon_protection
								name="<span color='#55ad44'>protected</span>"
								description="This unit is protected with Dragon's Protection."
							[/dummy]
						[/abilities]
					[/effect]
					[effect]
					    apply_to=halo
					    halo="halo/uws/dragon_protection[1~8].png:100"
					[/effect]
				[/object]
			[/then]
		[/if]
	[/event]
	
	[event]
		name=attack
		first_time_only=no
		
		[filter_second]
			ability=qquws_dragon_protection
		[/filter_second]
		
		[if]
			[variable]
				name=unit.level
				less_than_equal_to=$second_unit.variables.dragon_protection_max_lvl
			[/variable]
			[and]
				[variable]
					name=second_unit.variables.dragon_protection_counter
					greater_than=0
				[/variable]
			[/and]
			[then]
				[object]
					silent=yes
					id=dragon_protection_enabled
					take_only_once=no
					
					[filter]
						id=$second_unit.id
					[/filter]
					
					[effect]
						apply_to=new_ability
						[abilities]
							[dummy]
								id=qquws_protected_dragon_protection
								name="<span color='#55ad44'>protected</span>"
								description="This unit is protected with Dragon's Protection."
							[/dummy]
						[/abilities]
					[/effect]
					[effect]
					    apply_to=halo
					    halo="halo/uws/dragon_protection[1~8].png:100"
					[/effect]
				[/object]
			[/then]
		[/if]
	[/event]
	
	[event]
		name=attack end
		first_time_only=no
		
		[filter]
			ability=qquws_protected_dragon_protection
		[/filter]
		
		[if]
			[variable]
				name=unit.hitpoints
				less_than=1
			[/variable]
			[then]
				[if]
					[variable]
						name=unit.variables.dragon_restore_is_fraction
						boolean_equals=yes
					[/variable]
					[then]
						{VARIABLE unit.hitpoints "$( ceil( $unit.max_hitpoints * $unit.variables.dragon_restore_amount ) )"}
					[/then]
					[else]
						{VARIABLE unit.hitpoints $unit.variables.dragon_restore_amount}
					[/else]
				[/if]
				
				[unstore_unit]
					variable=unit
				[/unstore_unit]
				
				[modify_unit]
					[filter]
						id=$unit.id
					[/filter]
					
					[variables]
						dragon_protection_counter=0
					[/variables]
				[/modify_unit]
				
				[floating_text]
					x,y=$unit.x,$unit.y
					text="<span color='#42bd19' size='large'>Protection!</span>"
				[/floating_text]
			[/then]
		[/if]
		
		[remove_object]
			id=$unit.id
			object_id=dragon_protection_enabled
		[/remove_object]
	[/event]
	
	[event]
		name=attack end
		first_time_only=no
		
		[filter_second]
			ability=qquws_protected_dragon_protection
		[/filter_second]
		
		[if]
			[variable]
				name=second_unit.hitpoints
				less_than=1
			[/variable]
			[then]
				[if]
					[variable]
						name=second_unit.variables.dragon_restore_is_fraction
						boolean_equals=yes
					[/variable]
					[then]
						{VARIABLE second_unit.hitpoints "$( ceil( $second_unit.max_hitpoints * $second_unit.variables.dragon_restore_amount ) )"}
					[/then]
					[else]
						{VARIABLE second_unit.hitpoints $second_unit.variables.dragon_restore_amount}
					[/else]
				[/if]

				[unstore_unit]
					variable=second_unit
				[/unstore_unit]
				
				[modify_unit]
					[filter]
						id=$second_unit.id
					[/filter]
					
					[variables]
						dragon_protection_counter=0
					[/variables]
				[/modify_unit]
				
				[floating_text]
					x,y=$second_unit.x,$second_unit.y
					text="<span color='#42bd19' size='large'>Protection!</span>"
				[/floating_text]
			[/then]
		[/if]
		
		[remove_object]
			id=$second_unit.id
			object_id=dragon_protection_enabled
		[/remove_object]
	[/event]

	[event]
		name=side turn
		first_time_only=no

		[filter_side]
			[has_unit]
				side=$side_number
				ability=qquws_dragon_protection
			[/has_unit]
		[/filter_side]

		[modify_unit]
			[filter]
				side=$side_number
				ability=qquws_dragon_protection
			[/filter]
			
			[variables]
				dragon_protection_counter=1
			[/variables]
		[/modify_unit]
	[/event]
#enddef

#define REGISTER_SICKNESS
	[event]
		name=attacker hits
		first_time_only=no
		
		[filter_attack]
			special_id=qquws_sickness
		[/filter_attack]
		
		[filter_second]
			[not]
				trait=immune_to_specials
			[/not]
			
			[not]
				ability=qquws_bitten_sickness
			[/not]
		[/filter_second]
		
		[if]
			[variable]
				name=second_unit.hitpoints
				greater_than=0
			[/variable]
			[then]
				[fire_event]
					name=uws_handle_sickness
					
					[primary_unit]
						id=$second_unit.id
					[/primary_unit]
				[/fire_event]
			[/then]
		[/if]
	[/event]
	
	[event]
		name=defender hits
		first_time_only=no
		
		[filter_second_attack]
			special_id=qquws_sickness
		[/filter_second_attack]
		
		[filter]
			[not]
				trait=immune_to_specials
			[/not]
			
			[not]
				ability=qquws_bitten_sickness
			[/not]
		[/filter]
		
		[if]
			[variable]
				name=unit.hitpoints
				greater_than=0
			[/variable]
			[then]
				[fire_event]
					name=uws_handle_sickness
					
					[primary_unit]
						id=$unit.id
					[/primary_unit]
				[/fire_event]
			[/then]
		[/if]
	[/event]
	
	[event]
		name=uws_handle_sickness
		first_time_only=no
		
		{VARIABLE sickness_end_turn $turn_number}
		{VARIABLE_OP sickness_end_turn add 3}
		
		[modify_unit]
			[filter]
				id=$unit.id
			[/filter]
			
			[status]
				slowed=yes
				unhealable=yes
				poisoned=yes
			[/status]
			
			[object]
				silent=yes
				id=uws_sickness_bitten_object
				take_only_once=no
				
				[effect]
					apply_to=new_ability
					[abilities]
						[dummy]
							id=qquws_bitten_sickness
							name="<span color='#b0693a'>sickness</span>"
							description="This unit is bitten. It is slowed, poisoned, unhealable and receives 25% more damage from all enemies. The effect will wear off on turn $sickness_end_turn|."
						[/dummy]
						[damage]
							id=qquws_easy_target
							name="easy target"
							apply_to=opponent
							multiply=1.3
							description="Receives 30% more damage from all enemies. The effect will wear off on turn $sickness_end_turn|."
							affect_self=yes
							affect_allies=no
							affect_enemies=no
						[/damage]
					[/abilities]
				[/effect]
				[effect]
				    apply_to=halo
				    halo="halo/uws/sickness[1~6].png:160"
				[/effect]
			[/object]
		[/modify_unit]
		
		[floating_text]
			x,y=$unit.x,$unit.y
			text="<span color='#b0693a' size='large'>Sickness!</span>"
		[/floating_text]
		
		[set_variables]
			name=qquws_lasting_effect_information
			mode=append
			[value]
			    id=$unit.id
			    side=$unit.side
			    end_of_effect_turn=$sickness_end_turn
			    effect_type=sickness
			[/value]
		[/set_variables]
	[/event]
#enddef

#define REGISTER_REQUIRES_ESCORTING
	[event]
		name=side turn
		first_time_only=no
		
		[filter_side]
			side=$uws_game.filter_human_sides
			
			[has_unit]
				side=$side_number
				ability=qquws_requires_escorting
			[/has_unit]
		[/filter_side]
		
		{VARIABLE all_units_found no}
		{VARIABLE distance_within_limit no}
		[lua]
			code = <<
				local side_number = wml.variables['side_number']
				local easily_lost = wesnoth.units.find_on_map({ side = side_number, ability = 'qquws_requires_escorting' })
				local leader_8 = wesnoth.units.find_on_map({ side = 8, canrecruit = true })
				local leader_9 = wesnoth.units.find_on_map({ side = 9, canrecruit = true })
				
				if easily_lost and easily_lost[1] then
					wml.variables['all_units_found'] = true
					
					local distance_8 = 99
					local distance_9 = 99
					if leader_8 and leader_8[1] then
						distance_8 = wesnoth.map.distance_between({ easily_lost[1].x, easily_lost[1].y }, { leader_8[1].x, leader_8[1].y })
					end
					
					if leader_9 and leader_9[1] then
						distance_9 = wesnoth.map.distance_between({ easily_lost[1].x, easily_lost[1].y }, { leader_9[1].x, leader_9[1].y })
					end
					
					if distance_8 < 3 or distance_9 < 3 then
						wml.variables['distance_within_limit'] = true
					end
				end
>>
		[/lua]
		
		[if]
			[variable] # should ALWAYS evaluate to true
				name=all_units_found
				boolean_equals=yes
			[/variable]
			[then]
				[store_unit]
					[filter]
						side=$side_number
						ability=qquws_requires_escorting
					[/filter]
					
					variable=easily_lost_unit
					mode=always_clear
				[/store_unit]
			
				[if]
					[variable]
						name=distance_within_limit
						boolean_equals=yes
					[/variable]
					[then]
						[if]
							[variable]
								name=easily_lost_unit.variables.unit_lost_counter
								less_than=1
							[/variable]
							[then]
								[message]
									id=$easily_lost_unit.id
									message="Goodness me, my heart is in my throat, I thought I lost you guys!"
								[/message]
							[/then]
						[/if]
						
						[modify_unit]
							[filter]
								id=$easily_lost_unit.id
							[/filter]
							
							[variables]
								unit_lost_counter=1
							[/variables]
						[/modify_unit]
					[/then]
					[else]
						[if]
							[variable]
								name=easily_lost_unit.variables.unit_lost_counter
								less_than=1
							[/variable]
							[then]
								[message]
									id=$easily_lost_unit.id
									message="I'm lost..."
								[/message]
								
								[kill]
									id=$easily_lost_unit.id
									animate=yes
									fire_event=no
								[/kill]
							[/then]
							[else]
								[message]
									id=$easily_lost_unit.id
									message="Guys? GUYS?! Where are you? Don't leave me here alone!"
								[/message]
								
								[modify_unit]
									[filter]
										id=$easily_lost_unit.id
									[/filter]
									
									[variables]
										unit_lost_counter=0
									[/variables]
								[/modify_unit]
							[/else]
						[/if]
					[/else]
				[/if]
			[/then]
		[/if]
	[/event]
	
	[event]
		name=last breath
		first_time_only=no
		
		[filter]
			ability=qquws_requires_escorting
		[/filter]
		
		[store_unit]
			[filter]
				side=$unit.side
				canrecruit=yes
			[/filter]
			
			variable=dead_unit_side_owner
			mode=always_clear
		[/store_unit]
		
		[message]
			id=$unit.id
			message="Darkness I see, help me! HELP ME!"
		[/message]
		
		[message]
			id=$dead_unit_side_owner.id
			message="No hard feelings after this guy."
		[/message]
	[/event]
#enddef

#define REGISTER_INTERRUPTS
	[event]
		name=defender hits
		first_time_only=no

		[filter_second_attack]
			special_id=qquws_interrupt
		[/filter_second_attack]
		[filter]
			[not]
				trait=immune_to_specials
			[/not]
		[/filter]
		[filter_condition]
			[variable]
				name=unit.hitpoints
				greater_than=0
			[/variable]
			[variable]
				name=second_unit.hitpoints
				greater_than=0
			[/variable]
		[/filter_condition]

		[store_unit]
			[filter]
				find_in=second_unit
			[/filter]
			
			variable=qquws_interrupt_target
			kill=yes
		[/store_unit]
		
		{VARIABLE qquws_interrupt_target.variables.qquws_interrupt yes}
	[/event]
	
	[event]
		name=attack end
		first_time_only=no
		
		[filter_condition]
			[variable]
				name=qquws_interrupt_target.variables.qquws_interrupt
				equals=yes
			[/variable]
		[/filter_condition]
		
		{CLEAR_VARIABLE qquws_interrupt_target.variables.qquws_interrupt}
		[unstore_unit]
			variable=qquws_interrupt_target
			text=_ "interrupt"
			{COLOR_HEAL}
		[/unstore_unit]
		
		{CLEAR_VARIABLE qquws_interrupt_target}
	[/event]
#enddef

#define REGISTER_MEDUSA_SPIRIT
	[event]
		name=attacker hits
		first_time_only=no

		[filter_second]
			ability=qquws_medusa_spirit
		[/filter_second]
		[filter]
			[not]
				trait=immune_to_specials
			[/not]
		[/filter]
		[filter_condition]
			[variable]
				name=unit.hitpoints
				greater_than=0
			[/variable]
			[variable]
				name=second_unit.hitpoints
				greater_than=0
			[/variable]
		[/filter_condition]

		[if]
			[variable]
				name=unit.status.slowed
				boolean_equals=yes
			[/variable]
			[then]
				[if]
					[variable]
						name=unit.status.petrified
						boolean_equals=no
					[/variable]
					[then]
						[modify_unit]
							[filter]
								id=$unit.id
							[/filter]
							
							[status]
								petrified=yes
							[/status]
							
							[object]
								silent=yes
								duration=turn
								
								[effect]
								    apply_to=remove_attacks
								[/effect]
								[effect]
									apply_to=new_ability
									[abilities]
										[dummy]
											id=qquws_status_turned_to_stone
											name="<span color='#ab7b87'>turned to stone</span>"
											description="This unit gazed into the eyes of medusa. The effect lasts for two turns."
										[/dummy]
									[/abilities]
								[/effect]
							[/object]
						[/modify_unit]
						
						[floating_text]
							x,y=$unit.x,$unit.y
							text="<span color='#ff0000'>petrified!</span>"
						[/floating_text]
						
						[set_variables]
							name=qquws_lasting_effect_information
							mode=append
							[value]
							    id=$unit.id
							    side=$unit.side
							    end_of_effect_turn="$($turn_number| + 2)"
							    effect_type=petrification
							[/value]
						[/set_variables]
					[/then]
				[/if]
			[/then]
			[else]
				[modify_unit]
					[filter]
						id=$unit.id
					[/filter]
					
					[status]
						slowed=yes
					[/status]
				[/modify_unit]
				
				[floating_text]
					x,y=$unit.x,$unit.y
					text="<span color='#ff0000'>slowed</span>"
				[/floating_text]
			[/else]
		[/if]
	[/event]
#enddef

#define REGISTER_CARNAGE
	[event]
		name=die
		first_time_only=no
		
		[filter_second]
			ability=qquws_carnage
		[/filter_second]
		
		[modify_unit]
			[filter]
				id=$second_unit.id
			[/filter]
				
			[object]
				silent=yes

				[effect]
				    apply_to=attack
				    increase_damage=15%
				[/effect]
			[/object]
		[/modify_unit]
		
		[heal_unit]
			[filter]
				id=$second_unit.id
			[/filter]
			
			amount=$second_unit.variables.carnage_heal_amount
			restore_statuses=yes
			animate=yes
		[/heal_unit]
		
		[floating_text]
			x,y=$second_unit.x,$second_unit.y
			text="<span color='#ff0000'>Carnage!</span>"
		[/floating_text]
	[/event]
#enddef

#define REGISTER_MIND_RAID
	[event]
		name=attacker hits
		first_time_only=no
		
		[filter]
			ability=qquws_mind_raid
		[/filter]
		
		[filter_second]
			[not]
				trait=immune_to_specials
			[/not]
		[/filter_second]
		
		[if]
			[variable]
				name=second_unit.hitpoints
				greater_than=0
			[/variable]
			[then]
				[fire_event]
					name=uws_handle_mind_raid
					
					[primary_unit]
						id=$unit.id
					[/primary_unit]
					
					[secondary_unit]
						id=$second_unit.id
					[/secondary_unit]
				[/fire_event]
			[/then]
		[/if]
	[/event]
	
	[event]
		name=defender hits
		first_time_only=no
		
		[filter_second]
			ability=qquws_mind_raid
		[/filter_second]
		
		[filter]
			[not]
				trait=immune_to_specials
			[/not]
		[/filter]
		
		[if]
			[variable]
				name=unit.hitpoints
				greater_than=0
			[/variable]
			[then]
				[fire_event]
					name=uws_handle_mind_raid
					
					[primary_unit]
						id=$second_unit.id
					[/primary_unit]
					
					[secondary_unit]
						id=$unit.id
					[/secondary_unit]
				[/fire_event]
			[/then]
		[/if]
	[/event]
	
	[event]
		name=uws_handle_mind_raid
		first_time_only=no
		
		{VARIABLE mind_raid_stolen_xp $unit.variables.mind_raid_stolen_xp}
		{VARIABLE_OP mind_raid_stolen_xp add $unit.variables.mind_raid_steal_per_hit}
		
		[if]
			[variable]
				name=unit.variables.mind_raid_stolen_xp
				greater_than_equal_to=$unit.variables.mind_raid_threshold
			[/variable]
			[then]
				{VARIABLE mind_raid_stolen_xp 0}
				
				[modify_unit]
					[filter]
						id=$unit.id
					[/filter]
					
					[object]
						silent=yes
						
						[effect]
						    apply_to=attack
						    increase_damage=15%
						[/effect]
					[/object]
				[/modify_unit]
				
				[floating_text]
					x,y=$unit.x,$unit.y
					text="<span color='#943fd1'>+15% dmg</span>"
				[/floating_text]
			[/then]
		[/if]
		
		[modify_unit]
			[filter]
				id=$unit.id
			[/filter]
			
			[variables]
				mind_raid_stolen_xp=$mind_raid_stolen_xp
			[/variables]
		[/modify_unit]
		
		{VARIABLE mind_raid_reduced_xp $second_unit.experience}
		{VARIABLE_OP mind_raid_reduced_xp sub $unit.variables.mind_raid_steal_per_hit}
		
		[modify_unit]
			[filter]
				id=$second_unit.id
			[/filter]
			
			experience=$mind_raid_reduced_xp
		[/modify_unit]
		
		[floating_text]
			x,y=$second_unit.x,$second_unit.y
			text="<span color='#5e98a8'>-$unit.variables.mind_raid_steal_per_hit|xp</span>"
		[/floating_text]
		
		{CLEAR_VARIABLE mind_raid_reduced_xp}
		{CLEAR_VARIABLE mind_raid_stolen_xp}
	[/event]
#enddef

#define REGISTER_EXPLODES
	[event]
		name=attacker hits
		first_time_only=no
		
		[filter_second]
			ability=qquws_explodes
		[/filter_second]
		
		[filter]
			[not]
				trait=immune_to_specials
			[/not]
		[/filter]

		[if]
			[variable]
				name=second_unit.hitpoints
				greater_than=0
			[/variable]
			[and]
				[variable]
					name=second_unit.hitpoints
					less_than=$second_unit.variables.explodes_threshold
				[/variable]
			[/and]
			[then]
				[fire_event]
					name=uws_handle_explosion
					
					[primary_unit]
						id=$second_unit.id
					[/primary_unit]
				[/fire_event]
			[/then]
		[/if]
	[/event]
	
	[event]
		name=defender hits
		first_time_only=no
		
		[filter]
			ability=qquws_explodes
		[/filter]
		
		[filter_second]
			[not]
				trait=immune_to_specials
			[/not]
		[/filter_second]
		
		[if]
			[variable]
				name=unit.hitpoints
				greater_than=0
			[/variable]
			[and]
				[variable]
					name=unit.hitpoints
					less_than=$unit.variables.explodes_threshold
				[/variable]
			[/and]
			[then]
				[fire_event]
					name=uws_handle_explosion
					
					[primary_unit]
						id=$unit.id
					[/primary_unit]
				[/fire_event]
			[/then]
		[/if]
	[/event]
	
	[event]
		name=uws_handle_explosion
		first_time_only=no

		[modify_unit]
			[filter]
				id=$unit.id
			[/filter]

			[object]
				silent=yes

				[effect]
					apply_to=new_animation
					id="uws_kamikaze_kaboom"
					[animation]
						apply_to=death
						[frame]
							alpha=0
							halo="projectiles/fireball-impact-[1~16].png~SCALE_INTO_SHARP(162,162):150"
							halo_x=0
							halo_y=0
						[/frame]
					[/animation]
				[/effect]
			[/object]
		[/modify_unit]

		{VARIABLE explodes_damage $unit.variables.explodes_damage}
		{VARIABLE explodes_x $unit.x}
		{VARIABLE explodes_y $unit.y}

		[store_unit]
			[filter]
				[filter_adjacent]
					x,y=$explodes_x,$explodes_y
				[/filter_adjacent]
			[/filter]

			variable=explodes_units_workaround
			mode=always_clear
		[/store_unit]

		[floating_text]
			x,y=$explodes_x,$explodes_y
			text="<span color='#ff0000'>KABOOM!!!</span>"
		[/floating_text]

		[harm_unit]
			[filter]
				id=$unit.id
			[/filter]
			
			amount=9999
			damage_type=impact
			alignment=neutral
			kill=yes
			fire_event=yes
			animate=yes
			delay=0
		[/harm_unit]

		{VARIABLE new_terrain "^Dc"}
		{VARIABLE new_terrain_x $explodes_x}
		{VARIABLE new_terrain_y $explodes_y}

		[fire_event]
			name=update_single_tile
		[/fire_event]
		
		# find in workaround because [filter_adjacent] didn't want to work after [kill] which was creating chicken egg problem
		[harm_unit]
			[filter]
				find_in=explodes_units_workaround
			[/filter]
			
			amount=$explodes_damage
			damage_type=impact
			alignment=neutral
			kill=no
			fire_event=yes
			animate=yes
			delay=0
			experience=no
		[/harm_unit]
	[/event]
#enddef

#define REGISTER_CONCENTRATION
	[event]
		name=attacker hits
		first_time_only=no
		
		[filter_attack]
			special_id=qquws_concentration
		[/filter_attack]
		
		[object]
			id=qquws_concentration_bonus_object
			take_only_once=no
			silent=yes
			
			[filter]
				id=$unit.id
			[/filter]

			[effect]
			    apply_to=attack
			    range=ranged
			    name=$weapon.name
			    increase_accuracy=$unit.variables.concentration_amount
			[/effect]
		[/object]
	[/event]
	
	[event]
		name=attack end
		first_time_only=no
		
		[filter_attack]
			special_id=qquws_concentration
		[/filter_attack]
		
		[if]
			[variable]
				name=unit.hitpoints
				greater_than=0
			[/variable]
			[then]
				[remove_object]
					id=$unit.id
					object_id=qquws_concentration_bonus_object
				[/remove_object]
			[/then]
		[/if]
	[/event]
#enddef

#define REGISTER_BATTLE_FURY
	[event]
		name=attack
		first_time_only=no
		
		[filter_attack]
			special_id=qquws_battle_fury
		[/filter_attack]
		
		[foreach]
			array=unit.attack
			variable=units_weapon
			index_var=i
			readonly=yes
			
			[do]
				[if]
					[variable]
						name=units_weapon.name
						equals=$weapon.name
					[/variable]
					[then]
						{VARIABLE battle_fury_attack_id $i}
						{VARIABLE battle_fury_base_damage $weapon.damage}
						[break][/break]
					[/then]
				[/if]
			[/do]
		[/foreach]

		{VARIABLE fury_damage_increase_counter 0}
	[/event]
	
	[event]
		name=attacker hits
		first_time_only=no
		
		[filter_attack]
			special_id=qquws_battle_fury
		[/filter_attack]
		
		{VARIABLE_OP fury_damage_increase_counter add $unit.variables.fury_amount}
		{VARIABLE unit.attack[$battle_fury_attack_id].damage "$( floor( $battle_fury_base_damage * 0.01 * (100 + $fury_damage_increase_counter) ) )"}
		[unstore_unit]
		        variable=unit
		[/unstore_unit]
	[/event]
	
	[event]
		name=defender hits
		first_time_only=no
		
		[filter_attack]
			special_id=qquws_battle_fury
		[/filter_attack]
		
		{VARIABLE unit.attack[$battle_fury_attack_id].damage $battle_fury_base_damage}
		{VARIABLE fury_damage_increase_counter 0}
		[unstore_unit]
		        variable=unit
		[/unstore_unit]
	[/event]
	
	[event]
		name=attack end
		first_time_only=no
		
		[filter_attack]
			special_id=qquws_battle_fury
		[/filter_attack]
		
		{VARIABLE unit.attack[$battle_fury_attack_id].damage $battle_fury_base_damage}
		[unstore_unit]
		        variable=unit
		[/unstore_unit]
		
		{CLEAR_VARIABLE battle_fury_attack_id,battle_fury_base_damage,fury_damage_increase_counter}
	[/event]
#enddef

#define REGISTER_CHRONOSPHERE
	[event]
		name=attack
		first_time_only=no
		
		[filter_second]
			ability=qquws_chronosphere
		[/filter_second]
		
		[filter]
			[not]
				trait=immune_to_specials
			[/not]

			[not]
				status=unslowable
			[/not]
		[/filter]
		
		[modify_unit]
			[filter]
				id=$unit.id
			[/filter]
			
			[status]
				slowed=yes
			[/status]
		[/modify_unit]
		
		[floating_text]
			x,y=$unit.x,$unit.y
			text="<span color='#45bdf5'>Slowed!</span>"
		[/floating_text]
	[/event]
	
	[event]
		name=attack
		first_time_only=no
		
		[filter_second]
			ability=qquws_lesser_chronosphere
		[/filter_second]
		
		[filter]
			[not]
				trait=immune_to_specials
			[/not]

			[not]
				status=unslowable
			[/not]
		[/filter]
		
		[filter_attack]
			range=melee
		[/filter_attack]
		
		[modify_unit]
			[filter]
				id=$unit.id
			[/filter]
			
			[status]
				slowed=yes
			[/status]
		[/modify_unit]
		
		[floating_text]
			x,y=$unit.x,$unit.y
			text="<span color='#45bdf5'>Slowed!</span>"
		[/floating_text]
	[/event]
#enddef

#define REGISTER_NECROMANCERS_BANE
	[event]
		name=attack end
		first_time_only=no
		
		[filter]
			ability=qquws_necromancers_bane
		[/filter]
		
		{VARIABLE necro_bane_reduce_near_units $unit.variables.fear_reduction}
		[if]
			[variable]
				name=second_unit.hitpoints
				less_than=1
			[/variable]
			[then]
				{VARIABLE_OP necro_bane_reduce_near_units add $unit.variables.fear_kill_reduction}
			[/then]
		[/if]
		
		[if]
			[variable]
				name=necro_bane_reduce_near_units
				greater_than=0
			[/variable]
			[then]
				{VARIABLE fear_check_unit_level $second_unit.level}
				{VARIABLE_OP fear_check_unit_level add $unit.variables.fear_increase_max_level}

				{VARIABLE unit_levels "0,1,2,3,4,5,6,7"}
				
				[switch]
					variable=fear_check_unit_level
					
					[case]
						value=0
						{VARIABLE unit_levels "0"}
					[/case]
					[case]
						value=1
						{VARIABLE unit_levels "0,1"}
					[/case]
					[case]
						value=2
						{VARIABLE unit_levels "0,1,2"}
					[/case]
					[case]
						value=3
						{VARIABLE unit_levels "0,1,2,3"}
					[/case]
					[case]
						value=4
						{VARIABLE unit_levels "0,1,2,3,4"}
					[/case]
					[case]
						value=5
						{VARIABLE unit_levels "0,1,2,3,4,5"}
					[/case]
					[case]
						value=6
						{VARIABLE unit_levels "0,1,2,3,4,5,6"}
					[/case]
				[/switch]

				{VARIABLE minimum_damage_required "$( floor( 60.0 / $necro_bane_reduce_near_units ) )"}
				
				[modify_unit]
					[filter]
						[filter_location]
							x,y=$second_unit.x,$second_unit.y
							radius=$unit.variables.fear_radius
							[filter_radius]
								terrain="!,_off^_usr,X*,M*^X*"
							[/filter_radius]
						[/filter_location]
						
						[filter_side]
							[enemy_of]
								side=$unit.side
							[/enemy_of]
						[/filter_side]
						
						level=$unit_levels
						
						[not]
							ability=qquws_necro_alarmed
						[/not]
					[/filter]
						
					[object]
						silent=yes
						duration=turn end
						
						[effect]
							apply_to=new_ability
							[abilities]
								[dummy]
									id=qquws_necro_alarmed
									name="<span color='#db524d'>alarmed</span>"
									description="This unit is alarmed by the presence of the Necromancer's Bane. It's damage is reduced by $necro_bane_reduce_near_units|% (half of this value if it is a champion, Butcher of Wesnoth, fearless unit or a leader)."
								[/dummy]
							[/abilities]
						[/effect]
						[effect]
						     apply_to=attack
						     remove_specials=qquws_bane_alarmed_dmg
						     [set_specials]
						    	  	mode=append
						     		[damage]
										id=qquws_bane_alarmed_dmg
										name=""
										description=""
										apply_to=self
										multiply="( (100.0 - if(self.traits.immune_to_specials or self.traits.fearless or self.canrecruit, $necro_bane_reduce_near_units / 2.0, $necro_bane_reduce_near_units)) / 100.0 )"
										[filter_base_value]
											greater_than_equal_to=$minimum_damage_required
										[/filter_base_value]
									[/damage]
						     [/set_specials]
						 [/effect]
						
						[effect]
						    apply_to=image_mod
						    add="~CS(+40,+40,+40)~BW(220)"
						[/effect]
					[/object]
				[/modify_unit]
			[/then]
		[/if]
	[/event]
#enddef

#define REGISTER_PREEMPTIVE_STRIKE
	[event]
		name=attack
		first_time_only=no
		
		[filter_attack]
			special_id=qquws_preemptive_strike
		[/filter_attack]
		
		{VARIABLE_OP preemptive_calculate_chance rand 0..99}
		{VARIABLE chance_check_against $unit.variables.preemptive_strike_chance}

		[if]
			[have_unit]
				id=$second_unit.id
				trait=qquws_champion_trait
			[/have_unit]
			[then]
				{VARIABLE chance_check_against $unit.variables.preemptive_strike_champion_chance}
			[/then]
		[/if]

		[if]
			[variable]
				name=preemptive_calculate_chance
				less_than=$chance_check_against
			[/variable]
			[then]
				{VARIABLE harm_damage "$( ceil($weapon.damage * $unit.variables.preemptive_strike_damage * 0.01) )"}
				
				[floating_text]
					x,y=$unit.x,$unit.y
					text="<span color='#d12e33' size='medium'>strike!</span>"
				[/floating_text]
				
				[harm_unit]
					[filter]
						id=$second_unit.id
					[/filter]
					
					[filter_second]
						id=$unit.id
					[/filter_second]
					
					[primary_attack]
						name=$weapon.name
					[/primary_attack]
					
					animate=yes
					experience=yes
					fire_event=yes
					alignment=$unit.alignment
					damage_type=$weapon.type
					amount=$harm_damage
					kill=yes
					delay=0
				[/harm_unit]
			[/then]
			[else]
				[animate_unit]
					flag=attack
					[filter]
						id=$unit.id
					[/filter]
					[primary_attack]
						name=$weapon.name
					[/primary_attack]
					
					hits=no
				[/animate_unit]
				
				[floating_text]
					x,y=$second_unit.x,$second_unit.y
					text="<span color='#65b8b5' size='medium'>miss!</span>"
				[/floating_text]
			[/else]
		[/if]
	[/event]
	
	[event]
		name=attack
		first_time_only=no
		
		[filter_attack]
			special_id=qquws_initiative
		[/filter_attack]

		{VARIABLE_OP preemptive_calculate_chance rand 1..10}
		{VARIABLE chance_check_against 8}

		[if]
			[have_unit]
				id=$second_unit.id
				trait=qquws_champion_trait
			[/have_unit]
			[then]
				{VARIABLE chance_check_against 6}
			[/then]
		[/if]

		[if]
			[variable]
				name=preemptive_calculate_chance
				less_than=$chance_check_against
			[/variable]
			[then]
				{VARIABLE harm_damage "$( $weapon.damage * 1.25 )"}
				{VARIABLE_OP harm_damage round floor}
				
				[floating_text]
					x,y=$unit.x,$unit.y
					text="<span color='#d12e33' size='medium'>initiative!</span>"
				[/floating_text]
				
				[harm_unit]
					[filter]
						id=$second_unit.id
					[/filter]
					
					[filter_second]
						id=$unit.id
					[/filter_second]
					
					[primary_attack]
						name=$weapon.name
					[/primary_attack]
					
					animate=yes
					experience=yes
					fire_event=yes
					alignment=$unit.alignment
					damage_type=$weapon.type
					amount=$harm_damage
					kill=yes
					delay=0
				[/harm_unit]
			[/then]
			[else]
				[animate_unit]
					flag=attack
					[filter]
						id=$unit.id
					[/filter]
					[primary_attack]
						name=$weapon.name
					[/primary_attack]
					
					hits=no
				[/animate_unit]
				
				[floating_text]
					x,y=$second_unit.x,$second_unit.y
					text="<span color='#65b8b5' size='medium'>initiative miss!</span>"
				[/floating_text]
			[/else]
		[/if]
	[/event]
	
	[event]
		name=attack
		first_time_only=no
		
		[filter_second_attack]
			special_id=qquws_initiative
		[/filter_second_attack]
		
		{VARIABLE_OP preemptive_calculate_chance rand 1..10}
		{VARIABLE chance_check_against 8}

		[if]
			[have_unit]
				id=$unit.id
				trait=qquws_champion_trait
			[/have_unit]
			[then]
				{VARIABLE chance_check_against 6}
			[/then]
		[/if]

		[if]
			[variable]
				name=preemptive_calculate_chance
				less_than=$chance_check_against
			[/variable]
			[then]
				{VARIABLE harm_damage "$( $second_weapon.damage * 1.25 )"}
				{VARIABLE_OP harm_damage round floor}
				
				[floating_text]
					x,y=$second_unit.x,$second_unit.y
					text="<span color='#d12e33' size='medium'>initiative!</span>"
				[/floating_text]
				
				[harm_unit]
					[filter]
						id=$unit.id
					[/filter]
					
					[filter_second]
						id=$second_unit.id
					[/filter_second]
					
					[primary_attack]
						name=$second_weapon.name
					[/primary_attack]
					
					animate=yes
					experience=no
					fire_event=yes
					alignment=$second_unit.alignment
					damage_type=$second_weapon.type
					amount=$harm_damage
					kill=yes
					delay=0
				[/harm_unit]
			[/then]
			[else]
				[animate_unit]
					flag=attack
					[filter]
						id=$second_unit.id
					[/filter]
					[primary_attack]
						name=$second_weapon.name
					[/primary_attack]
					
					hits=no
				[/animate_unit]
				
				[floating_text]
					x,y=$second_unit.x,$second_unit.y
					text="<span color='#65b8b5' size='medium'>initiative miss!</span>"
				[/floating_text]
			[/else]
		[/if]
	[/event]
#enddef

#define REGISTER_BATTLE_FERVOR
	{UNIT_BASED_GLOBAL_ALLY_BUFF qquws_battle_fervor_trait qquws_battle_fervor apply_battle_fervor_to_all_allies "battle fervor" "This unit benefits from the battle fervor aura. It's movement points are increased by $global_buff_unit.variables.battle_fervor_mp|." (
		[effect]
		    apply_to=movement
		    increase=$global_buff_unit.variables.battle_fervor_mp
		[/effect]
	) (
		[if]
			[variable]
				name=uws_game.is_pvp
				boolean_equals=yes
			[/variable]
			[then]
				[store_unit]
					[filter]
						side=$unit.side
						ability=qquws_battle_fervor
					[/filter]
					
					variable=global_buff_unit
					mode=always_clear
				[/store_unit]
			[/then]
			[else]
				[store_unit]
					[filter]
						ability=qquws_battle_fervor
						
						[filter_side]
							[allied_with]
								side=$unit.side
							[/allied_with]
						[/filter_side]
					[/filter]
					
					variable=global_buff_unit
					mode=always_clear
				[/store_unit]
			[/else]
		[/if]
	)}
#enddef

#define REGISTER_ENEMY_CONTROL
	{UNIT_BASED_GLOBAL_ALLY_BUFF qquws_enemy_control_trait qquws_enemy_control apply_enemy_control_to_all_allies "enemy control" "This unit can control how the enemies behave and therefore ignores their zone of control." (
		[effect]
			apply_to=new_ability
			[abilities]
				[skirmisher]
					id=qquws_enemy_control_skirmisher
					name=""
					description=""
					affect_self=yes
				[/skirmisher]
			[/abilities]
		[/effect]
	) ()}
#enddef

#define REGISTER_RETRIBUTION
	[event]
		name=attack
		first_time_only=no
		
		[filter_second_attack]
			special_id=qquws_retribution
		[/filter_second_attack]
		
		{VARIABLE retribution_no_of_strikes_left $second_weapon.number}
	[/event]
	
	[event]
		name=attacker hits
		first_time_only=no
		
		[filter_second_attack]
			special_id=qquws_retribution
		[/filter_second_attack]
		
		[if]
			[variable]
				name=second_unit.hitpoints
				greater_than=0
			[/variable]
			[and]
				[variable]
					name=retribution_no_of_strikes_left
					greater_than=0
				[/variable]
			[/and]
			[then]
				[modify_unit]
					[filter]
						find_in=second_unit
					[/filter]
					
					[status]
						qquws_retribution=yes
					[/status]
				[/modify_unit]
				
				[floating_text]
					x,y=$second_unit.x,$second_unit.y
					text="<span color='#ff0000'>Retribution!</span>"
				[/floating_text]
				
				{VARIABLE_OP retribution_no_of_strikes_left sub 1}
			[/then]
		[/if]
	[/event]
	
	[event]
		name=attacker misses
		first_time_only=no
		
		[filter_second_attack]
			special_id=qquws_retribution
		[/filter_second_attack]
		
		[modify_unit]
			[filter]
				find_in=second_unit
			[/filter]
			
			[status]
				qquws_retribution=no
			[/status]
		[/modify_unit]
		
		{VARIABLE_OP retribution_no_of_strikes_left sub 1}
	[/event]
	
	[event]
		name=attack end
		first_time_only=no
		
		[filter_second_attack]
			special_id=qquws_retribution
		[/filter_second_attack]
		
		[modify_unit]
			[filter]
				find_in=second_unit
			[/filter]
			
			[status]
				qquws_retribution=no
			[/status]
		[/modify_unit]
		
		{CLEAR_VARIABLE retribution_no_of_strikes_left}
	[/event]
#enddef

#define REGISTER_ENDURANCE
	[event]
		name=attacker hits
		first_time_only=no
		
		[filter_second]
			ability=qquws_endurance
		[/filter_second]
		
		[if]
			[variable]
				name=second_unit.variables.qquws_endurance_types
				contains=$weapon.type
			[/variable]
			[then]
				[fire_event]
					name=qquws_apply_endurance
					
					[primary_unit]
						id=$second_unit.id
					[/primary_unit]
					[secondary_unit]
						id=$unit.id
					[/secondary_unit]
				[/fire_event]
			[/then]
		[/if]
	[/event]
	
	[event]
		name=defender hits
		first_time_only=no
		
		[filter]
			ability=qquws_endurance
		[/filter]

		[if]
			[variable]
				name=unit.variables.qquws_endurance_types
				contains=$second_weapon.type
			[/variable]
			[then]
				[fire_event]
					name=qquws_apply_endurance
					
					[primary_unit]
						id=$unit.id
					[/primary_unit]
					[secondary_unit]
						id=$second_unit.id
					[/secondary_unit]
				[/fire_event]
			[/then]
		[/if]
	[/event]
	
	[event]
		name=qquws_apply_endurance
		first_time_only=no

		[if]
			[variable]
				name=unit.hitpoints
				greater_than=0
			[/variable]
			[then]
				{VARIABLE endurance_regen_value "$( 0.01 * $unit.variables.qquws_endurance_regen_factor * $damage_inflicted )"}
				{VARIABLE_OP endurance_regen_value round ceil}

				[heal_unit]
					[filter]
						id=$unit.id
					[/filter]
					
					amount=$endurance_regen_value
					restore_statuses=no
				[/heal_unit]

				[floating_text]
					x,y=$x1,$y1
					text="<span color='#00ff00'>+$endurance_regen_value</span>"
				[/floating_text]

				{CLEAR_VARIABLE endurance_regen_value}
			[/then]
		[/if]
	[/event]
#enddef

#define REGISTER_TERRAIN_KNOWLEDGE
	{UNIT_BASED_GLOBAL_ALLY_BUFF qquws_terrain_knowledge_trait qquws_terrain_knowledge apply_terrain_knowledge_to_all_allies "improved terrain knowledge" "This unit can better understand different terrains.
defense everywhere +5" (
		[effect]
			apply_to=defense
			replace=no
			[defense]
				flat=-5
				frozen=-5
				forest=-5
				hills=-5
				mountains=-5
				village=-5
				swamp_water=-5
				shallow_water=-5
				deep_water=-5
				reef=-5
				castle=-5
				cave=-5
				sand=-5
				fungus=-5
			[/defense]
		[/effect]
	) ()}
#enddef

#define REGISTER_TERRAIN_MASTERY
	{UNIT_BASED_GLOBAL_ALLY_BUFF qquws_terrain_mastery_trait qquws_terrain_mastery apply_terrain_mastery_to_all_allies "improved terrain knowledge" "This unit can better understand different terrains thanks the knowledge of the cartographer.
defense everywhere +10
movements costs -1" (
		[effect]
			apply_to=defense
			replace=no
			[defense]
				flat=-10
				frozen=-10
				forest=-10
				hills=-10
				mountains=-10
				village=-10
				swamp_water=-10
				shallow_water=-10
				deep_water=-10
				reef=-10
				castle=-10
				cave=-10
				sand=-10
				fungus=-10
			[/defense]
		[/effect]
		[effect]
		    apply_to=movement_costs
		    replace=no
		    [movement_costs]
				flat=-1
				frozen=-1
				forest=-1
				hills=-1
				mountains=-1
				village=-1
				swamp_water=-1
				shallow_water=-1
				deep_water=-1
				reef=-1
				castle=-1
				cave=-1
				sand=-1
				fungus=-1
		    [/movement_costs]
		[/effect]
	) ()}
#enddef

#define REGISTER_SHARPSHOOTER
	[event]
		name=attacker hits
		first_time_only=no

		[filter_attack]
			special_id=qquws_sharpshooter
		[/filter_attack]

		[if]
			[have_unit]
				formula="enemy_of(sharpshooter, second_target) and not second_target.petrified and not first_target.traits.immune_to_specials
					    where
					    first_target = unit_at(loc($second_unit.x, $second_unit.y)),
						second_target = unit_at(direction_from(loc($unit.x, $unit.y), $unit.facing, 2)),
						sharpshooter = unit_at(loc($unit.x, $unit.y))"
			[/have_unit]
			[then]
				{VARIABLE_OP sharpshooter_chance rand 1..100}
				{VARIABLE sharpshooter_damage "$( floor($damage_inflicted * $unit.variables.sharpshooter_fraction * 0.01) )"}

				[if]
					[variable]
						name=sharpshooter_chance
						less_than=$unit.variables.sharpshooter_chance
					[/variable]
					[and]
						[variable]
							name=sharpshooter_damage
							greater_than=0
						[/variable]
					[/and]
					[then]
						[store_locations]
							[filter_adjacent_location]
								x,y=$second_unit.x,$second_unit.y
								adjacent=-$unit.facing
							[/filter_adjacent_location]

							variable=sharpshooter_target
							mode=replace
						[/store_locations]

						[harm_unit]
							[filter]
								x,y=$sharpshooter_target.x,$sharpshooter_target.y
							[/filter]
							
							[filter_second]
								id=$unit.id
							[/filter_second]
							
							amount=$sharpshooter_damage
							damage_type=$weapon.type
							alignment=$unit.alignment
							kill=yes
							animate=no
							experience=yes
							fire_event=yes
							delay=0
						[/harm_unit]
					[/then]
				[/if]
			[/then]
		[/if]
	[/event]
#enddef

#define REGISTER_CORRUPTION
	[event]
		name=attack end
		first_time_only=no

		[filter_attack]
			special_id=qquws_corruption
		[/filter_attack]

		[filter_second]
			[not]
				canrecruit=yes
			[/not]

			[not]
				trait=immune_to_specials
			[/not]

			[not]
				trait=qquws_enraged_trait
			[/not]
		[/filter_second]

		[if]
			[variable]
				name=second_unit.hitpoints
				greater_than=0
			[/variable]
			[and]
				[have_unit]
					trait=qquws_corrupted_trait
					side=$unit.side
					count=0
				[/have_unit]
			[/and]
			[then]
				{VARIABLE_OP corruption_rand rand 1..100}
				{VARIABLE corruption_chance_compare "$( 50 + 20 * ( $unit.level - $second_unit.level ) )"}

				[if]
					[variable]
						name=corruption_rand
						less_than_equal_to=$corruption_chance_compare
					[/variable]
					[then]
						[modify_unit]
							[filter]
								id=$second_unit.id
							[/filter]

							side=$unit.side

							[trait]
								id=qquws_corrupted_trait
								name=corrupted
								description="This unit is corrupted."
							[/trait]
						[/modify_unit]

						[floating_text]
							x,y=$second_unit.x,$second_unit.y
							text="<span color='#138755' size='large'>Corrupted!</span>"
						[/floating_text]
					[/then]
					[else]
						[modify_unit]
							[filter]
								id=$second_unit.id
							[/filter]

							[trait]
								id=qquws_enraged_trait
								name=enraged
								description="This unit is enraged by your audacious proposition. It can no longer be corrupted."
								
								[effect]
								     apply_to=attack
								     increase_damage=40%
								[/effect]
							[/trait]
						[/modify_unit]

						[floating_text]
							x,y=$second_unit.x,$second_unit.y
							text="<span color='#a80c0c' size='large'>Enraged!</span>"
						[/floating_text]
					[/else]
				[/if]
			[/then]
		[/if]
	[/event]
#enddef

#define REGISTER_UNPOISONABLE_AURA
	{UNIT_BASED_GLOBAL_ALLY_BUFF qquws_unpoisonable_trait qquws_unpoisonable_aura apply_unpoisonable_aura_to_all_allies "immune to poison" "This unit can not be poisoned." (
		[effect]
			apply_to=status
			add=unpoisonable
		[/effect]
	) ()}
#enddef

#define REGISTER_UNDRAINABLE_AURA
	{UNIT_BASED_GLOBAL_ALLY_BUFF qquws_undrainable_trait qquws_undrainable_aura apply_undrainable_aura_to_all_allies "immune to drain" "This unit can not be drained." (
		[effect]
			apply_to=status
			add=undrainable
		[/effect]
	) ()}
#enddef

#define REGISTER_UNSLOWABLE_AURA
	{UNIT_BASED_GLOBAL_ALLY_BUFF qquws_unslowable_trait qquws_unslowable_aura apply_unslowable_aura_to_all_allies "immune to slow" "This unit can not be slowed." (
		[effect]
			apply_to=status
			add=unslowable
		[/effect]
	) ()}
#enddef

#define REGISTER_POISON_AOE
	[event]
		name=turn refresh
		first_time_only=no

		[filter_condition]
			[have_unit]
				side=$side_number
				ability=qquws_poison_aura
			[/have_unit]
		[/filter_condition]

		[store_unit]
			[filter]
				side=$side_number
				ability=qquws_poison_aura
			[/filter]

			variable=poison_aura_units
			mode=always_clear
			kill=no
		[/store_unit]

		[for]
			array=poison_aura_units
			variable=i
			[do]
				[harm_unit]
					[filter]
						[filter_location]
							x,y=$poison_aura_units[$i].x,$poison_aura_units[$i].y
							radius=$poison_aura_units[$i].variables.poison_aura_radius
							[filter_radius]
								terrain="!,_off^_usr,X*,M*^X*"
							[/filter_radius]
						[/filter_location]
						
						[filter_side]
							[enemy_of]
								side=$side_number
							[/enemy_of]
						[/filter_side]

						[not]
							status=unpoisonable,invulnerable
						[/not]
					[/filter]

					[filter_second]
						id=$poison_aura_units[$i].y
					[/filter_second]

					amount=$poison_aura_units[$i].variables.poison_aura_dmg
					kill=no
					fire_event=no
					experience=no
					animate=yes
					poisoned=yes
					delay=0
				[/harm_unit]
			[/do]
		[/for]

		{CLEAR_VARIABLE poison_aura_units}
	[/event]
#enddef

#define REGISTER_FIGHT_ENDURANCE
	[event]
		name=attack
		first_time_only=no

		[filter]
			ability=qquws_fight_endurance
		[/filter]

		{VARIABLE fight_endurance_starting_hitpoints $unit.hitpoints}
	[/event]

	[event]
		name=attack end
		first_time_only=no

		[filter]
			ability=qquws_fight_endurance
		[/filter]

		[if]
			[variable]
				name=unit.hitpoints
				greater_than=0
			[/variable]
			[and]
				[variable]
					name=unit.hitpoints
					less_than=$fight_endurance_starting_hitpoints
				[/variable]
			[/and]
			[then]
				{VARIABLE endurance_regen_value "$( floor(0.01 * $unit.variables.fight_endurance_reduction * ( $fight_endurance_starting_hitpoints - $unit.hitpoints ) ) )"}

				[if]
					[variable]
						name=endurance_regen_value
						greater_than=0
					[/variable]
					[then]
						[heal_unit]
							[filter]
								id=$unit.id
							[/filter]
							
							amount=$endurance_regen_value
							restore_statuses=no
						[/heal_unit]

						[floating_text]
							x,y=$unit.x,$unit.y
							text="<span color='#00ff00'>+$endurance_regen_value endurance</span>"
						[/floating_text]
					[/then]
				[/if]

				{CLEAR_VARIABLE endurance_regen_value}
			[/then]
		[/if]
	[/event]
#enddef

#define REGISTER_AOE_DRAIN
	[event]
		name=turn refresh
		first_time_only=no

		[filter_condition]
			[have_unit]
				side=$side_number
				ability=qquws_aoe_draining
			[/have_unit]
		[/filter_condition]

		[store_unit]
			[filter]
				side=$side_number
				ability=qquws_aoe_draining
			[/filter]

			variable=aoe_draining_units
			mode=always_clear
			kill=no
		[/store_unit]

		[for]
			array=aoe_draining_units
			variable=i
			[do]
				[harm_unit]
					[filter]
						[filter_adjacent]
							id=$aoe_draining_units[$i].id
							is_enemy=yes
						[/filter_adjacent]
					[/filter]

					[filter_second]
						id=$aoe_draining_units[$i].id
					[/filter_second]

					amount=$aoe_draining_units[$i].variables.drain_base
					alignment=$aoe_draining_units[$i].alignment
					kill=no
					fire_event=yes
					experience=no
					animate=yes
					variable=harmed_units
					delay=0
				[/harm_unit]

				{VARIABLE total_drained 0}
				[for]
					array=harmed_units
					variable=j
					[do]
						{VARIABLE_OP total_drained add $harmed_units[$j].harm_amount}
					[/do]
				[/for]

				{VARIABLE_OP total_drained multiply $aoe_draining_units[$i].variables.aoe_drains_heal_factor}
				{VARIABLE_OP total_drained round floor}

				[if]
					[variable]
						name=total_drained
						greater_than=0
					[/variable]
					[then]
						[heal_unit]
							[filter]
								id=$aoe_draining_units[$i].id
							[/filter]

							amount=$total_drained
							animate=yes
							restore_statuses=no
							restore_attacks=no
						[/heal_unit]
					[/then]
				[/if]
			[/do]
		[/for]

		{CLEAR_VARIABLE harmed_units,total_drained,aoe_draining_units}
	[/event]
#enddef

#define REGISTER_MOTILITY_MASTERY_AOE
	[event]
		name=turn refresh
		first_time_only=no

		[filter_condition]
			[have_unit]
				side=$side_number
				ability=qquws_motility_aoe
			[/have_unit]
		[/filter_condition]

		[store_unit]
			[filter]
				side=$side_number
				ability=qquws_motility_aoe
			[/filter]

			variable=slow_mastery_unit
			mode=always_clear
			kill=no
		[/store_unit]

		[modify_unit]
			[filter]
				[filter_adjacent]
					id=$slow_mastery_unit.id
					is_enemy=yes
				[/filter_adjacent]

				[not]
					trait=immune_to_specials
				[/not]

				[not]
					status=unslowable
				[/not]
			[/filter]

			[object]
				silent=yes
				duration=turn end
				
				[effect]
				    apply_to=movement
				    set=0
				[/effect]
				[effect]
				    apply_to=zoc
				    value=no
				[/effect]
				[effect]
				    apply_to=image_mod
				    add="~SWAP(red, red, red)"
				[/effect]
				[effect]
				    apply_to=overlay
				    add=halo/uws/immobilise.png
				[/effect]
				[effect]
				    apply_to=new_ability
				    [abilities]
						[dummy]
							id=qquws_immobilised_status
							name="<span color='#8c914e'>Immobilised</span>"
							description="This unit is immobilised and cannot move for one turn."
						[/dummy]
				    [/abilities]
				[/effect]
			[/object]
		[/modify_unit]
	[/event]
#enddef

#define REGISTER_FIGHT_REGEN
	[event]
		name=attack end
		first_time_only=no
		
		[filter]
			ability=qquws_fight_regen
		[/filter]
		
		[if]
			[variable]
				name=unit.hitpoints
				greater_than=1
			[/variable]
			[then]
				[heal_unit]
					[filter]
						id=$unit.id
					[/filter]
					
					amount=$unit.variables.qquws_fight_regen_amount
					animate=yes
					restore_statuses=no
				[/heal_unit]
			[/then]
		[/if]
	[/event]

	[event]
		name=attack end
		first_time_only=no
		
		[filter_second]
			ability=qquws_fight_regen
		[/filter_second]
		
		[if]
			[variable]
				name=second_unit.hitpoints
				greater_than=1
			[/variable]
			[then]
				[heal_unit]
					[filter]
						id=$second_unit.id
					[/filter]
					
					amount=$second_unit.variables.qquws_fight_regen_amount
					animate=yes
					restore_statuses=no
				[/heal_unit]
			[/then]
		[/if]
	[/event]
#enddef

#define REGISTER_SECRET_FIRE
	[event]
		name=turn refresh
		first_time_only=no

		[filter_condition]
			[have_unit]
				side=$side_number
				ability=qquws_secret_fire
			[/have_unit]
		[/filter_condition]

		[store_unit]
			[filter]
				side=$side_number
				ability=qquws_secret_fire
			[/filter]

			variable=secret_fire_unit
			mode=always_clear
			kill=no
		[/store_unit]

		[harm_unit]
			[filter]
				[filter_adjacent]
					id=$secret_fire_unit.id
					is_enemy=yes
				[/filter_adjacent]
			[/filter]

			[filter_second]
				id=$secret_fire_unit.id
			[/filter_second]
			
			amount=$secret_fire_unit.variables.secret_fire_adjacent
			alignment=$secret_fire_unit.alignment
			damage_type=fire
			kill=yes
			fire_event=yes
			animate=yes
			experience=kill
			delay=0
		[/harm_unit]

		{CLEAR_VARIABLE secret_fire_unit}
	[/event]

	[event]
		name=attack
		first_time_only=no
		
		[filter_second]
			ability=qquws_secret_fire
		[/filter_second]

		{VARIABLE secret_fire_harm_amount $second_unit.variables.secret_fire_defending}
		[if]
			[variable]
				name=weapon.range
				not_equals=melee
			[/variable]
			[or]
				[have_unit]
					id=$unit.id
					trait=immune_to_specials
					count=1
				[/have_unit]
			[/or]
			[then]
				{VARIABLE_OP secret_fire_harm_amount divide 2}
				{VARIABLE_OP secret_fire_harm_amount round floor}
			[/then]
		[/if]
		
		[if]
			[variable]
				name=secret_fire_harm_amount
				greater_than=0
			[/variable]
			[then]
				[harm_unit]
					[filter]
						id=$unit.id
					[/filter]

					[filter_second]
						id=$second_unit.id
					[/filter_second]
					
					amount=$secret_fire_harm_amount
					alignment=$second_unit.alignment
					damage_type=fire
					kill=yes
					fire_event=yes
					animate=yes
					experience=yes
					delay=0
				[/harm_unit]
			[/then]
		[/if]

		{CLEAR_VARIABLE secret_fire_harm_amount}
	[/event]
#enddef

#define REGISTER_FIRE_VISION
	{UNIT_BASED_GLOBAL_ALLY_BUFF qquws_fire_vision_trait qquws_fire_vision apply_fire_vision_to_all_allies "fire vision" "This unit benefits from the fire vision aura. It's vision points are increased by $global_buff_unit.variables.fire_vision_bonus|." (
		[effect]
		    apply_to=vision
		    increase=$global_buff_unit.variables.fire_vision_bonus
		[/effect]
	) (
		[if]
			[variable]
				name=uws_game.is_pvp
				boolean_equals=yes
			[/variable]
			[then]
				[store_unit]
					[filter]
						side=$unit.side
						ability=qquws_fire_vision
					[/filter]
					
					variable=global_buff_unit
					mode=always_clear
				[/store_unit]
			[/then]
			[else]
				[store_unit]
					[filter]
						ability=qquws_fire_vision
						
						[filter_side]
							[allied_with]
								side=$unit.side
							[/allied_with]
						[/filter_side]
					[/filter]
					
					variable=global_buff_unit
					mode=always_clear
				[/store_unit]
			[/else]
		[/if]
	)}
#enddef

#define REGISTER_LEADS_BY_EXAMPLE
	[event]
		name=attack
		first_time_only=no

		[filter]
			ability=qquws_leads_by_example
		[/filter]

		{VARIABLE hack no}
		[if]
			[have_unit]
				id=$second_unit.id
				trait=immune_to_specials
			[/have_unit]
			[then]
				{VARIABLE hack yes}
			[/then]
		[/if]
		{VARIABLE trigger_leads_by_example "$( if($hack or ($unit.level <= $second_unit.level and $second_unit.hitpoints > 0.5 * $second_unit.max_hitpoints), 1, 0) )"}

		[if]
			[variable]
				name=trigger_leads_by_example
				numerical_equals=1
			[/variable]
			[then]
				[modify_unit]
					[filter]
						side=$unit.side

						[not]
							id=$unit.id
						[/not]

						formula="if(attacks_left > 0 and moves = max_moves, 1, 0)"
					[/filter]

					moves="$( $this_unit.max_moves + 1 )"
						
					[object]
						silent=yes
						duration=turn end
						
						[effect]
						    apply_to=attack
						    increase_damage="$unit.variables.qquws_leads_by_example_buff|%"
						[/effect]
						[effect]
						    apply_to=overlay
						    add=misc/new-battle2.png
						[/effect]
					[/object]
				[/modify_unit]
				
				[floating_text]
					x,y=$unit.x,$unit.y
					text="<span color='#f56642' size='medium'>FOR THE GLORY!!!</span>"
				[/floating_text]
			[/then]
		[/if]

		{CLEAR_VARIABLE trigger_leads_by_example,hack}
	[/event]
#enddef

#define REGISTER_GREAT_LEADER
	[event]
		name=die
		first_time_only=no

		[filter_second]
			ability=qquws_great_leader
		[/filter_second]

		{VARIABLE experience_given 4}
		[if]
			[variable]
				name=unit.level
				greater_than=0
			[/variable]
			[then]
				{VARIABLE experience_given "$( $unit.level * 8)"}
			[/then]
		[/if]

		{VARIABLE experience_given "$( floor($experience_given * 0.01 * $second_unit.variables.qquws_great_leader_teaching_rate) )"}

		[if]
			[variable]
				name=experience_given
				greater_than=0
			[/variable]
			[then]
				[modify_unit]
					[filter]
						[filter_adjacent]
							x,y=$second_unit.x,$second_unit.y
							is_enemy=no
						[/filter_adjacent]
					[/filter]
						
					[object]
						silent=yes
						
						[effect]
						    apply_to=experience
						    increase=$experience_given
						[/effect]
					[/object]
				[/modify_unit]
				
				[floating_text]
					x,y=$second_unit.x,$second_unit.y
					text="<span color='#31a0e0' size='medium'>mentoring</span>"
				[/floating_text]
			[/then]
		[/if]
	[/event]
#enddef

#define REGISTER_TREATS_WOUNDED
	[event]
		name=last breath
		first_time_only=no

		[filter]
			id=$unit.id
			canrecruit=no
			[filter_adjacent]
				is_enemy=no
				ability=qquws_treats_wounded
			[/filter_adjacent]
		[/filter]

		[if]
			[variable]
				name=unit.level
				greater_than=0
			[/variable]
			[then]
				[fire_event]
					name=handle_unit_sent_to_hospital

					[primary_unit]
						id=$unit.id
					[/primary_unit]
				[/fire_event]
			[/then]
		[/if]
	[/event]

	[event]
		name=handle_unit_sent_to_hospital
		first_time_only=no

		[store_unit]
			[filter]
				ability=qquws_treats_wounded
				
				[filter_adjacent]
					id=$unit.id
					is_enemy=no
				[/filter_adjacent]
			[/filter]
			
			variable=healer_unit
			mode=always_clear
		[/store_unit]

		[floating_text]
			x,y=$unit.x,$unit.y
			text="<span color='#f56c42' size='medium'>It's not over yet!</span>"
		[/floating_text]

		[modify_unit]
			[filter]
				id=$unit.id
			[/filter]

			[variables]
				hospital_treatment=yes
			[/variables]

			[object]
				silent=yes

				[effect]
					apply_to=recall_cost
					set=$healer_unit.variables.treats_wounded_hospital_cost
				[/effect]
			[/object]
		[/modify_unit]

		[put_to_recall_list]
			id=$unit.id
			heal=yes
		[/put_to_recall_list]
	[/event]

	[event]
		name=recall
		first_time_only=no

		[filter]
			[filter_wml]
				[variables]
					hospital_treatment=yes
				[/variables]
			[/filter_wml]
		[/filter]

		[if]
			[variable]
				name=unit.canrecruit
				boolean_equals=yes
			[/variable]
			[then]
				[floating_text]
					x,y=$second_unit.x,$second_unit.y
					text="<span color='#00ff00' size='medium'>The King is back!</span>"
				[/floating_text]

				[fire_event]
					name=select_new_side_leader

					[primary_unit]
						id=$unit.id
					[/primary_unit]

					[secondary_unit]
						id=$second_unit.id
					[/secondary_unit]
				[/fire_event]
			[/then]
		[/if]

		[modify_unit]
			[filter]
				id=$unit.id
			[/filter]

			[variables]
				hospital_treatment=no
			[/variables]

			[object]
				silent=yes

				[effect]
					apply_to=recall_cost
					set=20
				[/effect]
			[/object]
		[/modify_unit]
	[/event]
#enddef

#define REGISTER_DEFENSIVE_MASTERY
	[event]
		name=defender misses
		first_time_only=no
		
		[filter_attack]
			special_id=qquws_master_defender
		[/filter_attack]
		
		[object]
			id=qquws_master_defender_bonus_object
			take_only_once=no
			silent=yes
			
			[filter]
				id=$unit.id
			[/filter]

			[effect]
			    apply_to=attack
			    name=$weapon.name
			    increase_parry=5
			[/effect]
		[/object]
	[/event]

	[event]
		name=attacker misses
		first_time_only=no
		
		[filter_second_attack]
			special_id=qquws_master_defender
		[/filter_second_attack]
		
		[object]
			id=qquws_master_defender_bonus_object
			take_only_once=no
			silent=yes
			
			[filter]
				id=$second_unit.id
			[/filter]

			[effect]
			    apply_to=attack
			    name=$second_weapon.name
			    increase_parry=5
			[/effect]
		[/object]
	[/event]
	
	[event]
		name=attack end
		first_time_only=no
		
		[filter_attack]
			special_id=qquws_master_defender
		[/filter_attack]
		
		[if]
			[variable]
				name=unit.hitpoints
				greater_than=0
			[/variable]
			[then]
				[remove_object]
					id=$unit.id
					object_id=qquws_master_defender_bonus_object
				[/remove_object]
			[/then]
		[/if]
	[/event]

	[event]
		name=attack end
		first_time_only=no
		
		[filter_second_attack]
			special_id=qquws_master_defender
		[/filter_second_attack]
		
		[if]
			[variable]
				name=second_unit.hitpoints
				greater_than=0
			[/variable]
			[then]
				[remove_object]
					id=$second_unit.id
					object_id=qquws_master_defender_bonus_object
				[/remove_object]
			[/then]
		[/if]
	[/event]
#enddef

#define REGISTER_REFLECTS_MAGIC
	[event]
		name=attacker misses
		first_time_only=no

		[filter_attack]
			special_id=magical,AE_mag_magical_offensive,AE_mag_precision,AE_mag_enchanted,AE_mag_precision_offensive,AE_fut_ubiquitous,eoma_precision,eoma_enchanted,eoma_magical_offensive,eoma_precision_offensive
		[/filter_attack]
		
		[filter_second]
			ability=qquws_mirrored_blade_reflection
		[/filter_second]
		
		[filter_attack]
			range=ranged
			type=arcane,cold,fire,secret
		[/filter_attack]

		{VARIABLE reflected_damage "$( floor($weapon.damage * 0.85) )"}

		[harm_unit]
			[filter]
				id=$unit.id
			[/filter]

			[filter_second]
				id=$second_unit.id
			[/filter_second]
			
			amount=$reflected_damage
			alignment=neutral
			type=$weapon.type
			kill=yes
			animate=yes
			experience=no
			delay=0
		[/harm_unit]
	[/event]
#enddef

#define REGISTER_DARK_PACT
	[event]
		name=last breath
		first_time_only=no

		[filter]
			ability=qquws_dark_pact
		[/filter]

		# adding nested event like this almost guarantees that it is the last one in execution

		[event]
			name=die
			delayed_variable_substitution=yes

			[filter]
				ability=qquws_dark_pact
			[/filter]

			# prevent recursion
			[filter_second]
				[not]
					ability=qquws_dark_pact
				[/not]
			[/filter_second]

			[if]
				[variable]
					name=second_unit.id
					not_equals=""
				[/variable]
				[then]
					[floating_text]
						x,y=$unit.x,$unit.y
						text="<span color='#9a42b8'>Dark Pact!</span>"
					[/floating_text]

					[harm_unit]
						[filter]
							id=$second_unit.id
						[/filter]

						amount=100000
						kill=yes
						fire_event=yes
						experience=no
						animate=yes
						delay=500
					[/harm_unit]
				[/then]
			[/if]
		[/event]
	[/event]

	# @TODO once the underlying wesnoth issue is fixed (negative priority #9225) then this code can be uncommented the the above attack events removed


	# [event]
	# 	name=die
	# 	first_time_only=no
	# 	priority=-1

	# 	[filter]
	# 		ability=qquws_dark_pact
	# 	[/filter]

	# 	# prevent recursion
	# 	[filter_second]
	# 		[not]
	# 			ability=qquws_dark_pact
	# 		[/not]
	# 	[/filter_second]

	# 	[if]
	# 		[variable]
	# 			name=second_unit.id
	# 			not_equals=""
	# 		[/variable]
	# 		[then]
	# 			[floating_text]
	# 				x,y=$unit.x,$unit.y
	# 				text="<span color='#9a42b8'>Dark Pact!</span>"
	# 			[/floating_text]

	# 			[delay]
	# 				time=500
	# 				accelerate=yes
	# 			[/delay]

	# 			[kill]
	# 				id=$second_unit.id
	# 				fire_event=yes
	# 				animate=yes
	# 			[/kill]
	# 		[/then]
	# 	[/if]
	# [/event]
#enddef

#define REGISTER_SPORE_EXPLOSION
	[event]
		name=last breath
		first_time_only=no

		[filter]
			ability=qquws_fungoids_spore_explosion
		[/filter]

		[floating_text]
			x,y=$unit.x,$unit.y
			text="<span color='#f56042'>Spores!</span>"
		[/floating_text]

		[harm_unit]
			[filter]
				[filter_adjacent]
					id=$unit.id
					is_enemy=yes
				[/filter_adjacent]

				[not]
					trait=immune_to_specials
				[/not]

				[not]
					trait=qquws_epic_poison_trait
				[/not]

				[not]
					status=unpoisonable
				[/not]
			[/filter]

			[filter_second]
				id=$poison_mastery_unit.id
			[/filter_second]

			amount=0
			kill=no
			fire_event=no
			experience=yes
			animate=yes
			poisoned=yes
			delay=0
		[/harm_unit]

		[modify_unit]
			[filter]
				[filter_adjacent]
					id=$unit.id
					is_enemy=yes
				[/filter_adjacent]

				[not]
					trait=immune_to_specials
				[/not]

				[not]
					trait=qquws_fungoids_spore_carrier
				[/not]
			[/filter]

			[variables]
				spore_side=$unit.side
			[/variables]

			[trait]
				id=qquws_fungoids_spore_carrier
				name="spore carrier"
				description="This unit is a spore carrier. Upon dying it will spawn a hostile baby fungoids. There is no known cure to remove the spores."
			[/trait]
		[/modify_unit]
	[/event]
#enddef

#define REGISTER_FUNGOIDS_SPORES
	[event]
		name=attacker hits
		first_time_only=no
		
		[filter_attack]
			special_id=qquws_fungoids_spores
		[/filter_attack]
		
		[filter_second]
			[not]
				trait=qquws_fungoids_spore_carrier
			[/not]
		[/filter_second]

		[modify_unit]
			[filter]
				id=$second_unit.id

				[not]
					trait=immune_to_specials
				[/not]

				[not]
					trait=qquws_fungoids_spore_carrier
				[/not]
			[/filter]

			[variables]
				spore_side=$unit.side
			[/variables]

			[trait]
				id=qquws_fungoids_spore_carrier
				name="spore carrier"
				description="This unit is a spore carrier. Upon dying it will spawn a hostile baby fungoids. There is no known cure to remove the spores."
			[/trait]
		[/modify_unit]
	[/event]
	
	[event]
		name=defender hits
		first_time_only=no
		
		[filter_second_attack]
			special_id=qquws_fungoids_spores
		[/filter_second_attack]
		
		[filter]
			[not]
				trait=qquws_fungoids_spore_carrier
			[/not]
		[/filter]

		[modify_unit]
			[filter]
				id=$unit.id

				[not]
					trait=immune_to_specials
				[/not]

				[not]
					trait=qquws_fungoids_spore_carrier
				[/not]
			[/filter]

			[variables]
				spore_side=$second_unit.side
			[/variables]

			[trait]
				id=qquws_fungoids_spore_carrier
				name="spore carrier"
				description="This unit is a spore carrier. Upon dying it will spawn a hostile baby fungoids. There is no known cure to remove the spores."
			[/trait]
		[/modify_unit]
	[/event]
#enddef

#define REGISTER_FUNGOIDS_SPAWN
	[event]
		name=die
		first_time_only=no

		[filter]
			trait=qquws_fungoids_spore_carrier
		[/filter]

		[unit]
			type=QQ_baby_fungoid
			x=$unit.x
			y=$unit.y
			side=$unit.variables.spore_side
			passable=yes
			upkeep=loyal
			animate=yes
		[/unit]
	[/event]
#enddef

#define REGISTER_SOUND_OF_MADNESS
	[event]
		name=attacker hits
		first_time_only=no
		
		[filter_attack]
			special_id=qquws_sound_of_madness
		[/filter_attack]
		
		[filter_second]
			[not]
				trait=immune_to_specials
			[/not]

			[not]
				canrecruit=yes
			[/not]
		[/filter_second]

		{VARIABLE_OP madness_chance rand 0..9}

		[if]
			[variable]
				name=second_unit.hitpoints
				greater_than=0
			[/variable]
			[and]
				[variable]
					name=madness_chance
					less_than=5
				[/variable]
			[/and]
			[and]
				[variable]
					name=second_unit.level
					less_than=$unit.level
				[/variable]
			[/and]
			[then]
				[modify_unit]
					[filter]
						id=$second_unit.id
					[/filter]

					side=$unit.side

					[variables]
						qquws_madness_original_side=$second_unit.side
					[/variables]

					[trait]
						id=qquws_archwitch_madness_$unit.id
						name="<span color='#eb4934'>insane</span>"
						description="This unit is under the influence of the Archwitch and will obey all her commands."

						[effect]
							apply_to=image_mod
							add="~CS(25,25,90)"
						[/effect]
					[/trait]
				[/modify_unit]

				[store_unit]
					[filter]
						find_in=second_unit
					[/filter]
					
					variable=qquws_interrupt_target
					kill=yes
				[/store_unit]
				
				{VARIABLE qquws_interrupt_target.variables.qquws_interrupt yes}
			[/then]
		[/if]
	[/event]

	[event]
		name=defender hits
		first_time_only=no
		
		[filter_second_attack]
			special_id=qquws_sound_of_madness
		[/filter_second_attack]
		
		[filter]
			[not]
				trait=immune_to_specials
			[/not]

			[not]
				canrecruit=yes
			[/not]
		[/filter]

		{VARIABLE_OP madness_chance rand 0..9}

		[if]
			[variable]
				name=unit.hitpoints
				greater_than=0
			[/variable]
			[and]
				[variable]
					name=madness_chance
					less_than=5
				[/variable]
			[/and]
			[and]
				[variable]
					name=unit.level
					less_than=$second_unit.level
				[/variable]
			[/and]
			[then]
				[modify_unit]
					[filter]
						id=$unit.id
					[/filter]

					side=$second_unit.side

					[variables]
						qquws_madness_original_side=$unit.side
					[/variables]

					[trait]
						id=qquws_archwitch_madness_$second_unit.id
						name="<span color='#eb4934'>insane</span>"
						description="This unit is under the influence of the Archwitch and will obey all her commands."

						[effect]
							apply_to=image_mod
							add="~CS(25,25,90)"
						[/effect]
					[/trait]
				[/modify_unit]

				[store_unit]
					[filter]
						find_in=unit
					[/filter]
					
					variable=qquws_interrupt_target
					kill=yes
				[/store_unit]
				
				{VARIABLE qquws_interrupt_target.variables.qquws_interrupt yes}
			[/then]
		[/if]
	[/event]
	
	[event]
		name=attack end
		first_time_only=no
		
		[filter_condition]
			[variable]
				name=qquws_interrupt_target.variables.qquws_interrupt
				equals=yes
			[/variable]
		[/filter_condition]
		
		{CLEAR_VARIABLE qquws_interrupt_target.variables.qquws_interrupt}
		[unstore_unit]
			variable=qquws_interrupt_target
			text="sound of madness"
			{COLOR_HARM}
		[/unstore_unit]
		
		{CLEAR_VARIABLE qquws_interrupt_target}
	[/event]

	[event]
		name=last breath
		first_time_only=no

		[filter]
			[has_attack]
				special_id=qquws_sound_of_madness
			[/has_attack]
		[/filter]

		[store_unit]
			[filter]
				trait=qquws_archwitch_madness_$unit.id
			[/filter]
			
			variable=madness_units
			mode=always_clear
		[/store_unit]

		[for]
			array=madness_units
			variable=i

			[do]
				[modify_unit]
					[filter]
						id=$madness_units[$i].id
					[/filter]

					side=$madness_units[$i].variables.qquws_madness_original_side

					[variables]
						qquws_madness_original_side=""
					[/variables]
				[/modify_unit]

				[remove_trait]
					id=$madness_units[$i].id
					trait_id=qquws_archwitch_madness_$unit.id
				[/remove_trait]

				[floating_text]
					x,y=$madness_units[$i].x,$madness_units[$i].y
					text="<span color='#00ff00' size='large'>Sane again!</span>"
				[/floating_text]
			[/do]
		[/for]
	[/event]
#enddef

#define REGISTER_LAST_WORD
	[event]
		name=attacker hits
		first_time_only=no
		
		[filter_attack]
			special_id=qquws_last_word
		[/filter_attack]
		
		[filter_second]
			[not]
				trait=immune_to_specials
			[/not]
		[/filter_second]

		[fire_event]
			name=handle_last_word_event

			[primary_unit]
				id=$unit.id
			[/primary_unit]

			[secondary_unit]
				id=$second_unit.id
			[/secondary_unit]
		[/fire_event]
	[/event]

	[event]
		name=defender hits
		first_time_only=no
		
		[filter_second_attack]
			special_id=qquws_last_word
		[/filter_second_attack]
		
		[filter]
			[not]
				trait=immune_to_specials
			[/not]
		[/filter]

		[fire_event]
			name=handle_last_word_event

			[primary_unit]
				id=$second_unit.id
			[/primary_unit]

			[secondary_unit]
				id=$unit.id
			[/secondary_unit]
		[/fire_event]
	[/event]

	[event]
		name=handle_last_word_event
		first_time_only=no

		{VARIABLE drain_factor 50}
		[if]
			[have_unit]
				id=$unit.id
				[filter_location]
					time_of_day=neutral
				[/filter_location]
			[/have_unit]
			[then]
				{VARIABLE drain_factor 75}
			[/then]
		[/if]
		[if]
			[have_unit]
				id=$unit.id
				[filter_location]
					time_of_day=chaotic
				[/filter_location]
			[/have_unit]
			[then]
				{VARIABLE drain_factor 100}
			[/then]
		[/if]

		{VARIABLE drain_amount "$( floor($damage_inflicted * 0.01 * $drain_factor) )"}

		[if]
			[variable]
				name=unit.hitpoints
				less_than=$unit.max_hitpoints
			[/variable]
			[and]
				[variable]
					name=drain_amount
					greater_than=0
				[/variable]
			[/and]
			[then]
				{VARIABLE drain_amount "$( if($drain_amount > $unit.max_hitpoints - $unit.hitpoints, $unit.max_hitpoints - $unit.hitpoints, $drain_amount) )"}

				[heal_unit]
					[filter]
						id=$unit.id
					[/filter]
					
					amount=$drain_amount
					restore_statuses=yes
					animate=yes
				[/heal_unit]

				[harm_unit]
					[filter]
						[filter_side]
							[enemy_of]
								side=$unit.side
							[/enemy_of]
						[/filter_side]

						[filter_location]
							x,y=$second_unit.x,$second_unit.y
							radius=9
							[filter_radius]
								terrain="!,_off^_usr,X*,M*^X*"
							[/filter_radius]
						[/filter_location]

						[not]
							id=$second_unit.id
						[/not]
					[/filter]
					
					amount=$drain_amount
					alignment=neutral
					kill=yes
					animate=yes
					experience=no
					delay=0
				[/harm_unit]
			[/then]
		[/if]
	[/event]
#enddef

#define REGISTER_STAFF_OF_POWER
	[event]
		name=attack
		first_time_only=no
		
		[filter_attack]
			special_id=qquws_staff_of_power
		[/filter_attack]

		[modify_unit]
			[filter]
				id=$unit.id
			[/filter]

			[variables]
				staff_of_power_iterator=0
			[/variables]
		[/modify_unit]
	[/event]

	[event]
		name=attack
		first_time_only=no
		
		[filter_second_attack]
			special_id=qquws_staff_of_power
		[/filter_second_attack]
		
		[modify_unit]
			[filter]
				id=$second_unit.id
			[/filter]

			[variables]
				staff_of_power_iterator=0
			[/variables]
		[/modify_unit]
	[/event]

	[event]
		name=attacker hits
		first_time_only=no
		
		[filter_attack]
			special_id=qquws_staff_of_power
		[/filter_attack]
		
		[filter_second]
			[not]
				trait=immune_to_specials
			[/not]
		[/filter_second]

		[fire_event]
			name=handle_staff_of_power_event

			[primary_unit]
				id=$unit.id
			[/primary_unit]

			[secondary_unit]
				id=$second_unit.id
			[/secondary_unit]
		[/fire_event]
	[/event]

	[event]
		name=defender hits
		first_time_only=no
		
		[filter_second_attack]
			special_id=qquws_staff_of_power
		[/filter_second_attack]
		
		[filter]
			[not]
				trait=immune_to_specials
			[/not]
		[/filter]

		[fire_event]
			name=handle_staff_of_power_event

			[primary_unit]
				id=$second_unit.id
			[/primary_unit]

			[secondary_unit]
				id=$unit.id
			[/secondary_unit]
		[/fire_event]
	[/event]

	[event]
		name=handle_staff_of_power_event
		first_time_only=no

		[switch]
			variable=unit.variables.staff_of_power_iterator

			[case]
				value=0

				[modify_unit]
					[filter]
						id=$second_unit.id
					[/filter]

					[object]
						silent=yes
						duration=turn end

						[effect]
							apply_to=attack
							remove_specials=magical,AE_mag_magical_offensive,AE_mag_precision,AE_mag_enchanted,AE_mag_precision_offensive,AE_fut_ubiquitous,eoma_precision,eoma_enchanted,eoma_magical_offensive,eoma_precision_offensive
							increase_accuracy=-15
						[/effect]
						[effect]
							apply_to=zoc
							value=no
						[/effect]
						[effect]
							apply_to=image_mod
							add="~CS(-20,50,50)"
						[/effect]
					[/object]
				[/modify_unit]
			[/case]

			[case]
				value=1
				
				[heal_unit]
					[filter]
						id=$unit.id
					[/filter]
					
					amount=15
					restore_statuses=yes
					animate=yes
				[/heal_unit]
			[/case]

			[else]
				[harm_unit]
					[filter]
						[filter_adjacent]
							id=$second_unit.id
							is_enemy=no
						[/filter_adjacent]
					[/filter]
					
					amount=$damage_inflicted
					alignment=neutral
					kill=yes
					animate=yes
					experience=no
				[/harm_unit]
			[/else]
		[/switch]

		[modify_unit]
			[filter]
				id=$unit.id
			[/filter]

			[variables]
				staff_of_power_iterator="$( $unit.variables.staff_of_power_iterator + 1 )"
			[/variables]
		[/modify_unit]
	[/event]
#enddef

#define REGISTER_DARKNESS_INSIDE
	[event]
		name=die
		first_time_only=no

		[filter_second_attack]
			special_id=qquws_darkness_inside
		[/filter_second_attack]

		[filter]
			[not]
				canrecruit=yes
			[/not]

			[not]
				trait=immune_to_specials
			[/not]
		[/filter]

		[modify_unit]
			[filter]
				id=$unit.id
			[/filter]

			side=$second_unit.side
			hitpoints=$unit.max_hitpoints
			moves=$unit.max_moves
			attacks_left=1
			experience=0

			[status]
				unplagueable=yes
				unpetrifiable=yes
			[/status]

			[trait]
				id=qquws_darkness_inside_trait
				name="inner darkness"
				description="This was once a friendly ally. Now it's an empty shadow, full of resentment and sorrow. This unit is now immune to plague and petrification."
			[/trait]

			[object]
				id=qquws_darkness_inside_kill
				take_only_once=no
				silent=yes

				[effect]
					apply_to=image_mod
					add="~CS(-200,-200,-200)"
				[/effect]
				[effect]
					apply_to=new_ability
					[abilities]
						[dummy]
							id=qquws_soul_catcher
							name="soul catcher"
							description="This unit can only advance by consuming a magical or living being."
						[/dummy]
					[/abilities]
				[/effect]
				[effect]
					apply_to=new_advancement
					replace=yes
					types=QQ_blackness
				[/effect]
				[effect]
					apply_to=alignment
					set=chaotic
				[/effect]
				[effect]
					apply_to=max_experience
					set=999
				[/effect]
			[/object]
		[/modify_unit]
	[/event]
#enddef

#define REGISTER_SOUL_CATCHER
	[event]
	    name=die
	    first_time_only=no

	    [filter]
	        [not]
	            race=mechanical
	        [/not]
	    [/filter]

	    [filter_second]
	        ability=qquws_soul_catcher
	    [/filter_second]

	    [modify_unit]
			[filter]
				id=$second_unit.id
			[/filter]

			experience=$second_unit.max_experience
		[/modify_unit]
	[/event]

	[event]
		name=post advance
		first_time_only=no

		[filter]
			abililty=qquws_soul_catcher
		[/filter]

		[modify_unit]
			[filter]
				id=$unit.id
			[/filter]

			experience=0

			[object]
				silent=yes

				[effect]
				    apply_to=remove_ability
				    [abilities]
						[dummy]
							id=qquws_soul_catcher
						[/dummy]
				    [/abilities]
				[/effect]
			[/object]
		[/modify_unit]

		# somewhat out of place as it's a very special case, but it won't do any harm here, move to a dedicated event if needed
		[remove_object]
			id=$unit.id
			object_id=qquws_darkness_inside_kill
		[/remove_object]
	[/event]
#enddef

#define REGISTER_CURSE_OF_THE_DEAD
	[event]
		name=attacker hits
		first_time_only=no
		
		[filter_attack]
			special_id=qquws_curse_of_the_dead
		[/filter_attack]
		
		[filter_second]
			[not]
				trait=immune_to_specials
			[/not]
			
			[not]
				trait=uws_curse_of_the_dead_trait
			[/not]
		[/filter_second]
		
		[if]
			[variable]
				name=second_unit.hitpoints
				greater_than=0
			[/variable]
			[then]
				[fire_event]
					name=uws_handle_curse_of_the_dead
					
					[primary_unit]
						id=$second_unit.id
					[/primary_unit]
				[/fire_event]
			[/then]
		[/if]
	[/event]
	
	[event]
		name=defender hits
		first_time_only=no
		
		[filter_second_attack]
			special_id=qquws_curse_of_the_dead
		[/filter_second_attack]
		
		[filter]
			[not]
				trait=immune_to_specials
			[/not]
			
			[not]
				trait=uws_curse_of_the_dead_trait
			[/not]
		[/filter]
		
		[if]
			[variable]
				name=unit.hitpoints
				greater_than=0
			[/variable]
			[then]
				[fire_event]
					name=uws_handle_curse_of_the_dead
					
					[primary_unit]
						id=$unit.id
					[/primary_unit]
				[/fire_event]
			[/then]
		[/if]
	[/event]
	
	[event]
		name=uws_handle_curse_of_the_dead
		first_time_only=no
		
		{VARIABLE sickness_end_turn $turn_number}
		{VARIABLE_OP sickness_end_turn add 3}
		
		[modify_unit]
			[filter]
				id=$unit.id
			[/filter]
			
			[status]
				unhealable=yes
				poisoned=yes
			[/status]
			
			[trait]
				id=uws_curse_of_the_dead_trait
				name="<span color='#c2a00c'>cursed</span>"
				description="This unit is weakened by the curse of the dead and receives 12 points of damage each turn. The effect will wear off on turn $sickness_end_turn|."

				[effect]
					apply_to=attack
					increase_damage=-33%
				[/effect]
				[effect]
					apply_to=movement
					increase=-50%
				[/effect]
				[effect]
					apply_to=image_mod
					add="~CS(15,90,15)"
				[/effect]
			[/trait]
		[/modify_unit]
		
		[floating_text]
			x,y=$unit.x,$unit.y
			text="<span color='#c2a00c'>Cursed!</span>"
		[/floating_text]
		
		[set_variables]
			name=qquws_lasting_effect_information
			mode=append
			[value]
			    id=$unit.id
			    side=$unit.side
			    end_of_effect_turn=$sickness_end_turn
			    effect_type=curse_of_the_dead
			[/value]
		[/set_variables]
	[/event]
#enddef

#define REGISTER_WHISPER_OF_THE_GRAVE
	[event]
		name=attacker hits
		first_time_only=no
		
		[filter_attack]
			special_id=qquws_whisper_of_the_grave
		[/filter_attack]
		
		[filter_second]
			[not]
				trait=immune_to_specials
			[/not]
			
			[not]
				trait=uws_whisper_of_the_grave_trait
			[/not]
		[/filter_second]
		
		[if]
			[variable]
				name=second_unit.hitpoints
				greater_than=0
			[/variable]
			[then]
				[modify_unit]
					[filter]
						id=$second_unit.id
					[/filter]
					
					[status]
						unhealable=yes
					[/status]
					
					[trait]
						id=uws_whisper_of_the_grave_trait
						name="<span color='#88329c'>foredoomed</span>"
						description="This unit is searching for it's grave and receives 12 points of damage each turn until reaching the end. It's also lost all it's weapons and has all defenses reduced by 15%. The only way to save this unit is to seek help in a village or with a skilled healer.."

						[effect]
							apply_to=remove_attacks
						[/effect]
						[effect]
							apply_to=defense
							replace=no
							[defense]
								flat=15
								frozen=15
								forest=15
								hills=15
								mountains=15
								village=15
								swamp_water=15
								shallow_water=15
								deep_water=15
								reef=15
								castle=15
								cave=15
								sand=15
								fungus=15
							[/defense]
						[/effect]
						[effect]
							apply_to=image_mod
							add="~CS(-20,-70,-70)"
						[/effect]
					[/trait]
				[/modify_unit]
				
				[floating_text]
					x,y=$second_unit.x,$second_unit.y
					text="<span color='#88329c'>Grave!</span>"
				[/floating_text]
			[/then]
		[/if]
	[/event]

	[event]
		name=side turn
		first_time_only=no

		[filter_side]
			[has_unit]
				side=$side_number
				trait=uws_whisper_of_the_grave_trait
			[/has_unit]
		[/filter_side]

        [store_unit]
        	[filter]
	        	side=$side_number
	        	trait=uws_whisper_of_the_grave_trait
	        	[filter_location]
	        		terrain=*^V*
	        	[/filter_location]

		        [or]
		        	side=$side_number
		        	trait=uws_whisper_of_the_grave_trait
		        	[filter_adjacent]
		        		ability=curing,healing,AE_mag_curing,AE_mag_healing10,AE_mag_healing12,AE_mag_healing8,eoma_curing,eoma_healing8,eoma_healing10,eoma_healing12
		        		is_enemy=no
		        	[/filter_adjacent]
		        [/or]
		    [/filter]
        	variable=remove_grave_curse_units
            mode=always_clear
        [/store_unit]

        [for]
        	array=remove_grave_curse_units
        	variable=i

        	[do]
        		[remove_trait]
        			id=$remove_grave_curse_units[$i].id
        			trait_id=uws_whisper_of_the_grave_trait
        		[/remove_trait]

        		[floating_text]
					x,y=$remove_grave_curse_units[$i].x,$remove_grave_curse_units[$i].y
					text="<span color='#00ff00'>Healed!</span>"
				[/floating_text]
        	[/do]
        [/for]

        [harm_unit]
			[filter]
				side=$side_number
				trait=uws_whisper_of_the_grave_trait
			[/filter]
			
			amount=12
			alignment=neutral
			kill=yes
			animate=yes
			experience=no
		[/harm_unit]
	[/event]
#enddef

#define REGISTER_DRAGON_BREATH
	[event]
	    name=attacker hits,attacker misses
	    first_time_only=no

	    [filter_attack]
	        special_id=qquws_dragon_breath
	    [/filter_attack]

	    {VARIABLE dbreathdmg $weapon.damage}

	    [if]
	        [variable]
	    		name=unit.status.slowed
	    		boolean_equals=yes
	    	[/variable]
	        [then]
	            {VARIABLE_OP dbreathdmg divide 2}
	            {VARIABLE_OP dbreathdmg round floor}
	        [/then]
	    [/if]

	    [store_unit]
	        [filter]
	            [filter_adjacent]
	                x,y=$x2,$y2
	            [/filter_adjacent]
	            [not]
	                [filter_adjacent]
	                    x,y=$x1,$y1
	                [/filter_adjacent]
	            [/not]
	            [not]
	                x,y=$x1,$y1
	            [/not]
	            [not]
	                status=petrified
	            [/not]
	        [/filter]
	        variable=bystander
	    [/store_unit]

	    [foreach]
	        array=bystander
	        [do]
	        	{VARIABLE_OP breath_chance rand 1..100}

	            [if]
	            	[variable]
	            		name=breath_chance
	            		less_than_equal_to=60
	            	[/variable]
	                [then]
	                    [harm_unit]
	                        [filter]
	                            id=$bystander[$i].id
	                            [filter_side]
	                                [enemy_of]
	                                    side=$unit.side
	                                [/enemy_of]
	                            [/filter_side]
	                            [not]
	                                [filter_wml]
	                                    [status]
	                                        petrified=yes
	                                    [/status]
	                                [/filter_wml]
	                            [/not]
	                        [/filter]
	                        [filter_second]
	                            x,y=$x1,$y1
	                        [/filter_second]
	                        amount=$dbreathdmg
	                        damage_type=$weapon.type
	                        alignment=$unit.alignment
	                        fire_event=yes
	                        animate=defender
	                        delay=0
	                        experience=no
	                    [/harm_unit]
	                [/then]
	            [/if]
	        [/do]
	    [/foreach]

	    {CLEAR_VARIABLE dbreathdmg}
	    {CLEAR_VARIABLE bystander}
	[/event]
#enddef

#define REGISTER_AURA_OF_DECAY
	[event]
		name=side turn
		first_time_only=no

		[filter_side]
			[has_unit]
				ability=qquws_aura_of_decay
			[/has_unit]
		[/filter_side]

		[store_unit]
			[filter]
				side=$side_number
				ability=qquws_aura_of_decay
			[/filter]
			
			variable=aura_units
			mode=always_clear
		[/store_unit]

		[foreach]
			array=aura_units
			variable=aura_unit
			readonly=no
			
			[do]
				[modify_unit]
					[filter]
						[filter_adjacent]
							id=$aura_unit.id
							is_enemy=yes
						[/filter_adjacent]
					[/filter]

					experience="$( $this_unit.experience - 8 )"

					[object]
						silent=yes

						[effect]
						    apply_to=resistance
						    replace=no
						    [resistance]
								blade=2
								impact=2
								pierce=2
								arcane=2
								cold=2
								fire=2
						    [/resistance]
						[/effect]
					[/object]
				[/modify_unit]

				[harm_unit]
					[filter]
						[filter_adjacent]
							id=$aura_unit.id
							is_enemy=yes
						[/filter_adjacent]
					[/filter]

					[filter_second]
						id=$aura_unit.id
					[/filter_second]
					
					amount=4
					alignment=chaotic
					kill=no
					animate=yes
					experience=no
					delay=0
				[/harm_unit]
			[/do]
		[/foreach]
	[/event]
#enddef

#define REGISTER_FATEFUL
	[event]
		name=attacker hits
		first_time_only=no

		[filter_attack]
			special_id=qquws_fateful
		[/filter_attack]

		[filter_second]
			[not]
				trait=qquws_marked_fate
			[/not]
		[/filter_second]

		[if]
			[variable]
				name=second_unit.hitpoints
				greater_than=0
			[/variable]
			[then]
				[modify_unit]
					[filter]
						id=$second_unit.id
					[/filter]

					[trait]
						id=qquws_marked_fate
						name="<span color='#b0b3b8'>marked fate</span>"
						description="This unit's fate is marked and it will turn to stone for one turn at the beggining of it's turn."
					[/trait]
				[/modify_unit]
			[/then]
		[/if]
	[/event]

	[event]
		name=side turn
		first_time_only=no

		[filter_side]
			[has_unit]
				trait=qquws_marked_fate
			[/has_unit]
		[/filter_side]

		[modify_unit]
			[filter]
				side=$side_number
				trait=qquws_marked_fate
			[/filter]

			[status]
				petrified=yes
			[/status]
		[/modify_unit]
	[/event]

	[event]
		name=side turn end
		first_time_only=no

		[filter_side]
			[has_unit]
				trait=qquws_marked_fate
			[/has_unit]
		[/filter_side]

		[modify_unit]
			[filter]
				side=$side_number
				trait=qquws_marked_fate
			[/filter]

			[status]
				petrified=no
			[/status]
		[/modify_unit]

		[remove_trait]
			side=$side_number
			trait_id=qquws_marked_fate
		[/remove_trait]
	[/event]
#enddef

#define REGISTER_SLOWING_WAVE
	[event]
	    name=attacker hits
	    first_time_only=no

	    [filter_attack]
	        special_id=qquws_slowing_wave
	    [/filter_attack]

	    [store_unit]
	        [filter]
	            [filter_adjacent]
	                x,y=$x2,$y2
	            [/filter_adjacent]
	            [not]
	                [filter_adjacent]
	                    x,y=$x1,$y1
	                [/filter_adjacent]
	            [/not]
	            [not]
	                x,y=$x1,$y1
	            [/not]
	            [not]
	                status=petrified
	            [/not]
	        [/filter]
	        variable=bystander
	    [/store_unit]

	    {VARIABLE dbreathdmg $weapon.damage}

	    [if]
	    	[variable]
	    		name=unit.status.slowed
	    		boolean_equals=yes
	    	[/variable]
	        [then]
	            {VARIABLE_OP dbreathdmg divide 2}
	            {VARIABLE_OP dbreathdmg round floor}
	        [/then]
	    [/if]

	    [foreach]
	        array=bystander
	        [do]
                [harm_unit]
                    [filter]
                        id=$bystander[$i].id
                        [filter_side]
                            [enemy_of]
                                side=$unit.side
                            [/enemy_of]
                        [/filter_side]
                    [/filter]
                    [filter_second]
                        x,y=$x1,$y1
                    [/filter_second]
                    amount=$dbreathdmg
                    slowed=yes
                    kill=yes
                    damage_type=$weapon.type
                    alignment=$unit.alignment
                    fire_event=yes
                    animate=defender
                    delay=0
                    experience=no
                [/harm_unit]
	        [/do]
	    [/foreach]

	    {CLEAR_VARIABLE dbreathdmg}
	    {CLEAR_VARIABLE bystander}
	[/event]
#enddef

#define REGISTER_GLORY_OF_THE_SIN
	[event]
		name=attacker hits
		first_time_only=no

		[filter_attack]
			special_id=qquws_glory_of_the_sin
		[/filter_attack]

		[filter_second]
			[not]
				trait=qquws_bound_to_evil
			[/not]
		[/filter_second]

		[if]
			[variable]
				name=second_unit.hitpoints
				greater_than=0
			[/variable]
			[then]
				[fire_event]
					name=handle_glory_of_the_sin

					[primary_unit]
						id=$unit.id
					[/primary_unit]

					[secondary_unit]
						id=$second_unit.id
					[/secondary_unit]
				[/fire_event]
			[/then]
		[/if]
	[/event]

	[event]
		name=defender hits
		first_time_only=no

		[filter]
			[not]
				trait=qquws_bound_to_evil
			[/not]
		[/filter]

		[filter_second_attack]
			special_id=qquws_glory_of_the_sin
		[/filter_second_attack]

		[if]
			[variable]
				name=unit.hitpoints
				greater_than=0
			[/variable]
			[then]
				[fire_event]
					name=handle_glory_of_the_sin

					[primary_unit]
						id=$second_unit.id
					[/primary_unit]

					[secondary_unit]
						id=$unit.id
					[/secondary_unit]
				[/fire_event]
			[/then]
		[/if]
	[/event]

	[event]
		name=handle_glory_of_the_sin
		first_time_only=no

		[store_unit_type]
			variable=weapon_special_owner
			mode=always_clear
			type=$unit.type
		[/store_unit_type]

		[modify_unit]
			[filter]
				id=$second_unit.id
			[/filter]

			[variables]
				sinful_bond_unit_id=$unit.id
			[/variables]

			[trait]
				id=qquws_bound_to_evil
				name="<span color='#db633b'>bound to evil</span>"
				description="This unit is bound to the fate of the $weapon_special_owner.name|. Every time that unit receives damage it will propagate and damage this unit for 50% of the received damage. Conversely, each time this unit receives damage, 50% of it will heal the $weapon_special_owner.name|."
				
				[effect]
				    apply_to=overlay
				    add=halo/uws/bound_to_evil.png
				[/effect]
			[/trait]
		[/modify_unit]

		{VARIABLE all_bound_units $unit.variables.sinful_bond_units}
		[if]
			[variable]
				name=all_bound_units
				not_equals=""
			[/variable]
			[then]
				{VARIABLE all_bound_units "$all_bound_units|,"}
			[/then]
		[/if]
		{VARIABLE all_bound_units "$all_bound_units|$second_unit.id"}

		[modify_unit]
			[filter]
				id=$unit.id
			[/filter]

			[variables]
				sinful_bond_units=$all_bound_units
			[/variables]
		[/modify_unit]
	[/event]

	[event]
		name=attacker hits
		first_time_only=no

		[filter_second]
			trait=qquws_bound_to_evil
		[/filter_second]

		[heal_unit]
			[filter]
				id=$second_unit.variables.sinful_bond_unit_id
			[/filter]

			amount="$( ceil($damage_inflicted * 0.5) )"
			animate=yes
		[/heal_unit]
	[/event]

	[event]
		name=defender hits
		first_time_only=no

		[filter]
			trait=qquws_bound_to_evil
		[/filter]

		[heal_unit]
			[filter]
				id=$unit.variables.sinful_bond_unit_id
			[/filter]

			amount="$( ceil($damage_inflicted * 0.5) )"
			animate=yes
		[/heal_unit]
	[/event]

	[event]
		name=attacker hits
		first_time_only=no

		[filter_second]
			[has_attack]
				special_id=qquws_glory_of_the_sin
			[/has_attack]
		[/filter_second]

		[if]
			[variable]
				name=second_unit.variables.sinful_bond_units
				not_equals=""
			[/variable]
			[then]
				[harm_unit]
                    [filter]
                        id=$second_unit.variables.sinful_bond_units

                        [not]
                        	id=$unit.id
                        [/not]

                        [not]
                        	status=petrified
                        [/not]
                    [/filter]

                    amount="$( ceil($damage_inflicted * 0.5) )"
                    kill=yes
                    fire_event=yes
                    delay=0
                    experience=no
                    animate=yes
                [/harm_unit]
            [/then]
        [/if]
	[/event]

	[event]
		name=defender hits
		first_time_only=no

		[filter]
			[has_attack]
				special_id=qquws_glory_of_the_sin
			[/has_attack]
		[/filter]

		[if]
			[variable]
				name=unit.variables.sinful_bond_units
				not_equals=""
			[/variable]
			[then]
				[harm_unit]
                    [filter]
                        id=$unit.variables.sinful_bond_units

                        [not]
                        	id=$second_unit.id
                        [/not]

                        [not]
                        	status=petrified
                        [/not]
                    [/filter]

                    amount="$( ceil($damage_inflicted * 0.5) )"
                    kill=yes
                    fire_event=yes
                    delay=0
                    experience=no
                    animate=yes
                [/harm_unit]
            [/then]
        [/if]
	[/event]

	[event]
		name=die
		first_time_only=no

		[filter]
			[has_attack]
				special_id=qquws_glory_of_the_sin
			[/has_attack]
		[/filter]

		[if]
			[variable]
				name=unit.variables.sinful_bond_units
				not_equals=""
			[/variable]
			[then]
				[modify_unit]
					[filter]
						id=$unit.variables.sinful_bond_units
					[/filter]

					[variables]
						sinful_bond_unit_id=""
					[/variables]
				[/modify_unit]

				[remove_trait]
                    id=$unit.variables.sinful_bond_units
                    trait_id=qquws_bound_to_evil
                [/remove_trait]
            [/then]
        [/if]
	[/event]
#enddef

#define REGISTER_NIGHT_INSTIGATOR
	[event]
		name=turn refresh
		first_time_only=no

		[filter_side]
			[has_unit]
				ability=qquws_night_instigator
				[filter_location]
					time_of_day_id=first_watch,midnight,second_watch
				[/filter_location]
			[/has_unit]
		[/filter_side]

		[modify_unit]
			[filter]
				side=$side_number
				ability=qquws_night_instigator
				[filter_location]
					time_of_day_id=first_watch,midnight,second_watch
				[/filter_location]
			[/filter]

			moves="$( $this_unit.max_moves + 2 )"
		[/modify_unit]
	[/event]
#enddef

#define REGISTER_WEAPON_HIT_AND_RUN
	[event]
		name=attack end
		first_time_only=no

		[filter_attack]
			special_id=qquws_weapon_hit_and_run
		[/filter_attack]
		
		[filter]
			[not]
				ability=qquws_status_time_dilation_active
			[/not]
		[/filter]
		
		{VARIABLE_OP unit.moves add 1}
		[unstore_unit]
			variable=unit
			color="0,255,0"
			text="+1 movepoint"
			find_vacant=no
		[/unstore_unit]
	[/event]
#enddef

#define REGISTER_BLOODLUST
	[event]
	    name=die
	    first_time_only=no

	    [filter]
	        [not]
	            race=undead
	            [or]
	                race=mechanical
	            [/or]
	            [or]
	                race=AE_mag_magical
	            [/or]
	        [/not]
	    [/filter]

	    [filter_second]
	        ability=qquws_bloodlust3
	    [/filter_second]

        [heal_unit]
            [filter]
                id=$second_unit.id
            [/filter]
            amount=3
            animate=yes
            restore_statuses=no
        [/heal_unit]
	[/event]

	[event]
	    name=die
	    first_time_only=no

	    [filter]
	        [not]
	            race=undead
	            [or]
	                race=mechanical
	            [/or]
	            [or]
	                race=AE_mag_magical
	            [/or]
	        [/not]
	    [/filter]

	    [filter_second]
	        ability=qquws_bloodlust6
	    [/filter_second]

        [heal_unit]
            [filter]
                id=$second_unit.id
            [/filter]
            amount=6
            animate=yes
            restore_statuses=no
        [/heal_unit]
	[/event]

	[event]
	    name=die
	    first_time_only=no

	    [filter]
	        [not]
	            race=undead
	            [or]
	                race=mechanical
	            [/or]
	            [or]
	                race=AE_mag_magical
	            [/or]
	        [/not]
	    [/filter]

	    [filter_second]
	        ability=qquws_bloodlust9
	    [/filter_second]

        [heal_unit]
            [filter]
                id=$second_unit.id
            [/filter]
            amount=9
            animate=yes
            restore_statuses=no
        [/heal_unit]
	[/event]
#enddef

#define REGISTER_STICKY_TONGUE
	[event]
		name=attacker hits
		first_time_only=no
		
		[filter_attack]
			special_id=qquws_sticky_tongue
		[/filter_attack]
		
		[filter_second]
			[not]
				trait=qquws_sticky_tongue_trait,immune_to_specials
			[/not]
		[/filter_second]

		[if]
			[variable]
				name=second_unit.hitpoints
				greater_than=0
			[/variable]
			[then]
				{VARIABLE ungoo_turn "$( $turn_number + 2 )"}

				[modify_unit]
					[filter]
						id=$second_unit.id
					[/filter]

					[trait]
						id=qquws_sticky_tongue_trait
						name="<span color='#ff4444'>goo</span>"
						description="This unit is covered in sticky, disgusting goo. It will regain it's ability to move on turn $ungoo_turn|."
						[effect]
							apply_to=movement
							set=0
						[/effect]
						[effect]
							apply_to=image_mod
							add="~CS(150,150,150)"
						[/effect]
					[/trait]
				[/modify_unit]

				[floating_text]
					x,y=$second_unit.x,$second_unit.y
					text="<span color='#991111'>goo</span>"
				[/floating_text]

				[set_variables]
					name=qquws_lasting_effect_information
					mode=append
					[value]
					    id=$second_unit.id
					    side=$second_unit.side
					    end_of_effect_turn=$ungoo_turn
					    effect_type=sticky_tongue
					[/value]
				[/set_variables]
			[/then]
		[/if]
	[/event]
	
	[event]
		name=defender hits
		first_time_only=no
		
		[filter_second_attack]
			special_id=qquws_sticky_tongue
		[/filter_second_attack]
		
		[filter]
			[not]
				trait=qquws_sticky_tongue_trait
			[/not]
		[/filter]

		[if]
			[variable]
				name=unit.hitpoints
				greater_than=0
			[/variable]
			[then]
				{VARIABLE ungoo_turn "$( $turn_number + 2 )"}

				[modify_unit]
					[filter]
						id=$unit.id
					[/filter]

					[trait]
						id=qquws_sticky_tongue_trait
						name="<span color='#ff4444'>goo</span>"
						description="This unit is covered in sticky, disgusting goo. It will regain it's ability to move on turn $ungoo_turn|."
						[effect]
							apply_to=movement
							set=0
						[/effect]
						[effect]
							apply_to=image_mod
							add="~CS(150,150,150)"
						[/effect]
					[/trait]
				[/modify_unit]

				[floating_text]
					x,y=$unit.x,$unit.y
					text="<span color='#991111'>goo</span>"
				[/floating_text]

				[set_variables]
					name=qquws_lasting_effect_information
					mode=append
					[value]
					    id=$unit.id
					    side=$unit.side
					    end_of_effect_turn=$ungoo_turn
					    effect_type=sticky_tongue
					[/value]
				[/set_variables]
			[/then]
		[/if]
	[/event]
#enddef

#define REGISTER_DIGEST_THE_DEAD
	[event]
		name=die
		first_time_only=no
		
		[filter_second_attack]
			special_id=qquws_digest_the_dead
		[/filter_second_attack]
		
		[heal_unit]
			[filter]
				id=$second_unit.id
			[/filter]

			amount=full
			restore_statuses=no
			animate=yes
		[/heal_unit]
	[/event]
#enddef

#define REGISTER_IMPRISONER_OF_SOULS
	[event]
		name=die
		first_time_only=no
		
		[filter]
			[filter_adjacent]
				ability=qquws_imprisoner_of_souls
			[/filter_adjacent]
		[/filter]

		[store_unit]
			[filter]
				ability=qquws_imprisoner_of_souls

				[filter_adjacent]
					id=$unit.id
				[/filter_adjacent]
			[/filter]
			
			variable=imprisoner
			mode=always_clear
		[/store_unit]

		[for]
			array=imprisoner
			variable=i

			[do]
				[unit]
					type=QQ_enslaved_soul
					x=$unit.x
					y=$unit.y
					side=$imprisoner[$i].side
					passable=yes
					upkeep=loyal
					animate=yes
				[/unit]
			[/do]
		[/for]
	[/event]
#enddef

#define REGISTER_PROTECTED_BY_DARKNESS
	[event]
		name=attacker hits
		first_time_only=no

		[filter_second]
			ability=qquws_protected_by_darkness
			[filter_location]
				time_of_day_id=first_watch,midnight,second_watch
			[/filter_location]
		[/filter_second]

		[if]
			[variable]
				name=second_unit.hitpoints
				less_than=1
			[/variable]
			[then]
				{VARIABLE second_unit.hitpoints 1}
				[unstore_unit]
					variable=second_unit
					color="79,27,64"
					text="O Darkness I Arise!"
					find_vacant=no
				[/unstore_unit]
			[/then]
		[/if]
	[/event]

	[event]
		name=defender hits
		first_time_only=no

		[filter]
			ability=qquws_protected_by_darkness
			[filter_location]
				time_of_day_id=first_watch,midnight,second_watch
			[/filter_location]
		[/filter]

		[if]
			[variable]
				name=unit.hitpoints
				less_than=1
			[/variable]
			[then]
				{VARIABLE unit.hitpoints 1}
				[unstore_unit]
					variable=unit
					color="79,27,64"
					text="O Darkness I Arise!"
					find_vacant=no
				[/unstore_unit]
			[/then]
		[/if]
	[/event]
#enddef

#define REGISTER_AREA_SLOW
	[event]
		name=attacker hits
		first_time_only=no

		[filter_attack]
			special_id=qquws_area_slow
		[/filter_attack]

		[harm_unit]
			[filter]
				[filter_adjacent]
					id=$second_unit.id
				[/filter_adjacent]

				[filter_side]
					[enemy_of]
						side=$unit.side
					[/enemy_of]
				[/filter_side]
			[/filter]

			amount="$( ceil( $damage_inflicted * 0.5 ) )"
			slowed=yes
			delay=0
		[/harm_unit]
	[/event]
#enddef

#define REGISTER_INNER_COLD
	[event]
		name=attacker hits
		first_time_only=no

		[filter_second]
			ability=qquws_inner_cold
		[/filter_second]
		
		[filter_attack]
			range=melee
		[/filter_attack]
		
		[modify_unit]
			[filter]
				id=$unit.id
			[/filter]
			
			[status]
				slowed=yes
			[/status]
		[/modify_unit]
		
		[floating_text]
			x,y=$unit.x,$unit.y
			text="<span color='#45bdf5'>Slowed!</span>"
		[/floating_text]
	[/event]
#enddef

#define REGISTER_BATTLE_RAGE
	[event]
		name=attack
		first_time_only=no
		
		[filter_attack]
			special_id=qquws_battle_rage
		[/filter_attack]
		
		[foreach]
			array=unit.attack
			variable=units_weapon
			index_var=i
			readonly=yes
			
			[do]
				[if]
					[variable]
						name=units_weapon.name
						equals=$weapon.name
					[/variable]
					[then]
						{VARIABLE battle_rage_attack_id $i}
						{VARIABLE battle_rage_base_damage $weapon.damage}
						[break][/break]
					[/then]
				[/if]
			[/do]
		[/foreach]
	[/event]
	
	[event]
		name=attacker hits
		first_time_only=no
		
		[filter_attack]
			special_id=qquws_battle_rage
		[/filter_attack]
		
		{VARIABLE_OP unit.attack[$battle_rage_attack_id].damage add $unit.variables.battle_rage_increase}
		[unstore_unit]
		        variable=unit
		[/unstore_unit]
	[/event]
	
	[event]
		name=attack end
		first_time_only=no
		
		[filter_attack]
			special_id=qquws_battle_rage
		[/filter_attack]
		
		{VARIABLE unit.attack[$battle_rage_attack_id].damage $battle_rage_base_damage}
		[unstore_unit]
		        variable=unit
		[/unstore_unit]
		
		{CLEAR_VARIABLE battle_rage_attack_id}
		{CLEAR_VARIABLE battle_rage_base_damage}
	[/event]

	[event]
		name=attack
		first_time_only=no
		
		[filter_second_attack]
			special_id=qquws_battle_rage
		[/filter_second_attack]
		
		[foreach]
			array=second_unit.attack
			variable=sec_units_weapon
			index_var=i
			readonly=yes
			
			[do]
				[if]
					[variable]
						name=sec_units_weapon.name
						equals=$second_weapon.name
					[/variable]
					[then]
						{VARIABLE enemy_battle_rage_attack_id $i}
						{VARIABLE enemy_battle_rage_base_damage $second_weapon.damage}
						[break][/break]
					[/then]
				[/if]
			[/do]
		[/foreach]
	[/event]
	
	[event]
		name=defender hits
		first_time_only=no
		
		[filter_second_attack]
			special_id=qquws_battle_rage
		[/filter_second_attack]
		
		{VARIABLE_OP second_unit.attack[$enemy_battle_rage_attack_id].damage add $second_unit.variables.battle_rage_increase}
		[unstore_unit]
		    variable=second_unit
		[/unstore_unit]
	[/event]
	
	[event]
		name=attack end
		first_time_only=no
		
		[filter_second_attack]
			special_id=qquws_battle_rage
		[/filter_second_attack]
		
		{VARIABLE second_unit.attack[$enemy_battle_rage_attack_id].damage $enemy_battle_rage_base_damage}
		[unstore_unit]
		    variable=second_unit
		[/unstore_unit]
		
		{CLEAR_VARIABLE enemy_battle_rage_attack_id}
		{CLEAR_VARIABLE enemy_battle_rage_base_damage}
	[/event]
#enddef

#define REGISTER_HEAVY_STUN
	[event]
		name=attacker hits
		first_time_only=no
		
		[filter_attack]
			special_id=qquws_heavy_stun
		[/filter_attack]
		
		[filter_second]
			[not]
				ability=qquws_status_stunned
			[/not]

			[not]
				trait=immune_to_specials
			[/not]
		[/filter_second]
		
		[if]
			[variable]
				name=second_unit.hitpoints
				greater_than=0
			[/variable]
			[then]
				[modify_unit]
					[filter]
						id=$second_unit.id
					[/filter]
					
					[object]
						silent=yes
						duration=turn end
						
						[effect]
							apply_to=zoc
							value=no
						[/effect]
						[effect]
							apply_to=image_mod
							add="~CS(50,50,0)"
						[/effect]
						[effect]
							apply_to=attack
							remove_specials=magical,AE_mag_magical_offensive,AE_mag_precision,AE_mag_enchanted,AE_mag_precision_offensive,AE_fut_ubiquitous,eoma_precision,eoma_enchanted,eoma_magical_offensive,eoma_precision_offensive
							increase_accuracy=-10
						[/effect]
						[effect]
							apply_to=new_ability
							[abilities]
								[dummy]
									id=qquws_status_stunned
									name="<span color='#d1a758'>stunned</span>"
									description="This unit is stunned, has weapon CtH specials removed, accuracy decreased by 10 and no zone of control."
								[/dummy]
							[/abilities]
						[/effect]
					[/object]
				[/modify_unit]
				
				[floating_text]
					x,y=$second_unit.x,$second_unit.y
					text="<span color='#d1a758'>stunned</span>"
				[/floating_text]
			[/then]
		[/if]
	[/event]

	[event]
		name=defender hits
		first_time_only=no
		
		[filter_second_attack]
			special_id=qquws_heavy_stun
		[/filter_second_attack]
		
		[filter]
			[not]
				ability=qquws_status_stunned
			[/not]

			[not]
				trait=immune_to_specials
			[/not]
		[/filter]
		
		[if]
			[variable]
				name=unit.hitpoints
				greater_than=0
			[/variable]
			[then]
				[modify_unit]
					[filter]
						id=$unit.id
					[/filter]
					
					[object]
						silent=yes
						duration=turn end
						
						[effect]
							apply_to=zoc
							value=no
						[/effect]
						[effect]
							apply_to=image_mod
							add="~CS(50,50,0)"
						[/effect]
						[effect]
							apply_to=attack
							remove_specials=magical,AE_mag_magical_offensive,AE_mag_precision,AE_mag_enchanted,AE_mag_precision_offensive,AE_fut_ubiquitous,eoma_precision,eoma_enchanted,eoma_magical_offensive,eoma_precision_offensive
							increase_accuracy=-10
						[/effect]
						[effect]
							apply_to=new_ability
							[abilities]
								[dummy]
									id=qquws_status_stunned
									name="<span color='#d1a758'>stunned</span>"
									description="This unit is stunned, has weapon CtH specials removed, accuracy decreased by 10 and no zone of control."
								[/dummy]
							[/abilities]
						[/effect]
					[/object]
				[/modify_unit]
				
				[floating_text]
					x,y=$unit.x,$unit.y
					text="<span color='#d1a758'>stunned</span>"
				[/floating_text]
			[/then]
		[/if]
	[/event]
#enddef

#define REGISTER_AREA_DAMAGE
	[event]
		name=attacker hits
		first_time_only=no

		[filter_attack]
			special_id=qquws_area_damage
		[/filter_attack]

		[harm_unit]
			[filter]
				[filter_adjacent]
					id=$second_unit.id
				[/filter_adjacent]

				[filter_side]
					[enemy_of]
						side=$unit.side
					[/enemy_of]
				[/filter_side]
			[/filter]

			amount="$( ceil( $damage_inflicted * 0.5 ) )"
			damage_type=$weapon.type
			delay=0
		[/harm_unit]
	[/event]
#enddef

#define REGISTER_VISCIOUS_MOCKERY
	[event]
		name=die
		first_time_only=no

		[filter_second_attack]
			special_id=qquws_viscious_mockery
		[/filter_second_attack]

		[filter]
			[not]
				canrecruit=yes
			[/not]

			[not]
				trait=immune_to_specials
			[/not]
		[/filter]

		[modify_unit]
			[filter]
				id=$unit.id
			[/filter]

			side=$second_unit.side

			[variables]
				mocked_statue_creator=$second_unit.id
			[/variables]

			[trait]
				id=qquws_mocked_statue
				name="<span color='#7a475c'>mocked statue</span>"
				description="Remnant of it's former glory, now a miserable effigy. All sculptures will die with their creator."
			[/trait]

			[object]
				silent=yes

				[effect]
					apply_to=hitpoints
					heal_full=yes
				[/effect]
				[effect]
					apply_to=movement
					set=0
				[/effect]
				[effect]
					apply_to=zoc
					value=no
				[/effect]
				[effect]
				    apply_to=resistance
				    replace=yes
				    [resistance]
						arcane=0
						blade=0
						cold=0
						fire=0
						impact=0
						pierce=0
						secret=0
						insects=0
				    [/resistance]
				[/effect]
				[effect]
					apply_to=image_mod
					add="~GS()"
				[/effect]
			[/object]
		[/modify_unit]
	[/event]

	[event]
		name=die
		first_time_only=no

		[filter]
			[has_attack]
				special_id=qquws_viscious_mockery
			[/has_attack]
		[/filter]

		[kill]
			trait=qquws_mocked_statue
			[filter_wml]
				[variables]
					mocked_statue_creator=$unit.id
				[/variables]
			[/filter_wml]

			fire_event=no
			animate=yes
		[/kill]
	[/event]
#enddef

#define REGISTER_SLOW_AURA
	[event]
		name=turn refresh
		first_time_only=no

		[filter_condition]
			[have_unit]
				side=$side_number
				ability=qquws_slow_aura
			[/have_unit]
		[/filter_condition]

		[store_unit]
			[filter]
				side=$side_number
				ability=qquws_slow_aura
			[/filter]
			
			variable=slow_aura_units
			mode=always_clear
		[/store_unit]

		[for]
			array=slow_aura_units
			variable=i
			[do]
				[harm_unit]
					[filter]
						[filter_adjacent]
							id=$slow_aura_units[$i].id
							is_enemy=yes
						[/filter_adjacent]

						[not]
							status=unslowable
						[/not]
					[/filter]

					amount=$slow_aura_units[$i].variables.slow_aura_damage
					damage_type=cold
					alignment=neutral
					animate=yes
					slowed=yes
					kill=no
					fire_event=no
					experience=no
					delay=0
				[/harm_unit]
			[/do]
		[/for]
	[/event]
#enddef

#define REGISTER_LEVIATHANS_CALL
	[event]
		name=attacker hits
		first_time_only=no
		
		[filter_attack]
			special_id=qquws_leviathans_call
		[/filter_attack]

		[if]
			[variable]
				name=second_unit.hitpoints
				greater_than=0
			[/variable]
			[then]
				[if]
					[have_unit]
						id=$second_unit.id
						trait=qquws_leviathan_trait
					[/have_unit]
					[then]
						[remove_trait]
							id=$second_unit.id
							trait_id=qquws_leviathan_trait
						[/remove_trait]

						{VARIABLE lc_counter $second_unit.variables.leviathans_call_counter}
						{VARIABLE_OP lc_counter add 1}
						{VARIABLE mp_reduction $lc_counter}
						{VARIABLE dmg_reduction "$( -15 * $lc_counter )"}

						[if]
							[variable]
								name=lc_counter
								greater_than=6
							[/variable]
							[then]
								{VARIABLE dmg_reduction "-90"}
							[/then]
						[/if]

						{VARIABLE color_change_small "$( 15 * $lc_counter )"}
						{VARIABLE color_change_big "$( 25 * $lc_counter )"}

						[modify_unit]
							[filter]
								id=$second_unit.id
							[/filter]
							
							[variables]
								leviathans_call_counter=$lc_counter
							[/variables]

							[trait]
								id=qquws_leviathan_trait
								name="<span color='#802a37'>leviathan's call</span>"
								description="This unit responses to the Leviathan's call."

								[effect]
									apply_to=attack
								    increase_damage="$dmg_reduction|%"
								[/effect]
								[effect]
									apply_to=movement
								    increase=-$mp_reduction
								[/effect]
								[effect]
									apply_to=image_mod
									add="~CS($color_change_small,$color_change_small,$color_change_big)"
								[/effect]
							[/trait]
						[/modify_unit]

						[floating_text]
							x,y=$second_unit.x,$second_unit.y
							text="<span color='#802a37'>Leviathan's Call</span>"
						[/floating_text]
					[/then]
					[else]
						[modify_unit]
							[filter]
								id=$second_unit.id
							[/filter]
							
							[variables]
								leviathans_call_counter=1
							[/variables]

							[trait]
								id=qquws_leviathan_trait
								name="<span color='#802a37'>leviathan's call</span>"
								description="This unit responses to the Leviathan's call."

								[effect]
									apply_to=attack
								    increase_damage=-15%
								[/effect]
								[effect]
									apply_to=movement
								    increase=-1
								[/effect]
								[effect]
									apply_to=image_mod
									add="~CS(15,15,25)"
								[/effect]
							[/trait]
						[/modify_unit]

						[floating_text]
							x,y=$second_unit.x,$second_unit.y
							text="<span color='#802a37'>Leviathan's Call</span>"
						[/floating_text]

						[set_variables]
							name=qquws_lasting_effect_information
							mode=append
							[value]
							    id=$second_unit.id
							    side=$second_unit.side
							    end_of_effect_turn="$( $turn_number + 5 )"
							    effect_type=leviathans_call
							[/value]
						[/set_variables]
					[/else]
				[/if]
			[/then]
		[/if]
	[/event]
#enddef

#define REGISTER_NON_LIVING_DRAINS
	[event]
		name=attacker hits
		first_time_only=no
		
		[filter_attack]
			special_id=qquws_non_living_drains
		[/filter_attack]

		[filter_second]
			status=not_living
		[/filter_second]
		
		[fire_event]
			name=handle_non_living_drains
			[primary_unit]
				id=$unit.id
			[/primary_unit]
		[/fire_event]
	[/event]
	
	[event]
		name=defender hits
		first_time_only=no
		
		[filter_second_attack]
			special_id=qquws_non_living_drains
		[/filter_second_attack]

		[filter]
			status=not_living
		[/filter]
		
		[fire_event]
			name=handle_non_living_drains
			[primary_unit]
				id=$second_unit.id
			[/primary_unit]
		[/fire_event]
	[/event]

	[event]
		name=handle_non_living_drains
		first_time_only=no

		{VARIABLE heal_amount "$( floor( $damage_inflicted * $unit.variables.non_living_drains / 100 ))"}
		[if]
			[variable]
				name=heal_amount
				greater_than=0
			[/variable]
			[then]
				[heal_unit]
					[filter]
						id=$unit.id
					[/filter]
					
					amount=$heal_amount
					animate=yes
				[/heal_unit]
			[/then]
		[/if]
	[/event]
#enddef

#define REGISTER_COUNTERBALANCE
	[event]
		name=attacker misses
		first_time_only=no

		[filter_second_attack]
			special_id=qquws_counterbalance
		[/filter_second_attack]

		{VARIABLE_OP counterbalance_random rand 0..99}
		[set_variables]
			name=tmp_retaliation_counter
			mode=replace
			
			[split]
				list=$second_unit.variables.counterbalance_list
				key=threshold
				separator=","
				remove_empty=yes
			[/split]
		[/set_variables]
		
		{VARIABLE counterbalance_retaliation_counter 0}
		[foreach]
			array=tmp_retaliation_counter
			variable=tmp_counter
			readonly=yes
			
			[do]
				[if]
					[variable]
						name=tmp_counter.threshold
						less_than=$counterbalance_random
					[/variable]
					[then]
						{VARIABLE_OP counterbalance_retaliation_counter add 1}
					[/then]
				[/if]
			[/do]
		[/foreach]

		{VARIABLE counter_is_fatal yes}
		{VARIABLE counter_killed_cutoff 0}
		{VARIABLE counter_is_peaceful_warrior no}

		[if]
			[variable]
				name=counterbalance_retaliation_counter
				greater_than=0
			[/variable]
			[then]
				[floating_text]
					x,y=$second_unit.x,$second_unit.y
					text="<span color='#ee5555'>Counter!</span>"
				[/floating_text]

				[if]
					[have_unit]
						id=$second_unit.id
						ability=qquws_peaceful_warrior
					[/have_unit]
					[then]
						{VARIABLE counter_is_fatal no}
						{VARIABLE counter_killed_cutoff 1}
						{VARIABLE counter_is_peaceful_warrior yes}
					[/then]
				[/if]
			[/then]
		[/if]

		[for]
			variable=i
			start=1
			end=$counterbalance_retaliation_counter
			step=1
			[do]
				[if]
					[variable]
						name=unit.hitpoints
						greater_than=$counter_killed_cutoff
					[/variable]
					[then]
						[harm_unit]
							[filter]
								id=$unit.id
							[/filter]

							[filter_second]
								id=$second_unit.id
							[/filter_second]

							[primary_attack]
								name=$second_weapon.name
							[/primary_attack]

							amount="$( ceil($second_weapon.damage * 0.5) )"
							alignment=$second_unit.alignment
							damage_type=$second_weapon.type
							kill=$counter_is_fatal
							fire_event=yes
							animate=yes
							delay=250
						[/harm_unit]
					[/then]
					[else]
						[if]
							[variable]
								name=counter_is_peaceful_warrior
								boolean_equals=yes
							[/variable]
							[then]
								[if]
									[have_unit]
										id=$unit.id
										[not]
											ability=qquws_disarmed
										[/not]
									[/have_unit]
									[then]
										[fire_event]
											name=qquws_peaceful_warrior

											[primary_unit]
												id=$unit.id
											[/primary_unit]
										[/fire_event]
									[/then]
								[/if]
							[/then]
						[/if]
					[/else]
				[/if]
			[/do]
		[/for]
	[/event]
#enddef

#define REGISTER_PEACEFUL_WARRIOR
	[event]
		name=last breath
		first_time_only=no
		priority=5

		[filter]
			# ensures that the dying unit was attacking (peaceful warrior is defense only)
			side=$side_number
			[not]
				ability=qquws_disarmed
			[/not]
		[/filter]

		[filter_second]
			ability=qquws_peaceful_warrior
		[/filter_second]

		[fire_event]
			name=qquws_peaceful_warrior

			[primary_unit]
				id=$unit.id
			[/primary_unit]
		[/fire_event]
	[/event]

	[event]
		name=qquws_peaceful_warrior
		first_time_only=no

		[floating_text]
			x,y=$unit.x,$unit.y
			text="<span color='#7766ff'>Disarm!</span>"
		[/floating_text]

		[modify_unit]
			[filter]
				id=$unit.id
			[/filter]

			hitpoints=1

			[object]
				silent=yes
				duration=turn

				[effect]
					apply_to=remove_attacks
				[/effect]
				[effect]
					apply_to=new_ability
					[abilities]
						[dummy]
							id=qquws_disarmed
						[/dummy]
					[/abilities]
				[/effect]
			[/object]
		[/modify_unit]
	[/event]
#enddef

#define REGISTER_COLD_MASTERY_AURA
	{UNIT_BASED_GLOBAL_ALLY_BUFF qquws_cold_mastery_trait qquws_global_cold_mastery apply_cold_mastery_to_all_allies "cold master's presence" "This unit benefits from the cold mastery aura." (
		[effect]
			apply_to=attack
			type=cold
			increase_damage="$global_buff_unit.variables.cold_damage_increase|%"
		[/effect]
	) (
		[if]
			[variable]
				name=uws_game.is_pvp
				boolean_equals=yes
			[/variable]
			[then]
				[store_unit]
					[filter]
						side=$unit.side
						ability=qquws_global_cold_mastery
					[/filter]
					
					variable=global_buff_unit
					mode=always_clear
				[/store_unit]
			[/then]
			[else]
				[store_unit]
					[filter]
						ability=qquws_global_cold_mastery
						
						[filter_side]
							[allied_with]
								side=$unit.side
							[/allied_with]
						[/filter_side]
					[/filter]
					
					variable=global_buff_unit
					mode=always_clear
				[/store_unit]
			[/else]
		[/if]
	)}
#enddef

#define REGISTER_ARCANE_MASTERY_AURA
	{UNIT_BASED_GLOBAL_ALLY_BUFF qquws_arcane_mastery_trait qquws_global_arcane_mastery apply_arcane_mastery_to_all_allies "arcane master's presence" "This unit benefits from the arcane mastery aura." (
		[effect]
			apply_to=attack
			type=arcane
			increase_damage="$global_buff_unit.variables.arcane_damage_increase|%"
		[/effect]
	) (
		[if]
			[variable]
				name=uws_game.is_pvp
				boolean_equals=yes
			[/variable]
			[then]
				[store_unit]
					[filter]
						side=$unit.side
						ability=qquws_global_arcane_mastery
					[/filter]
					
					variable=global_buff_unit
					mode=always_clear
				[/store_unit]
			[/then]
			[else]
				[store_unit]
					[filter]
						ability=qquws_global_arcane_mastery
						
						[filter_side]
							[allied_with]
								side=$unit.side
							[/allied_with]
						[/filter_side]
					[/filter]
					
					variable=global_buff_unit
					mode=always_clear
				[/store_unit]
			[/else]
		[/if]
	)}
#enddef

#define REGISTER_FIRE_MASTERY_AURA
	{UNIT_BASED_GLOBAL_ALLY_BUFF qquws_fire_mastery_trait qquws_global_fire_mastery apply_fire_mastery_to_all_allies "fire master's presence" "This unit benefits from the fire mastery aura." (
		[effect]
			apply_to=attack
			type=fire
			increase_damage="$global_buff_unit.variables.fire_damage_increase|%"
		[/effect]
	) (
		[if]
			[variable]
				name=uws_game.is_pvp
				boolean_equals=yes
			[/variable]
			[then]
				[store_unit]
					[filter]
						side=$unit.side
						ability=qquws_global_fire_mastery
					[/filter]
					
					variable=global_buff_unit
					mode=always_clear
				[/store_unit]
			[/then]
			[else]
				[store_unit]
					[filter]
						ability=qquws_global_fire_mastery
						
						[filter_side]
							[allied_with]
								side=$unit.side
							[/allied_with]
						[/filter_side]
					[/filter]
					
					variable=global_buff_unit
					mode=always_clear
				[/store_unit]
			[/else]
		[/if]
	)}
#enddef

#define REGISTER_BLADE_MASTERY_AURA
	{UNIT_BASED_GLOBAL_ALLY_BUFF qquws_blade_mastery_trait qquws_global_blade_mastery apply_blade_mastery_to_all_allies "blade master's presence" "This unit benefits from the blade mastery aura." (
		[effect]
			apply_to=attack
			type=blade
			increase_damage="$global_buff_unit.variables.blade_damage_increase|%"
		[/effect]
	) (
		[if]
			[variable]
				name=uws_game.is_pvp
				boolean_equals=yes
			[/variable]
			[then]
				[store_unit]
					[filter]
						side=$unit.side
						ability=qquws_global_blade_mastery
					[/filter]
					
					variable=global_buff_unit
					mode=always_clear
				[/store_unit]
			[/then]
			[else]
				[store_unit]
					[filter]
						ability=qquws_global_blade_mastery
						
						[filter_side]
							[allied_with]
								side=$unit.side
							[/allied_with]
						[/filter_side]
					[/filter]
					
					variable=global_buff_unit
					mode=always_clear
				[/store_unit]
			[/else]
		[/if]
	)}
#enddef

#define REGISTER_IMPACT_MASTERY_AURA
	{UNIT_BASED_GLOBAL_ALLY_BUFF qquws_impact_mastery_trait qquws_global_impact_mastery apply_impact_mastery_to_all_allies "impact master's presence" "This unit benefits from the impact mastery aura." (
		[effect]
			apply_to=attack
			type=impact
			increase_damage="$global_buff_unit.variables.impact_damage_increase|%"
		[/effect]
	) (
		[if]
			[variable]
				name=uws_game.is_pvp
				boolean_equals=yes
			[/variable]
			[then]
				[store_unit]
					[filter]
						side=$unit.side
						ability=qquws_global_impact_mastery
					[/filter]
					
					variable=global_buff_unit
					mode=always_clear
				[/store_unit]
			[/then]
			[else]
				[store_unit]
					[filter]
						ability=qquws_global_impact_mastery
						
						[filter_side]
							[allied_with]
								side=$unit.side
							[/allied_with]
						[/filter_side]
					[/filter]
					
					variable=global_buff_unit
					mode=always_clear
				[/store_unit]
			[/else]
		[/if]
	)}
#enddef

#define REGISTER_PIERCE_MASTERY_AURA
	{UNIT_BASED_GLOBAL_ALLY_BUFF qquws_pierce_mastery_trait qquws_global_pierce_mastery apply_pierce_mastery_to_all_allies "pierce master's presence" "This unit benefits from the pierce mastery aura." (
		[effect]
			apply_to=attack
			type=pierce
			increase_damage="$global_buff_unit.variables.pierce_damage_increase|%"
		[/effect]
	) (
		[if]
			[variable]
				name=uws_game.is_pvp
				boolean_equals=yes
			[/variable]
			[then]
				[store_unit]
					[filter]
						side=$unit.side
						ability=qquws_global_pierce_mastery
					[/filter]
					
					variable=global_buff_unit
					mode=always_clear
				[/store_unit]
			[/then]
			[else]
				[store_unit]
					[filter]
						ability=qquws_global_pierce_mastery
						
						[filter_side]
							[allied_with]
								side=$unit.side
							[/allied_with]
						[/filter_side]
					[/filter]
					
					variable=global_buff_unit
					mode=always_clear
				[/store_unit]
			[/else]
		[/if]
	)}
#enddef

#define REGISTER_INSURANCE
	[event]
		name=die
		first_time_only=no

		[filter]
			ability=qquws_insured_unit
		[/filter]

		[if]
			[variable]
				name=unit.variables.kills
				greater_than=0
			[/variable]
			[then]
				{VARIABLE insurance_gold "$( $unit.variables.kills * $unit.variables.insurance_multiplier )"}
				
				[floating_text]
					x,y=$x1,$y1
					text="<span color='#ebae2a' size='large'>Insurance +$insurance_gold gold!</span>"
				[/floating_text]

				[gold]
					side=$unit.side
					amount=$insurance_gold
				[/gold]
			[/then]
		[/if]
	[/event]
#enddef

#define REGISTER_REANIMATES
	[event]
		name=attacker misses
		first_time_only=no

		[filter_second]
			ability=qquws_reanimation
		[/filter_second]

		[heal_unit]
			[filter]
				id=$second_unit.id
			[/filter]
			
			amount=$second_unit.variables.reanimation_heal
			restore_statuses=no
			animate=yes
		[/heal_unit]
	[/event]

	[event]
		name=defender misses
		first_time_only=no

		[filter]
			ability=qquws_reanimation
		[/filter]

		[heal_unit]
			[filter]
				id=$unit.id
			[/filter]
			
			amount=$unit.variables.reanimation_heal
			restore_statuses=no
			animate=yes
		[/heal_unit]
	[/event]
#enddef

#define REGISTER_STONE_SKIN
	[event]
		name=attacker hits
		first_time_only=no

		[filter_second]
			ability=qquws_stone_skin
		[/filter_second]

		{VARIABLE stone_skin_weapon_type $weapon.type}
		[fire_event]
			name=handle_stone_skin
			[primary_unit]
				id=$second_unit.id
			[/primary_unit]
		[/fire_event]
	[/event]

	[event]
		name=defender hits
		first_time_only=no

		[filter]
			ability=qquws_stone_skin
		[/filter]

		{VARIABLE stone_skin_weapon_type $second_weapon.type}
		[fire_event]
			name=handle_stone_skin
			[primary_unit]
				id=$unit.id
			[/primary_unit]
		[/fire_event]
	[/event]

	[event]
		name=handle_stone_skin
		first_time_only=no

		[if]
			[variable]
				name=unit.resistance.$stone_skin_weapon_type
				greater_than=15
			[/variable]
			[then]
				[modify_unit]
					[filter]
						id=$unit.id
					[/filter]
						
					[object]
						silent=yes
						
						[effect]
						    apply_to=remove_resistance
						    type=$stone_skin_weapon_type
						    amount="$( -1 * $unit.variables.stone_skin_amount )"
						[/effect]
					[/object]
				[/modify_unit]

				[floating_text]
					x,y=$unit.x,$unit.y
					text="<span color='#9f87a3'>Stone skin +$unit.variables.stone_skin_amount</span>"
				[/floating_text]
			[/then]
		[/if]
	[/event]
#enddef

#define REGISTER_ASTRAL_VAMPIRE
	[event]
		name=attack
		first_time_only=no

		[filter_second]
			ability=qquws_astral_vampire
		[/filter_second]

		{VARIABLE damage_dealt "$( ceil( $unit.hitpoints * $second_unit.variables.astral_vampire_amount / 100.0 ) )"}
		{VARIABLE reheal_amount "$( ceil( $damage_dealt * 0.5 ) )"}

		[harm_unit]
			[filter]
				id=$unit.id
			[/filter]

			[filter_second]
				id=$second_unit.id
			[/filter_second]
			
			amount=$damage_dealt
			alignment=neutral
			kill=yes
			animate=yes
			experience=yes
		[/harm_unit]

		[heal_unit]
			[filter]
				id=$second_unit.id
			[/filter]
			
			amount=$reheal_amount
			restore_statuses=no
			animate=yes
		[/heal_unit]
	[/event]
#enddef

#define REGISTER_BATTLE_STUDY
	[event]
		name=die
		first_time_only=no

		[filter_second]
			ability=qquws_battle_study
		[/filter_second]

		{VARIABLE unit_xp "$( $second_unit.experience + floor( $second_unit.variables.battle_study_self * [4,8,16,24,32,40,48,56][$unit.level] / 100.0 ) )"}
		[if]
			[variable]
				name=unit_xp
				greater_than_equal_to=$second_unit.max_experience
			[/variable]
			[then]
				{VARIABLE unit_xp "$( $second_unit.max_experience - 1 )"}
			[/then]
		[/if]

		{VARIABLE diff "$( $unit_xp - $second_unit.experience )"}
		[if]
			[variable]
				name=diff
				greater_than=0
			[/variable]
			[then]
				[modify_unit]
					[filter]
						id=$second_unit.id
					[/filter]

					experience=$unit_xp
				[/modify_unit]

				[floating_text]
					x,y=$second_unit.x,$second_unit.y
					text="<span color='#608dd1'>+$diff|xp</span>"
				[/floating_text]
			[/then]
		[/if]
	[/event]

	[event]
		name=die
		first_time_only=no

		[filter_second]
			[filter_adjacent]
				ability=qquws_battle_study_adjacent_enabled
				is_enemy=no
			[/filter_adjacent]
		[/filter_second]

		[store_unit]
			[filter]
				ability=qquws_battle_study_adjacent_enabled
				[filter_adjacent]
					id=$second_unit.id
					is_enemy=no
				[/filter_adjacent]
			[/filter]
			
			variable=battle_study
			mode=always_clear
		[/store_unit]

		{VARIABLE unit_xp "$( $second_unit.experience + floor( $battle_study.variables.battle_study_adjacent * [4,8,16,24,32,40,48,56][$unit.level] / 100.0 ) )"}
		[if]
			[variable]
				name=unit_xp
				greater_than_equal_to=$second_unit.max_experience
			[/variable]
			[then]
				{VARIABLE unit_xp "$( $second_unit.max_experience - 1 )"}
			[/then]
		[/if]

		{VARIABLE diff "$( $unit_xp - $second_unit.experience )"}
		[if]
			[variable]
				name=diff
				greater_than=0
			[/variable]
			[then]
				[modify_unit]
					[filter]
						id=$second_unit.id
					[/filter]

					experience=$unit_xp
				[/modify_unit]

				[floating_text]
					x,y=$second_unit.x,$second_unit.y
					text="<span color='#608dd1'>+$diff|xp</span>"
				[/floating_text]
			[/then]
		[/if]
	[/event]
#enddef

#define REGISTER_COMBAT_TEACHER
	[event]
		name=side turn
		first_time_only=no

		[filter_side]
			[has_unit]
				ability=qquws_combat_teacher
			[/has_unit]
		[/filter_side]

		[store_unit]
			[filter]
				side=$side_number
				ability=qquws_combat_teacher
			[/filter]
			
			variable=teachers
			mode=always_clear
		[/store_unit]

		[for]
			array=teachers
			variable=i
			[do]
				[store_unit]
					[filter]
						side=$side_number
						[filter_adjacent]
							id=$teachers[$i].id
						[/filter_adjacent]
					[/filter]
					
					variable=teacher_adjacent
					mode=always_clear
				[/store_unit]

				[for]
					array=teacher_adjacent
					variable=j
					[do]
						{VARIABLE unit_xp $teacher_adjacent[$j].experience}
						{VARIABLE_OP unit_xp add $teachers[$i].variables.combat_teacher_amount}

						[if]
							[variable]
								name=unit_xp
								greater_than_equal_to=$teacher_adjacent[$j].max_experience
							[/variable]
							[then]
								{VARIABLE unit_xp $teacher_adjacent[$j].max_experience}
								{VARIABLE_OP unit_xp sub 1}
							[/then]
						[/if]

						{VARIABLE diff $unit_xp}
						{VARIABLE_OP diff sub $teacher_adjacent[$j].experience}

						[if]
							[variable]
								name=diff
								greater_than=0
							[/variable]
							[then]
								[modify_unit]
									[filter]
										id=$teacher_adjacent[$j].id
									[/filter]

									experience=$unit_xp
								[/modify_unit]

								[floating_text]
									x,y=$teacher_adjacent[$j].x,$teacher_adjacent[$j].y
									text="<span color='#608dd1'>+$diff|xp</span>"
								[/floating_text]
							[/then]
						[/if]
					[/do]
				[/for]
			[/do]
		[/for]
	[/event]
#enddef

#define REGISTER_INTELLIGENCE_INCREASE
	{UNIT_BASED_GLOBAL_ALLY_BUFF intelligent qquws_intelligence_increase apply_intelligent_trait_to_all_allies "intelligent" "Intelligent units require 20% less experience than usual to advance." (
		[effect]
            apply_to=max_experience
            increase=-20%
        [/effect]
	) ()}
#enddef

#define REGISTER_ENERGETICAL_SHIELD
	[event]
		name=turn refresh
		first_time_only=no

		[modify_unit]
			[filter]
				ability=qquws_energy_shield
			[/filter]

			[status]
				qquws_active_shield=yes
			[/status]
		[/modify_unit]
	[/event]

	[event]
		name=attack end
		first_time_only=no

		[filter_second]
			ability=qquws_energy_shield
			status=qquws_active_shield
		[/filter_second]

		[modify_unit]
			[filter]
				id=$second_unit.id
			[/filter]

			[status]
				qquws_active_shield=no
			[/status]
		[/modify_unit]
	[/event]
#enddef

#define REGISTER_MOONSONG
	[event]
		name=turn refresh
		first_time_only=no

		[filter_side]
			[has_unit]
				ability=qquws_moon_song
				[filter_location]
					time_of_day_id=first_watch,midnight,second_watch
				[/filter_location]
			[/has_unit]
		[/filter_side]

		[modify_unit]
			[filter]
				ability=qquws_moon_song
				[filter_location]
					time_of_day_id=first_watch,midnight,second_watch
				[/filter_location]
			[/filter]

			attacks_left=2
		[/modify_unit]
	[/event]

	[event]
		name=attack end
		first_time_only=no

		[filter]
			ability=qquws_moon_song
			[filter_location]
				time_of_day_id=first_watch,midnight,second_watch
			[/filter_location]
		[/filter]

		[if]
			[variable]
				name=unit.attacks_left
				greater_than=0
			[/variable]
			[then]
				[floating_text]
					x,y=$unit.x,$unit.y
					text="<span color='#abbac2'>The Moon is bright!</span>"
				[/floating_text]
			[/then]
		[/if]
	[/event]
#enddef

#define REGISTER_SUNSONG
	[event]
		name=turn refresh
		first_time_only=no

		[filter_side]
			[has_unit]
				ability=qquws_sun_song
				[filter_location]
					time_of_day_id=morning,afternoon
				[/filter_location]
			[/has_unit]
		[/filter_side]

		[modify_unit]
			[filter]
				ability=qquws_sun_song
				[filter_location]
					time_of_day_id=morning,afternoon
				[/filter_location]
			[/filter]

			attacks_left=2
		[/modify_unit]
	[/event]

	[event]
		name=attack end
		first_time_only=no

		[filter]
			ability=qquws_sun_song
			[filter_location]
				time_of_day_id=morning,afternoon
			[/filter_location]
		[/filter]

		[if]
			[variable]
				name=unit.attacks_left
				greater_than=0
			[/variable]
			[then]
				[floating_text]
					x,y=$unit.x,$unit.y
					text="<span color='#f0ce37'>The Sun is bright!</span>"
				[/floating_text]
			[/then]
		[/if]
	[/event]
#enddef

#define REGISTER_FIGHT_RECUPERATION
	[event]
		name=attack end
		first_time_only=no

		[filter]
			ability=qquws_fight_recuperation
		[/filter]

		[if]
			[variable]
				name=unit.hitpoints
				greater_than=0
			[/variable]
			[then]
				[heal_unit]
					[filter]
						id=$unit.id
					[/filter]

					amount=$unit.variables.recuperation_amount
					animate=yes
					restore_statuses=no
				[/heal_unit]
			[/then]
		[/if]
	[/event]

	[event]
		name=attack end
		first_time_only=no

		[filter_second]
			ability=qquws_fight_recuperation
		[/filter_second]

		[if]
			[variable]
				name=second_unit.hitpoints
				greater_than=0
			[/variable]
			[then]
				[heal_unit]
					[filter]
						id=$second_unit.id
					[/filter]

					amount=$second_unit.variables.recuperation_amount
					animate=yes
					restore_statuses=no
				[/heal_unit]
			[/then]
		[/if]
	[/event]
#enddef

#define REGISTER_FIGHT_RECOVERY
	[event]
		name=attack end
		first_time_only=no

		[filter]
			ability=qquws_fight_recovery
		[/filter]

		[if]
			[variable]
				name=unit.hitpoints
				greater_than=0
			[/variable]
			[then]
				[heal_unit]
					[filter]
						id=$unit.id
					[/filter]

					amount=$unit.variables.recovery_amount
					animate=yes
					restore_statuses=yes
				[/heal_unit]
			[/then]
		[/if]
	[/event]

	[event]
		name=attack end
		first_time_only=no

		[filter_second]
			ability=qquws_fight_recovery
		[/filter_second]

		[if]
			[variable]
				name=second_unit.hitpoints
				greater_than=0
			[/variable]
			[then]
				[heal_unit]
					[filter]
						id=$second_unit.id
					[/filter]

					amount=$second_unit.variables.recovery_amount
					animate=yes
					restore_statuses=yes
				[/heal_unit]
			[/then]
		[/if]
	[/event]
#enddef

#define REGISTER_AMLA_FIGHT_RECOVERY
	[event]
		name=attack end
		first_time_only=no

		[filter]
			ability=qquws_amla_fight_recovery
		[/filter]

		[if]
			[variable]
				name=unit.hitpoints
				greater_than=0
			[/variable]
			[then]
				[heal_unit]
					[filter]
						id=$unit.id
					[/filter]

					amount=0
					animate=yes
					restore_statuses=yes
				[/heal_unit]
			[/then]
		[/if]
	[/event]

	[event]
		name=attack end
		first_time_only=no

		[filter_second]
			ability=qquws_amla_fight_recovery
		[/filter_second]

		[if]
			[variable]
				name=second_unit.hitpoints
				greater_than=0
			[/variable]
			[then]
				[heal_unit]
					[filter]
						id=$second_unit.id
					[/filter]

					amount=0
					animate=yes
					restore_statuses=yes
				[/heal_unit]
			[/then]
		[/if]
	[/event]
#enddef

#define REGISTER_BLOODLINE
	{UNIT_BASED_GLOBAL_ALLY_BUFF qquws_bloodline_trait qquws_bloodline apply_bloodline_to_all_allies "bloodline" "This unit benefits from the bloodline. It's hitpoints are increased." (
		[effect]
		    apply_to=hitpoints
		    increase="$global_buff_unit.variables.bloodline_increase|%"
			increase_total="$global_buff_unit.variables.bloodline_increase|%"
		[/effect]
	) (
		[if]
			[variable]
				name=uws_game.is_pvp
				boolean_equals=yes
			[/variable]
			[then]
				[store_unit]
					[filter]
						side=$unit.side
						ability=qquws_bloodline
					[/filter]
					
					variable=global_buff_unit
					mode=always_clear
				[/store_unit]
			[/then]
			[else]
				[store_unit]
					[filter]
						ability=qquws_bloodline
						
						[filter_side]
							[allied_with]
								side=$unit.side
							[/allied_with]
						[/filter_side]
					[/filter]
					
					variable=global_buff_unit
					mode=always_clear
				[/store_unit]
			[/else]
		[/if]
	)}
#enddef

#define REGISTER_SHROUD_OF_INVISIBILITY
	[event]
		name=turn refresh
		first_time_only=no

		[filter_side]
			[has_unit]
				side=$side_number
				ability=qquws_shroud_of_invisibility
			[/has_unit]
		[/filter_side]

		[store_unit]
			[filter]
				side=$side_number
				ability=qquws_shroud_of_invisibility
			[/filter]
			
			variable=shroud_of_invi_units
			mode=always_clear
		[/store_unit]
		
		[for]
			array=shroud_of_invi_units
			variable=i
			[do]
				[modify_unit]
					[filter]
						[filter_location]
							x,y=$shroud_of_invi_units[$i].x,$shroud_of_invi_units[$i].y
							radius=$shroud_of_invi_units[$i].variables.invisibility_radius
							[filter_radius]
								terrain="!,_off^_usr,X*,M*^X*"
							[/filter_radius]
						[/filter_location]
						
						[filter_side]
							[allied_with]
								side=$side_number
							[/allied_with]
						[/filter_side]

						[not]
							ability=qquws_shroud_of_invisibility
						[/not]
					[/filter]

					[object]
						silent=yes
						duration=turn

						[effect]
							apply_to=new_ability
							[abilities]
								[hides]
									id=invisible
									name="invisible"
									description="The unit is constantly invisible when in the presence of the shroud of invisibility, except when a unit comes next to it. Any enemy unit that first discovers this unit immediately loses all its remaining movement."
									affect_self=yes
								[/hides]
							[/abilities]
						[/effect]
					[/object]
				[/modify_unit]
			[/do]
		[/for]
	[/event]
#enddef

#define REGISTER_DRUMS_OF_WAR
	[event]
		name=turn refresh
		first_time_only=no

		[filter_side]
			[has_unit]
				side=$side_number
				ability=qquws_drums_of_war
			[/has_unit]
		[/filter_side]

		[store_unit]
			[filter]
				side=$side_number
				ability=qquws_drums_of_war
			[/filter]
			
			variable=drums_units
			mode=always_clear
		[/store_unit]
		
		[for]
			array=drums_units
			variable=i
			[do]
				{VARIABLE damage_increase $drums_units[$i].variables.drums_of_war_increase}
				[modify_unit]
					[filter]
						[filter_location]
							x,y=$drums_units[$i].x,$drums_units[$i].y
							radius=5
							[filter_radius]
								terrain="!,_off^_usr,X*,M*^X*"
							[/filter_radius]
						[/filter_location]
						
						[filter_side]
							[allied_with]
								side=$side_number
							[/allied_with]
						[/filter_side]

						[not]
							ability=qquws_drums_of_war
						[/not]
					[/filter]

					[object]
						silent=yes
						duration=turn

						[effect]
							apply_to=attack
							[set_specials]
								mode=append
								[damage]
									id=qquws_drums_of_war_effect
									multiply="( (100.0 + $damage_increase ) / 100.0 )"
									apply_to=self
								[/damage]
							[/set_specials]
						[/effect]
						[effect]
							apply_to=image_mod
							add="~CS(65,0,0)"
						[/effect]
					[/object]
				[/modify_unit]
			[/do]
		[/for]
	[/event]
#enddef

#define REGISTER_ASSASSINATION
	[event]
		name=attacker hits
		first_time_only=no

		[filter_attack]
			special_id=qquws_assassination
		[/filter_attack]

		[if]
			[variable]
				name=second_unit.hitpoints
				greater_than=0
			[/variable]
			[then]
				{VARIABLE assassination_threshold "$( floor( $damage_inflicted * $unit.variables.assassination_factor ))"}

				[if]
					[variable]
						name=second_unit.hitpoints
						less_than_equal_to=$assassination_threshold
					[/variable]
					[then]
						[floating_text]
							x,y=$second_unit.x,$second_unit.y
							text="<span color='#ff2222'>Assassination!</span>"
						[/floating_text]

						[harm_unit]
							[filter]
								id=$second_unit.id
							[/filter]

							[filter_second]
								id=$unit.id
							[/filter_second]

							[secondary_attack]
								name=$weapon.name
							[/secondary_attack]

							amount=999
							kill=yes
							fire_event=yes
							animate=yes
							experience=kill
						[/harm_unit]
					[/then]
				[/if]
			[/then]
		[/if]
	[/event]
#enddef

#define REGISTER_RANDOM_DAMAGE
	[event]
		name=attacker hits,attacker misses
		first_time_only=no

		[filter_attack]
			special_id=qquws_random_damage
		[/filter_attack]

		{VARIABLE damage_factor "$( [50,50,60,65,75,85,100,120,120,120,120,120,120,130,140,150,175,200,240][1d18] )"}
		{VARIABLE_OP damage_factor divide 100000}

		[modify_unit]
			[filter]
				id=$unit.id
			[/filter]

			[variables]
				random_damage_factor=$damage_factor
			[/variables]
		[/modify_unit]
	[/event]

	[event]
		name=defender hits,defender misses
		first_time_only=no

		[filter_second_attack]
			special_id=qquws_random_damage
		[/filter_second_attack]

		{VARIABLE damage_factor "$( [50,50,60,65,75,85,100,120,120,120,120,120,120,130,140,150,175,200,240][1d18] )"}
		{VARIABLE_OP damage_factor divide 100000}

		[modify_unit]
			[filter]
				id=$second_unit.id
			[/filter]

			[variables]
				random_damage_factor=$damage_factor
			[/variables]
		[/modify_unit]
	[/event]
#enddef

#define REGISTER_SHIELD_MASTER
	[event]
		name=attack,attacker hits,attacker misses
		first_time_only=no

		[filter_second]
			ability=qquws_shield_master
		[/filter_second]

		[if]
			[variable]
				name=second_unit.hitpoints
				greater_than=0
			[/variable]
			[then]
				[fire_event]
					name=qquws_handle_shield_master_e
					[primary_unit]
						id=$second_unit.id
					[/primary_unit]
				[/fire_event]
			[/then]
		[/if]
	[/event]

	[event]
		name=attack,attacker hits,attacker misses
		first_time_only=no

		[filter_second]
			id=$second_unit.id
			[filter_adjacent]
				ability=qquws_shield_master
				is_enemy=no
			[/filter_adjacent]
		[/filter_second]

		[store_unit]
			[filter]
				ability=qquws_shield_master
				[filter_adjacent]
					id=$second_unit.id
					is_enemy=no
				[/filter_adjacent]
			[/filter]
			
			variable=shield_master_unit
			mode=always_clear
		[/store_unit]

		[if]
			[variable]
				name=second_unit.hitpoints
				greater_than=0
			[/variable]
			[then]
				[fire_event]
					name=qquws_handle_shield_master_e
					[primary_unit]
						id=$shield_master_unit.id
					[/primary_unit]
				[/fire_event]
			[/then]
		[/if]
	[/event]

	[event]
		name=attack_end
		first_time_only=no

		[filter_second]
			ability=qquws_shield_master
		[/filter_second]

		[modify_unit]
			[filter]
				id=$second_unit.id
			[/filter]

			[status]
				qquws_shield_master_active=no
			[/status]
		[/modify_unit]
	[/event]

	[event]
		name=attack_end
		first_time_only=no

		[filter_second]
			id=$second_unit.id
			[filter_adjacent]
				ability=qquws_shield_master
				is_enemy=no
			[/filter_adjacent]
		[/filter_second]

		[modify_unit]
			[filter]
				ability=qquws_shield_master
				[filter_adjacent]
					id=$second_unit.id
					is_enemy=no
				[/filter_adjacent]
			[/filter]

			[status]
				qquws_shield_master_active=no
			[/status]
		[/modify_unit]
	[/event]

	[event]
		name=qquws_handle_shield_master_e
		first_time_only=no

		[if]
			[have_unit]
				id=$unit.id
				status=qquws_shield_master_active
			[/have_unit]
			[and]
				[variable]
					name=damage_inflicted
					not_equals=""
				[/variable]
			[/and]
			[then]
				[floating_text]
					x,y=$unit.x,$unit.y
					text="<span color='#7da194'>Shielded!</span>"
				[/floating_text]
			[/then]
		[/if]

		{VARIABLE shield_is_active no}
		{VARIABLE_OP shield_rand rand 0..99}
		[if]
			[variable]
				name=shield_rand
				less_than=$unit.variables.qquws_shield_master_chance
			[/variable]
			[then]
				{VARIABLE shield_is_active yes}
			[/then]
		[/if]

		[modify_unit]
			[filter]
				id=$unit.id
			[/filter]

			[status]
				qquws_shield_master_active=$shield_is_active
			[/status]
		[/modify_unit]
	[/event]
#enddef

#define REGISTER_EARTHQUAKE
	[event]
		name=moveto
		first_time_only=no

		[filter]
			ability=qquws_earthquake
			[filter_adjacent]
				is_enemy=yes
			[/filter_adjacent]
		[/filter]

		[floating_text]
			x,y=$x1,$y1
			text="<span color='#a67e63'>Quake!</span>"
		[/floating_text]
		{QUAKE "rumble.ogg"}
		[modify_unit]
			[filter]
				[filter_adjacent]
					id=$unit.id
					is_enemy=yes
				[/filter_adjacent]

				[not]
					ability=qquws_status_earthquaked
				[/not]

				formula="if( self.flying, 0, 1)"
			[/filter]

			[object]
				silent=yes
				duration=turn end

				[effect]
					apply_to=defense
					replace=no
					[defense]
						flat=15
						frozen=15
						forest=15
						hills=15
						mountains=15
						village=15
						reef=15
						swamp_water=15
						shallow_water=15
						castle=15
						cave=15
						sand=15
						fungus=15
					[/defense]
				[/effect]
				[effect]
					apply_to=zoc
					value=no
				[/effect]
				[effect]
					apply_to=image_mod
					add="~CS(40,40,-20)"
				[/effect]
				[effect]
					apply_to=new_ability
					[abilities]
						[dummy]
							id=qquws_status_earthquaked
							name="<span color='#a67e63'>earthquaked</span>"
							description="This unit experienced an earthquake, it has no zone of control and all defenses reduced by 15%. The effect will wear off after one turn."
						[/dummy]
					[/abilities]
				[/effect]
			[/object]
		[/modify_unit]
	[/event]
#enddef

#define REGISTER_DAMAGE_ON_DEATH
	[event]
		name=last breath
		first_time_only=no

		[filter]
			ability=qquws_damage_on_death
		[/filter]

		[modify_unit]
			[filter]
				id=$unit.id
			[/filter]

			[object]
				silent=yes

				[effect]
					apply_to=new_animation
					id="uws_kamikaze_kaboom"
					[animation]
						apply_to=death
						[frame]
							alpha=0
							halo="projectiles/fireball-impact-[1~16].png~SCALE_INTO_SHARP(288,288):200"
							halo_x=0
							halo_y=0
						[/frame]
					[/animation]
				[/effect]
			[/object]
		[/modify_unit]

		{VARIABLE new_terrain "^Dc"}
		{VARIABLE new_terrain_x $unit.x}
		{VARIABLE new_terrain_y $unit.y}

		[fire_event]
			name=update_single_tile
		[/fire_event]

		[floating_text]
			x,y=$unit.x,$unit.y
			text="<span color='#ff0000'>KABOOM!</span>"
		[/floating_text]
	[/event]

	[event]
		name=die
		first_time_only=no

		[filter]
			ability=qquws_damage_on_death
		[/filter]

		[harm_unit]
			[filter]
				[filter_adjacent]
					x,y=$unit.x,$unit.y
				[/filter_adjacent]
			[/filter]
			
			amount="$( ceil($turn_number * $unit.variables.damage_on_death_tn_factor) )"
			damage_type=impact
			alignment=neutral
			kill=no
			animate=yes
			delay=0
			experience=no
		[/harm_unit]
	[/event]
#enddef

#define REGISTER_ALCOHOL_FUMES
	[event]
		name=attack
		first_time_only=no

		[filter_second]
			ability=qquws_alcohol_fumes
		[/filter_second]

		[filter_attack]
			range=melee
		[/filter_attack]

		{VARIABLE fumes_reduction $second_unit.variables.alcohol_fumes_reduction}

		[modify_unit]
			[filter]
				id=$unit.id
			[/filter]

			[object]
				silent=yes
				duration=turn

				[effect]
					apply_to=defense
					replace=no
					[defense]
						flat=$fumes_reduction
						frozen=$fumes_reduction
						forest=$fumes_reduction
						hills=$fumes_reduction
						mountains=$fumes_reduction
						village=$fumes_reduction
						swamp_water=$fumes_reduction
						shallow_water=$fumes_reduction
						deep_water=$fumes_reduction
						reef=$fumes_reduction
						castle=$fumes_reduction
						cave=$fumes_reduction
						sand=$fumes_reduction
						fungus=$fumes_reduction
					[/defense]
				[/effect]
				[effect]
					apply_to=attack
					increase_accuracy=-$fumes_reduction
				[/effect]
				[effect]
				    apply_to=image_mod
				    add="~BL(1)"
				[/effect]
			[/object]
		[/modify_unit]

		[floating_text]
			x,y=$second_unit.x,$second_unit.y
			text="<span color='#5bd970'>Fumes</span>"
		[/floating_text]
	[/event]
#enddef

#define REGISTER_ETHEREAL_BODY
	[event]
		name=attack
		first_time_only=no

		[filter_second]
			ability=qquws_ethereal_body
		[/filter_second]

		{VARIABLE_OP check rand 0..1}
		[if]
			[variable]
				name=check
				equals=1
			[/variable]
			[then]
				[modify_unit]
					[filter]
						id=$second_unit.id
					[/filter]

					[status]
						qquws_active_ethereal_body=yes
					[/status]

					[object]
						silent=yes
						id=qquws_ethereal_body_object
						take_only_once=no

						[effect]
							apply_to=image_mod
							add="~BL(1)~O(50%)"
						[/effect]
					[/object]
				[/modify_unit]
			[/then]
		[/if]
	[/event]

	[event]
		name=attack end
		first_time_only=no

		[filter_second]
			ability=qquws_ethereal_body
		[/filter_second]

		[modify_unit]
			[filter]
				id=$second_unit.id
			[/filter]

			[status]
				qquws_active_ethereal_body=no
			[/status]
		[/modify_unit]

		[remove_object]
			id=$second_unit.id
			object_id=qquws_ethereal_body_object
		[/remove_object]
	[/event]
#enddef

#define REGISTER_ICY_SHACKLES
	[event]
		name=attack
		first_time_only=no

		[filter_attack]
			special_id=qquws_icy_shackles
		[/filter_attack]

		[store_unit_defense_on]
			id=$second_unit.id
			variable=icy_shackles_initial_defense
		[/store_unit_defense_on]
	[/event]

	[event]
		name=attack end
		first_time_only=no

		[filter_attack]
			special_id=qquws_icy_shackles
		[/filter_attack]

		[if]
			[variable]
				name=second_unit.hitpoints
				greater_than=0
			[/variable]
			[then]
				[store_unit_defense_on]
					id=$second_unit.id
					variable=icy_shackles_final_defense
				[/store_unit_defense_on]

				{VARIABLE icy_shackles_reduction "$( floor( $unit.variables.icy_shackles_factor * ( $icy_shackles_initial_defense - $icy_shackles_final_defense )) )"}
				[if]
					[variable]
						name=icy_shackles_reduction
						greater_than=4
					[/variable]
					[then]
						[modify_unit]
							[filter]
								id=$second_unit.id
							[/filter]

							[object]
								silent=yes
								duration=turn end

								[effect]
								    apply_to=attack
								    increase_attacks="-$icy_shackles_reduction|%"
								[/effect]
								[effect]
								    apply_to=movement
								    increase="-$icy_shackles_reduction|%"
								[/effect]
								[effect]
									apply_to=new_ability
									[abilities]
										[dummy]
											id=qquws_icy_shackles_status_info
											name="<span color='#438ede'>icy shackles</span>"
											description="This unit suffers from being bound by ice. It's attack strikes and movement are decreased by $icy_shackles_reduction|% for a duration of one turn."
										[/dummy]
									[/abilities]
								[/effect]
								[effect]
									apply_to=image_mod
									add="~CS(-20,-20,60)"
								[/effect]
							[/object]
						[/modify_unit]
					[/then]
				[/if]
			[/then]
		[/if]
	[/event]
#enddef

#define REGISTER_ASSASSINS_STRIKE
	[event]
		name=attack
		first_time_only=no

		[filter_attack]
			special_id=qquws_assassins_strike
		[/filter_attack]

		[filter]
			[filter_location]
				time_of_day_id=first_watch,midnight,second_watch
			[/filter_location]
		[/filter]

		[modify_unit]
			[filter]
				id=$unit.id
			[/filter]

			[status]
				assassins_strike_active=yes
			[/status]
		[/modify_unit]
	[/event]

	[event]
		name=attacker hits
		first_time_only=no

		[filter_attack]
			special_id=qquws_assassins_strike
		[/filter_attack]

		[filter]
			status=assassins_strike_active
		[/filter]

		{VARIABLE attacks_left $unit.attacks_left}

		[if]
			[have_unit]
				id=$unit.id
				ability=qquws_successful_operation
			[/have_unit]
			[and]
				[variable]
					name=second_unit.hitpoints
					less_than=1
				[/variable]
			[/and]
			[then]
				{VARIABLE attacks_left 1}

				[floating_text]
					x,y=$unit.x,$unit.y
					text="<span color='#bf4545'>target neutralised</span>"
				[/floating_text]
			[/then]
		[/if]

		[modify_unit]
			[filter]
				id=$unit.id
			[/filter]

			[status]
				assassins_strike_active=no
			[/status]

			attacks_left=$attacks_left
		[/modify_unit]
	[/event]

	[event]
		name=attacker misses
		first_time_only=no

		[filter_attack]
			special_id=qquws_assassins_strike
		[/filter_attack]

		[filter]
			status=assassins_strike_active
		[/filter]

		[modify_unit]
			[filter]
				id=$unit.id
			[/filter]

			[status]
				assassins_strike_active=no
			[/status]
		[/modify_unit]
	[/event]

	[event]
		name=defender hits,defender misses
		first_time_only=no

		[filter_second_attack]
			special_id=qquws_assassins_strike
		[/filter_second_attack]

		[filter_second]
			status=assassins_strike_active
		[/filter_second]

		[modify_unit]
			[filter]
				id=$second_unit.id
			[/filter]

			[status]
				assassins_strike_active=no
			[/status]
		[/modify_unit]
	[/event]
#enddef

#define REGISTER_TRUE_FLAME
	[event]
		name=turn refresh
		first_time_only=no
		priority=10

		[if]
			[have_unit]
				side=$side_number
				ability=qquws_true_flame
			[/have_unit]
			[then]
				[store_unit]
					[filter]
						side=$side_number
						ability=qquws_true_flame
					[/filter]
					
					variable=true_flame_units
					mode=always_clear
				[/store_unit]
				
				[foreach]
					array=true_flame_units
					variable=true_flame_unit
					readonly=yes
					
					[do]
						[store_unit]
							[filter]
								[filter_location]
									x,y=$true_flame_unit.x,$true_flame_unit.y
									radius=3
									[filter_radius]
										terrain="!,_off^_usr,X*,M*^X*"
									[/filter_radius]
									[filter_vision]
										visible=yes
										respect_fog=yes
									[/filter_vision]
								[/filter_location]
								
								[filter_side]
									[enemy_of]
										side=$true_flame_unit.side
									[/enemy_of]
								[/filter_side]
								
								level=0,1
								x=2-99
							[/filter]
							
							variable=killable_units
							mode=always_clear
						[/store_unit]

						[foreach]
							array=killable_units
							variable=killable_unit
							readonly=yes
							[do]
								[kill]
									id=$killable_unit.id
									animate=yes
									fire_event=yes
								[/kill]

								[floating_text]
									x,y=$killable_unit.x,$killable_unit.y
									text="<span color='#ba554c'>Trial of Fire!</span>"
								[/floating_text]

								[unit]
									type=Fire Wraith
									x=$killable_unit.x
									y=$killable_unit.y
									side=$true_flame_unit.side
									passable=yes
									upkeep=loyal
									animate=yes
								[/unit]
							[/do]
						[/foreach]
					[/do]
				[/foreach]
				
				{CLEAR_VARIABLE true_flame_units,killable_units}
			[/then]
		[/if]
	[/event]
#enddef

#define REGISTER_EXTINGUISHED_SPARK
	[event]
		name=attack end
		first_time_only=no

		[filter_attack]
			special_id=qquws_extinguished_spark
		[/filter_attack]

		[if]
			[variable]
				name=unit.hitpoints
				greater_than=0
			[/variable]
			[then]
				[heal_unit]
					[filter]
						id=$unit.id
					[/filter]
					
					amount=12
					restore_statuses=no
					animate=yes
				[/heal_unit]
			[/then]
		[/if]

		[if]
			[variable]
				name=second_unit.hitpoints
				greater_than=0
			[/variable]
			[then]
				{VARIABLE recovery_turn "$( $turn_number + 2 )"}
				[modify_unit]
					[filter]
						id=$second_unit.id
					[/filter]
					
					[status]
						petrified=yes
						unhealable=yes
					[/status]

					[object]
						silent=yes
						duration=turn end
						
						[effect]
						    apply_to=remove_attacks
						[/effect]
						[effect]
							apply_to=new_ability
							[abilities]
								[dummy]
									id=qquws_status_astral_imprisoned
									name="<span color='#ba554c'>extinguished</span>"
									description="This unit's spirit is extinguished. It will regain it's strength in turn $recovery_turn."
								[/dummy]
							[/abilities]
						[/effect]
					[/object]
				[/modify_unit]

				[floating_text]
					x,y=$second_unit.x,$second_unit.y
					text="<span color='#ba554c'>Extinguished!</span>"
				[/floating_text]
				
				[set_variables]
					name=qquws_lasting_effect_information
					mode=append
					[value]
					    id=$second_unit.id
					    side=$second_unit.side
					    end_of_effect_turn=$recovery_turn
					    effect_type=petrification
					[/value]
				[/set_variables]
			[/then]
		[/if]
	[/event]
#enddef

#define REGISTER_FIERY_FAMILIAR
	[event]
		name=post advance
		first_time_only=no

		[filter]
			ability=qquws_fiery_familiar
		[/filter]

		[if]
			[have_unit]
				side=$unit.side
				trait=qquws_familiar
				count=0
			[/have_unit]
			[then]
				[switch]
					variable=unit.level

					[case]
						value=0
						{VARIABLE unit_type_pool "Raven,Mudcrawler,Giant Scorpling"}
						{VARIABLE ae_unit_type_pool "Raven,Mudcrawler,Giant Scorpling,AE_dep_deep_wisp,AE_arc_menagerie_Lunar_Bug,AE_arc_phantom_Spirit_Dove,AE_mrc_slavers_Hawk"}
					[/case]
					[case]
						value=1
						{VARIABLE unit_type_pool "Raven,Mudcrawler,Giant Scorpling"}
						{VARIABLE ae_unit_type_pool "Raven,Mudcrawler,Giant Scorpling,AE_dep_deep_wisp,AE_arc_menagerie_Lunar_Bug,AE_arc_phantom_Spirit_Dove,AE_mrc_slavers_Hawk"}
					[/case]
					[case]
						value=2
						{VARIABLE unit_type_pool "Dark Omen,Fire Guardian,Sand Scuttler"}
						{VARIABLE ae_unit_type_pool "Dark Omen,Fire Guardian,Sand Scuttler,AE_ext_monsters_Fire_Wisp,AE_myh_Fire,AE_myh_Fire_Sprite,AE_mag_Fire_Elemental,AE_FL_bloodelf_Phoenix_Hatchling,AE_mrc_emperors_guard_Ryu,AE_mrc_infernai_Scamp"}
					[/case]
					[case]
						value=3
						{VARIABLE unit_type_pool "War Harbinger,Fire Wraith,Firebane Ant"}
						{VARIABLE ae_unit_type_pool "War Harbinger,Fire Wraith,Firebane Ant,AE_myh_Living_Furnace,AE_mag_Red_Salamander,AE_mag_Harbinger,AE_mag_Fire_Avatar,AE_mag_Efreeti,AE_FL_bloodelf_Fire_Bird,AE_mrc_emperors_guard_Tatsu,AE_mrc_infernai_Familiar,AE_ext_monsters_Fire_Guardian,AE_ext_monsters_Wingless_Dragon"}
					[/case]
					[case]
						value=4
						{VARIABLE unit_type_pool "Fire Ant Queen,Inferno Drake"}
						{VARIABLE ae_unit_type_pool "Fire Ant Queen,Inferno Drake,AE_ext_monsters_Fire_Warrior_Spirit,AE_ext_monsters_Red_Dragon,AE_myh_Lava_Beast,AE_mag_Doom_Bringer,AE_mag_Lava_Salamander,AE_mag_Fire_God,AE_mag_Great_Efreeti,AE_FL_bloodelf_Phoenix,AE_mrc_infernai_Cerberus"}
					[/case]
					[case]
						value=5
						{VARIABLE unit_type_pool "Armageddon Drake"}
						{VARIABLE ae_unit_type_pool "Armageddon Drake,AE_ext_monsters_Fire_Dragon,AE_FL_bloodelf_Pyromaster"}
					[/case]
					[else]
						{VARIABLE unit_type_pool "QQ_enflamed_spirit"}
						{VARIABLE ae_unit_type_pool "QQ_enflamed_spirit"}
					[/else]
				[/switch]

				[if]
					[variable]
						name=random_pool.allow_ae
						boolean_equals=yes
					[/variable]
					[then]
						{VARIABLE_OP familiar_type rand $ae_unit_type_pool}
					[/then]
					[else]
						{VARIABLE_OP familiar_type rand $unit_type_pool}
					[/else]
				[/if]

				{VARIABLE familiar_description_info "This unit is owned by it's master."}
				[if]
					[variable]
						name=unit.variables.familiar_share_xp
						boolean_equals=yes
					[/variable]
					[then]
						{VARIABLE familiar_description_info "This unit is owned by it's master. Each time it kills an enemy it adds xp with the master."}
					[/then]
				[/if]

				[unit]
					type=$familiar_type
					side=$unit.side
					to_variable=spawning_familiar
					random_traits=no
					random_gender=yes
					upkeep=loyal
					advances_to=null
					[variables]
						master_id=$unit.id
						share_xp_with_master=$unit.variables.familiar_share_xp
					[/variables]

					[modifications]
						[trait]
							id=qquws_familiar
							name="<span color='#a35661'>familiar</span>"
							description=$familiar_description_info
						[/trait]
					[/modifications]
				[/unit]

				{VARIABLE new_unit_spawn_quiet_bonus_id ""}
				{VARIABLE enable_human_player_restriction yes}
				
				{VARIABLE new_unit_spawn_id $spawning_familiar.id}
				{VARIABLE champion_unit_id $spawning_familiar.id}
				{VARIABLE prespawn_moves 99}
				{VARIABLE prespawn_buff_a "rand"}
				{VARIABLE prespawn_buff_b "rand"}
				{VARIABLE prespawn_buff_c "rand"}
				{VARIABLE prespawn_full_buff "rand:rand:rand"}
				{VARIABLE champion_unit_already_exists yes}
				{VARIABLE is_single_buff_random yes}

				[fire_event]
					name=generate_champion_data
				[/fire_event]

				[switch]
					variable=unit.variables.familiar_type

					[case]
						value=minion

						{VARIABLE new_unit_spawn_champion ""}
						{VARIABLE_OP select_key rand 1..3}

						[switch]
							variable=select_key

							[case]
								value=1
								{VARIABLE new_unit_spawn_minion $prespawn_buff_a}
							[/case]
							[case]
								value=2
								{VARIABLE new_unit_spawn_minion $prespawn_buff_b}
							[/case]
							[case]
								value=3
								{VARIABLE new_unit_spawn_minion $prespawn_buff_c}
							[/case]
						[/switch]
					[/case]

					[case]
						value=champion

						{VARIABLE new_unit_spawn_minion ""}
						{VARIABLE new_unit_spawn_champion "$prespawn_buff_a|:$prespawn_buff_b|:$prespawn_buff_c"}
					[/case]
				[/switch]

				[unstore_unit]
					variable=spawning_familiar
					find_vacant=yes
					x=$unit.x
					y=$unit.y
					fire_event=yes
					animate=yes
				[/unstore_unit]

				{VARIABLE new_unit_bulky_value 0}
				{VARIABLE new_unit_beefy_value 0}
				{VARIABLE new_unit_armored_value 0}
				{VARIABLE new_unit_fast_value 0}
				{VARIABLE new_unit_agile_value 0}
				{VARIABLE new_unit_aggressive_value 0}

				[fire_event]
					name=apply_new_unit_bonus
				[/fire_event]

				{CLEAR_VARIABLE enable_human_player_restriction}
			[/then]
		[/if]
	[/event]

	[event]
		name=die
		first_time_only=no

		[filter_second]
			trait=qquws_familiar
		[/filter_second]

		[if]
			[variable]
				name=second_unit.variables.share_xp_with_master
				boolean_equals=yes
			[/variable]
			[then]
				{VARIABLE give_xp "$( [2,4,8,12,16,20,24,28][$unit.level] )"}

				[store_unit]
					[filter]
						id=$second_unit.variables.master_id
					[/filter]
					
					variable=familiars_master
					mode=always_clear
				[/store_unit]

				[modify_unit]
					[filter]
						id=$familiars_master.id
					[/filter]

					[effect]
						apply_to=experience
						increase=$give_xp
					[/effect]
				[/modify_unit]

				[floating_text]
					x,y=$familiars_master.x,$familiars_master.y
					text="<span color='#608dd1'>+$give_xp|xp</span>"
				[/floating_text]
			[/then]
		[/if]
	[/event]
#enddef

#define REGISTER_SUNRISE_REGEN
	[event]
		name=turn refresh
		first_time_only=no

		[filter_side]
			[has_unit]
				side=$side_number
				ability=qquws_sunrise_regenerates
				[filter_location]
                    time_of_day_id=dawn
                [/filter_location]
			[/has_unit]
		[/filter_side]

		[store_unit]
			[filter]
				side=$side_number
				ability=qquws_sunrise_regenerates
				[filter_location]
                    time_of_day_id=dawn
                [/filter_location]
			[/filter]
			
			variable=sunrise_units
			mode=always_clear
		[/store_unit]

		[for]
			array=sunrise_units
			variable=i

			[do]
				{VARIABLE max_hp $sunrise_units[$i].max_hitpoints}
				{VARIABLE heal_amount "$( floor( 0.4 * $max_hp ) )"}
				[heal_unit]
					[filter]
						id=$sunrise_units[$i].id
					[/filter]
					
					amount=$heal_amount
					restore_statuses=yes
					animate=yes
				[/heal_unit]
			[/do]
		[/for]

		{CLEAR_VARIABLE max_hp,heal_amount}
	[/event]
#enddef

#define REGISTER_WEAKENING_ATTACK
	[event]
		name=attacker hits
		first_time_only=no

		[filter_attack]
			special_id=qquws_weaken
		[/filter_attack]

		[filter_second]
			[not]
				ability=qquws_weakened_status
			[/not]
		[/filter_second]

		[modify_unit]
			[filter]
				id=$second_unit.id
			[/filter]

			[object]
				silent=yes
				duration=turn end

				[effect]
				    apply_to=attack
				    increase_damage="-$unit.variables.weaken_reduction|%"
				[/effect]
				[effect]
				    apply_to=image_mod
				    add="~CS(-15,35,-15)"
				[/effect]
				[effect]
					apply_to=new_ability
					[abilities]
						[dummy]
							id=qquws_weakened_status
							name="<span color='#5c9c6d'>weakened</span>"
							description="This unit is weakened. It's damage is reduced by $unit.variables.weaken_reduction|% until the end of it's turn."
						[/dummy]
					[/abilities]
				[/effect]
			[/object]
		[/modify_unit]
	[/event]

	[event]
		name=defender hits
		first_time_only=no

		[filter_second_attack]
			special_id=qquws_weaken
		[/filter_second_attack]

		[filter]
			[not]
				ability=qquws_weakened_status
			[/not]
		[/filter]

		[modify_unit]
			[filter]
				id=$unit.id
			[/filter]

			[object]
				silent=yes
				duration=turn end

				[effect]
				    apply_to=attack
				    increase_damage="-$second_unit.variables.weaken_reduction|%"
				[/effect]
				[effect]
				    apply_to=image_mod
				    add="~CS(-15,35,-15)"
				[/effect]
				[effect]
					apply_to=new_ability
					[abilities]
						[dummy]
							id=qquws_weakened_status
							name="<span color='#5c9c6d'>weakened</span>"
							description="This unit is weakened. It's damage is reduced by $second_unit.variables.weaken_reduction|% until the end of it's turn."
						[/dummy]
					[/abilities]
				[/effect]
			[/object]
		[/modify_unit]
	[/event]
#enddef

#define REGISTER_FIRE_CLEAVE
	[event]
		name=attacker hits,attacker misses
		first_time_only=no

		[filter_attack]
			special_id=qquws_fire_cleave
		[/filter_attack]

		[store_unit]
	        [filter]
	            [filter_adjacent]
	                x,y=$x2,$y2
	            [/filter_adjacent]
	            [filter_adjacent]
	                x,y=$x1,$y1
	                is_enemy=yes
	            [/filter_adjacent]
	            [not]
	                [filter_wml]
	                    [status]
	                        petrified=yes
	                    [/status]
	                [/filter_wml]
	            [/not]
	        [/filter]
	        variable=cleaver_units
	    [/store_unit]

	    {VARIABLE cleave_damage "$( floor( 0.01 * $damage_inflicted * $unit.variables.fire_cleave_factor ) )"}

	    [if]
	    	[variable]
	    		name=cleave_damage
	    		greater_than=0
	    	[/variable]
	    	[then]
			    [foreach]
			        array=cleaver_units
			        variable=cleaver_unit
			        [do]
			        	[store_unit_defense]
			        		id=$cleaver_unit.id
			        		variable=terrain_defense
			        	[/store_unit_defense]

			        	{VARIABLE_OP terrain_defense add 5}
			        	{VARIABLE_OP cleaver_rand_compare rand 1..100}
			            
			            [if]
			                [variable]
			                	name=cleaver_rand_compare
			                	less_than_equal_to=$terrain_defense
			                [/variable]
			                [then]
			                    [harm_unit]
			                        [filter]
			                            id=$cleaver_unit.id
			                        [/filter]
			                        [filter_second]
			                            id=$unit.id
			                        [/filter_second]

			                        amount=$cleave_damage
			                        damage_type=fire
			                        alignment=$unit.alignment
			                        fire_event=yes
			                        animate=defender
			                        delay=0
			                        kill=yes
			                        experience=yes
			                    [/harm_unit]
			                [/then]
			            [/if]
			        [/do]
			    [/foreach]

	    		{CLEAR_VARIABLE cleaver_units}
	    	[/then]
	    [/if]
	[/event]
#enddef

#define REGISTER_BLINDING_SPARKS
	[event]
		name=attacker hits
		first_time_only=no

		[filter_attack]
			special_id=qquws_blinding_sparks
		[/filter_attack]

		[if]
			[variable]
				name=second_unit.hitpoints
				greater_than=0
			[/variable]
			[then]
				[fire_event]
					name=handle_blinding_sparks

					[primary_unit]
						id=$unit.id
					[/primary_unit]
					[secondary_unit]
						id=$second_unit.id
					[/secondary_unit]
				[/fire_event]
			[/then]
		[/if]
	[/event]

	[event]
		name=defender hits
		first_time_only=no

		[filter_second_attack]
			special_id=qquws_blinding_sparks
		[/filter_second_attack]

		[if]
			[variable]
				name=unit.hitpoints
				greater_than=0
			[/variable]
			[then]
				[fire_event]
					name=handle_blinding_sparks

					[primary_unit]
						id=$second_unit.id
					[/primary_unit]
					[secondary_unit]
						id=$unit.id
					[/secondary_unit]
				[/fire_event]
			[/then]
		[/if]
	[/event]

	[event]
		name=handle_blinding_sparks
		first_time_only=no

		{VARIABLE total_blinded_value 0}
		[if]
			[variable]
				name=second_unit.status.sparks_blinded
				boolean_equals=yes
			[/variable]
			[then]
				{VARIABLE total_blinded_value $second_unit.variables.total_blinded_value}
				[remove_object]
					id=$second_unit.id
					object_id=qquws_blinding_spot_temp_object
				[/remove_object]
			[/then]
		[/if]

		{VARIABLE_OP total_blinded_value add $unit.variables.blinding_sparks_factor}

		[modify_unit]
			[filter]
				id=$second_unit.id
			[/filter]

			[variables]
				total_blinded_value=$total_blinded_value
			[/variables]

			[object]
				silent=yes
				take_only_once=no
				id=qquws_blinding_spot_temp_object
				duration=turn end

				[effect]
					apply_to=status
					add=sparks_blinded
				[/effect]
				[effect]
					apply_to=attack
					special_type=chance_to_hit
					[set_specials]
						mode=append
						[chance_to_hit]
							id=qquws_blinded_from_sparks
							name="<span color='#a6948b'>blinded $total_blinded_value</span>"
							description="This attack has always at least $total_blinded_value|% chance to hit."
							sub=$total_blinded_value
							cumulative=yes
						[/chance_to_hit]
					[/set_specials]
				[/effect]
				[effect]
					apply_to=attack
					[not]
						special_type=chance_to_hit
					[/not]
					increase_accuracy="-$total_blinded_value"
				[/effect]
				[effect]
				    apply_to=overlay
				    add=halo/uws/blinded_x.png
				[/effect]
				[effect]
					apply_to=image_mod
					add="~CS(70,70,70)"
				[/effect]
			[/object]
		[/modify_unit]
	[/event]
#enddef

#define REGISTER_STILLNESS_AURA
	[event]
		name=turn refresh
		first_time_only=no

		[filter_condition]
			[have_unit]
				side=$side_number
				ability=qquws_stillness_aura
			[/have_unit]
		[/filter_condition]

		[store_unit]
			[filter]
				side=$side_number
				ability=qquws_stillness_aura
			[/filter]
			
			variable=aura_units
			mode=always_clear
		[/store_unit]

		[for]
			array=aura_units
			variable=i
			[do]
				[harm_unit]
					[filter]
						[filter_location]
							x,y=$aura_units[$i].x,$aura_units[$i].y
							radius=3
							[filter_radius]
								terrain="!,_off^_usr,X*,M*^X*"
							[/filter_radius]
						[/filter_location]
						
						[filter_side]
							[enemy_of]
								side=$side_number
							[/enemy_of]
						[/filter_side]

						[not]
							status=unslowable
						[/not]
					[/filter]

					amount=$aura_units[$i].variables.stillness_aura_damage
					damage_type=cold
					alignment=neutral
					animate=yes
					slowed=yes
					kill=no
					fire_event=no
					experience=no
					delay=0
				[/harm_unit]
			[/do]
		[/for]
	[/event]
#enddef

#define REGISTER_LEATHER_COVER
	{UNIT_BASED_GLOBAL_ALLY_BUFF qquws_leather_cover_trait qquws_leather_cover apply_leather_cover_to_all_allies "leather protection $global_buff_unit.variables.leather_cover_reduction" "This unit benefits from the additional leather armour All incoming damage is reduced by $global_buff_unit.variables.leather_cover_reduction point(s) unless it is arcane or secret type." (
		[effect]
			apply_to=new_ability
			[abilities]
				[damage]
					id=qquws_leather_single
					affect_self=yes
					affect_allies=no
					affect_enemies=no
					apply_to=opponent
					sub=$global_buff_unit.variables.leather_cover_reduction
					[filter_opponent]
						[filter_weapon]
							type=blade,impact,pierce,cold,fire
						[/filter_weapon]
					[/filter_opponent]
				[/damage]
			[/abilities]
		[/effect]
	) (
		[if]
			[variable]
				name=uws_game.is_pvp
				boolean_equals=yes
			[/variable]
			[then]
				[store_unit]
					[filter]
						side=$unit.side
						ability=qquws_leather_cover
					[/filter]
					
					variable=global_buff_unit
					mode=always_clear
				[/store_unit]
			[/then]
			[else]
				[store_unit]
					[filter]
						ability=qquws_leather_cover
						
						[filter_side]
							[allied_with]
								side=$unit.side
							[/allied_with]
						[/filter_side]
					[/filter]
					
					variable=global_buff_unit
					mode=always_clear
				[/store_unit]
			[/else]
		[/if]
	)}
#enddef

#define REGISTER_SUPER_POISON
	[event]
		name=attacker hits
		first_time_only=no

		[filter_attack]
			special_id=qquws_super_poison
		[/filter_attack]

		[filter_second]
			[not]
				status=unpoisonable
			[/not]

			[not]
				status=super_poisoned
			[/not]
		[/filter_second]

		[if]
			[variable]
				name=second_unit.hitpoints
				greater_than=0
			[/variable]
			[and]
				[variable]
					name=unit.variables.super_poison_extra_dmg
					greater_than=0
				[/variable]
			[/and]
			[then]
				{VARIABLE poison_value "$( $unit.variables.super_poison_extra_dmg + 8 )"}
				[if]
					[variable]
						name=unit.variables.super_poison_inflicts_unhealable
						boolean_equals=yes
					[/variable]
					[then]
						{VARIABLE poison_value $unit.variables.super_poison_extra_dmg}
					[/then]
				[/if]

				[modify_unit]
					[filter]
						id=$second_unit.id
					[/filter]

					[status]
						super_poisoned=yes
					[/status]

					[variables]
						super_poison_inflict_extra=$unit.variables.super_poison_extra_dmg
					[/variables]

					[trait]
						id=qquws_super_poison_info
						name="<span color='#4bab55'>poisoned $poison_value</span>"
						description="This unit is affected by a strong poison. It will lose $poison_value hitpoints per turn unless healed. Like regular poison this will not kill."
					[/trait]
				[/modify_unit]
			[/then]
		[/if]
	[/event]

	[event]
		name=defender hits
		first_time_only=no

		[filter_second_attack]
			special_id=qquws_super_poison
		[/filter_second_attack]

		[filter]
			[not]
				status=unpoisonable
			[/not]

			[not]
				status=super_poisoned
			[/not]
		[/filter]

		[if]
			[variable]
				name=unit.hitpoints
				greater_than=0
			[/variable]
			[and]
				[variable]
					name=second_unit.variables.super_poison_extra_dmg
					greater_than=0
				[/variable]
			[/and]
			[then]
				{VARIABLE poison_value "$( $second_unit.variables.super_poison_extra_dmg + 8 )"}
				[if]
					[variable]
						name=second_unit.variables.super_poison_inflicts_unhealable
						boolean_equals=yes
					[/variable]
					[then]
						{VARIABLE poison_value $second_unit.variables.super_poison_extra_dmg}
					[/then]
				[/if]

				[modify_unit]
					[filter]
						id=$unit.id
					[/filter]

					[status]
						super_poisoned=yes
					[/status]

					[variables]
						super_poison_inflict_extra=$second_unit.variables.super_poison_extra_dmg
					[/variables]

					[trait]
						id=qquws_super_poison_info
						name="<span color='#4bab55'>poisoned $poison_value</span>"
						description="This unit is affected by a strong poison. It will lose $poison_value hitpoints per turn unless healed. Like regular poison this will not kill."
					[/trait]
				[/modify_unit]
			[/then]
		[/if]
	[/event]

	[event]
		name=turn refresh
		first_time_only=no

		[filter_side]
			[has_unit]
				status=super_poisoned
			[/has_unit]
		[/filter_side]

		[remove_trait]
			side=$side_number
			status=super_poisoned
			[not]
				status=poisoned
			[/not]
			trait_id=qquws_super_poison_info
		[/remove_trait]

		[modify_unit]
			[filter]
				side=$side_number
				status=super_poisoned
				[not]
					status=poisoned
				[/not]
			[/filter]

			[status]
				super_poisoned=no
			[/status]
		[/modify_unit]

		[harm_unit]
			[filter]
				side=$side_number
				status=super_poisoned
			[/filter]

			amount=$this_unit.variables.super_poison_inflict_extra
			kill=no
			animate=yes
			experience=no
		[/harm_unit]
	[/event]
#enddef

#define REGISTER_INFERNO
	[event]
		name=attacker hits,attacker misses
		first_time_only=no

		[filter_attack]
			special_id=qquws_inferno
		[/filter_attack]

		[store_unit]
	        [filter]
	            [filter_adjacent]
	                x,y=$unit.x,$unit.y
	                is_enemy=yes
	            [/filter_adjacent]
	            [not]
	                x,y=$second_unit.x,$second_unit.y
	            [/not]
	            [not]
	                [filter_wml]
	                    [status]
	                        petrified=yes
	                    [/status]
	                [/filter_wml]
	            [/not]
	        [/filter]
	        variable=bystander
	    [/store_unit]

	    [foreach]
	        array=bystander
	        [do]
	            {VARIABLE_OP inferno_chance rand 1..100}

	            [if]
	            	[variable]
	            		name=inferno_chance
	            		less_than_equal_to=60
	            	[/variable]
	                [then]
	                    [harm_unit]
	                        [filter]
	                            id=$bystander[$i].id
	                            [filter_side]
	                                [enemy_of]
	                                    side=$unit.side
	                                [/enemy_of]
	                            [/filter_side]
	                            [not]
	                                [filter_wml]
	                                    [status]
	                                        petrified=yes
	                                    [/status]
	                                [/filter_wml]
	                            [/not]
	                        [/filter]
	                        [filter_second]
	                            id=$unit.id
	                        [/filter_second]

	                        amount=$weapon.damage
	                        damage_type=$weapon.type
	                        alignment=$unit.alignment
	                        fire_event=yes
	                        animate=defender
	                        delay=0
	                        experience=no
	                    [/harm_unit]
	                [/then]
	            [/if]
	        [/do]
    	[/foreach]
	[/event]

	[event]
		name=defender hits,defender misses
		first_time_only=no

		[filter_second_attack]
			special_id=qquws_inferno
		[/filter_second_attack]

		[store_unit]
	        [filter]
	            [filter_adjacent]
	                x,y=$second_unit.x,$second_unit.y
	                is_enemy=yes
	            [/filter_adjacent]
	            [not]
	            	x,y=$unit.x,$unit.y
	            [/not]
	            [not]
	                [filter_wml]
	                    [status]
	                        petrified=yes
	                    [/status]
	                [/filter_wml]
	            [/not]
	        [/filter]
	        variable=bystander
	    [/store_unit]

	    [foreach]
	        array=bystander
	        [do]
	            {VARIABLE_OP inferno_chance rand 1..100}

	            [if]
	            	[variable]
	            		name=inferno_chance
	            		less_than_equal_to=60
	            	[/variable]
	                [then]
	                    [harm_unit]
	                        [filter]
	                            id=$bystander[$i].id
	                            [filter_side]
	                                [enemy_of]
	                                    side=$second_unit.side
	                                [/enemy_of]
	                            [/filter_side]
	                            [not]
	                                [filter_wml]
	                                    [status]
	                                        petrified=yes
	                                    [/status]
	                                [/filter_wml]
	                            [/not]
	                        [/filter]
	                        [filter_second]
	                            id=$second_unit.id
	                        [/filter_second]

	                        amount=$second_weapon.damage
	                        damage_type=$second_weapon.type
	                        alignment=$second_unit.alignment
	                        kill=yes
	                        fire_event=yes
	                        animate=defender
	                        delay=0
	                        experience=no
	                    [/harm_unit]
	                [/then]
	            [/if]
	        [/do]
    	[/foreach]
	[/event]
#enddef

#define REGISTER_VISCERAL_PAIN
	[event]
		name=die
		first_time_only=no

		[filter]
			[not]
				canrecruit=yes
			[/not]
		[/filter]

		[filter_second]
			ability=qquws_visceral_pain
		[/filter_second]

		{VARIABLE recruited_on_turn $unit.variables.recruited_on_turn}
		[if]
			[variable]
				name=recruited_on_turn
				equals=""
			[/variable]
			[then]
				{VARIABLE recruited_on_turn "$( $turn_number - 1 )"}
			[/then]
		[/if]

		[harm_unit]
			[filter]
				side=$unit.side
				canrecruit=yes
			[/filter]

			amount="$( $turn_number - $recruited_on_turn )"
			kill=no
            fire_event=yes
            animate=defender
            delay=0
            experience=no
		[/harm_unit]
	[/event]
#enddef

#define REGISTER_DRAGON_PRIDE
	[event]
		name=attacker hits
		first_time_only=no

		[filter_second]
			ability=qquws_dragon_pride
		[/filter_second]

		[if]
			[variable]
				name=second_unit.hitpoints
				greater_than=0
			[/variable]
			[then]
				{VARIABLE hitpoints_fraction "$( ($second_unit.hitpoints + 0.1) / $second_unit.max_hitpoints )"}
				{VARIABLE reheal_chance_sign 6}
				{VARIABLE reheal_chance_epic 8}
				[if]
					[variable]
						name=hitpoints_fraction
						less_than=0.24
					[/variable]
					[then]
						{VARIABLE reheal_chance_sign 54}
						{VARIABLE reheal_chance_epic 72}
					[/then]
					[else]
						[if]
							[variable]
								name=hitpoints_fraction
								less_than=0.44
							[/variable]
							[then]
								{VARIABLE reheal_chance_sign 42}
								{VARIABLE reheal_chance_epic 56}
							[/then]
							[else]
								[if]
									[variable]
										name=hitpoints_fraction
										less_than=0.64
									[/variable]
									[then]
										{VARIABLE reheal_chance_sign 30}
										{VARIABLE reheal_chance_epic 40}
									[/then]
									[else]
										[if]
											[variable]
												name=hitpoints_fraction
												less_than=0.84
											[/variable]
											[then]
												{VARIABLE reheal_chance_sign 18}
												{VARIABLE reheal_chance_epic 24}
											[/then]
										[/if]
									[/else]
								[/if]
							[/else]
						[/if]
					[/else]
				[/if]

				{VARIABLE reheal_chance $reheal_chance_sign}
				{VARIABLE reheal_fraction_option "30,30,40,40,40,40,40,50,50,60,60,70,80,90"}
				[if]
					[variable]
						name=second_unit.variables.dragons_pride_reheal_option
						equals=item_b
					[/variable]
					[then]
						{VARIABLE reheal_chance $reheal_chance_epic}
						{VARIABLE reheal_fraction_option "40,40,50,50,50,60,60,60,75,75,75,85,85,100,115,135"}
					[/then]
				[/if]

				{VARIABLE_OP random_chance rand 0..99}
				[if]
					[variable]
						name=random_chance
						less_than=$reheal_chance
					[/variable]
					[then]
						{VARIABLE_OP reheal_fraction rand $reheal_fraction_option}
						{VARIABLE reheal_amount "$( floor($reheal_fraction * $damage_inflicted * 0.01) )"}

						[if]
							[variable]
								name=reheal_amount
								greater_than=0
							[/variable]
							[then]
								[heal_unit]
									[filter]
										id=$second_unit.id
									[/filter]
									
									amount=$reheal_amount
									restore_statuses=no
									animate=yes
								[/heal_unit]
							[/then]
						[/if]
					[/then]
				[/if]
			[/then]
		[/if]
	[/event]
#enddef

#define REGISTER_DRAGON_PRIDE_STONE
	[event]
		name=last breath
		first_time_only=no

		[filter]
			trait=qquws_dragon_pride_stone_active
		[/filter]

		[remove_trait]
			id=$unit.id
			trait_id=qquws_dragon_pride_stone_active
		[/remove_trait]

		[modify_unit]
			[filter]
				id=$unit.id
			[/filter]

			hitpoints="$( floor(0.01 * $unit.variables.untouchable_heal * $unit.max_hitpoints) )"
			[status]
				petrified=yes
			[/status]
		[/modify_unit]

		[floating_text]
			x,y=$unit.x,$unit.y
			text="<span color='#afb372'>Untouchable!</span>"
		[/floating_text]

		[if]
			[variable]
				name=unit.variables.untouchable_cloud
				boolean_equals=yes
			[/variable]
			[then]
				[harm_unit]
					[filter]
						[filter_location]
							x,y=$unit.x,$unit.y
							radius=1
							[filter_radius]
								terrain="!,_off^_usr,X*,M*^X*"
							[/filter_radius]
						[/filter_location]
						
						[filter_side]
							[enemy_of]
								side=$unit.side
							[/enemy_of]
						[/filter_side]

						[not]
							status=unpoisonable,invulnerable
						[/not]
					[/filter]

					amount=8
					kill=no
					fire_event=no
					experience=no
					animate=yes
					poisoned=yes
					delay=0
				[/harm_unit]
			[/then]
		[/if]

		[set_variables]
			name=qquws_lasting_effect_information
			mode=append
			[value]
			    id=$unit.id
			    side=$unit.side
			    end_of_effect_turn="$( $turn_number + 1 )"
			    effect_type=petrification
			[/value]
		[/set_variables]
	[/event]
#enddef

#define REGISTER_TEST_OF_FAITH
	[event]
		name=attack
		first_time_only=no
		
		[filter_attack]
			special_id=qquws_test_of_faith
		[/filter_attack]
		
		[foreach]
			array=unit.attack
			variable=units_weapon
			index_var=i
			readonly=yes
			
			[do]
				[if]
					[variable]
						name=units_weapon.name
						equals=$weapon.name
					[/variable]
					[then]
						{VARIABLE test_of_faith_attack_id $i}
						{VARIABLE test_of_faith_base_damage $weapon.damage}
						[break][/break]
					[/then]
				[/if]
			[/do]
		[/foreach]
	[/event]
	
	[event]
		name=attacker hits
		first_time_only=no
		
		[filter_attack]
			special_id=qquws_test_of_faith
		[/filter_attack]
		
		{VARIABLE_OP unit.attack[$test_of_faith_attack_id].damage add $unit.variables.test_of_faith_increase}
		[unstore_unit]
		     variable=unit
		[/unstore_unit]
	[/event]
	
	[event]
		name=attack end
		first_time_only=no
		
		[filter_attack]
			special_id=qquws_test_of_faith
		[/filter_attack]
		
		{VARIABLE unit.attack[$test_of_faith_attack_id].damage $test_of_faith_base_damage}
		[unstore_unit]
		      variable=unit
		[/unstore_unit]
		
		{CLEAR_VARIABLE test_of_faith_attack_id}
		{CLEAR_VARIABLE test_of_faith_base_damage}
	[/event]
#enddef

#define REGISTER_BATTLE_CRY
	[event]
		name=last breath
		first_time_only=no

		[filter]
			side=$unit.side

			[filter_side]
				[has_unit]
					ability=qquws_final_cry
				[/has_unit]
			[/filter_side]
		[/filter]

		[store_unit]
			[filter]
				side=$unit.side
				ability=qquws_final_cry
			[/filter]
			
			variable=final_cry_item_holder
			mode=always_clear
		[/store_unit]

		[if]
			[variable]
				name=final_cry_item_holder.id
				not_equals=""
			[/variable]
			[then]
				{VARIABLE damage_to_deal $final_cry_item_holder.variables.battle_cry_base_dmg}
				{VARIABLE unit_kills $unit.variables.kills}
				[if]
					[variable]
						name=unit_kills
						equals=""
					[/variable]
					[then]
						{VARIABLE unit_kills 0}
					[/then]
				[/if]

				{VARIABLE kill_based_damage "$( floor( $unit_kills * $final_cry_item_holder.variables.battle_cry_factor ) )"}

				[if]
					[variable]
						name=kill_based_damage
						greater_than=$damage_to_deal
					[/variable]
					[then]
						{VARIABLE damage_to_deal $kill_based_damage}
					[/then]
				[/if]

				[floating_text]
					x,y=$unit.x,$unit.y
					text="<span color='#2d4fe3'>Glory!</span>"
				[/floating_text]

				[harm_unit]
					[filter]
						[filter_adjacent]
							id=$unit.id
							is_enemy=yes
						[/filter_adjacent]
					[/filter]

					[filter_second]
						id=$unit.id
					[/filter_second]

					amount=$damage_to_deal
					kill=no
					fire_event=yes
					experience=no
					animate=yes
					variable=harmed_units
					delay=250
				[/harm_unit]
			[/then]
		[/if]
	[/event]
#enddef

#define REGISTER_PARALYSING_VENOM
	[event]
		name=attacker hits
		first_time_only=no

		[filter_attack]
			special_id=qquws_paralysing_venom
		[/filter_attack]

		[filter_second]
			[not]
				ability=qquws_venom_sickness
			[/not]
		[/filter_second]

		[fire_event]
			name=handle_venom_poisoning

			[primary_unit]
				id=$second_unit.id
			[/primary_unit]
		[/fire_event]
	[/event]

	[event]
		name=defender hits
		first_time_only=no

		[filter_second_attack]
			special_id=qquws_paralysing_venom
		[/filter_second_attack]

		[filter]
			[not]
				ability=qquws_venom_sickness
			[/not]
		[/filter]

		[fire_event]
			name=handle_venom_poisoning

			[primary_unit]
				id=$unit.id
			[/primary_unit]
		[/fire_event]
	[/event]

	[event]
		name=handle_venom_poisoning
		first_time_only=no

		[if]
			[variable]
				name=unit.hitpoints
				greater_than=0
			[/variable]
			[then]
				{VARIABLE venom_end_turn "$( $turn_number + 3 )"}

				[modify_unit]
					[filter]
						id=$unit.id
					[/filter]
					
					[status]
						slowed=yes
						unhealable=yes
					[/status]
					
					[object]
						silent=yes
						id=uws_venom_bitten_object
						take_only_once=no
						
						[effect]
							apply_to=new_ability
							[abilities]
								[dummy]
									id=qquws_venom_sickness
									name="<span color='#40ad6a'>venom</span>"
									description="This unit is bitten by arachna. It is permanently slowed and unhealable. The effect will wear off on turn $venom_end_turn|."
								[/dummy]
							[/abilities]
						[/effect]
						[effect]
						    apply_to=image_mod
						    add="~CS(70,70,70)"
						[/effect]
					[/object]
				[/modify_unit]
				
				[floating_text]
					x,y=$unit.x,$unit.y
					text="<span color='#b0693a' size='large'>Venom!</span>"
				[/floating_text]

				[set_variables]
					name=qquws_lasting_effect_information
					mode=append
					[value]
					    id=$unit.id
					    side=$unit.side
					    end_of_effect_turn=$venom_end_turn
					    effect_type=venom
					[/value]
				[/set_variables]
			[/then]
		[/if]
	[/event]
#enddef

#define REGISTER_CORPSE_FEAST
	[event]
		name=die
		first_time_only=no

		[filter_second_attack]
			special_id=qquws_corpse_feast
		[/filter_second_attack]

		[if]
			[variable]
				name=unit.level
				greater_than=0
			[/variable]
			[then]
				[heal_unit]
					[filter]
						id=$second_unit.id
					[/filter]

					amount="$( $unit.level * 8 )"
					restore_statuses=no
					animate=yes
				[/heal_unit]
			[/then]
		[/if]
	[/event]
#enddef

#define REGISTER_ZERO_XP
	[event]
		name=last breath
		first_time_only=no

		[filter]
			trait=qquws_zero_xp
		[/filter]

		[modify_unit]
			[filter]
				id=$second_unit.id
			[/filter]

			[effect]
				apply_to=experience
				increase="$( [-4,-8,-16,-24,-32,-40,-48,-56][$unit.level] )"
			[/effect]
		[/modify_unit]
	[/event]
#enddef

#define REGISTER_CRIT_STRIKE
	[event]
		name=attack,attacker hits,attacker misses
		first_time_only=no

		[filter_attack]
			special_id=qquws_critical_damage
		[/filter_attack]

		[if]
			[variable]
				name=damage_inflicted
				not_equals=""
			[/variable]
			[and]
				[variable]
					name=unit.status.qquws_crit_strike_active
					boolean_equals=yes
				[/variable]
			[/and]
			[then]
				[floating_text]
					x,y=$unit.x,$unit.y
					text="<span color='#ff0000'>Critical strike!</span>"
				[/floating_text]
			[/then]
		[/if]

		{VARIABLE_OP crit_chance rand 0..99}

		[if]
			[variable]
				name=crit_chance
				less_than=$unit.variables.crit_strike_chance
			[/variable]
			[then]
				[modify_unit]
					[filter]
						id=$unit.id
					[/filter]

					[status]
						qquws_crit_strike_active=yes
					[/status]
				[/modify_unit]
			[/then]
			[else]
				[modify_unit]
					[filter]
						id=$unit.id
					[/filter]

					[status]
						qquws_crit_strike_active=no
					[/status]
				[/modify_unit]
			[/else]
		[/if]
	[/event]

	[event]
		name=attack_end
		first_time_only=no

		[filter_attack]
			special_id=qquws_critical_damage
		[/filter_attack]

		[modify_unit]
			[filter]
				id=$unit.id
			[/filter]

			[status]
				qquws_crit_strike_active=no
			[/status]
		[/modify_unit]
	[/event]
#enddef

#define REGISTER_TAX_COLLECTOR
	[event]
		name=attacker hits
		first_time_only=no

		[filter]
			ability=qquws_tax_collector
		[/filter]

		[store_gold]
			variable=attacked_side_gold
			side=$second_unit.side
		[/store_gold]

		{VARIABLE remove_gold_value "$( if($attacked_side_gold > 0, ceil( $attacked_side_gold * 0.08), 1 ) )"}
		[gold]
			side=$second_unit.side
			amount=-$remove_gold_value
		[/gold]

		[floating_text]
			x,y=$second_unit.x,$second_unit.y
			text="<span color='#b08e68'>-$remove_gold_value gold</span>"
		[/floating_text]
	[/event]

	[event]
		name=attack end
		first_time_only=no

		[filter]
			ability=qquws_tax_collector
		[/filter]

		[store_gold]
			variable=attacked_side_gold
			side=$second_unit.side
		[/store_gold]

		[if]
			[variable]
				name=attacked_side_gold
				less_than=0
			[/variable]
			[and]
				[variable]
					name=unit.hitpoints
					greater_than=0
				[/variable]
			[/and]
			[and]
				[variable]
					name=second_unit.hitpoints
					greater_than=1
				[/variable]
			[/and]
			[then]
				[harm_unit]
					[filter]
						id=$second_unit.id
					[/filter]
					
					amount="$( -1 * $attacked_side_gold )"
					alignment=neutral
					kill=no
					animate=yes
					experience=no
				[/harm_unit]

				[floating_text]
					x,y=$unit.x,$unit.y
					text="<span color='#b07668'>$attacked_side_gold debt</span>"
				[/floating_text]
			[/then]
		[/if]
	[/event]
#enddef

#define REGISTER_CHILLING_COLD
	{UNIT_BASED_GLOBAL_ALLY_BUFF qquws_chilling_cold_trait qquws_global_chilling_cold_1 apply_chilling_cold_1_to_all_allies "chilling cold" "This unit benefits from the chilling cold aura." (
		[effect]
			apply_to=attack
			type=cold
			remove_specials=slow
		    [set_specials]
		    	mode=append
		    	[slow]
					id=slow
					name="slows"
					description="This attack slows the target until it ends a turn."
				[/slow]
		    [/set_specials]
		[/effect]
	) ()}

	{UNIT_BASED_GLOBAL_ALLY_BUFF qquws_chilling_cold_trait qquws_global_chilling_cold_2 apply_chilling_cold_2_to_all_allies "chilling cold 65%" "This unit benefits from the chilling cold aura." (
		[effect]
			apply_to=attack
			type=cold
			remove_specials=slow,qquws_super_slow
		    [set_specials]
		    	mode=append
		    	[slow]
					id=qquws_super_slow
					name="slows 65% (attack only)"
					description="This attack slows the target by 65% until it ends a turn. Active only on offense."
					active_on=offense
				[/slow]
		    [/set_specials]
		[/effect]
	) ()}

	[event]
		name=attacker hits
		first_time_only=no

		[filter_attack]
			special_id=qquws_super_slow
		[/filter_attack]

		[filter_second]
			[not]
				status=unslowable
			[/not]

			[not]
				ability=qquws_status_super_slowed
			[/not]
		[/filter_second]

		[if]
			[variable]
				name=second_unit.hitpoints
				greater_than=0
			[/variable]
			[then]
				[modify_unit]
					[filter]
						id=$second_unit.id
					[/filter]

					[object]
						silent=yes
						duration=turn end

						[effect]
						    apply_to=movement
						    increase=-25%
						[/effect]
						[effect]
						    apply_to=attack
						    increase_damage=-25%
						[/effect]
						[effect]
							apply_to=new_ability
							[abilities]
								[dummy]
									id=qquws_status_super_slowed
									name="<span color='#79ada4'>slowed 65%</span>"
									description="This unit slowness is worsened by the presence of the Arctic Master."
								[/dummy]
							[/abilities]
						[/effect]
						[effect]
						    apply_to=overlay
						    add=halo/uws/super_cold.png
						[/effect]
					[/object]
				[/modify_unit]
			[/then]
		[/if]
	[/event]
#enddef

#define REGISTER_FROSTBITE
	[event]
		name=attacker hits
		first_time_only=no

		[filter_attack]
			special_id=qquws_frostbite
		[/filter_attack]

		[filter_second]
			[not]
				ability=qquws_frostbitten
			[/not]
		[/filter_second]

		[modify_unit]
			[filter]
				id=$second_unit.id
			[/filter]

			[object]
				silent=yes
				duration=turn end

				[effect]
					apply_to=new_ability
					[abilities]
						[damage]
							id=qquws_frostbitten
							name="<span color='#64999c'>frostbitten</span>"
							apply_to=opponent
							multiply=$unit.variables.frostbite_factor
							description="This unit is frostbitten and will receive x$unit.variables.frostbite_factor more damage from all sources."
							affect_self=yes
							affect_allies=no
							affect_enemies=no
						[/damage]
					[/abilities]
				[/effect]
				[effect]
					apply_to=image_mod
					add="~CS(5,5,25)"
				[/effect]
			[/object]
		[/modify_unit]
	[/event]
#enddef

#define REGISTER_PARALYSE
	[event]
		name=attacker hits
		first_time_only=no

		[filter_attack]
			special_id=qquws_paralyse
		[/filter_attack]

		[filter_second]
			[not]
				ability=qquws_status_paralysed
			[/not]
		[/filter_second]

		[if]
			[variable]
				name=second_unit.hitpoints
				greater_than=0
			[/variable]
			[then]
				[modify_unit]
					[filter]
						id=$second_unit.id
					[/filter]

					[status]
						unhealable=yes
					[/status]

					[object]
						silent=yes
						id=qquws_paralysed_unhealable
						take_only_once=no

						[effect]
							apply_to=image_mod
							add="~CS(70,30,30)"
						[/effect]
						[effect]
							apply_to=movement
							increase=-40%
						[/effect]
						[effect]
							apply_to=new_ability
							[abilities]
								[dummy]
									id=qquws_status_paralysed
									name="<span color='#deb0ab'>paralysed</span>"
									description="Paralysed units are uhealable (regen, heal, village rest and drains don't work), and have movement points reduced by 40%."
								[/dummy]
							[/abilities]
						[/effect]
					[/object]
				[/modify_unit]

				[floating_text]
					x,y=$second_unit.x,$second_unit.y
					text="<span color='#deb0ab'>Paralysed!</span>"
				[/floating_text]
			[/then]
		[/if]
	[/event]

	[event]
		name=attacker hits
		first_time_only=no

		[filter_attack]
			special_id=qquws_paralyse
		[/filter_attack]

		[filter_second]
			[not]
				ability=qquws_status_dmg_reduction_paralysed
			[/not]
		[/filter_second]

		[if]
			[variable]
				name=second_unit.hitpoints
				greater_than=0
			[/variable]
			[then]
				[modify_unit]
					[filter]
						id=$second_unit.id
					[/filter]

					[object]
						silent=yes
						id=qquws_paralysed_remove_weapons
						take_only_once=no

						[effect]
							apply_to=attack
							increase_damage=-40%
						[/effect]
						[effect]
							apply_to=new_ability
							[abilities]
								[dummy]
									id=qquws_status_dmg_reduction_paralysed
								[/dummy]
							[/abilities]
						[/effect]
					[/object]
				[/modify_unit]
			[/then]
		[/if]
	[/event]

	[event]
		name=defender hits
		first_time_only=no

		[filter_second_attack]
			special_id=qquws_paralyse
		[/filter_second_attack]

		[filter]
			[not]
				ability=qquws_status_paralysed
			[/not]
		[/filter]

		[if]
			[variable]
				name=unit.hitpoints
				greater_than=0
			[/variable]
			[then]
				[modify_unit]
					[filter]
						id=$unit.id
					[/filter]

					[status]
						unhealable=yes
					[/status]

					[object]
						silent=yes
						id=qquws_paralysed_unhealable
						take_only_once=no

						[effect]
							apply_to=image_mod
							add="~CS(70,30,30)"
						[/effect]
						[effect]
							apply_to=movement
							increase=-40%
						[/effect]
						[effect]
							apply_to=new_ability
							[abilities]
								[dummy]
									id=qquws_status_paralysed
									name="<span color='#deb0ab'>paralysed</span>"
									description="Paralysed units are uhealable (regen, heal, village rest and drains don't work), and have movement points reduced by 40%."
								[/dummy]
							[/abilities]
						[/effect]
					[/object]
				[/modify_unit]

				[floating_text]
					x,y=$unit.x,$unit.y
					text="<span color='#deb0ab'>Paralysed!</span>"
				[/floating_text]
			[/then]
		[/if]
	[/event]

	[event]
		name=defender hits
		first_time_only=no

		[filter_second_attack]
			special_id=qquws_paralyse
		[/filter_second_attack]

		[filter]
			[not]
				ability=qquws_status_dmg_reduction_paralysed
			[/not]
		[/filter]

		[if]
			[variable]
				name=unit.hitpoints
				greater_than=0
			[/variable]
			[then]
				[modify_unit]
					[filter]
						id=$unit.id
					[/filter]

					[object]
						silent=yes
						id=qquws_paralysed_remove_weapons
						take_only_once=no

						[effect]
							apply_to=attack
							increase_damage=-40%
						[/effect]
						[effect]
							apply_to=new_ability
							[abilities]
								[dummy]
									id=qquws_status_dmg_reduction_paralysed
								[/dummy]
							[/abilities]
						[/effect]
					[/object]
				[/modify_unit]
			[/then]
		[/if]
	[/event]

	[event]
		name=attack end
		priority=100 # bring attacks back again in case something has to be recalculated on weapons
		first_time_only=no

		[filter]
			ability=qquws_status_dmg_reduction_paralysed
		[/filter]

		[remove_object]
			id=$unit.id
			object_id=qquws_paralysed_remove_weapons
		[/remove_object]
	[/event]

	[event]
		name=attack end
		priority=100
		first_time_only=no

		[filter_second]
			ability=qquws_status_dmg_reduction_paralysed
		[/filter_second]

		[remove_object]
			id=$second_unit.id
			object_id=qquws_paralysed_remove_weapons
		[/remove_object]
	[/event]

	[event]
		name=turn end
		first_time_only=no

		[modify_unit]
			[filter]
				ability=qquws_status_paralysed
				side=$side_number
			[/filter]

			[status]
				unhealable=no
			[/status]
		[/modify_unit]

		[remove_object]
			ability=qquws_status_paralysed
			side=$side_number
			object_id=qquws_paralysed_unhealable
		[/remove_object]
	[/event]
#enddef

#define REGISTER_DEBILITATING_POISON
	[event]
		name=attacker hits
		first_time_only=no

		[filter_attack]
			special_id=qquws_debilitating_poison
		[/filter_attack]

		[filter_second]
			[not]
				ability_id=qquws_removed_regen_abilities
			[/not]
		[/filter_second]

		[if]
			[variable]
				name=second_unit.hitpoints
				greater_than=0
			[/variable]
			[then]
				[modify_unit]
					[filter]
						id=$second_unit.id
					[/filter]
						
					[object]
						silent=yes
						duration=turn end
						
						[effect]
						    apply_to=remove_ability
						    [experimental_filter_ability]
						    	tag_name=heals
						    [/experimental_filter_ability]
						[/effect]
						[effect]
						    apply_to=remove_ability
						    [experimental_filter_ability]
						    	tag_name=regenerate
						    [/experimental_filter_ability]
						[/effect]
						[effect]
						    apply_to=overlay
						    add=halo/uws/debilitating.png
						[/effect]
					[/object]
				[/modify_unit]
			[/then]
		[/if]
	[/event]
#enddef

#define REGISTER_GUN_RELOAD
	[event]
		name=turn refresh
		first_time_only=no

		[filter_side]
			[has_unit]
				side=$side_number
				ability=qquws_has_gun_reload
			[/has_unit]
		[/filter_side]

		{VARIABLE turn_mod "$( $turn_number % 2 )"}
		[if]
			[have_unit]
				side=$side_number
				ability=qquws_has_gun_reload
			[/have_unit]
			[and]
				[variable]
					name=turn_mod
					equals=1
				[/variable]
			[/and]
			[then]
				[modify_unit]
					[filter]
						side=$side_number
						ability=qquws_has_gun_reload
					[/filter]

					[status]
						gun_reload_ready=yes
					[/status]
				[/modify_unit]
			[/then]
		[/if]
	[/event]

	[event]
		name=attack end
		first_time_only=no

		[filter]
			status=gun_reload_ready
		[/filter]

		[filter_attack]
			special_id=qquws_gun_reload
		[/filter_attack]

		[modify_unit]
			[filter]
				id=$unit.id
			[/filter]

			[status]
				gun_reload_ready=no
			[/status]

			attacks_left=1
		[/modify_unit]

		[floating_text]
			x,y=$unit.x,$unit.y
			text="<span color='#cf7d65'>Reload!</span>"
		[/floating_text]
	[/event]
#enddef
