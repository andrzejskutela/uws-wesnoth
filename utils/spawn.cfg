#define QQUWS_SPAWN
	[event]
		name=spawn
		first_time_only=no
		
		{VARIABLE do_spawn_west $spawn_west}
		{VARIABLE do_spawn_east $spawn_east}
		{VARIABLE immune_to_specials no}
		
		[if]
			[variable]
				name=spawn_x
				numerical_equals=$uws_game.middle
			[/variable]
			[or]
				[variable]
					name=uws_game.mode
					equals=slash
				[/variable]
			[/or]
			[then]
				{VARIABLE do_spawn_east no}
			[/then]
			[else]
				[if]
					[variable]
						name=uws_game.mode
						equals=scroll
					[/variable]
					[and]
						[variable]
							name=uws_game.single_player_game
							boolean_equals=yes
						[/variable]
					[/and]
					[then]
						[if]
							[variable]
								name=sides[8].is_present
								boolean_equals=yes
							[/variable]
							[then]
								{VARIABLE do_spawn_west yes}
								{VARIABLE do_spawn_east no}
							[/then]
							[else]
								{VARIABLE do_spawn_west no}
								{VARIABLE do_spawn_east yes}
							[/else]
						[/if]
					[/then]
				[/if]
			[/else]
		[/if]
		
		{VARIABLE unit_placement_y $spawn_y}
		
		{VARIABLE is_lava_safe no}
		[if]
			[variable]
				name=spawn_final_boss
				boolean_equals=yes
			[/variable]
			[then]
				{VARIABLE is_lava_safe yes}
				{VARIABLE immune_to_specials yes}
			[/then]
		[/if]
		
		[if]
			[variable]
				name=spawn_buff
				not_equals=""
			[/variable]
			[then]
				{VARIABLE is_lava_safe yes}
				{VARIABLE immune_to_specials yes}
			[/then]
		[/if]
		
		{VARIABLE new_unit_has_item no}
		{VARIABLE current_random_item_id ""}
		[if]
			[variable]
				name=spawn_item
				not_equals=""
			[/variable]
			[then]
				{VARIABLE new_unit_has_item yes}
				{VARIABLE current_random_item_id $spawn_item}
			[/then]
		[/if]
		
		{VARIABLE unit_has_gold no}
		{VARIABLE new_unit_gold 0}
		[if]
			[variable]
				name=spawn_gold
				greater_than=0
			[/variable]
			[then]
				{VARIABLE unit_has_gold yes}
				{VARIABLE new_unit_gold $spawn_gold}
			[/then]
		[/if]
		
		{VARIABLE new_unit_spawn_quiet_bonus_id $spawn_quiet_buff}
		{VARIABLE new_unit_spawn_minion ""}
		{VARIABLE new_unit_bulky_value $spawn_bulky}
		{VARIABLE new_unit_beefy_value $spawn_beefy}
		{VARIABLE new_unit_armored_value $spawn_armored}
		{VARIABLE new_unit_fast_value $spawn_fast}
		{VARIABLE new_unit_agile_value $spawn_agile}
		{VARIABLE east_spawn_side $spawn_side}
		
		[if]
			[variable]
				name=spawn_side
				greater_than=1
			[/variable]
			[then]
				{VARIABLE_OP east_spawn_side add 3}
			[/then]
		[/if]
		
		[if]
			[variable]
				name=do_spawn_west
				boolean_equals=yes
			[/variable]
			[then]
				[fire_event]
					name=get_new_unit_on_map
				[/fire_event]
				
				[if]
					[variable]
						name=spawn_name
						not_equals=""
					[/variable]
					[and]
						[variable]
							name=spawn_final_boss
							boolean_equals=no
						[/variable]
					[/and]
					[then]
						{VARIABLE spawning_unit.name $spawn_name}
					[/then]
				[/if]
				
				[unstore_unit]
					variable=spawning_unit
					find_vacant=yes
					x=$spawn_x
					y=$spawn_y
				[/unstore_unit]
				
				{VARIABLE new_unit_spawn_id $spawning_unit.id}
				{VARIABLE run_events_for_side $spawn_side}
				
				[if]
					[variable]
						name=spawn_recruits
						not_equals=no
					[/variable]
					[then]
						{SET_GOLD_FOR_SIDE $spawn_side $spawn_recruitment_gold}
						
						[fire_event]
							name=race_ensure_one_recruiter
						[/fire_event]
						
						[fire_event]
							name=slash_call_to_fight
						[/fire_event]
					[/then]
				[/if]
				
				{VARIABLE new_unit_spawn_champion $spawn_buff}
				{VARIABLE calculate_handicap_for 8}
				{VARIABLE new_unit_y $spawn_y}
				
				[fire_event]
					name=calculate_handicap
				[/fire_event]
				
				[fire_event]
					name=apply_new_unit_bonus
				[/fire_event]
				
				[if]
					[variable]
						name=spawn_event
						not_equals=""
					[/variable]
					[then]
						{VARIABLE gameplay_event_id $spawn_event}
						{VARIABLE new_gpe_id "gpe_$new_unit_spawn_id"}
						{VARIABLE gpe_owner_side $spawn_side}
						{VARIABLE gpe_owner_unit $new_unit_spawn_id}
						
						[fire_event]
							name=register_gameplay_event
						[/fire_event]
					[/then]
				[/if]
				
				[if]
					[variable]
						name=spawn_calls_for_help
						boolean_equals=yes
					[/variable]
					[then]
						{VARIABLE new_high_point_tmp $spawn_y}
						{VARIABLE_OP new_high_point_tmp sub 5}
						{VARIABLE_OP new_high_point_tmp add $race_spawn_look_ahead}
						
						[if]
							[variable]
								name=new_high_point_tmp
								less_than=$sides[8].race_high_point
							[/variable]
							[then]
								{VARIABLE sides[8].race_high_point $new_high_point_tmp}
							[/then]
						[/if]
					[/then]
				[/if]
				
				[if]
					[variable]
						name=spawn_story_message
						not_equals=""
					[/variable]
					[then]
						{FLASH_RED (
							[message]
								id=$new_unit_spawn_id
								message="$spawn_story_message"
							[/message]
						)}
						
						[if]
							[variable]
								name=spawn_story_response
								not_equals=""
							[/variable]
							[then]
								[store_unit]
									[filter]
										side=$uws_game.filter_human_sides
										canrecruit=yes
									[/filter]
									
									variable=message_leader
									mode=always_clear
								[/store_unit]
				
								[message]
									id=$message_leader.id
									message="$spawn_story_response"
								[/message]
								
								{CLEAR_VARIABLE message_leader}
							[/then]
						[/if]
					[/then]
				[/if]
				
				[if]
					[variable]
						name=spawn_final_boss
						boolean_equals=yes
					[/variable]
					[then]
						{VARIABLE is_lava_safe yes}
						
						[if]
							[variable]
								name=uws_game.mode
								equals=slash
							[/variable]
							[then]
								[event]
									id=final_boss_warning
									name=die
									first_time_only=no
									delayed_variable_substitution=no
									
									[if]
										[have_unit]
											side=2,3,4
											x=2-100
											count=6-9
										[/have_unit]
										[then]
											[message]
												id=$new_unit_spawn_id
												message="You think you can threaten me? YOU?! Bring me their heads!"
											[/message]
											
											[modify_unit]
												[filter]
													side=2,3,4
													status=guardian
												[/filter]
												
												[status]
													guardian=no
												[/status]
											[/modify_unit]
											
											[remove_event]
												id=final_boss_warning
											[/remove_event]
										[/then]
									[/if]
								[/event]
								
								[event]
									id=final_boss_give_mp_to_units
									name=die
									first_time_only=no
									delayed_variable_substitution=no
									
									[if]
										[have_unit]
											side=2,3,4
											x=2-100
											count=1-5
										[/have_unit]
										[then]
											[message]
												id=$new_unit_spawn_id
												message="Move you lazy maggots! Kill them!!!"
											[/message]
											
											[modify_unit]
												[filter]
													side=2,3,4
													formula="if(self.max_moves < 3, 1, 0)"
												[/filter]
												
												[object]
													silent=yes
													
													[effect]
													    apply_to=movement
													    set=6
													[/effect]
												[/object]
											[/modify_unit]
											
											[modify_unit]
												[filter]
													side=2,3,4
													x=3-100
													canrecruit=yes
												[/filter]
												
												canrecruit=no
											[/modify_unit]
											
											[remove_event]
												id=final_boss_give_mp_to_units
											[/remove_event]
										[/then]
									[/if]
								[/event]
							[/then]
						[/if]
					[/then]
				[/if]
			[/then]
		[/if]
		
		[if]
			[variable]
				name=do_spawn_east
				boolean_equals=yes
			[/variable]
			[then]
				[if]
					[variable]
						name=uws_game.full_random
						boolean_equals=yes
					[/variable]
					[then]
						{VARIABLE spawn_type $spawn_second_random}
					[/then]
				[/if]
				
				[if]
					[variable]
						name=new_unit_has_item
						boolean_equals=yes
					[/variable]
					[then]
						{VARIABLE current_random_item_id $spawn_item}
					[/then]
				[/if]
				
				[fire_event]
					name=get_new_unit_on_map
				[/fire_event]
				
				{VARIABLE spawning_unit.side $east_spawn_side}
				{VARIABLE east_x $uws_game.edge}
				{VARIABLE_OP east_x sub $spawn_x}
				
				[if]
					[variable]
						name=spawn_second_name
						not_equals=""
					[/variable]
					[then]
						{VARIABLE spawning_unit.name $spawn_second_name}
					[/then]
				[/if]
				
				[unstore_unit]
					variable=spawning_unit
					find_vacant=yes
					x=$east_x
					y=$spawn_y
				[/unstore_unit]
				
				{VARIABLE new_unit_spawn_id $spawning_unit.id}
				{VARIABLE run_events_for_side $east_spawn_side}
				
				[if]
					[variable]
						name=spawn_recruits
						not_equals=no
					[/variable]
					[then]
						{SET_GOLD_FOR_SIDE $east_spawn_side $spawn_recruitment_gold}
						
						[fire_event]
							name=race_ensure_one_recruiter
						[/fire_event]
						
						[fire_event]
							name=slash_call_to_fight
						[/fire_event]
					[/then]
				[/if]
				
				{VARIABLE new_unit_spawn_champion $spawn_second_buff}
				{VARIABLE calculate_handicap_for 9}
				{VARIABLE new_unit_y $spawn_y}
				
				[fire_event]
					name=calculate_handicap
				[/fire_event]
				
				[fire_event]
					name=apply_new_unit_bonus
				[/fire_event]
				
				[if]
					[variable]
						name=spawn_calls_for_help
						boolean_equals=yes
					[/variable]
					[then]
						{VARIABLE new_high_point_tmp $spawn_y}
						{VARIABLE_OP new_high_point_tmp sub 5}
						{VARIABLE_OP new_high_point_tmp add $race_spawn_look_ahead}
						
						[if]
							[variable]
								name=new_high_point_tmp
								less_than=$sides[9].race_high_point
							[/variable]
							[then]
								{VARIABLE sides[9].race_high_point $new_high_point_tmp}
							[/then]
						[/if]
					[/then]
				[/if]
				
				[if]
					[variable]
						name=spawn_event
						not_equals=""
					[/variable]
					[then]
						{VARIABLE gameplay_event_id $spawn_event}
						{VARIABLE new_gpe_id "gpe_$new_unit_spawn_id"}
						{VARIABLE gpe_owner_side $east_spawn_side}
						{VARIABLE gpe_owner_unit $new_unit_spawn_id}
						
						[fire_event]
							name=register_gameplay_event
						[/fire_event]
					[/then]
				[/if]
			[/then]
		[/if]
	[/event]
	
	[event]
		name=get_new_unit_on_map
		first_time_only=no
		
		[unit]
			type=$spawn_type
			side=$spawn_side
			to_variable=spawning_unit
			random_traits=no
			random_gender=yes
			upkeep=loyal
			[variables]
				has_item=$new_unit_has_item
				item_id=$current_random_item_id
				has_gold=$unit_has_gold
				gold_amount=$spawn_gold
				final_boss=$spawn_final_boss
				is_lava_safe=$is_lava_safe
				placement_y=$unit_placement_y
				is_stoic=$spawn_disallow_slash_unguardian
				calls_for_help=$spawn_calls_for_help
				recruit_armored=$spawn_recruit_armored
				recruit_minion=$spawn_recruit_minion
				is_immune_to_specials=$immune_to_specials
				race_points_value=$spawn_race_points_value
			[/variables]
		[/unit]
		
		[if]
			[variable]
				name=spawn_final_boss
				boolean_equals=yes
			[/variable]
			[then]
				{VARIABLE spawning_unit.status.unpoisonable yes}
				{VARIABLE spawning_unit.status.undrainable yes}
				{VARIABLE spawning_unit.status.unplagueable yes}
				{VARIABLE spawning_unit.status.unpetrifiable yes}
				{VARIABLE spawning_unit.facing s}
				{VARIABLE spawning_unit.name $uws_game.final_boss_name}
				{VARIABLE spawning_unit.unrenamable yes}
			[/then]
		[/if]
		
		[if]
			[variable]
				name=spawn_recruits
				not_equals=no
			[/variable]
			[then]
				{VARIABLE spawning_unit.canrecruit yes}
				{VARIABLE spawning_unit.extra_recruit $spawn_recruits}
			[/then]
		[/if]
		
		[if]
			[variable]
				name=spawn_damaged
				greater_than=0
			[/variable]
			[then]
				{VARIABLE_OP spawning_unit.hitpoints multiply $spawn_damaged}
			[/then]
		[/if]
		
		[if]
			[variable]
				name=spawn_moves
				greater_than=-1
			[/variable]
			[then]
				{VARIABLE spawning_unit.moves $spawn_moves}
				{VARIABLE spawning_unit.max_moves $spawn_moves}
			[/then]
		[/if]
		
		[if]
			[variable]
				name=spawn_guard
				boolean_equals=yes
			[/variable]
			[then]
				{VARIABLE spawning_unit.status.guardian yes}
			[/then]
		[/if]
		
		[if]
			[variable]
				name=spawn_side
				equals=1
			[/variable]
			[then]
				{VARIABLE spawning_unit.status.petrified yes}
			[/then]
		[/if]
	[/event]
	
	[event]
		name=calculate_handicap
		first_time_only=no
		
		{VARIABLE new_unit_bonus_hp 0}
		{VARIABLE new_unit_bonus_dmg 0}
		{VARIABLE new_unit_bonus_strikes 0}
		{VARIABLE bonus_breakdown ""}
		
		[if]
			[variable]
				name=uws_game.mode
				equals=scroll
			[/variable]
			[then]
				{VARIABLE bonus_strength_kval "$(ceil(($turn_number + $uws_game.base_bonus_strength_kval) / 8))"}
			[/then]
			[else]
				{VARIABLE bonus_strength_kval "$(ceil(($uws_game.race_start_y - $new_unit_y + $uws_game.base_bonus_strength_kval) / 10))"}
				
				[if]
					[variable]
						name=bonus_strength_kval
						less_than=1
					[/variable]
					[then]
						{VARIABLE bonus_strength_kval 1}
					[/then]
				[/if]
			[/else]
		[/if]
		
		{UWS_XPMOD_EXPANDED_SETTINGS}
		{VARIABLE hp_income_multiplier "$(1.15 - $bonus_strength_kval * 0.035)"}
		
		[if]
			[variable]
				name=uws_game.basic_income
				less_than=$sides[$calculate_handicap_for|].gold_income
			[/variable]
			[and]
				[variable]
					name=uws_game.spawn_weak_enemies
					boolean_equals=false
				[/variable]
			[/and]
			[then]
				{VARIABLE penalty_starting_value $sides[$calculate_handicap_for|].gold_income}
				
				{VARIABLE penalty_value "$( $bonus_strength_kval * 1.2 * $hp_income_multiplier * ($penalty_starting_value - $uws_game.basic_income) )"}
				{VARIABLE_OP penalty_value round 1}
				
				{VARIABLE penalty_dmg_value "$( $bonus_strength_kval * 0.5 * $hp_income_multiplier * ($penalty_starting_value - $uws_game.basic_income) )"}
				{VARIABLE_OP penalty_dmg_value round 1}
				
				{VARIABLE_OP new_unit_bonus_hp add $penalty_value}
				{VARIABLE_OP new_unit_bonus_dmg add $penalty_dmg_value}
				{VARIABLE bonus_breakdown ("High income: +$penalty_value|% hp / +$penalty_dmg_value|% dmg
$bonus_breakdown")}
			[/then]
		[/if]
		
		[if]
			[variable]
				name=uws_game.basic_village_total
				less_than=$sides[$calculate_handicap_for|].village_income
			[/variable]
			[and]
				[variable]
					name=uws_game.spawn_weak_enemies
					boolean_equals=false
				[/variable]
			[/and]
			[then]
				{VARIABLE penalty_starting_value $sides[$calculate_handicap_for|].village_income}
				
				{VARIABLE penalty_value "$( $bonus_strength_kval * 1.6 * $hp_income_multiplier * ($penalty_starting_value - $uws_game.basic_village_total) )"}
				{VARIABLE_OP penalty_value round 1}
				
				{VARIABLE penalty_dmg_value "$( $bonus_strength_kval * 0.4 * $hp_income_multiplier * ($penalty_starting_value - $uws_game.basic_village_total) )"}
				{VARIABLE_OP penalty_dmg_value round 1}
				
				{VARIABLE_OP new_unit_bonus_hp add $penalty_value}
				{VARIABLE_OP new_unit_bonus_dmg add $penalty_dmg_value}
				{VARIABLE bonus_breakdown ("High village income: +$penalty_value|% hp / +$penalty_dmg_value|% dmg
$bonus_breakdown")}
			[/then]
		[/if]
		
		[if]
			[variable]
				name=bonustile_enabled
				boolean_equals=yes
			[/variable]
			[and]
				[variable]
					name=uws_game.spawn_weak_enemies
					boolean_equals=false
				[/variable]
			[/and]
			[then]
				{VARIABLE starter_value 5}
				{VARIABLE mult_value 1}
				[if]
					[variable]
						name=bonus_strength_kval
						greater_than=8
					[/variable]
					[then]
						{VARIABLE starter_value 34}
						{VARIABLE mult_value 1}
					[/then]
					[else]
						[if]
							[variable]
								name=bonus_strength_kval
								greater_than=4
							[/variable]
							[then]
								{VARIABLE starter_value 18}
								{VARIABLE mult_value 3}
							[/then]
							[else]
								{VARIABLE starter_value 6}
								{VARIABLE mult_value 6}
							[/else]
						[/if]
					[/else]
				[/if]
				
				{VARIABLE penalty_value "$( $bonus_strength_kval * $mult_value + $starter_value )"}
				{VARIABLE_OP penalty_value round 1}
				{VARIABLE_OP new_unit_bonus_hp add $penalty_value}
				{VARIABLE bonus_breakdown ("Bonus Tile mod: +$penalty_value|% hp
$bonus_breakdown")}
			[/then]
		[/if]
		
		[if]
			[variable]
				name=How_Much_We_Do_Funny_Bonuses
				greater_than=0
			[/variable]
			[and]
				[variable]
					name=uws_game.spawn_weak_enemies
					boolean_equals=false
				[/variable]
			[/and]
			[then]
				{VARIABLE penalty_value "$( sqrt($How_Much_We_Do_Funny_Bonuses) * $bonus_strength_kval * (3.2 + (8 * $bonus_strength_kval / 50 - 1.2) / 2 ) )"}
				{VARIABLE penalty_dmg_value "$( sqrt($How_Much_We_Do_Funny_Bonuses) * $bonus_strength_kval )"}
				
				[if]
					[variable]
						name=uws_game.mode
						equals=scroll
					[/variable]
					[then]
						{VARIABLE_OP penalty_value multiply 2}
						{VARIABLE_OP penalty_dmg_value multiply 2}
					[/then]
				[/if]
				
				{VARIABLE_OP penalty_value round 1}
				{VARIABLE_OP penalty_dmg_value round 1}
				
				{VARIABLE_OP new_unit_bonus_hp add $penalty_value}
				{VARIABLE_OP new_unit_bonus_dmg add $penalty_dmg_value}
				{VARIABLE bonus_breakdown ("Bonus Spam mod: +$penalty_value|% hp / +$penalty_dmg_value|% dmg
$bonus_breakdown")}
			[/then]
		[/if]
		
		[if]
			[variable]
				name=aww_04_passive_xp
				greater_than=0
			[/variable]
			[and]
				[variable]
					name=uws_game.spawn_weak_enemies
					boolean_equals=false
				[/variable]
			[/and]
			[then]
				{VARIABLE penalty_value "$( $aww_04_passive_xp * 1.6 * $bonus_strength_kval )"}
				{VARIABLE_OP penalty_value round 1}
				
				{VARIABLE penalty_dmg_value "$( $aww_04_passive_xp * 0.4 * $bonus_strength_kval )"}
				{VARIABLE_OP penalty_dmg_value round 1}
				
				{VARIABLE_OP new_unit_bonus_hp add $penalty_value}
				{VARIABLE_OP new_unit_bonus_dmg add $penalty_dmg_value}
				{VARIABLE bonus_breakdown ("Passive XP: +$penalty_value|% hp / +$penalty_dmg_value|% dmg
$bonus_breakdown")}
			[/then]
		[/if]
		
		[if]
			[variable]
				name=exp_assigned
				boolean_equals=yes
			[/variable]
			[and]
				[variable]
					name=uws_game.spawn_weak_enemies
					boolean_equals=false
				[/variable]
			[/and]
			[then]
				{VARIABLE penalty_value "$( $bonus_strength_kval * 4 + 26 )"}
				
				[if]
					[variable]
						name=XP_bank_start
						greater_than=0
					[/variable]
					[then]
						{VARIABLE_OP penalty_value add "$( floor($XP_bank_start / if($bonus_strength_kval < 10, $bonus_strength_kval ^ 1.5 + 0.5, 200)) )"}
					[/then]
				[/if]
				
				{VARIABLE_OP penalty_value round 1}
				{VARIABLE_OP new_unit_bonus_hp add $penalty_value}
				{VARIABLE bonus_breakdown ("XP Bank: +$penalty_value|% hp
$bonus_breakdown")}
			[/then]
		[/if]
		
		[if]
			[variable]
				name=sides[$calculate_handicap_for|].xp_mod_hp
				greater_than=0
			[/variable]
			[and]
				[variable]
					name=uws_game.spawn_weak_enemies
					boolean_equals=false
				[/variable]
			[/and]
			[then]
				{VARIABLE mod_used_total $sides[$calculate_handicap_for|].xp_mod_hp}
				
				{VARIABLE penalty_value "$( $mod_used_total * $uws_xpmod_hp_factor )"}
				{VARIABLE_OP penalty_value round 1}
				
				{VARIABLE penalty_dmg_value "$( $mod_used_total * $uws_xpmod_hp_factor )"}
				{VARIABLE_OP penalty_dmg_value round 1}
				
				{VARIABLE_OP mod_used_total multiply 4}
				{VARIABLE_OP new_unit_bonus_hp add $penalty_value}
				{VARIABLE_OP new_unit_bonus_dmg add $penalty_dmg_value}
				{VARIABLE bonus_breakdown ("XP Mod +$mod_used_total HP: +$penalty_value|% hp / +$penalty_dmg_value|% dmg
$bonus_breakdown")}
			[/then]
		[/if]
		
		[if]
			[variable]
				name=sides[$calculate_handicap_for|].xp_mod_mp
				greater_than=0
			[/variable]
			[and]
				[variable]
					name=uws_game.spawn_weak_enemies
					boolean_equals=false
				[/variable]
			[/and]
			[then]
				{VARIABLE mod_used_total $sides[$calculate_handicap_for|].xp_mod_mp}
				
				{VARIABLE penalty_value "$( ($mod_used_total ^ 2) * $uws_xpmod_mp_factor_hp )"}
				{VARIABLE_OP penalty_value round 1}
				
				{VARIABLE penalty_dmg_value "$( $mod_used_total * $uws_xpmod_mp_factor_dmg )"}
				{VARIABLE_OP penalty_dmg_value round 1}
				
				{VARIABLE_OP new_unit_bonus_hp add $penalty_value}
				{VARIABLE_OP new_unit_bonus_dmg add $penalty_dmg_value}
				{VARIABLE bonus_breakdown ("XP Mod +$mod_used_total MP: +$penalty_value|% hp / +$penalty_dmg_value|% dmg
$bonus_breakdown")}
			[/then]
		[/if]
		
		[if]
			[variable]
				name=sides[$calculate_handicap_for|].xp_mod_dmg
				greater_than=0
			[/variable]
			[and]
				[variable]
					name=uws_game.spawn_weak_enemies
					boolean_equals=false
				[/variable]
			[/and]
			[then]
				{VARIABLE mod_used_total $sides[$calculate_handicap_for|].xp_mod_dmg}
				
				{VARIABLE penalty_value "$( $mod_used_total * $uws_xpmod_dmg_factor_hp )"}
				{VARIABLE_OP penalty_value round 1}
				
				{VARIABLE penalty_dmg_value "$( $mod_used_total * $uws_xpmod_dmg_factor_dmg )"}
				{VARIABLE_OP penalty_dmg_value round 1}
				
				{VARIABLE_OP new_unit_bonus_hp add $penalty_value}
				{VARIABLE_OP new_unit_bonus_dmg add $penalty_dmg_value}
				{VARIABLE bonus_breakdown ("XP Mod +$mod_used_total Damage: +$penalty_value|% hp / +$penalty_dmg_value|% dmg
$bonus_breakdown")}
			[/then]
		[/if]
		
		[if]
			[variable]
				name=sides[$calculate_handicap_for|].xp_mod_str
				greater_than=0
			[/variable]
			[and]
				[variable]
					name=uws_game.spawn_weak_enemies
					boolean_equals=false
				[/variable]
			[/and]
			[then]
				{VARIABLE mod_used_total $sides[$calculate_handicap_for|].xp_mod_str}
				
				{VARIABLE penalty_value "$( 2.8 + ($mod_used_total ^ 2) * if(bonus_factor < 0.2, 0.2, bonus_factor) where bonus_factor = (0.76 - $mod_used_total * $uws_xpmod_strike_factor_hp) )"}
				{VARIABLE_OP penalty_value round 1}
				
				{VARIABLE penalty_dmg_value "$( $mod_used_total * $uws_xpmod_strike_factor_dmg )"}
				{VARIABLE_OP penalty_dmg_value round 1}
				
				{VARIABLE_OP new_unit_bonus_hp add $penalty_value}
				{VARIABLE_OP new_unit_bonus_dmg add $penalty_dmg_value}
				{VARIABLE bonus_breakdown ("XP Mod +$mod_used_total Strikes: +$penalty_value|% hp / +$penalty_dmg_value|% dmg
$bonus_breakdown")}
			[/then]
		[/if]
		
		[if]
			[variable]
				name=sides[$calculate_handicap_for|].is_leader_above_lvl2
				boolean_equals=yes
			[/variable]
			[and]
				[variable]
					name=uws_game.spawn_weak_enemies
					boolean_equals=false
				[/variable]
			[/and]
			[then]
				[if]
					[variable]
						name=bonus_strength_kval
						less_than=6
					[/variable]
					[then]
						{VARIABLE penalty_value "$( [36,28,20,12,4][ $bonus_strength_kval - 1 ] )"}
						{VARIABLE_OP new_unit_bonus_hp add $penalty_value}
						{VARIABLE bonus_breakdown ("Starting with high level leader: +$penalty_value|% hp
$bonus_breakdown")}
					[/then]
				[/if]
			[/then]
		[/if]
		
		{VARIABLE basic_eras "era_default,era_dunefolk,Ageless Era,Ageless Heroes,Ageless Union,DefaultAgeless Union,era_magic,era_magic_aoh,era_magic_masters"}
		{VARIABLE very_strong_eras "DMM_Shops_Mod,DMMH_Shops_Mod,DMML_Shops_Mod,DMMLH_Shops_Mod"}
		[if]
			[not]
				[variable]
					name=basic_eras
					contains=$current_era_id
				[/variable]
			[/not]
			[and]
				[variable]
					name=uws_game.spawn_weak_enemies
					boolean_equals=false
				[/variable]
			[/and]
			[then]
				{VARIABLE penalty_value "$( 6.4 + $bonus_strength_kval * 1.6 )"}
				{VARIABLE penalty_dmg_value 0}
				
				[if]
					[variable]
						name=very_strong_eras
						contains=$current_era_id
					[/variable]
					[then]
						{VARIABLE_OP penalty_value add "$( 16 + $bonus_strength_kval * 5.4 )"}
						{VARIABLE penalty_dmg_value "$( 12 + $bonus_strength_kval * 2.5 )"}
						{VARIABLE_OP penalty_dmg_value round 1}
					[/then]
				[/if]
				
				{VARIABLE_OP penalty_value round 1}
				
				[if]
					[variable]
						name=penalty_dmg_value
						greater_than=0.1
					[/variable]
					[then]
						{VARIABLE_OP new_unit_bonus_hp add $penalty_value}
						{VARIABLE_OP new_unit_bonus_dmg add $penalty_dmg_value}
						{VARIABLE bonus_breakdown ("Strong Era settings: +$penalty_value|% hp / +$penalty_dmg_value|% dmg
$bonus_breakdown")}
					[/then]
					[else]
						{VARIABLE_OP new_unit_bonus_hp add $penalty_value}
						{VARIABLE bonus_breakdown ("Strong Era settings: +$penalty_value|% hp
$bonus_breakdown")}
					[/else]
				[/if]
			[/then]
		[/if]
		
		[if]
			[variable]
				name=aww_10_enable_gifted_leaders
				boolean_equals=yes
			[/variable]
			[and]
				[variable]
					name=uws_game.spawn_weak_enemies
					boolean_equals=false
				[/variable]
			[/and]
			[then]
				{VARIABLE penalty_value 8}
				{VARIABLE_OP new_unit_bonus_hp add $penalty_value}
				{VARIABLE bonus_breakdown ("Gifted leaders mod: +$penalty_value|% hp
$bonus_breakdown")}
			[/then]
		[/if]
		
		[if]
			[variable]
				name=uws_game.enable_scenario_bonus
				boolean_equals=yes
			[/variable]
			[then]
				{VARIABLE_OP new_unit_bonus_hp add $uws_game.scenario_bonus_hp}
				{VARIABLE bonus_text "Scenario bonus: +$uws_game.scenario_bonus_hp|% hp"}
				
				[if]
					[variable]
						name=uws_game.scenario_bonus_dmg
						greater_than=0
					[/variable]
					[then]
						{VARIABLE_OP new_unit_bonus_dmg add $uws_game.scenario_bonus_dmg}
						{VARIABLE bonus_text "$bonus_text / +$uws_game.scenario_bonus_dmg|% dmg"}
					[/then]
				[/if]
				
				[if]
					[variable]
						name=uws_game.scenario_bonus_strikes
						greater_than=0
					[/variable]
					[then]
						{VARIABLE_OP new_unit_bonus_strikes add $uws_game.scenario_bonus_strikes}
						{VARIABLE bonus_text "$bonus_text / +$uws_game.scenario_bonus_strikes strikes"}
					[/then]
				[/if]
				
				{VARIABLE bonus_breakdown ("$bonus_text
$bonus_breakdown")}
			[/then]
		[/if]
		
		[if]
			[variable]
				name=uws_game.spawn_weak_enemies
				boolean_equals=yes
			[/variable]
			[then]
				{VARIABLE_OP new_unit_bonus_dmg sub 30}
				
				# penalty mulitplier is 0.5 on easy and uws_game.spawn_weak_enemies is only on easy, hence -15 in description makes more sense while keeping 30 in bonus_dmg
				{VARIABLE bonus_breakdown ("Easy difficuty: +0% hp / -15% dmg
$bonus_breakdown")}
			[/then]
		[/if]
	[/event]
	
	[event]
		name=generate_champion_data
		first_time_only=no
		
		[if]
			[variable]
				name=is_single_buff_random
				boolean_equals=yes
			[/variable]
			[then]
				[unit]
					type=$prespawn_champion_type
					side=1
					to_variable=new_champion_precheck_unit
					random_traits=no
					random_gender=yes
					upkeep=loyal
					[abilities]
						[hides]
							id=hidden
							name= _ "hidden"
							female_name= _ "female^hidden"
							name_inactive= _ "hidden"
							female_name_inactive= _ "female^hidden"
							description= _ "This unit is hidden."
							affect_self=yes
							[filter_self]
								[filter_location]
									terrain=*
								[/filter_location]
							[/filter_self]
						[/hides]
					[/abilities]
				[/unit]
				
				[unstore_unit]
					variable=new_champion_precheck_unit
					x=1
					y=1
				[/unstore_unit]
				
				{VARIABLE new_unit_has_ranged_attack no}
				{VARIABLE new_unit_has_melee_attack no}
				{VARIABLE has_magical_melee no}
				{VARIABLE has_magical_ranged no}
				{VARIABLE has_melee_pierce no}
				{VARIABLE has_melee_charge no}
				{VARIABLE unit_is_static no}
				{VARIABLE has_physical_resistances no}
				{VARIABLE has_berserk no}
				{VARIABLE is_high_level no}
				{VARIABLE has_strong_melee_blade no}
				{VARIABLE has_overwhelming_melee_blade no}
				{VARIABLE has_strong_impact no}
				
				[if]
					[have_unit]
						id=$new_champion_precheck_unit.id
						[has_attack]
							formula="if(range='ranged' and damage * number > 5, 1, 0)"
						[/has_attack]
						count=1
					[/have_unit]
					[then]
						{VARIABLE new_unit_has_ranged_attack yes}
					[/then]
				[/if]
				
				[if]
					[have_unit]
						id=$new_champion_precheck_unit.id
						[has_attack]
							formula="if(range='melee' and damage * number > 5, 1, 0)"
						[/has_attack]
						count=1
					[/have_unit]
					[then]
						{VARIABLE new_unit_has_melee_attack yes}
					[/then]
				[/if]
				
				[if]
					[have_unit]
						id=$new_champion_precheck_unit.id
						[has_attack]
							range=melee
							special_id=magical
						[/has_attack]
						count=1
					[/have_unit]
					[then]
						{VARIABLE has_magical_melee yes}
					[/then]
				[/if]
				
				[if]
					[have_unit]
						id=$new_champion_precheck_unit.id
						[has_attack]
							range=ranged
							special_id=magical
						[/has_attack]
						count=1
					[/have_unit]
					[then]
						{VARIABLE has_magical_ranged yes}
					[/then]
				[/if]
				
				[if]
					[have_unit]
						id=$new_champion_precheck_unit.id
						[has_attack]
							range=melee
							type=pierce
						[/has_attack]
						count=1
					[/have_unit]
					[then]
						{VARIABLE has_melee_pierce yes}
					[/then]
				[/if]
				
				[if]
					[have_unit]
						id=$new_champion_precheck_unit.id
						[has_attack]
							range=melee
							special_id=charge
						[/has_attack]
						count=1
					[/have_unit]
					[then]
						{VARIABLE has_melee_charge yes}
					[/then]
				[/if]
				
				[if]
					[have_unit]
						id=$new_champion_precheck_unit.id
						[has_attack]
							special_id=berserk
						[/has_attack]
						count=1
					[/have_unit]
					[then]
						{VARIABLE has_berserk yes}
					[/then]
				[/if]
				
				[if]
					[variable]
						name=prespawn_moves
						numerical_equals=0
					[/variable]
					[then]
						{VARIABLE unit_is_static yes}
					[/then]
				[/if]
				
				[if]
					[have_unit]
						id=$new_champion_precheck_unit.id
						formula="if(avg_res > 0 and avg_res < 33, 1, 0)
							where avg_res = ((resistance.blade + resistance.impact + resistance.pierce) / 3)"
						count=1
					[/have_unit]
					[then]
						{VARIABLE has_physical_resistances yes}
					[/then]
				[/if]
				
				[if]
					[have_unit]
						id=$new_champion_precheck_unit.id
						level=3,4,5,6,7
						count=1
					[/have_unit]
					[then]
						{VARIABLE is_high_level yes}
					[/then]
				[/if]
				
				[if]
					[have_unit]
						id=$new_champion_precheck_unit.id
						[has_attack]
							range=melee
							type=blade
							damage=20-999
						[/has_attack]
						count=1
					[/have_unit]
					[then]
						{VARIABLE has_strong_melee_blade yes}
					[/then]
				[/if]
				
				[if]
					[have_unit]
						id=$new_champion_precheck_unit.id
						[has_attack]
							range=melee
							type=blade
							damage=16-999
							number=4-99
						[/has_attack]
						count=1
					[/have_unit]
					[then]
						{VARIABLE has_overwhelming_melee_blade yes}
					[/then]
				[/if]
				
				[if]
					[have_unit]
						id=$new_champion_precheck_unit.id
						[has_attack]
							type=impact
							damage=24-999
						[/has_attack]
						count=1
					[/have_unit]
					[then]
						{VARIABLE has_strong_impact yes}
					[/then]
				[/if]
				
				[qquws_generate_random_champion]
					var_buff_a=prespawn_buff_a
					var_buff_b=prespawn_buff_b
					var_buff_c=prespawn_buff_c
					full_buff=$prespawn_full_buff
				[/qquws_generate_random_champion]
			[/then]
		[/if]
		
		[qquws_champion_buff_to_name]
			var_buff_a=$prespawn_buff_a
			var_buff_b=$prespawn_buff_b
			var_buff_c=$prespawn_buff_c
			name_var=prespawn_buff_name
		[/qquws_champion_buff_to_name]
		
		[if]
			[variable]
				name=is_single_buff_random
				boolean_equals=yes
			[/variable]
			[then]
				{CLEAR_VARIABLE new_champion_precheck_unit}
				[kill]
					x=1
					y=1
					fire_event=no
				[/kill]
			[/then]
		[/if]
	[/event]
#enddef

#define UWS_XPMOD_EXPANDED_SETTINGS
	{VARIABLE uws_xpmod_hp_factor 0.4}
	{VARIABLE uws_xpmod_mp_factor_hp 0.1}
	{VARIABLE uws_xpmod_mp_factor_dmg 0.25}
	{VARIABLE uws_xpmod_dmg_factor_hp 1.2}
	{VARIABLE uws_xpmod_dmg_factor_dmg 0.4}
	{VARIABLE uws_xpmod_strike_factor_hp 0.03}
	{VARIABLE uws_xpmod_strike_factor_dmg 1.2}
	[if]
		[variable]
			name=sides[$calculate_handicap_for|].enable_expanded_xpmod_rules
			boolean_equals=yes
		[/variable]
		[then]
			[store_unit]
				[filter]
					side=$calculate_handicap_for
				[/filter]
				mode=always_clear
				variable=uws_expanded_xp_mod_units
			[/store_unit]
			
			[foreach]
				array=uws_expanded_xp_mod_units
				variable=uws_unit
				readonly=yes
				
				[do]
					{VARIABLE unit_kills_count $uws_unit.variables.kills}
					{VARIABLE_OP unit_kills_count sub 50}
					{VARIABLE_OP unit_kills_count divide 15}
					{VARIABLE_OP unit_kills_count round floor}
					
					[if]
						[variable]
							name=unit_kills_count
							greater_than=0
						[/variable]
						[then]
							{VARIABLE power_factor "$((1.0 * $unit_kills_count) ^ 1.4)"}
							{VARIABLE_OP uws_xpmod_hp_factor add "$(0.02 * $power_factor)"}
							{VARIABLE_OP uws_xpmod_mp_factor_hp add "$(0.004 * $unit_kills_count)"} # unit kills on purpose
							{VARIABLE_OP uws_xpmod_mp_factor_dmg add "$(0.01 * $power_factor)"}
							{VARIABLE_OP uws_xpmod_dmg_factor_hp add "$(0.06 * $power_factor)"}
							{VARIABLE_OP uws_xpmod_dmg_factor_dmg add "$(0.02 * $power_factor)"}
							{VARIABLE_OP uws_xpmod_strike_factor_hp sub "$(0.002 * $power_factor)"}
							{VARIABLE_OP uws_xpmod_strike_factor_dmg add "$(0.05 * $power_factor)"}
						[/then]
					[/if]
				[/do]
			[/foreach]
			
			{CLEAR_VARIABLE uws_expanded_xp_mod_units}
		[/then]
	[/if]
#enddef


#define SPAWN_SET_VARIABLES
	{VARIABLE spawn_x $spawn_queue[$j].x}
	{VARIABLE spawn_type $spawn_queue[$j].type}
	{VARIABLE spawn_side $spawn_queue[$j].side}
	{VARIABLE spawn_guard $spawn_queue[$j].guard}
	{VARIABLE spawn_moves $spawn_queue[$j].moves}
	{VARIABLE spawn_buff $spawn_queue[$j].buff}
	{VARIABLE spawn_second_buff $spawn_queue[$j].second_buff}
	{VARIABLE spawn_quiet_buff $spawn_queue[$j].quiet_buff}
	{VARIABLE spawn_item $spawn_queue[$j].item}
	{VARIABLE spawn_second_item $spawn_queue[$j].second_item}
	{VARIABLE spawn_gold $spawn_queue[$j].gold}
	{VARIABLE spawn_recruits $spawn_queue[$j].recruits}
	{VARIABLE spawn_recruitment_gold $spawn_queue[$j].recruitment_gold}
	{VARIABLE spawn_bulky $spawn_queue[$j].bulky}
	{VARIABLE spawn_beefy $spawn_queue[$j].beefy}
	{VARIABLE spawn_damaged $spawn_queue[$j].damaged}
	{VARIABLE spawn_final_boss $spawn_queue[$j].final_boss}
	{VARIABLE spawn_event $spawn_queue[$j].event}
	{VARIABLE spawn_second_random $spawn_queue[$j].second_random}
	{VARIABLE spawn_name $spawn_queue[$j].name}
	{VARIABLE spawn_second_name $spawn_queue[$j].second_name}
	{VARIABLE spawn_disallow_slash_unguardian $spawn_queue[$j].disallow_slash_unguardian}
	{VARIABLE spawn_calls_for_help $spawn_queue[$j].calls_for_help}
	{VARIABLE spawn_armored $spawn_queue[$j].armored}
	{VARIABLE spawn_recruit_armored $spawn_queue[$j].recruit_armored}
	{VARIABLE spawn_recruit_minion $spawn_queue[$j].recruit_minion}
	{VARIABLE spawn_fast $spawn_queue[$j].fast}
	{VARIABLE spawn_agile $spawn_queue[$j].agile}
	{VARIABLE spawn_story_message $spawn_queue[$j].story_message}
	{VARIABLE spawn_story_response $spawn_queue[$j].story_response}
	{VARIABLE spawn_race_points_value $spawn_queue[$j].race_points_value}
#enddef

