#define UWS_VERSION
2.6.0#enddef

#define MOD_SETTINGS EXP
	{MORNING}
	{AFTERNOON}
	{DUSK}
	{FIRST_WATCH}
	{SECOND_WATCH}
	{DAWN}

	{DEFAULT_MUSIC_PLAYLIST}

	turns="-1"
	experience_modifier={EXP}%

	victory_when_enemies_defeated=yes
	random_start_time=no
	force_modification="plan_unit_advance"
	require_scenario=yes
#enddef

#define MOD_DESCRIPTION
    description="Run away from the lava. Fight through various types of environment against number of enemies.

Good luck and have fun!
quequo"
#enddef

#define GAME_OPTION_CHECKBOX ID DEFAULT NAME DESC
	[checkbox]
		id={ID}
		default={DEFAULT}
		name={NAME}
		description={DESC}
	[/checkbox]
#enddef

#define RESET_GOLD
	[for]
		variable=i
		start=8
		end=9
		step=1
		[do]
			[store_gold]
				side=$i
				variable=gold
			[/store_gold]
			[set_variable]
				name=gold
				multiply=-1
			[/set_variable]
			[gold]
				side=$i
				amount=$gold
			[/gold]
		[/do]
	[/for]
#enddef

#define RESET_GOLD_FOR_SIDE_IF_NEGATIVE SIDE
	[store_gold]
		side={SIDE}
		variable=gold
	[/store_gold]

	[if]
		[variable]
			name=gold
			less_than=0
		[/variable]
		[then]
			[set_variable]
				name=gold
				multiply=-1
			[/set_variable]
			[gold]
				side={SIDE}
				amount=$gold
			[/gold]
		[/then]
	[/if]
#enddef

#define SET_GOLD_FOR_SIDE SIDE GOLD
	[store_gold]
		side={SIDE}
		variable=gold
	[/store_gold]
	[set_variable]
		name=gold
		multiply=-1
	[/set_variable]
	[gold]
		side={SIDE}
		amount=$gold
	[/gold]
	[gold]
		side={SIDE}
		amount={GOLD}
	[/gold]
#enddef

#define TIP_OF_THE_DAY
	[lua]
		name=tip_of_the_day
	    code = <<
	    	local game_mode = wml.variables['uws_game.mode']
	    	local is_pvp = wml.variables['uws_game.is_pvp']
	    	local is_campaign = wml.variables['uws_game.is_campaign']
	    	
		local tips = {
			"Did you know that UWS supports many eras? Supported eras include Default, Ageless, WotG, RoL and EoMa.",
			"Slow, Plague, Berserk - these go a long way in UWS.",
			"Right click menu -> UWS game info for extra information about the game and the mod.",
			"Pay attention to your promotion ranks when picking up items. Remember, the higher the rank - the stronger the item.",
			"Good luck, have fun and enjoy :)",
			"Scroll, Race, Hack'n Slash, After-Classic - UWS is a map pack with a multitude of game modes and options to craft your perfect game!",
			"All your units level 2 and higher benefit from the UWS AMLA. Each unit gets a different selection of bonuses available depending on the unit's traits, race, attacks and base abilities."
		}
		
		if game_mode ~= 'after_classic' then
			table.insert(tips, "There are 4 available difficulty levels for each game. Make sure that whatever you choose, it is fun to play!")
		end
		
		if game_mode == 'slash' then
			table.insert(tips, "When playing cooperative Hack'n Slash, cooperation and communication should be at the core of your strategy. Especially at hardcore difficulty.")
		end
		
		if is_pvp == false then
			table.insert(tips, "Although UWS is meant to be played by 2 players, playing solo also is supported. Just set the other player to none when starting a new game.")
			
			if is_campaign == false then
				table.insert(tips, "Did you know there is a UWS campaign that can be played as one or two players? Check out multiplayer campaigns dropdown option when hosting a new game.")
			end
		end
		
		local tip = mathx.random_choice(tips)
		wesnoth.interface.add_chat_message("Tip of the Day", tip)
	    >>
	[/lua]
#enddef

#define INIT_NEW_GAME
	{VARIABLE uws_game.version {UWS_VERSION}}
	{VARIABLE is_single_high_point_cutoff no}
	{VARIABLE current_era_id ""}
	
	[fire_event]
		name=uws_handle_xp_mod
	[/fire_event]
	
	{RANDOM_DEFINITIONS}
	{ENABLED_ERA_CHECKER}
	{DEFINE_RANDOM_POOL}
	
	{RESET_GOLD}
#enddef

#define INIT_CAMPAIGN_SCENARIO
	{VARIABLE is_single_high_point_cutoff no}
	[fire_event]
		name=uws_handle_xp_mod
	[/fire_event]
	
	[if]
		[variable]
			name=sides[8].is_alive
			boolean_equals=yes
		[/variable]
		[then]
			[if]
				[variable]
					name=sides[8].recruits
					not_equals=""
				[/variable]
				[then]
					[modify_side]
						side=8
						recruit=$sides[8].recruits
					[/modify_side]
				[/then]
			[/if]
		[/then]
		[else]
			[kill]
				side=8
				fire_event=no
			[/kill]
			
			[modify_side]
				side=8
				controller=null
			[/modify_side]
		[/else]
	[/if]
	
	
	[if]
		[variable]
			name=sides[9].is_alive
			boolean_equals=yes
		[/variable]
		[then]
			[modify_side]
				side=9
				recruit=$sides[9].recruits
			[/modify_side]
		[/then]
		[else]
			[kill]
				side=9
				fire_event=no
			[/kill]
			
			[modify_side]
				side=9
				controller=null
			[/modify_side]
		[/else]
	[/if]
#enddef

#define POST_INIT_NEW_GAME
	{INIT_ITEMS_DATA}
	
	[if]
		[variable]
			name=uws_game.spawn_hidden_leaders
			boolean_equals=yes
		[/variable]
		[then]
			{CREATE_PLACEHOLDER_LEADER 1}
			[capture_village]
				side=1
				fire_event=no
				owner_side=0
			[/capture_village]
		[/then]
	[/if]
	
	{VARIABLE all_opponents_names ""}
	{VARIABLE all_opponents_glue ""}
	[for]
		variable=i
		start=9
		end=8
		step=-1
		[do]
			[gold]
				side=$i
				amount=$uws_game.starting_gold
			[/gold]
			
			[if]
				[variable]
					name=sides[$i|].is_present
					boolean_equals=yes
				[/variable]
				[then]
					{VARIABLE all_opponents_names "$all_opponents_names|$all_opponents_glue|$sides[$i|].leader_name|"}
					{VARIABLE all_opponents_glue " and "}
				[/then]
			[/if]
		[/do]
	[/for]
	
	[if]
		[variable]
			name=uws_game.process_spawn_table
			boolean_equals=yes
		[/variable]
		[then]
			[lua]
		    		code=<<
					wesnoth.dofile("~add-ons/QQ_Ultimate_Wesnoth_Survival/lua/spawn.lua")
				>>
			[/lua]
		[/then]
	[/if]
	
	[fire_event]
		name=register_custom_scenario_events
	[/fire_event]
	
	[fire_event]
		name=register_required_item_events
	[/fire_event]
#enddef

#define GENERATE_RANK_RELATED_VARIABLES
	{VARIABLE threshold_initiated $uws_game.threshold_initiated}
	{VARIABLE threshold_proven $uws_game.threshold_proven}
	{VARIABLE threshold_notable $uws_game.threshold_notable}
	{VARIABLE threshold_significant $uws_game.threshold_significant}
	{VARIABLE threshold_epic $uws_game.threshold_epic}
	
	{VARIABLE under_initiated $threshold_initiated}
	{VARIABLE under_proven $threshold_proven}
	{VARIABLE under_notable $threshold_notable}
	{VARIABLE under_significant $threshold_significant}
	{VARIABLE under_epic $threshold_epic}
	{VARIABLE_OP under_initiated sub 1}
	{VARIABLE_OP under_proven sub 1}
	{VARIABLE_OP under_notable sub 1}
	{VARIABLE_OP under_significant sub 1}
	{VARIABLE_OP under_epic sub 1}
	
	{VARIABLE rank_none_color "#ffffff"}
	{VARIABLE rank_initiated_color "#66e3bb"}
	{VARIABLE rank_proven_color "#738ef0"}
	{VARIABLE rank_notable_color "#c85ce6"}
	{VARIABLE rank_significant_color "#eb4646"}
	{VARIABLE rank_epic_color "#eb1c53"}
	
	{VARIABLE band_none_text "<span color='$rank_none_color'>0 - $under_initiated kills</span>:"}
	{VARIABLE band_initiated_text "<span color='$rank_initiated_color'>$threshold_initiated - $under_proven kills</span>:"}
	{VARIABLE band_proven_text "<span color='$rank_proven_color'>$threshold_proven - $under_notable kills</span>:"}
	{VARIABLE band_notable_text "<span color='$rank_notable_color'>$threshold_notable - $under_significant kills</span>:"}
	{VARIABLE band_significant_text "<span color='$rank_significant_color'>$threshold_significant - $under_epic kills</span>:"}
	{VARIABLE band_epic_text "<span color='$rank_epic_color'>$threshold_epic|+ kills</span>:"}
#enddef

#define REMOVE_SHROUD_AROUND X Y
	{VARIABLE x_from {X}}
	{VARIABLE x_to {X}}
	{VARIABLE_OP x_from sub 1}
	{VARIABLE_OP x_to add 1}
	
	{VARIABLE y_from {Y}}
	{VARIABLE y_to {Y}}
	{VARIABLE_OP y_from sub 1}
	{VARIABLE_OP y_to add 1}
	
	[remove_shroud]
        	[filter_side]
        		side=$uws_game.filter_human_sides
        	[/filter_side]
        	
        	x=$x_from|-$x_to
        	y=$y_from|-$y_to
        [/remove_shroud]
#enddef

#define TELEPORT_LEADER SIDE X Y
	[if]
		[have_unit]
			side={SIDE}
			can_recruit=yes
		[/have_unit]
		[then]
			[store_unit]
				variable=leader_unit
				kill=yes
				[filter]
					side={SIDE}
					canrecruit=yes
				[/filter]
			[/store_unit]
			[unstore_unit]
				variable=leader_unit
				x,y={X},{Y}
			[/unstore_unit]
			
			{VARIABLE sides[{SIDE}].race_high_point {Y}}
		[/then]
	[/if]
#enddef

#define PLACE_OBJECTS_ON_MAP
	[for]
		variable=i
		array=scrollable_items
		
		[do]
			[if]
				[variable]
					name=scrollable_items[$i].image
					not_equals=""
				[/variable]
				[then]
					[fire_event]
						name=render_item_on_map
					[/fire_event]
				[/then]
			[/if]
		[/do]
	[/for]
#enddef

#define UNSYNC_INFO_MENU_ITEM
	[set_menu_item]
		id=uws_info_menu_item
		description="UWS game info"
		image="uws_menuitem_1.png"
		synced=no
		[command]
			{VARIABLE menu_location "menu"}
			[while]
				[variable]
					name=menu_location
					not_equals=end
				[/variable]
				[do]
					[switch]
						variable=menu_location
						[case]
							value=menu
							
							[message]
								caption="Ultimate Wesnoth Survival v$uws_game.version"
								image="portraits/monsters/young-ogre.png"
								message="$game_info_data|$qq_rb.game_info_data"
								
								[option]
									label="Ancient Book of Secret Artifacts"
									[command]
										{VARIABLE menu_location "items"}
									[/command]
								[/option]
								[option]
									label="Credits"
									[command]
										{VARIABLE menu_location "credits"}
									[/command]
								[/option]
								[option]
									label="Changelog"
									[command]
										{VARIABLE menu_location "changelog"}
									[/command]
								[/option]
								[option]
									label="Done"
									[command]
										{VARIABLE menu_location "end"}
									[/command]
								[/option]
							[/message]
						[/case]
						
						[case]
							value=items
							
							[message]
								speaker=narrator
								caption="Ultimate Wesnoth Survival v$uws_game.version"
								image=portraits/uws/elf-mystic.png
								message="Here comes the list of all 42 items that can be found in the game."
								
								[option]
									label="Back"
									[command]
										{VARIABLE menu_location "menu"}
									[/command]
								[/option]
								[option]
									label="Done"
									[command]
										{VARIABLE menu_location "end"}
									[/command]
								[/option]
								[option]
									label=$items_steps[1].hp_low
									image=$items_steps[3].hp_low
									message=$items_steps[5].hp_low
									[command]
										{VARIABLE menu_location "hp_low"}
									[/command]
								[/option]
								[option]
									label=$items_steps[1].hp_med
									image=$items_steps[3].hp_med
									message=$items_steps[5].hp_med
									[command]
										{VARIABLE menu_location "hp_med"}
									[/command]
								[/option]
								[option]
									label=$items_steps[1].hp_high
									image=$items_steps[3].hp_high
									message=$items_steps[5].hp_high
									[command]
										{VARIABLE menu_location "hp_high"}
									[/command]
								[/option]
								[option]
									label=$items_steps[1].arcane_res
									image=$items_steps[3].arcane_res
									message=$items_steps[5].arcane_res
									[command]
										{VARIABLE menu_location "arcane_res"}
									[/command]
								[/option]
								[option]
									label=$items_steps[1].cold_res
									image=$items_steps[3].cold_res
									message=$items_steps[5].cold_res
									[command]
										{VARIABLE menu_location "cold_res"}
									[/command]
								[/option]
								[option]
									label=$items_steps[1].fire_res
									image=$items_steps[3].fire_res
									message=$items_steps[5].fire_res
									[command]
										{VARIABLE menu_location "fire_res"}
									[/command]
								[/option]
								[option]
									label=$items_steps[1].blade_res
									image=$items_steps[3].blade_res
									message=$items_steps[5].blade_res
									[command]
										{VARIABLE menu_location "blade_res"}
									[/command]
								[/option]
								[option]
									label=$items_steps[1].impact_res
									image=$items_steps[3].impact_res
									message=$items_steps[5].impact_res
									[command]
										{VARIABLE menu_location "impact_res"}
									[/command]
								[/option]
								[option]
									label=$items_steps[1].pierce_res
									image=$items_steps[3].pierce_res
									message=$items_steps[5].pierce_res
									[command]
										{VARIABLE menu_location "pierce_res"}
									[/command]
								[/option]
								[option]
									label=$items_steps[1].magic_res
									image=$items_steps[3].magic_res
									message=$items_steps[5].magic_res
									[command]
										{VARIABLE menu_location "magic_res"}
									[/command]
								[/option]
								[option]
									label=$items_steps[1].phys_res
									image=$items_steps[3].phys_res
									message=$items_steps[5].phys_res
									[command]
										{VARIABLE menu_location "phys_res"}
									[/command]
								[/option]
								[option]
									label=$items_steps[1].golden_armor
									image=$items_steps[3].golden_armor
									message=$items_steps[5].golden_armor
									[command]
										{VARIABLE menu_location "golden_armor"}
									[/command]
								[/option]
								[option]
									label=$items_steps[1].dragon_protection
									image=$items_steps[3].dragon_protection
									message=$items_steps[5].dragon_protection
									[command]
										{VARIABLE menu_location "dragon_protection"}
									[/command]
								[/option]
								[option]
									label=$items_steps[1].protection
									image=$items_steps[3].protection
									message=$items_steps[5].protection
									[command]
										{VARIABLE menu_location "protection"}
									[/command]
								[/option]
								[option]
									label=$items_steps[1].steadfast
									image=$items_steps[3].steadfast
									message=$items_steps[5].steadfast
									[command]
										{VARIABLE menu_location "steadfast"}
									[/command]
								[/option]
								[option]
									label=$items_steps[1].heal
									image=$items_steps[3].heal
									message=$items_steps[5].heal
									[command]
										{VARIABLE menu_location "heal"}
									[/command]
								[/option]
								[option]
									label=$items_steps[1].regen
									image=$items_steps[3].regen
									message=$items_steps[5].regen
									[command]
										{VARIABLE menu_location "regen"}
									[/command]
								[/option]
								[option]
									label=$items_steps[1].leadership
									image=$items_steps[3].leadership
									message=$items_steps[5].leadership
									[command]
										{VARIABLE menu_location "leadership"}
									[/command]
								[/option]
								[option]
									label=$items_steps[1].burns
									image=$items_steps[3].burns
									message=$items_steps[5].burns
									[command]
										{VARIABLE menu_location "burns"}
									[/command]
								[/option]
								[option]
									label=$items_steps[1].fear
									image=$items_steps[3].fear
									message=$items_steps[5].fear
									[command]
										{VARIABLE menu_location "fear"}
									[/command]
								[/option]
								[option]
									label=$items_steps[1].icewind_aura
									image=$items_steps[3].icewind_aura
									message=$items_steps[5].icewind_aura
									[command]
										{VARIABLE menu_location "icewind_aura"}
									[/command]
								[/option]
								[option]
									label=$items_steps[1].field_disruption
									image=$items_steps[3].field_disruption
									message=$items_steps[5].field_disruption
									[command]
										{VARIABLE menu_location "field_disruption"}
									[/command]
								[/option]
								[option]
									label=$items_steps[1].book
									image=$items_steps[3].book
									message=$items_steps[5].book
									[command]
										{VARIABLE menu_location "book"}
									[/command]
								[/option]
								[option]
									label=$items_steps[1].feeding
									image=$items_steps[3].feeding
									message=$items_steps[5].feeding
									[command]
										{VARIABLE menu_location "feeding"}
									[/command]
								[/option]
								[option]
									label=$items_steps[1].defense
									image=$items_steps[3].defense
									message=$items_steps[5].defense
									[command]
										{VARIABLE menu_location "defense"}
									[/command]
								[/option]
								[option]
									label=$items_steps[1].mp
									image=$items_steps[3].mp
									message=$items_steps[5].mp
									[command]
										{VARIABLE menu_location "mp"}
									[/command]
								[/option]
								[option]
									label=$items_steps[1].skirm
									image=$items_steps[3].skirm
									message=$items_steps[5].skirm
									[command]
										{VARIABLE menu_location "skirm"}
									[/command]
								[/option]
								[option]
									label=$items_steps[1].rat_pack
									image=$items_steps[3].rat_pack
									message=$items_steps[5].rat_pack
									[command]
										{VARIABLE menu_location "rat_pack"}
									[/command]
								[/option]
								[option]
									label=$items_steps[1].hitn_run
									image=$items_steps[3].hitn_run
									message=$items_steps[5].hitn_run
									[command]
										{VARIABLE menu_location "hitn_run"}
									[/command]
								[/option]
								[option]
									label=$items_steps[1].extra_strikes
									image=$items_steps[3].extra_strikes
									message=$items_steps[5].extra_strikes
									[command]
										{VARIABLE menu_location "extra_strikes"}
									[/command]
								[/option]
								[option]
									label=$items_steps[1].melee_dmg
									image=$items_steps[3].melee_dmg
									message=$items_steps[5].melee_dmg
									[command]
										{VARIABLE menu_location "melee_dmg"}
									[/command]
								[/option]
								[option]
									label=$items_steps[1].melee_parry
									image=$items_steps[3].melee_parry
									message=$items_steps[5].melee_parry
									[command]
										{VARIABLE menu_location "melee_parry"}
									[/command]
								[/option]
								[option]
									label=$items_steps[1].melee_poison
									image=$items_steps[3].melee_poison
									message=$items_steps[5].melee_poison
									[command]
										{VARIABLE menu_location "melee_poison"}
									[/command]
								[/option]
								[option]
									label=$items_steps[1].melee_slow
									image=$items_steps[3].melee_slow
									message=$items_steps[5].melee_slow
									[command]
										{VARIABLE menu_location "melee_slow"}
									[/command]
								[/option]
								[option]
									label=$items_steps[1].freezing_gem
									image=$items_steps[3].freezing_gem
									message=$items_steps[5].freezing_gem
									[command]
										{VARIABLE menu_location "freezing_gem"}
									[/command]
								[/option]
								[option]
									label=$items_steps[1].armor_destruction
									image=$items_steps[3].armor_destruction
									message=$items_steps[5].armor_destruction
									[command]
										{VARIABLE menu_location "armor_destruction"}
									[/command]
								[/option]
								[option]
									label=$items_steps[1].first_strike
									image=$items_steps[3].first_strike
									message=$items_steps[5].first_strike
									[command]
										{VARIABLE menu_location "first_strike"}
									[/command]
								[/option]
								[option]
									label=$items_steps[1].discouragement
									image=$items_steps[3].discouragement
									message=$items_steps[5].discouragement
									[command]
										{VARIABLE menu_location "discouragement"}
									[/command]
								[/option]
								[option]
									label=$items_steps[1].ranged_dmg
									image=$items_steps[3].ranged_dmg
									message=$items_steps[5].ranged_dmg
									[command]
										{VARIABLE menu_location "ranged_dmg"}
									[/command]
								[/option]
								[option]
									label=$items_steps[1].ranged_acc
									image=$items_steps[3].ranged_acc
									message=$items_steps[5].ranged_acc
									[command]
										{VARIABLE menu_location "ranged_acc"}
									[/command]
								[/option]
								[option]
									label=$items_steps[1].double_attack
									image=$items_steps[3].double_attack
									message=$items_steps[5].double_attack
									[command]
										{VARIABLE menu_location "double_attack"}
									[/command]
								[/option]
								[option]
									label=$items_steps[1].drain
									image=$items_steps[3].drain
									message=$items_steps[5].drain
									[command]
										{VARIABLE menu_location "drain"}
									[/command]
								[/option]
							[/message]
						[/case]
						
						[case]
							value=credits
							
							[message]
								speaker=narrator
								caption="Ultimate Wesnoth Survival v$uws_game.version"
								image=portraits/goblins/impaler.png
								message="Mod created by quequo, based on earlier development of Ageless Scrolling Survival and Arena Survival also by quequo.
				
Ageless Scrolling Survival was based on earlier The Scrolling Survival created by krotop, EPillager, Jason back in Wesnoth 1.6 around 2010 (or maybe even earlier?)

Dimaga Beach map and mod idea is from Valley of the Ancients map pack by trewe.

PvP mod idea is based on the Afterlife mod by vasili.

Some sprites for lvl5+ enemies, items, portraits and halos were borrowed from other addons, including but not limited to Era of Magic, War of the Gods, War of Legends, Reign of Lords and SXRPG.

Big shoutout to IPS, MasterChi3f, Rudko44, zen-cat, mmmax, Pferd and Beniowski and others for helping with testing and balancing the map.

And of course this addon would not have been possible if not for the work of all Battle for Wesnoth developers."
								
								[option]
									label="Back"
									[command]
										{VARIABLE menu_location "menu"}
									[/command]
								[/option]
								[option]
									label="Done"
									[command]
										{VARIABLE menu_location "end"}
									[/command]
								[/option]
							[/message]
						[/case]

						[case]
							value=changelog
							
							[message]
								speaker=narrator
								caption="Ultimate Wesnoth Survival v$uws_game.version"
								image=portraits/monsters/jumping-spider.webp
								message="{~add-ons/QQ_Ultimate_Wesnoth_Survival/changelog/current.txt}"
								
								[option]
									label="Changelog 2.6.x"
									[command]
										{VARIABLE menu_location "clog_2_6"}
									[/command]
								[/option]
								[option]
									label="Changelog 2.5.x"
									[command]
										{VARIABLE menu_location "clog_2_5"}
									[/command]
								[/option]
								[option]
									label="Back"
									[command]
										{VARIABLE menu_location "menu"}
									[/command]
								[/option]
								[option]
									label="Done"
									[command]
										{VARIABLE menu_location "end"}
									[/command]
								[/option]
							[/message]
						[/case]

						[case]
							value=clog_2_5
							
							[message]
								speaker=narrator
								caption="Ultimate Wesnoth Survival 2.5.x changelog"
								image=portraits/merfolk/hunter.webp
								message="{~add-ons/QQ_Ultimate_Wesnoth_Survival/changelog/v2.5.txt}"
								
								[option]
									label="Back"
									[command]
										{VARIABLE menu_location "changelog"}
									[/command]
								[/option]
								[option]
									label="Done"
									[command]
										{VARIABLE menu_location "end"}
									[/command]
								[/option]
							[/message]
						[/case]

						[case]
							value=clog_2_6
							
							[message]
								speaker=narrator
								caption="Ultimate Wesnoth Survival 2.6.x changelog"
								image=portraits/goblins/impaler.webp
								message="{~add-ons/QQ_Ultimate_Wesnoth_Survival/changelog/v2.6.txt}"
								
								[option]
									label="Back"
									[command]
										{VARIABLE menu_location "changelog"}
									[/command]
								[/option]
								[option]
									label="Done"
									[command]
										{VARIABLE menu_location "end"}
									[/command]
								[/option]
							[/message]
						[/case]
						
						[else]
							[message]
								speaker=narrator
								caption=$items_steps[1].$menu_location
								image=$items_steps[3].$menu_location
								message="$items_steps[4].$menu_location

$items_steps[6].$menu_location"
								
								[option]
									label="Back to Items"
									[command]
										{VARIABLE menu_location "items"}
									[/command]
								[/option]
								[option]
									label="Done"
									[command]
										{VARIABLE menu_location "end"}
									[/command]
								[/option]
							[/message]
						[/else]
					[/switch]
				[/do]
			[/while]
		[/command]
	[/set_menu_item]

	[set_menu_item]
		id=uws_player_info_menu_item
		description="UWS player info"
		image="uws_menuitem_2.png"
		synced=no
		[show_if]
			[have_unit]
				x,y=$x1,$y1
				side=$uws_game.filter_human_sides
			[/have_unit]
		[/show_if]
		[command]
			[store_unit]
				variable=selected_unit
				kill=no
				[filter]
					x,y=$x1,$y1
				[/filter]
			[/store_unit]

			{VARIABLE message_caption $sides[$selected_unit.side].side_name}
			{VARIABLE player_info_message "Enemies killed: $sides[$selected_unit.side].kills
Units lost: $sides[$selected_unit.side].lost_recruited recruited, $sides[$selected_unit.side].lost_all in total"}

			[store_unit]
				variable=side_leader
				kill=no
				[filter]
					side=$selected_unit.side
					canrecruit=yes
				[/filter]
			[/store_unit]

			[store_unit_type]
				variable=side_leader_type
				mode=always_clear
				type=$side_leader.type
			[/store_unit_type]

			[if]
				[variable]
					name=side_leader.profile
					not_equals=""
				[/variable]
				[then]
					{VARIABLE side_leader_image $side_leader_type.profile}
				[/then]
				[else]
					{VARIABLE side_leader_image $side_leader_type.image}
				[/else]
			[/if]

			[store_unit]
				variable=all_player_units
				kill=no
				[filter]
					side=$selected_unit.side
				[/filter]
			[/store_unit]

			[set_variables]
				name=player_units_table
				mode=replace
			[/set_variables]

			[for]
				variable=i
				array=all_player_units
				[do]
					[store_unit_type]
						variable=selected_unit_type
						mode=always_clear
						type=$all_player_units[$i].type
					[/store_unit_type]
					{VARIABLE player_units_table[$i].id $all_player_units[$i].id}
					{VARIABLE player_units_table[$i].name $all_player_units[$i].name}
					{VARIABLE player_units_table[$i].level $all_player_units[$i].level}
					{VARIABLE player_units_table[$i].exp $all_player_units[$i].experience}
					{VARIABLE player_units_table[$i].max_exp $all_player_units[$i].max_experience}
					{VARIABLE player_units_table[$i].exp_fraction $all_player_units[$i].experience}
					{VARIABLE_OP player_units_table[$i].exp_fraction divide $all_player_units[$i].max_experience}
					{VARIABLE player_units_table[$i].x $all_player_units[$i].x}
					{VARIABLE player_units_table[$i].y $all_player_units[$i].y}
					{VARIABLE player_units_table[$i].type_name $selected_unit_type.name}
					{VARIABLE player_units_table[$i].image $selected_unit_type.image}
					{VARIABLE player_units_table[$i].xp_mod_info ""}

					[if]
						[variable]
							name=all_player_units[$i].name
							equals=""
						[/variable]
						[then]
							{VARIABLE player_units_table[$i].display_name "Nameless $selected_unit_type.name"}
						[/then]
						[else]
							{VARIABLE player_units_table[$i].display_name "$all_player_units[$i].name the $selected_unit_type.name"}
						[/else]
					[/if]

					{VARIABLE player_units_table[$i].kills 0}
					[if]
						[variable]
							name=all_player_units[$i].variables.kills
							greater_than=0
						[/variable]
						[then]
							{VARIABLE player_units_table[$i].kills $all_player_units[$i].variables.kills}
						[/then]
					[/if]

					{VARIABLE display_rank_info no}
					{VARIABLE rank_info ""}
					[fire_event]
						name=generate_promotion_rank_variables
						[primary_unit]
							id=$all_player_units[$i].id
						[/primary_unit]
					[/fire_event]

					{VARIABLE player_units_table[$i].rank "<span color='$promotion_colour'>$promotion_label</span>"}
					{VARIABLE player_units_table[$i].items $unit_items_names}

					{VARIABLE xp_mod_use_info ""}
					[if]
						[variable]
							name=all_player_units[$i].variables.xp_mod_hp
							not_equals=""
						[/variable]
						[then]
							{VARIABLE xp_mod_amount $all_player_units[$i].variables.xp_mod_hp}
							{VARIABLE_OP xp_mod_amount multiply 4}
							{VARIABLE xp_mod_use_info "$xp_mod_use_info +$xp_mod_amount|hp"}
						[/then]
					[/if]

					[if]
						[variable]
							name=all_player_units[$i].variables.xp_mod_mp
							not_equals=""
						[/variable]
						[then]
							{VARIABLE xp_mod_amount $all_player_units[$i].variables.xp_mod_mp}
							{VARIABLE xp_mod_use_info "$xp_mod_use_info +$xp_mod_amount|mp"}
						[/then]
					[/if]

					[if]
						[variable]
							name=all_player_units[$i].variables.xp_mod_dmg
							not_equals=""
						[/variable]
						[then]
							{VARIABLE xp_mod_amount $all_player_units[$i].variables.xp_mod_dmg}
							{VARIABLE xp_mod_use_info "$xp_mod_use_info +$xp_mod_amount|dmg"}
						[/then]
					[/if]

					[if]
						[variable]
							name=all_player_units[$i].variables.xp_mod_str
							not_equals=""
						[/variable]
						[then]
							{VARIABLE xp_mod_amount $all_player_units[$i].variables.xp_mod_str}
							{VARIABLE xp_mod_use_info "$xp_mod_use_info +$xp_mod_amount|str"}
						[/then]
					[/if]

					[if]
						[variable]
							name=xp_mod_use_info
							not_equals=""
						[/variable]
						[then]
							{VARIABLE player_units_table[$i].xp_mod_info "
<span color='#c8a5cf'>xp mod</span>: $xp_mod_use_info"}
						[/then]
					[/if]
				[/do]
			[/for]

			{CLEAR_VARIABLE selected_unit_type,all_player_units,selected_unit,side_leader,side_leader_type}

			[lua]
				name=uws_player_info_helper
			    code = <<
			    	local units = wml.array_access.get('player_units_table')
					table.sort(units, function(a, b) return a['kills'] > b['kills'] end)
					wml.array_access.set('player_units_table', units)
			    >>
			[/lua]

			[set_variables]
				name=message_tag_info
				mode=replace
				[value]
					caption="$message_caption|'s units"
					image=$side_leader_image
					message="$player_info_message
(double click on unit to select it in the map)"
					[option]
						label="Exit"
						message=""
						[command]
						[/command]
					[/option]
				[/value]
			[/set_variables]

			[for]
				variable=i
				array=player_units_table
				[do]
					{VARIABLE exp_color "#a2d2eb"}
					[if]
						[variable]
							name=player_units_table[$i].exp_fraction
							greater_than=0.7499
						[/variable]
						[then]
							[if]
								[variable]
									name=player_units_table[$i].exp_fraction
									greater_than=0.899
								[/variable]
								[then]
									{VARIABLE exp_color "#7e39cc"}
								[/then]
								[else]
									{VARIABLE exp_color "#3f7fd9"}
								[/else]
							[/if]
						[/then]
					[/if]

					{VARIABLE j "$( $i + 1 )"}
					{VARIABLE message_tag_info[0].option[$j].label "$player_units_table[$i].display_name
Level: $player_units_table[$i].level (<span color='$exp_color'>$player_units_table[$i].exp|/$player_units_table[$i].max_exp</span>)
<span size='small'>[$player_units_table[$i].x, $player_units_table[$i].y]</span>"}
					{VARIABLE message_tag_info[0].option[$j].message "Kills: $player_units_table[$i].kills
Rank: $player_units_table[$i].rank"}
					{VARIABLE message_tag_info[0].option[$j].image $player_units_table[$i].image}
					{VARIABLE message_tag_info[0].option[$j].command.select_unit.id $player_units_table[$i].id}

					[if]
						[variable]
							name=player_units_table[$i].items
							not_equals=""
						[/variable]
						[then]
							{VARIABLE message_tag_info[0].option[$j].message "$message_tag_info[0].option[$j].message
Items: <span color='#83c25f'>$player_units_table[$i].items</span>"}
						[/then]
					[/if]

					{VARIABLE message_tag_info[0].option[$j].message "$message_tag_info[0].option[$j].message|$player_units_table[$i].xp_mod_info"}
				[/do]
			[/for]

			[insert_tag]
				name=message
				variable=message_tag_info
			[/insert_tag]
		[/command]
	[/set_menu_item]
#enddef

#define STORE_SIDE_RECRUITS SIDE RECRUITS_VAR
	[store_side]
		side={SIDE}
		variable=stored_side
		mode=always_clear
	[/store_side]
	
	{VARIABLE {RECRUITS_VAR} $stored_side.recruit}
#enddef

#define RACE_RESTRICT_AI_MOVEMENT
	{VARIABLE map_middle_east "$( $uws_game.middle + 1 )"}
	{VARIABLE map_middle_west "$( $uws_game.middle - 1 )"}
	{VARIABLE map_cutoff $uws_game.race_make_players_opponents_y}
	
	{RESTRICT_AI_MOVEMENT 2 "$map_middle_east|-99" "$map_cutoff|-99"}
	{RESTRICT_AI_MOVEMENT 3 "$map_middle_east|-99" "$map_cutoff|-99"}
	{RESTRICT_AI_MOVEMENT 4 "$map_middle_east|-99" "$map_cutoff|-99"}
	{RESTRICT_AI_MOVEMENT 5 "2-$map_middle_west" "$map_cutoff|-99"}
	{RESTRICT_AI_MOVEMENT 6 "2-$map_middle_west" "$map_cutoff|-99"}
	{RESTRICT_AI_MOVEMENT 7 "2-$map_middle_west" "$map_cutoff|-99"}
	
	{CLEAR_VARIABLE map_middle_east,map_middle_west,map_cutoff}
#enddef

#define RESTRICT_AI_MOVEMENT SIDE X Y
	[modify_ai]
		side={SIDE}
		action=add
    		path=aspect[avoid].facet[]
		[facet]
			[value]
				x={X}
				y={Y}
			[/value]
		[/facet]
	[/modify_ai]
#enddef

#define TRANSFER_GAME_SETTINGS_TO_GAME_VAR
	[set_variables]
		name=copy_field_names
		mode=replace
		[split]
			list="name,mask_file,scroll_rounds,middle,edge,starting_ax,starting_bx,starting_y,race_start_y,race_finish_y,race_make_players_opponents_y,max_items_per_unit,threshold_initiated,threshold_proven,threshold_notable,threshold_significant,threshold_epic,slash_keep_tile,next_scenario_uws_id,next_scenario_id,final_boss_name,enable_scenario_bonus,scenario_bonus_hp,scenario_bonus_dmg,scenario_bonus_strikes,base_bonus_strength_kval,suid"
			key="k"
			separator=","
		[/split]
	[/set_variables]
	
	[foreach]
		array=copy_field_names
		variable=field_name
		[do]
			{VARIABLE field $field_name.k}
			{VARIABLE uws_game.$field $game_settings[$uws_game.map_id].$field}
		[/do]
	[/foreach]
	
	{CLEAR_VARIABLE copy_field_names,field_name,field,game_settings}
#enddef

#define QQUWS_ARENA_MENUITEMS
	[event]
		name=start

		[set_menu_item]
			id=qquws_buy_surprise
			description="Add to recruitment list (3g)"
			synced=yes
			use_hotkey=no
			[show_if]
				[have_unit]
					x,y=$x1,$y1
					side=9
					level=0-2
				[/have_unit]
			[/show_if]
			[command]
				[store_gold]
					side=$side_number
					variable=current_gold
				[/store_gold]
				
				[if]
					[variable]
						name=current_gold
						greater_than_equal_to=3
					[/variable]
					[then]
						[store_unit]
							variable=selected_unit
							mode=always_clear
							[filter]
								x,y=$x1,$y1
							[/filter]
						[/store_unit]
						
						[gold]
							side=$side_number
							amount=-3
						[/gold]

						[floating_text]
							x,y=$x1,$y1
							text="<span color='#b5803f' size='large'>-3g</span>"
						[/floating_text]
						
						[if]
							[variable]
								name=sides[$side_number|].extra_recruitment
								not_equals=""
							[/variable]
							[then]
								{VARIABLE sides[$side_number|].extra_recruitment "$sides[$side_number|].extra_recruitment|,"}
							[/then]
						[/if]
						
						{VARIABLE sides[$side_number|].extra_recruitment "$sides[$side_number|].extra_recruitment|$selected_unit.type"}
						
						[sync_variable]
							name=sides[$side_number|].extra_recruitment
						[/sync_variable]
						
						[set_extra_recruit]
							side=$side_number
							canrecruit=yes
							extra_recruit=$sides[$side_number|].extra_recruitment
						[/set_extra_recruit]
					[/then]
					[else]
						[message]
						    speaker=narrator
						    caption="The Arbitrator"
						    image="portraits/monsters/piglet.png"
						    side_for=$side_number
						    message="You do not have enough gold"
						[/message]
					[/else]
				[/if]
			[/command]
		[/set_menu_item]

		[set_menu_item]
			id=qquws_recruit_surprise
			description="Recruit as surprise"
			synced=yes
			use_hotkey=no
			[show_if]
				[have_unit]
					x,y=$x1,$y1
					side=9
				[/have_unit]
				[and]
					[variable]
						name=no_of_players_present
						greater_than=1
					[/variable]
				[/and]
			[/show_if]
			[command]
				[store_unit]
					variable=selected_unit
					mode=always_clear
					[filter]
						x,y=$x1,$y1
					[/filter]
				[/store_unit]
				
				[store_unit_type]
					variable=selected_unit_type
					mode=always_clear
					type=$selected_unit[0].type
				[/store_unit_type]

				{GET_SURPRISE_INDEX}

				{VARIABLE surprises_list[$surprise_index].type $selected_unit_type.id}
				{VARIABLE surprises_list[$surprise_index].value $selected_unit_type.cost}
				
				[floating_text]
					x,y=$x1,$y1
					text="<span color='#edf0f7' size='large'>Surprise!</span>"
				[/floating_text]
			[/command]
		[/set_menu_item]
	[/event]
#enddef

#define GET_SURPRISE_INDEX
	{VARIABLE surprise_index $side_number}
	{VARIABLE_OP surprise_index add 1}
	
	[while]
		[variable]
			name=surprise_index
			greater_than=$no_of_players_present
		[/variable]
		[or]
			[variable]
				name=sides[$surprise_index].is_alive
				boolean_equals=no
			[/variable]
		[/or]
		[do]
			{VARIABLE_OP surprise_index add 1}
			[if]
				[variable]
					name=surprise_index
					greater_than=$no_of_players_present
				[/variable]
				[then]
					{VARIABLE surprise_index 1}
				[/then]
			[/if]
		[/do]
	[/while]
#enddef

#define HNS_GIFT_UNIT_MENU_ITEM
	[if]
		[variable]
			name=uws_game.single_player_game
			boolean_equals=no
		[/variable]
		[and]
			[variable]
				name=uws_game.mode
				equals=slash
			[/variable]
		[/and]
		[then]
			[set_menu_item]
				id=qquws_gift_unit
				description="Gift this unit"
				synced=yes
				use_hotkey=no
				[show_if]
					[have_unit]
						x,y=$x1,$y1
						side=$side_number
						canrecruit=no
						[not]
							status=qquws_gifted_unit
						[/not]
					[/have_unit]
					[and]
						[variable]
							name=uws_game.single_player_game
							boolean_equals=no
						[/variable]
					[/and]
				[/show_if]
				[command]
					{VARIABLE gift_side_to 8}
					{VARIABLE gift_name_to $sides[8].side_name}

					[if]
						[variable]
							name=side_number
							equals=8
						[/variable]
						[then]
							{VARIABLE gift_side_to 9}
							{VARIABLE gift_name_to $sides[9].side_name}
						[/then]
					[/if]

					[message]
						speaker=narrator
						caption="Elvish Fairy of the Enchanted Forest"
						image="portraits/elves/shyde.webp"
						message="Gift this unit to $gift_name_to? Remember that once a unit is gifted to another player, it cannot be taken back."
						[option]
							message="Yes, wrap it in a ribbon and gift it"
							[command]
								[modify_unit]
									[filter]
										x,y=$x1,$y1
									[/filter]

									[status]
										qquws_gifted_unit=yes
									[/status]

									side=$gift_side_to
								[/modify_unit]
							[/command]
						[/option]
						[option]
							message="Nah, I've changed my mind"
							[command]
							[/command]
						[/option]
					[/message]
				[/command]
			[/set_menu_item]
		[/then]
	[/if]
#enddef
