#define QQUWS_APPLY_UWS_AMLA_MODIFICATION
	[event]
		name=post advance
		first_time_only=no

		[filter]
			side=$uws_game.filter_human_sides
			[not]
				[filter_wml]
					[variables]
						has_uws_amla_defined=yes
					[/variables]
				[/filter_wml]
			[/not]
		[/filter]

		[fire_event]
			name=apply_uws_amla_mod
			[primary_unit]
				id=$unit.id
			[/primary_unit]
		[/fire_event]
	[/event]

	[event]
		name=apply_uws_amla_mod
		first_time_only=no

		[if]
			[have_unit]
				id=$unit.id
				formula="if(not advances_to, 1, 0)"
			[/have_unit]
			[then]
				{UWS_AMLA_PRECHECK_UNIT}
				{ADD_DEFAULT_UWS_AMLA}

				[qquws_generate_random_amla_list]
					list_var=uws_amla_list
				[/qquws_generate_random_amla_list]

				[set_variables]
					name=amla_keys
					mode=replace
					[split]
						list=$uws_amla_list
						key=key
						separator=","
						remove_empty=yes
					[/split]
				[/set_variables]

				[foreach]
					array=amla_keys
					variable=amla_buff
					readonly=yes
					
					[do]
						[if]
							[variable]
								name=amla_buff.key
								not_equals=""
							[/variable]
							[then]
								{VARIABLE register_uws_special ""}
								{ADD_UWS_AMLA_MOD}

								[if]
									[variable]
										name=register_uws_special
										not_equals=""
									[/variable]
									[then]
										[fire_event]
											name=register_uws_event
										[/fire_event]
										{VARIABLE register_uws_special ""}
									[/then]
								[/if]
							[/then]
						[/if]
					[/do]
				[/foreach]
			[/then]
		[/if]
	[/event]
#enddef

#define UWS_AMLA_PRECHECK_UNIT
	[set_variables]
		name=qquws_amla_data
		mode=replace
		[value]
			level=$unit.level
			has_ranged_attack=no
			has_melee_attack=no
			has_magical_melee=no
			has_magical_ranged=no
			has_steadfast=no
			is_fast=no
			has_default_regenerates=no
			is_strong=no
			is_dextrous=no
			is_quick=no
			is_resilient=no
			is_intelligent=no
			is_healthy=no
			is_undead=no
			is_mechanical=no
			is_elemental=no
			is_human=no
		[/value]
	[/set_variables]
	
	[if]
		[have_unit]
			id=$unit.id
			[has_attack]
				formula="if(range='ranged' and damage > 6, 1, 0)"
			[/has_attack]
			count=1
		[/have_unit]
		[then]
			{VARIABLE qquws_amla_data.has_ranged_attack yes}
		[/then]
	[/if]
	
	[if]
		[have_unit]
			id=$unit.id
			[has_attack]
				formula="if(range='melee' and damage > 6, 1, 0)"
			[/has_attack]
			count=1
		[/have_unit]
		[then]
			{VARIABLE qquws_amla_data.has_melee_attack yes}
		[/then]
	[/if]
	
	[if]
		[have_unit]
			id=$unit.id
			[has_attack]
				range=melee
				special_id=magical
			[/has_attack]
			count=1
		[/have_unit]
		[then]
			{VARIABLE qquws_amla_data.has_magical_melee yes}
		[/then]
	[/if]

	[if]
		[have_unit]
			id=$unit.id
			[has_attack]
				range=ranged
				special_id=magical
			[/has_attack]
			count=1
		[/have_unit]
		[then]
			{VARIABLE qquws_amla_data.has_magical_ranged yes}
		[/then]
	[/if]

	[if]
		[have_unit]
			id=$unit.id
			ability=steadfast
			count=1
		[/have_unit]
		[then]
			{VARIABLE qquws_amla_data.has_steadfast yes}
		[/then]
	[/if]

	[if]
		[variable]
			name=$unit.max_moves
			greater_than=8
		[/variable]
		[then]
			{VARIABLE qquws_amla_data.is_fast yes}
		[/then]
	[/if]

	[if]
		[have_unit]
			id=$unit.id
			ability=regenerates,AE_mag_regenerates8,eoma_regenerates8
			count=1
		[/have_unit]
		[then]
			{VARIABLE qquws_amla_data.has_default_regenerates yes}
		[/then]
	[/if]

	[if]
		[have_unit]
			id=$unit.id
			trait=strong
			count=1
		[/have_unit]
		[then]
			{VARIABLE qquws_amla_data.is_strong yes}
		[/then]
	[/if]

	[if]
		[have_unit]
			id=$unit.id
			trait=dextrous
			count=1
		[/have_unit]
		[then]
			{VARIABLE qquws_amla_data.is_dextrous yes}
		[/then]
	[/if]

	[if]
		[have_unit]
			id=$unit.id
			trait=quick
			count=1
		[/have_unit]
		[then]
			{VARIABLE qquws_amla_data.is_quick yes}
		[/then]
	[/if]

	[if]
		[have_unit]
			id=$unit.id
			trait=resilient
			count=1
		[/have_unit]
		[then]
			{VARIABLE qquws_amla_data.is_resilient yes}
		[/then]
	[/if]

	[if]
		[have_unit]
			id=$unit.id
			trait=intelligent
			count=1
		[/have_unit]
		[then]
			{VARIABLE qquws_amla_data.is_intelligent yes}
		[/then]
	[/if]

	[if]
		[have_unit]
			id=$unit.id
			trait=healthy
			count=1
		[/have_unit]
		[then]
			{VARIABLE qquws_amla_data.is_healthy yes}
		[/then]
	[/if]

	[if]
		[have_unit]
			id=$unit.id
			trait=undead,AE_arc_phantom
			count=1
		[/have_unit]
		[then]
			{VARIABLE qquws_amla_data.is_undead yes}
		[/then]
	[/if]

	[if]
		[have_unit]
			id=$unit.id
			trait=mechanical
			count=1
		[/have_unit]
		[then]
			{VARIABLE qquws_amla_data.is_mechanical yes}
		[/then]
	[/if]

	[if]
		[have_unit]
			id=$unit.id
			trait=elemental,magical
			count=1
		[/have_unit]
		[then]
			{VARIABLE qquws_amla_data.is_elemental yes}
		[/then]
	[/if]

	[if]
		[have_unit]
			id=$unit.id
			race=human,dunefolk,AE_arc_race_human_primevalist,AE_arc_race_south_seas_human,AE_arc_race_ukian,AE_bem_calydonians_race,AE_efm_dalefolk,AE_efm_dalefolk,AE_efm_darklanders,AE_efm_freemen_race,AE_efm_highlanders_race,AE_efm_imperialists_race,AE_efm_seastates_race,AE_efm_whites,AE_ele_viking,AE_feu_ceresians_race,AE_fut_race_Nordhris,AE_imp_arendians_race,AE_imp_lavinian_race,AE_imp_marauder_race,AE_imp_nemidian_race,AE_imp_sidhe_race,AE_mag_summoner,AE_mie_thelian,AE_mie_vampire,AE_mrc_cult_race,AE_mrc_emperors_guard_race,AE_mrc_enchanters_race,AE_mrc_equestrians_race,AE_mrc_fanatics_race,AE_mrc_holy_order_race,AE_mrc_mercenaries_race,AE_mrc_oracles_race,AE_mrc_refugees_race,AE_mrc_slavers_race,AE_mrc_tribe_race,AE_myh_windsong,AE_RHY_human,AE_stf_eltireans_race,Altaris,pirat,tubylec,eoma_summoner
			count=1
		[/have_unit]
		[then]
			{VARIABLE qquws_amla_data.is_human yes}
		[/then]
	[/if]

	[if]
		[have_unit]
			id=$unit.id
			race=elf,AE_chs_aragwaith,AE_chs_faerie,AE_feu_high_elves_race,AE_imp_issaelfr_race,AE_mie_faerie,AE_RHY_elyser,AE_RHY_vixen,driada,amazon
			count=1
		[/have_unit]
		[then]
			{VARIABLE qquws_amla_data.is_elf yes}
		[/then]
	[/if]

	[if]
		[have_unit]
			id=$unit.id
			race=dwarf,AE_chs_elvish_spirits,AE_feu_clockwork_dwarf,AE_fut_brungar_race,AE_imp_cavernei_race,AE_RHY_dwarf,AE_mrc_highlanders_race
			count=1
		[/have_unit]
		[then]
			{VARIABLE qquws_amla_data.is_dwarf yes}
		[/then]
	[/if]

	[if]
		[have_unit]
			id=$unit.id
			race=ogre,troll,AE_mag_cyclops,AE_RHY_giant,eoma_cyclops
			count=1
		[/have_unit]
		[then]
			{VARIABLE qquws_amla_data.is_troll yes}
		[/then]
	[/if]

	[if]
		[have_unit]
			id=$unit.id
			race=wose,AE_mie_treefolk
			count=1
		[/have_unit]
		[then]
			{VARIABLE qquws_amla_data.is_wose yes}
		[/then]
	[/if]

	[if]
		[have_unit]
			id=$unit.id
			race=drake
			count=1
		[/have_unit]
		[then]
			{VARIABLE qquws_amla_data.is_drake yes}
		[/then]
	[/if]

	[if]
		[have_unit]
			id=$unit.id
			race=lizard,AE_mag_salamander,AE_stf_free_saurians,eoma_salamander
			count=1
		[/have_unit]
		[then]
			{VARIABLE qquws_amla_data.is_saurian yes}
		[/then]
	[/if]

	[if]
		[have_unit]
			id=$unit.id
			race=orc,AE_arc_race_north_orc,AE_imp_Orcei_Gladiatores_race,AE_stf_minotaurs_race,AE_stf_minotaurs_Gnoll_race,AE_FL_bloodelf_Minotaur
			count=1
		[/have_unit]
		[then]
			{VARIABLE qquws_amla_data.is_orc yes}
		[/then]
	[/if]

	[if]
		[have_unit]
			id=$unit.id
			race=merman,naga,AE_arc_race_dogukian,AE_arc_race_south_seas_human,AE_ext_monsters_seacreatures,AE_myh_dryad,AE_RHY_aquana,AE_stf_triththa_cuttlefish
			count=1
		[/have_unit]
		[then]
			{VARIABLE qquws_amla_data.is_fish yes}
		[/then]
	[/if]

	[if]
		[have_unit]
			id=$unit.id
			race=goblin
			count=1
		[/have_unit]
		[then]
			{VARIABLE qquws_amla_data.is_goblin yes}
		[/then]
	[/if]

	[if]
		[have_unit]
			id=$unit.id
			race=AE_ele_centaur,AE_mie_centaur
			count=1
		[/have_unit]
		[then]
			{VARIABLE qquws_amla_data.is_centaur yes}
		[/then]
	[/if]

	[if]
		[have_unit]
			id=$unit.id
			race=AE_arc_race_primeval,AE_arc_magnellian,AE_roswellian,AE_arc_race_khthon
			count=1
		[/have_unit]
		[then]
			{VARIABLE qquws_amla_data.is_allien yes}
		[/then]
	[/if]

	[if]
		[have_unit]
			id=$unit.id
			race=AE_bem_anakes_race,AE_chs_demon,AE_chs_shaxthal,AE_ele_fallen,AE_ext_chaos_demon_race,AE_mrc_infernai_race,AE_chs_imps
			count=1
		[/have_unit]
		[then]
			{VARIABLE qquws_amla_data.is_demon yes}
		[/then]
	[/if]

	[if]
		[have_unit]
			id=$unit.id
			race=AE_dep_deep_elf,AE_efm_pygmies,AE_ext_dark_elves_race,AE_FGTNL_mrocznyelf,AE_mag_tharis,AE_RHY_darkelf,eoma_tharis,AE_fut_welkin
			count=1
		[/have_unit]
		[then]
			{VARIABLE qquws_amla_data.is_dark_elf yes}
		[/then]
	[/if]

	[if]
		[have_unit]
			id=$unit.id
			race=bats,horse,gryphon,monster,wolf,AE_arc_race_dogukian,AE_ext_dark_elves_wyrm_race,AE_ext_monsters_monster,AE_ext_monsters_seacreatures,AE_imp_Sidhe_Bear,AE_mag_roc,AE_mrc_equestrians_race,AE_RHY_roc,AE_RHY_animal,jastrzab,krokodyl,eoma_roc
			count=1
		[/have_unit]
		[then]
			{VARIABLE qquws_amla_data.is_animal yes}
		[/then]
	[/if]

	[if]
		[have_unit]
			id=$unit.id
			race=bats,gryphon,AE_mag_roc,AE_RHY_roc,jastrzab,eoma_roc,AE_fut_welkin,AE_mrc_avians_race,AE_RHY_angel
			count=1
		[/have_unit]
		[then]
			{VARIABLE qquws_amla_data.is_aerial yes}
		[/then]
	[/if]

	[if]
		[have_unit]
			id=$unit.id
			race=AE_mrc_hive_race
			count=1
		[/have_unit]
		[then]
			{VARIABLE qquws_amla_data.is_insect yes}
		[/then]
	[/if]

	[if]
		[have_unit]
			id=$unit.id
			race=wolf,AE_myh_warg
			count=1
		[/have_unit]
		[then]
			{VARIABLE qquws_amla_data.is_warg yes}
		[/then]
	[/if]

	[if]
		[have_unit]
			id=$unit.id
			[has_attack]
				special_id=magical,AE_mag_magical_defensive,AE_mag_magical_offensive,AE_mag_precision,AE_mag_enchanted,AE_mag_precision_offensive,AE_fut_ubiquitous,eoma_precision,eoma_enchanted,eoma_magical_offensive,eoma_magical_defensive,eoma_precision_offensive,marksman,AE_mag_marksman_greater,AE_mag_skilled,AE_chs_aimed
			[/has_attack]
			count=1
		[/have_unit]
		[then]
			{VARIABLE qquws_amla_data.has_cth_special yes}
		[/then]
	[/if]

	[if]
		[have_unit]
			id=$unit.id
			ability=AE_mrc_bloodlust,AE_mag_bloodlust2,AE_mag_bloodlust3,AE_mag_bloodlust4,AE_mag_bloodlust5,AE_mag_bloodlust6,AE_mag_bloodlust8,eoma_bloodlust3,eoma_bloodlust4,eoma_bloodlust5,eoma_bloodlust6,eoma_bloodlust8
			count=1
		[/have_unit]
		[then]
			{VARIABLE qquws_amla_data.has_bloodlust yes}
		[/then]
	[/if]
#enddef

#define ADD_UWS_AMLA_MOD
	[switch]
		variable=amla_buff.key
		[case]
			value=REGEN
			
			{AMLA_MOD_UNIT uws_amla_regen_1 1 25 "Regen +10" "icons/herb-bag.png" (
				[effect]
					apply_to=remove_ability
					[abilities]
						[regenerate]
							id=regenerates
						[/regenerate]
						[regenerate]
							id=AE_mag_regenerates8
						[/regenerate]
						[regenerate]
							id=eoma_regenerates8
						[/regenerate]
					[/abilities]
				[/effect]
				[effect]
				    apply_to=new_ability
				    [abilities]
						[regenerate]
							value=10
							id=amla_regenerates
							name="regenerates 10"
							description="The unit will heal itself 10hp per turn. If it is poisoned, it will remove the poison instead of healing."
							affect_self=yes
							poison=cured
						[/regenerate]
				    [/abilities]
				[/effect]
			)}

			{AMLA_MOD_UNIT uws_amla_regen_2 1 30 "Regen +12" "icons/herb-bag.png" (
				require_amla=uws_amla_regen_1
				[effect]
					apply_to=remove_ability
					[abilities]
						[regenerate]
							id=amla_regenerates
						[/regenerate]
					[/abilities]
				[/effect]
				[effect]
				    apply_to=new_ability
				    [abilities]
						[regenerate]
							value=12
							id=amla_regenerates
							name="regenerates 12"
							description="The unit will heal itself 12hp per turn. If it is poisoned, it will remove the poison instead of healing."
							affect_self=yes
							poison=cured
						[/regenerate]
				    [/abilities]
				[/effect]
			)}
		[/case]

		[case]
			value=MINI_REG
			
			{AMLA_MOD_UNIT uws_amla_mini_regen 1 15 "Regen +4" "icons/herb-bag.png" (
				[effect]
					apply_to=remove_ability
					[abilities]
						[regenerate]
							id=regenerates
						[/regenerate]
						[regenerate]
							id=AE_mag_regenerates8
						[/regenerate]
						[regenerate]
							id=eoma_regenerates8
						[/regenerate]
					[/abilities]
				[/effect]
				[effect]
				    apply_to=new_ability
				    [abilities]
						[regenerate]
							value=4
							id=amla_mini_regenerates
							name="regenerates 4"
							description="The unit will heal itself 4hp per turn. If it is poisoned, it will remove the poison instead of healing."
							affect_self=yes
							poison=cured
						[/regenerate]
				    [/abilities]
				[/effect]
			)}
		[/case]

		[case]
			value=R_DMG
			
			{AMLA_MOD_UNIT uws_amla_ranged_dmg 3 20 "Ranged dmg +8%" "icons/hat-huntsman.png" (
				[effect]
				    apply_to=attack
				    range=ranged
				    increase_damage=8%
				[/effect]
			)}
		[/case]

		[case]
			value=R_STR
			
			{AMLA_MOD_UNIT uws_amla_ranged_strike_1 1 40 "Ranged strike (defense)" "icons/hat-huntsman.png" (
				[effect]
				    apply_to=attack
				    range=ranged
				    [set_specials]
				    	mode=append
						[attacks]
							id=qquws_fast_reflex
							name="fast reflex"
							description="Adds 1 strike when defending."
							active_on=offense
							add=1
						[/attacks]
				    [/set_specials]
				[/effect]
			)}

			{AMLA_MOD_UNIT uws_amla_ranged_strike_2 1 25 "Ranged strike (always)" "icons/hat-huntsman.png" (
				require_amla=uws_amla_ranged_strike_1
				[effect]
				    apply_to=attack
				    range=ranged
				    remove_specials=qquws_fast_reflex
				    increase_attacks=1
				[/effect]
			)}
		[/case]

		[case]
			value=R_MAG_ACC
			
			{AMLA_MOD_UNIT uws_amla_ranged_mag_acc_1 1 50 "Ranged magical 75%" "icons/ring_gold.png" (
				[effect]
				    apply_to=attack
				    range=ranged
				    special_id=magical
				    remove_specials=magical
				    [set_specials]
				    	mode=append
						[chance_to_hit]
					        id=magical
					        name="magical 75%"
					        description="This attack always has a 75% chance to hit regardless of the defensive ability of the unit being attacked."
					        value=75
					        cumulative=no
					    [/chance_to_hit]
				    [/set_specials]
				[/effect]
			)}

			{AMLA_MOD_UNIT uws_amla_ranged_mag_acc_2 1 75 "Ranged magical 80%" "icons/ring_gold.png" (
				require_amla=uws_amla_ranged_mag_acc_1
				[effect]
				    apply_to=attack
				    range=ranged
				    special_id=magical
				    remove_specials=magical
				    [set_specials]
				    	mode=append
						[chance_to_hit]
					        id=magical
					        name="magical 80%"
					        description="This attack always has a 80% chance to hit regardless of the defensive ability of the unit being attacked."
					        value=80
					        cumulative=no
					    [/chance_to_hit]
				    [/set_specials]
				[/effect]
			)}
		[/case]

		[case]
			value=R_ACC
			
			{AMLA_MOD_UNIT uws_amla_ranged_acc_1 1 16 "Ranged accuracy +2%" "icons/hat-huntsman.png" (
				[effect]
				    apply_to=attack
				    range=ranged
				    [not]
				    	special_id=magical,AE_mag_magical_defensive,AE_mag_magical_offensive,AE_mag_precision,AE_mag_enchanted,AE_mag_precision_offensive,AE_fut_ubiquitous,eoma_precision,eoma_enchanted,eoma_magical_offensive,eoma_magical_defensive,eoma_precision_offensive
				    [/not]
				    increase_accuracy=2
				[/effect]
			)}

			{AMLA_MOD_UNIT uws_amla_ranged_mag_acc_2 1 24 "Ranged accuracy +3%" "icons/hat-huntsman.png" (
				require_amla=uws_amla_ranged_acc_1
				[effect]
				    apply_to=attack
				    range=ranged
				    [not]
				    	special_id=magical,AE_mag_magical_defensive,AE_mag_magical_offensive,AE_mag_precision,AE_mag_enchanted,AE_mag_precision_offensive,AE_fut_ubiquitous,eoma_precision,eoma_enchanted,eoma_magical_offensive,eoma_magical_defensive,eoma_precision_offensive
				    [/not]
				    increase_accuracy=3
				[/effect]
			)}

			{AMLA_MOD_UNIT uws_amla_ranged_mag_acc_3 1 40 "Ranged accuracy +5%" "icons/hat-huntsman.png" (
				require_amla=uws_amla_ranged_acc_2
				[effect]
				    apply_to=attack
				    range=ranged
				    [not]
				    	special_id=magical,AE_mag_magical_defensive,AE_mag_magical_offensive,AE_mag_precision,AE_mag_enchanted,AE_mag_precision_offensive,AE_fut_ubiquitous,eoma_precision,eoma_enchanted,eoma_magical_offensive,eoma_magical_defensive,eoma_precision_offensive
				    [/not]
				    increase_accuracy=5
				[/effect]
			)}
		[/case]

		[case]
			value=R_PAR
			
			{AMLA_MOD_UNIT uws_amla_ranged_parry 1 30 "Ranged parry +5%" "icons/hat-huntsman.png" (
				[effect]
				    apply_to=attack
				    range=ranged
				    [not]
				    	special_id=magical,AE_mag_magical_defensive,AE_mag_magical_offensive,AE_mag_precision,AE_mag_enchanted,AE_mag_precision_offensive,AE_fut_ubiquitous,eoma_precision,eoma_enchanted,eoma_magical_offensive,eoma_magical_defensive,eoma_precision_offensive
				    [/not]
				    increase_parry=5
				[/effect]
				[effect]
				    apply_to=attack
				    range=ranged
				    special_id=magical,AE_mag_magical_defensive,AE_mag_magical_offensive,AE_mag_precision,AE_mag_enchanted,AE_mag_precision_offensive,AE_fut_ubiquitous,eoma_precision,eoma_enchanted,eoma_magical_offensive,eoma_magical_defensive,eoma_precision_offensive
				    [set_specials]
				    	mode=append
				    	[chance_to_hit]
							id=qquws_magical_fog
							sub=5
							name="mind fog"
							description="When this attack is used, opponent's magical chance to hit is reduced by 5%. Champions and the Butcher of Wesnoth are immune."
							apply_to=opponent
							cumulative=no
							[filter_opponent]
								[filter_weapon]
									special_id=magical,AE_mag_magical_defensive,AE_mag_magical_offensive,AE_mag_precision,AE_mag_enchanted,AE_mag_precision_offensive,AE_fut_ubiquitous,eoma_precision,eoma_enchanted,eoma_magical_offensive,eoma_magical_defensive,eoma_precision_offensive
								[/filter_weapon]

								[not]
									trait=immune_to_specials
								[/not]
							[/filter_opponent]
						[/chance_to_hit]
				    [/set_specials]
				[/effect]
			)}
		[/case]

		[case]
			value=M_DMG
			
			{AMLA_MOD_UNIT uws_amla_melee_dmg 3 20 "Melee dmg +8%" "icons/crossed_sword_and_hammer.png" (
				[effect]
				    apply_to=attack
				    range=melee
				    increase_damage=8%
				[/effect]
			)}
		[/case]

		[case]
			value=M_STR
			
			{AMLA_MOD_UNIT uws_amla_melee_strike_1 1 60 "Melee strike (defense)" "icons/crossed_sword_and_hammer.png" (
				[effect]
				    apply_to=attack
				    range=melee
				    [set_specials]
				    	mode=append
						[attacks]
							id=qquws_fast_reflex
							name="fast reflex"
							description="Adds 1 strike when defending."
							active_on=offense
							add=1
						[/attacks]
				    [/set_specials]
				[/effect]
			)}

			{AMLA_MOD_UNIT uws_amla_melee_strike_2 1 30 "Melee strike (always)" "icons/crossed_sword_and_hammer.png" (
				require_amla=uws_amla_melee_strike_1
				[effect]
				    apply_to=attack
				    range=melee
				    remove_specials=qquws_fast_reflex
				    increase_attacks=1
				[/effect]
			)}
		[/case]

		[case]
			value=M_MAG_ACC
			
			{AMLA_MOD_UNIT uws_amla_melee_mag_acc_1 1 40 "Melee magical 75%" "icons/crossed_sword_and_hammer.png" (
				[effect]
				    apply_to=attack
				    range=melee
				    special_id=magical
				    remove_specials=magical
				    [set_specials]
				    	mode=append
						[chance_to_hit]
					        id=magical
					        name="magical 75%"
					        description="This attack always has a 75% chance to hit regardless of the defensive ability of the unit being attacked."
					        value=75
					        cumulative=no
					    [/chance_to_hit]
				    [/set_specials]
				[/effect]
			)}

			{AMLA_MOD_UNIT uws_amla_melee_mag_acc_2 1 50 "Melee magical 80%" "icons/crossed_sword_and_hammer.png" (
				require_amla=uws_amla_melee_mag_acc_1
				[effect]
				    apply_to=attack
				    range=melee
				    special_id=magical
				    remove_specials=magical
				    [set_specials]
				    	mode=append
						[chance_to_hit]
					        id=magical
					        name="magical 80%"
					        description="This attack always has a 80% chance to hit regardless of the defensive ability of the unit being attacked."
					        value=80
					        cumulative=no
					    [/chance_to_hit]
				    [/set_specials]
				[/effect]
			)}

			{AMLA_MOD_UNIT uws_amla_melee_mag_acc_3 1 60 "Melee magical 85%" "icons/crossed_sword_and_hammer.png" (
				require_amla=uws_amla_melee_mag_acc_2
				[effect]
				    apply_to=attack
				    range=melee
				    special_id=magical
				    remove_specials=magical
				    [set_specials]
				    	mode=append
						[chance_to_hit]
					        id=magical
					        name="magical 85%"
					        description="This attack always has a 85% chance to hit regardless of the defensive ability of the unit being attacked."
					        value=85
					        cumulative=no
					    [/chance_to_hit]
				    [/set_specials]
				[/effect]
			)}
		[/case]

		[case]
			value=M_ACC
			
			{AMLA_MOD_UNIT uws_amla_melee_acc_1 1 16 "Melee accuracy +2%" "icons/crossed_sword_and_hammer.png" (
				[effect]
				    apply_to=attack
				    range=melee
				    [not]
				    	special_id=magical,AE_mag_magical_defensive,AE_mag_magical_offensive,AE_mag_precision,AE_mag_enchanted,AE_mag_precision_offensive,AE_fut_ubiquitous,eoma_precision,eoma_enchanted,eoma_magical_offensive,eoma_magical_defensive,eoma_precision_offensive
				    [/not]
				    increase_accuracy=2
				[/effect]
			)}

			{AMLA_MOD_UNIT uws_amla_melee_acc_2 1 24 "Melee accuracy +3%" "icons/crossed_sword_and_hammer.png" (
				require_amla=uws_amla_melee_acc_1
				[effect]
				    apply_to=attack
				    range=melee
				    [not]
				    	special_id=magical,AE_mag_magical_defensive,AE_mag_magical_offensive,AE_mag_precision,AE_mag_enchanted,AE_mag_precision_offensive,AE_fut_ubiquitous,eoma_precision,eoma_enchanted,eoma_magical_offensive,eoma_magical_defensive,eoma_precision_offensive
				    [/not]
				    increase_accuracy=3
				[/effect]
			)}
		[/case]

		[case]
			value=M_PAR
			
			{AMLA_MOD_UNIT uws_amla_melee_parry_1 1 10 "Melee parry +2%" "icons/crossed_sword_and_hammer.png" (
				[effect]
				    apply_to=attack
				    range=melee
				    [not]
				    	special_id=magical,AE_mag_magical_defensive,AE_mag_magical_offensive,AE_mag_precision,AE_mag_enchanted,AE_mag_precision_offensive,AE_fut_ubiquitous,eoma_precision,eoma_enchanted,eoma_magical_offensive,eoma_magical_defensive,eoma_precision_offensive
				    [/not]
				    increase_parry=2
				[/effect]
			)}

			{AMLA_MOD_UNIT uws_amla_melee_parry_2 1 15 "Melee parry +3%" "icons/crossed_sword_and_hammer.png" (
				require_amla=uws_amla_melee_parry_1
				[effect]
				    apply_to=attack
				    range=melee
				    [not]
				    	special_id=magical,AE_mag_magical_defensive,AE_mag_magical_offensive,AE_mag_precision,AE_mag_enchanted,AE_mag_precision_offensive,AE_fut_ubiquitous,eoma_precision,eoma_enchanted,eoma_magical_offensive,eoma_magical_defensive,eoma_precision_offensive
				    [/not]
				    increase_parry=3
				[/effect]
			)}
		[/case]

		[case]
			value=SMALL_SPEED
			
			{AMLA_MOD_UNIT uws_amla_small_speed 1 20 "Movement costs -1" "icons/boots_elven.png" (
				[effect]
				    apply_to=movement_costs
				    replace=no
				    [movement_costs]
						flat=-1
						frozen=-1
						forest=-1
						hills=-1
						mountains=-1
						village=-1
						swamp_water=-1
						shallow_water=-1
						deep_water=-1
						reef=-1
						castle=-1
						cave=-1
						sand=-1
						fungus=-1
				    [/movement_costs]
				[/effect]
			)}
		[/case]

		[case]
			value=SPEED
			
			# speed is always presented with small_speed due to the rules
			{AMLA_MOD_UNIT uws_amla_speed_2 1 30 "MP +1" "icons/boots_elven.png" (
				require_amla=uws_amla_small_speed
				[effect]
				    apply_to=movement
				    increase=1
				[/effect]
			)}
		[/case]

		[case]
			value=LOW_XP
			
			{AMLA_MOD_UNIT uws_amla_max_xp_reduction 1 -30 "" "icons/letter_and_ale.png" ()}
		[/case]

		[case]
			value=PHYS_RES
			
			{AMLA_MOD_UNIT uws_amla_phys_res 2 25 "Physical resistance +5%" "icons/shield_tower_merfolk.png" (
				[effect]
				    apply_to=resistance
				    replace=no
				    [resistance]
						blade=-5
						impact=-5
						pierce=-5
				    [/resistance]
				[/effect]
			)}
		[/case]

		[case]
			value=ARCANE_RES
			
			{AMLA_MOD_UNIT uws_amla_arcane_res 2 20 "Arcane resistance +10%" "icons/skull_ring.png" (
				[effect]
				    apply_to=resistance
				    replace=no
				    [resistance]
						arcane=-10
				    [/resistance]
				[/effect]
			)}
		[/case]

		[case]
			value=NIGHT_EXTRA_DMG
			
			{AMLA_MOD_UNIT uws_amla_night_dmg_1 1 25 "Night damage +10% on offense" "icons/uws/cloak_black.png" (
				[effect]
				    apply_to=attack
				    remove_specials=qquws_evil_attack
				    [set_specials]
				    	mode=append
						[damage]
					        id=qquws_evil_attack
					        name="evil"
					        description="This attack deals additional 10% damage on offense when used at nighttime."
					        multiply=1.1
					        apply_to=self
					        active_on=offense
					        [filter_self]
					        	[filter_location]
					        		time_of_day=chaotic
					        	[/filter_location]
					        [/filter_self]
					    [/damage]
				    [/set_specials]
				[/effect]
			)}

			{AMLA_MOD_UNIT uws_amla_night_dmg_2 1 35 "Night damage +20% on offense" "icons/uws/cloak_black.png" (
				require_amla=uws_amla_night_dmg_1
				[effect]
				    apply_to=attack
				    remove_specials=qquws_evil_attack
				    [set_specials]
				    	mode=append
						[damage]
					        id=qquws_evil_attack
					        name="evil"
					        description="This attack deals additional 20% damage on offense when used at nighttime."
					        multiply=1.2
					        apply_to=self
					        active_on=offense
					        [filter_self]
					        	[filter_location]
					        		time_of_day=chaotic
					        	[/filter_location]
					        [/filter_self]
					    [/damage]
				    [/set_specials]
				[/effect]
			)}
		[/case]

		[case]
			value=ELEM_RES
			
			{AMLA_MOD_UNIT uws_amla_elem_res_1 1 20 "Fire and Cold resistance +7%" "icons/jewelry_necklace_amber.png" (
				[effect]
				    apply_to=resistance
				    replace=no
				    [resistance]
						fire=-7
						cold=-7
				    [/resistance]
				[/effect]
			)}

			{AMLA_MOD_UNIT uws_amla_elem_res_2 1 30 "Fire and Cold resistance +8%" "icons/jewelry_necklace_amber.png" (
				require_amla=uws_amla_elem_res_1
				[effect]
				    apply_to=resistance
				    replace=no
				    [resistance]
						fire=-8
						cold=-8
				    [/resistance]
				[/effect]
			)}
		[/case]

		[case]
			value=ELEM_HEAL_ON_HIT
			
			{AMLA_MOD_UNIT uws_amla_elem_hoh_1 1 25 "Heal on hit +1" "icons/ankh_necklace.png" (
				[effect]
				     apply_to=attack
				     remove_specials=qquws_amla_heals_on_hit
				     [set_specials]
				    	  mode=append
				     	  [heal_on_hit]
							id=qquws_amla_heals_on_hit
							name="heals on hit +1"
							description="Each landing hit causes this unit to heal 1 hitpoint."
							value=1
							apply_to=self
						  [/heal_on_hit] 
				     [/set_specials]
				 [/effect]
			)}

			{AMLA_MOD_UNIT uws_amla_elem_hoh_2 1 40 "Heal on hit +2" "icons/ankh_necklace.png" (
				require_amla=uws_amla_elem_hoh_1
				[effect]
				     apply_to=attack
				     remove_specials=qquws_amla_heals_on_hit
				     [set_specials]
				    	  mode=append
				     	  [heal_on_hit]
							id=qquws_amla_heals_on_hit
							name="heals on hit +2"
							description="Each landing hit causes this unit to heal 2 hitpoints."
							value=2
							apply_to=self
						  [/heal_on_hit] 
				     [/set_specials]
				 [/effect]
			)}

			{AMLA_MOD_UNIT uws_amla_elem_hoh_3 1 60 "Heal on hit +3" "icons/ankh_necklace.png" (
				require_amla=uws_amla_elem_hoh_2
				[effect]
				     apply_to=attack
				     remove_specials=qquws_amla_heals_on_hit
				     [set_specials]
				    	  mode=append
				     	  [heal_on_hit]
							id=qquws_amla_heals_on_hit
							name="heals on hit +3"
							description="Each landing hit causes this unit to heal 3 hitpoints."
							value=3
							apply_to=self
						  [/heal_on_hit] 
				     [/set_specials]
				 [/effect]
			)}
		[/case]

		[case]
			value=VIL_CASTLE_DEF
			
			{AMLA_MOD_UNIT uws_amla_hum_def 2 30 "Village and Castle defense +5%" "icons/uws/shield_kite.png" (
				[effect]
					apply_to=defense
					replace=no
					[defense]
						village=-5
						castle=-5
					[/defense]
				[/effect]
			)}
		[/case]

		[case]
			value=HUMAN_ARMOR
			
			{AMLA_MOD_UNIT uws_amla_hum_arm_blade 2 25 "Blade resistance +10%" "icons/uws/padded_coat.png" (
				[effect]
				    apply_to=resistance
				    replace=no
				    [resistance]
						blade=-10
				    [/resistance]
				[/effect]
			)}

			{AMLA_MOD_UNIT uws_amla_hum_arm_pierce 2 25 "Pierce resistance +10%" "icons/cuirass_leather_studded.png" (
				[effect]
				    apply_to=resistance
				    replace=no
				    [resistance]
						pierce=-10
				    [/resistance]
				[/effect]
			)}

			{AMLA_MOD_UNIT uws_amla_hum_arm_cold 2 25 "Cold resistance +10%" "icons/uws/tunic_black.png" (
				[effect]
				    apply_to=resistance
				    replace=no
				    [resistance]
						cold=-10
				    [/resistance]
				[/effect]
			)}
		[/case]

		[case]
			value=FOREST_DEF
			
			{AMLA_MOD_UNIT uws_amla_forest_def 2 35 "Forest defense +5%" "icons/uws/armor_dragon.png" (
				[effect]
					apply_to=defense
					replace=no
					[defense]
						forest=-5
					[/defense]
				[/effect]
			)}
		[/case]

		[case]
			value=ELF_R_ACC
			
			{AMLA_MOD_UNIT uws_amla_ranged_mag_acc_3 1 20 "Elvish accuracy +5%" "icons/uws/bow.png" (
				[effect]
				    apply_to=attack
				    range=ranged
				    [not]
				    	special_id=magical,AE_mag_magical_defensive,AE_mag_magical_offensive,AE_mag_precision,AE_mag_enchanted,AE_mag_precision_offensive,AE_fut_ubiquitous,eoma_precision,eoma_enchanted,eoma_magical_offensive,eoma_magical_defensive,eoma_precision_offensive
				    [/not]
				    increase_accuracy=5
				[/effect]
			)}
		[/case]

		[case]
			value=CAVE_MOUNT_DEF
			
			{AMLA_MOD_UNIT uws_amla_dwarf_def 2 30 "Mountains and Caves defense +5%" "icons/stone_ring.png" (
				[effect]
					apply_to=defense
					replace=no
					[defense]
						cave=-5
						mountains=-5
					[/defense]
				[/effect]
			)}
		[/case]

		[case]
			value=DWARF_DMG
			
			{AMLA_MOD_UNIT uws_amla_dwarf_dmg 1 60 "Damage +20%" "icons/uws/dwarf_juice.png" (
				[effect]
				    apply_to=attack
				    increase_damage=20%
				[/effect]
			)}
		[/case]

		[case]
			value=CAVE_HILLS_DEF
			
			{AMLA_MOD_UNIT uws_amla_troll_def 2 30 "Caves and Hills defense +5%" "icons/bag.png" (
				[effect]
					apply_to=defense
					replace=no
					[defense]
						cave=-5
						hills=-5
					[/defense]
				[/effect]
			)}
		[/case]

		[case]
			value=TROLL_DMG
			
			{AMLA_MOD_UNIT uws_amla_troll_dmg 1 35 "Melee damage +15%" "icons/uws/charm.png" (
				[effect]
				    apply_to=attack
				    range=melee
				    increase_damage=15%
				[/effect]
			)}
		[/case]

		[case]
			value=IMPACT_RES
			
			{AMLA_MOD_UNIT uws_amla_impact_res 2 20 "Impact resistance +10%" "icons/shield_tower.png" (
				[effect]
				    apply_to=resistance
				    replace=no
				    [resistance]
						impact=-10
				    [/resistance]
				[/effect]
			)}
		[/case]

		[case]
			value=BLADE_RES
			
			{AMLA_MOD_UNIT uws_amla_blade_res 2 20 "Blade resistance +10%" "icons/jewelery_butterfly_pin.png" (
				[effect]
				    apply_to=resistance
				    replace=no
				    [resistance]
						blade=-10
				    [/resistance]
				[/effect]
			)}
		[/case]

		[case]
			value=IMPACT_PIERCE_RES
			
			{AMLA_MOD_UNIT uws_amla_wose_res_1 1 20 "Impact and Pierce resistance +7%" "icons/jewelry_necklace_amber.png" (
				[effect]
				    apply_to=resistance
				    replace=no
				    [resistance]
						impact=-7
						pierce=-7
				    [/resistance]
				[/effect]
			)}

			{AMLA_MOD_UNIT uws_amla_wose_res_2 1 30 "Impact and Pierce resistance +8%" "icons/jewelry_necklace_amber.png" (
				require_amla=uws_amla_wose_res_1
				[effect]
				    apply_to=resistance
				    replace=no
				    [resistance]
						impact=-8
						pierce=-8
				    [/resistance]
				[/effect]
			)}
		[/case]

		[case]
			value=WOSE_DMG
			
			{AMLA_MOD_UNIT uws_amla_wose_dmg 2 25 "Melee damage +12%" "icons/uws/charm.png" (
				[effect]
				    apply_to=attack
				    increase_damage=12%
				[/effect]
			)}
		[/case]

		[case]
			value=SAND_CASTLE_DEF
			
			{AMLA_MOD_UNIT uws_amla_drake_def 2 30 "Caves and Hills defense +5%" "icons/circlet_winged.png" (
				[effect]
					apply_to=defense
					replace=no
					[defense]
						sand=-5
						castle=-5
					[/defense]
				[/effect]
			)}
		[/case]

		[case]
			value=PIERCE_RES
			
			{AMLA_MOD_UNIT uws_amla_pierce_res 2 20 "Pierce resistance +10%" "icons/cuirass_muscled.png" (
				[effect]
				    apply_to=resistance
				    replace=no
				    [resistance]
						pierce=-10
				    [/resistance]
				[/effect]
			)}
		[/case]

		[case]
			value=SWAMP_FLAT_DEF
			
			{AMLA_MOD_UNIT uws_amla_saurian_def 2 40 "Flat and Swamp defense +5%" "icons/shield_polished.png" (
				[effect]
					apply_to=defense
					replace=no
					[defense]
						flat=-5
						swamp_water=-5
					[/defense]
				[/effect]
			)}
		[/case]

		[case]
			value=COLD_RES
			
			{AMLA_MOD_UNIT uws_amla_cold_res 2 20 "Cold resistance +10%" "icons/tunic_green.png" (
				[effect]
				    apply_to=resistance
				    replace=no
				    [resistance]
						cold=-10
				    [/resistance]
				[/effect]
			)}
		[/case]

		[case]
			value=NIGHT_EXTRA_STRIKE
			
			{AMLA_MOD_UNIT uws_amla_night_strike 1 50 "Night +1 strike (offense)" "icons/uws/axe_rusty.png" (
				[effect]
				    apply_to=attack
				    [set_specials]
				    	mode=append
						[attacks]
							id=qquws_vicious
							name="vicious"
							description="Adds 1 strike when attacking during nighttime."
							active_on=offense
							apply_to=self
							add=1
							[filter_self]
								[filter_location]
									time_of_day_id=first_watch,midnight,second_watch
								[/filter_location]
							[/filter_self]
						[/attacks]
				    [/set_specials]
				[/effect]
			)}
		[/case]

		[case]
			value=NIGHT_EXTRA_MP
			
			{AMLA_MOD_UNIT uws_amla_night_mp 1 30 "Night +1mp" "icons/uws/boots_officer.png" (
				[effect]
				    apply_to=new_ability
				    [abilities]
						[dummy]
							id=qquws_night_instigator
							name="instigator"
							description="This unit gains one extra movement point during nighttime."
						[/dummy]
				    [/abilities]
				[/effect]
			)}

			{VARIABLE register_uws_special "night_instigator_special"}
		[/case]

		[case]
			value=WATER_DEF
			
			{AMLA_MOD_UNIT uws_amla_water_def 2 25 "Water defense +5%" "icons/orc_roundshield.png" (
				[effect]
					apply_to=defense
					replace=no
					[defense]
						shallow_water=-5
						deep_water=-5
						reef=-5
					[/defense]
				[/effect]
			)}
		[/case]

		[case]
			value=FISH_FLAT_DEF
			
			{AMLA_MOD_UNIT uws_amla_fish_flat_def 2 40 "Flat defense +5%" "icons/uws/cuirass_fiber.png" (
				[effect]
					apply_to=defense
					replace=no
					[defense]
						flat=-5
					[/defense]
				[/effect]
			)}
		[/case]

		[case]
			value=HILLS_MOUNT_DEF
			
			{AMLA_MOD_UNIT uws_amla_goblin_def 2 30 "Hills and Mountains defense +5%" "icons/goblin_def.png" (
				[effect]
					apply_to=defense
					replace=no
					[defense]
						hills=-5
						mountains=-5
					[/defense]
				[/effect]
			)}
		[/case]

		[case]
			value=FLAT_HILLS_DEF
			
			{AMLA_MOD_UNIT uws_amla_centaur_def 2 35 "Flat and Hills defense +5%" "attacks/hoof.png" (
				[effect]
					apply_to=defense
					replace=no
					[defense]
						hills=-5
						flat=-5
					[/defense]
				[/effect]
			)}
		[/case]

		[case]
			value=R_HIT_AND_RUN_1
			
			{AMLA_MOD_UNIT uws_amla_ranged_har 1 50 "Hit and Run +1 on ranged" "icons/attacks/bow-short.png" (
				[effect]
				    apply_to=attack
				    range=ranged
				    [set_specials]
				    	mode=append
						[dummy]
							id=qquws_weapon_hit_and_run
							name="hit and run +1"
							description="After attacking this unit can move back. If the unit already has hit and run ability then using this weapon adds another movement point after attacking."
						[/dummy]
				    [/set_specials]
				[/effect]
			)}

			{VARIABLE register_uws_special "weapon_hit_and_run_special"}
		[/case]
	[/switch]
#enddef

#define AMLA_MOD_UNIT UWS_AMLA_ID MAX_TIMES XP_CHANGE DESCRIPTION IMAGE EFFECT_WML
	[modify_unit]
		[filter]
			id=$unit.id
		[/filter]

		[effect]
			apply_to=new_advancement
			replace=no
			[advancement]
				id={UWS_AMLA_ID}
				always_display=yes
				description={DESCRIPTION}"

Full heal
Max experience +"{XP_CHANGE}"%"
				image={IMAGE}
				max_times={MAX_TIMES}
				strict_amla=yes
				major_amla=yes
				{EFFECT_WML}
				[effect]
					apply_to=hitpoints
					heal_full=yes
				[/effect]
				[effect]
					apply_to=max_experience
					increase={XP_CHANGE}
				[/effect]
				[effect]
		            apply_to=status
		            remove=poisoned
		        [/effect]
		        [effect]
		            apply_to=status
		            remove=slowed
		        [/effect]
			[/advancement]
		[/effect]
	[/modify_unit]
#enddef

#define ADD_DEFAULT_UWS_AMLA
	[modify_unit]
		[filter]
			id=$unit.id
		[/filter]

		[variables]
			has_uws_amla_defined=yes
		[/variables]

		[object]
			silent=yes

			[effect]
				apply_to=remove_advancement
				amlas=amla_default
			[/effect]
		[/object]

		[effect]
			apply_to=new_advancement
			replace=no
			[advancement]
				id=uws_default_amla
				always_display=no
				description="Max hp +8%
Full heal
Max experience +12%"
				image="icons/amla-default.png"
				max_times=-1
				strict_amla=yes
				major_amla=no
				[effect]
					apply_to=hitpoints
					heal_full=yes
					increase_total=8%
				[/effect]
				[effect]
					apply_to=max_experience
					increase=12%
				[/effect]
				[effect]
		            apply_to=status
		            remove=poisoned
		        [/effect]
		        [effect]
		            apply_to=status
		            remove=slowed
		        [/effect]
			[/advancement]
		[/effect]
	[/modify_unit]
#enddef
