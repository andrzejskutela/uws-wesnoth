#define QQUWS_REGISTER_LOCATION_EVENTS
	[event]
		name=register_new_location_event
		first_time_only=no
		
		[switch]
			variable=register_event_name
			
			[case]
				value="rfc_crystal_forest"
				
				{VARIABLE crystal_forest_consumed_$register_event_id no}
				[event]
					id=$register_event_id
					name=$register_event_name
					first_time_only=no
					delayed_variable_substitution=no
					
					[if]
						[variable]
							name=crystal_forest_consumed_$register_event_id
							boolean_equals=yes
						[/variable]
						[then]
							[message]
								speaker=narrator
								caption="Gatekeeper of the Crystal Forest"
								image="portraits/humans/assassin.png"
								message="Go away before I send my dogs after you!"
							[/message]
						[/then]
						[else]
							[if]
								[have_unit]
									id=$|unit.id
									[filter_wml]
										[variables]
											special_id="rfc_crystal_forest_escort_unit"
										[/variables]
									[/filter_wml]
									count=1
								[/have_unit]
								[then]
									[message]
										speaker=narrator
										caption="Gatekeeper of the Crystal Forest"
										image="portraits/humans/assassin.png"
										message="Aaa... finally! We've been waiting for you for ages! Where were you?"
									[/message]
									
									[message]
										id=$|unit.id
										message="It's a long story, I will tell you over a pint. These guys over there helped me to get here, I think they deserve a little gift for their help."
									[/message]
									
									[message]
										speaker=narrator
										caption="Gatekeeper of the Crystal Forest"
										image="portraits/humans/assassin.png"
										message="Is that so? A friend of my friend is my friend too. Please, take this as a token of our gratitude."
									[/message]

									{VARIABLE escorted_unit_level_$register_event_id $|unit.level}
									
									{VARIABLE render_new_item yes}
									{VARIABLE item_x $|unit.x}
									[if]
										[variable]
											name=item_x
											less_than=$uws_game.middle
										[/variable]
										[then]
											{VARIABLE_OP item_x add 1}
										[/then]
										[else]
											{VARIABLE_OP item_x sub 1}
										[/else]
									[/if]
									
									{VARIABLE item_y $|unit.y}

									[item]
										x,y=$|item_x,$|item_y
										image="scenery/tent-shop-weapons.png"
									[/item]
									
									[set_variables]
										name=scrollable_items
										mode=append
										[value]
											cat=event
											x=$|item_x
											y=$|item_y
											image="scenery/tent-shop-weapons.png"
											event="cf_ability_shop_$register_event_name"
											render=yes
										[/value]
									[/set_variables]
									
									{VARIABLE_OP item_y add 1}
									
									[item]
										x,y=$|item_x,$|item_y
										image="items/uws/red_key.png"
									[/item]
									
									[set_variables]
										name=scrollable_items
										mode=append
										[value]
											cat=event
											x=$|item_x
											y=$|item_y
											image="items/uws/red_key.png"
											event="key_$register_event_name"
											render=yes
										[/value]
									[/set_variables]
									
									[kill]
										id=$|unit.id
										fire_event=no
										animate=yes
									[/kill]

									[event]
										id=cf_ability_shop_$register_event_id
										name=cf_ability_shop_$register_event_id
										first_time_only=no
										delayed_variable_substitution=yes
										
										[message]
											speaker=narrator
											caption="Training Master of the Crystal Forest"
											image="portraits/humans/outlaw.webp"
											message="G'day my friend. As a token of our gratitude for saving Bob we will train you in one chosen ability. $|unit.id"
											[option]
												message="Regenerates +8 (Bob's level 0+)"
												[command]
													[modify_unit]
														[filter]
															id=$|unit.id
														[/filter]
														
														[object]
															silent=yes

															[effect]
																apply_to=new_ability
																[abilities]
																	[regenerate]
																        value=8
																        id=qquws_regenerates
																        name="regenerates 8"
																        description="The unit will heal itself 8 HP per turn. If it is poisoned, it will remove the poison instead of healing."
																        affect_self=yes
																        poison=cured
																    [/regenerate]
																[/abilities]
															[/effect]
														[/object]
													[/modify_unit]
											
													[remove_event]
														id=cf_ability_shop_$register_event_id
													[/remove_event]
													
													{VARIABLE uws_event_consumed yes}
												[/command]
											[/option]
											[option]
												message="Skirmisher (Bob's level 0+)"
												[command]
													[modify_unit]
														[filter]
															id=$|unit.id
														[/filter]
														
														[object]
															silent=yes

															[effect]
																apply_to=new_ability
																[abilities]
																	{ABILITY_SKIRMISHER}
																[/abilities]
															[/effect]
														[/object]
													[/modify_unit]
											
													[remove_event]
														id=cf_ability_shop_$register_event_id
													[/remove_event]
													
													{VARIABLE uws_event_consumed yes}
												[/command]
											[/option]
											[option]
												message="MP +1, MC -1 (Bob's level 0+)"
												[command]
													[modify_unit]
														[filter]
															id=$|unit.id
														[/filter]
														
														[object]
															silent=yes

															[effect]
															    apply_to=movement
															    increase=1
															[/effect]
															[effect]
															    apply_to=movement_costs
															    replace=no
															    [movement_costs]
																	flat=-1
																	frozen=-1
																	forest=-1
																	hills=-1
																	mountains=-1
																	village=-1
																	swamp_water=-1
																	shallow_water=-1
																	deep_water=-1
																	reef=-1
																	castle=-1
																	cave=-1
																	sand=-1
																	fungus=-1
															    [/movement_costs]
															[/effect]
														[/object]
													[/modify_unit]
											
													[remove_event]
														id=cf_ability_shop_$register_event_id
													[/remove_event]
													
													{VARIABLE uws_event_consumed yes}
												[/command]
											[/option]
											[option]
												message="Illuminates (Bob's level 1+)"
												[command]
													[modify_unit]
														[filter]
															id=$|unit.id
														[/filter]
														
														[object]
															silent=yes

															[effect]
																apply_to=new_ability
																[abilities]
																	[illuminates]
																        id=illumination
																        value=25
																        max_value=25
																        cumulative=no
																        name="illuminates"
																        female_name="female^illuminates"
																        description="This unit illuminates the surrounding area, making lawful units fight better, and chaotic units fight worse.

Any units adjacent to this unit will fight as if it were dusk when it is night, and as if it were day when it is dusk."
																        affect_self=yes
																        halo_image="halo/illuminates-aura.png"
																    [/illuminates]
																[/abilities]
															[/effect]
														[/object]
													[/modify_unit]
											
													[remove_event]
														id=cf_ability_shop_$register_event_id
													[/remove_event]
													
													{VARIABLE uws_event_consumed yes}
												[/command]
												[show_if]
													[variable]
														name=escorted_unit_level_$register_event_id
														greater_than=0
													[/variable]
												[/show_if]
											[/option]
											[option]
												message="Heals +10 (Bob's level 1+)"
												[command]
													[modify_unit]
														[filter]
															id=$|unit.id
														[/filter]
														
														[object]
															silent=yes

															[effect]
																apply_to=new_ability
																[abilities]
																	[heals]
																        value=12
																        id=healing
																        affect_allies=yes
																        name="heals +12"
																        description="This unit combines herbal remedies with magic to heal units more quickly than is normally possible on the battlefield.

A unit cared for by this healer may heal up to 10 HP per turn, or stop poison from taking effect for that turn.
This ability will not cure an affected unit of poison, however, only delay its effect."
																        affect_self=no
																        poison=slowed
																        [affect_adjacent]
																        [/affect_adjacent]
																    [/heals]
																[/abilities]
															[/effect]
														[/object]
													[/modify_unit]
											
													[remove_event]
														id=cf_ability_shop_$register_event_id
													[/remove_event]
													
													{VARIABLE uws_event_consumed yes}
												[/command]
												[show_if]
													[variable]
														name=escorted_unit_level_$register_event_id
														greater_than=0
													[/variable]
												[/show_if]
											[/option]
											[option]
												message="Defense everywhere +5 (Bob's level 1+)"
												[command]
													[modify_unit]
														[filter]
															id=$|unit.id
														[/filter]
														
														[object]
															silent=yes

															[effect]
																apply_to=defense
																replace=no
																[defense]
																	flat=-5
																	frozen=-5
																	forest=-5
																	hills=-5
																	mountains=-5
																	village=-5
																	swamp_water=-5
																	shallow_water=-5
																	deep_water=-5
																	reef=-5
																	castle=-5
																	cave=-5
																	sand=-5
																	fungus=-5
																[/defense]
															[/effect]
														[/object]
													[/modify_unit]
											
													[remove_event]
														id=cf_ability_shop_$register_event_id
													[/remove_event]
													
													{VARIABLE uws_event_consumed yes}
												[/command]
												[show_if]
													[variable]
														name=escorted_unit_level_$register_event_id
														greater_than=0
													[/variable]
												[/show_if]
											[/option]
											[option]
												message="Diversion (Bob's level 1+)"
												[command]
													[modify_unit]
														[filter]
															id=$|unit.id
														[/filter]
														
														[object]
															silent=yes

															[effect]
																apply_to=new_ability
																[abilities]
																	{ABILITY_DIVERSION}
																[/abilities]
															[/effect]
														[/object]
													[/modify_unit]
											
													[remove_event]
														id=cf_ability_shop_$register_event_id
													[/remove_event]
													
													{VARIABLE uws_event_consumed yes}
												[/command]
												[show_if]
													[variable]
														name=escorted_unit_level_$register_event_id
														greater_than=0
													[/variable]
												[/show_if]
											[/option]
											[option]
												message="Damage +20% (Bob's level 2+)"
												[command]
													[modify_unit]
														[filter]
															id=$|unit.id
														[/filter]
														
														[object]
															silent=yes

															[effect]
															    apply_to=attack
															    increase_damage=20%
															[/effect]
														[/object]
													[/modify_unit]
											
													[remove_event]
														id=cf_ability_shop_$register_event_id
													[/remove_event]
													
													{VARIABLE uws_event_consumed yes}
												[/command]
												[show_if]
													[variable]
														name=escorted_unit_level_$register_event_id
														greater_than=1
													[/variable]
												[/show_if]
											[/option]
											[option]
												message="nighttime +1 strike, +25% dmg (Bob's level 3)"
												[command]
													[modify_unit]
														[filter]
															id=$|unit.id
														[/filter]
														
														[object]
															silent=yes

															[effect]
															    apply_to=attack
															    [set_specials]
															    	mode=append
																	[attacks]
																		id=qquws_night_strike
																		name="night strike"
																		description="Adds 1 strike and 25% damage when attacking during nighttime."
																		active_on=offense
																		apply_to=self
																		add=1
																		[filter_self]
																			[filter_location]
																				time_of_day_id=first_watch,midnight,second_watch
																			[/filter_location]
																		[/filter_self]
																	[/attacks]
																	[attacks]
																		id=qquws_night_strike_dmg
																		active_on=offense
																		apply_to=self
																		multiply=1.25
																		[filter_self]
																			[filter_location]
																				time_of_day_id=first_watch,midnight,second_watch
																			[/filter_location]
																		[/filter_self]
																	[/attacks]
															    [/set_specials]
															[/effect]
														[/object]
													[/modify_unit]
											
													[remove_event]
														id=cf_ability_shop_$register_event_id
													[/remove_event]
													
													{VARIABLE uws_event_consumed yes}
												[/command]
												[show_if]
													[variable]
														name=escorted_unit_level_$register_event_id
														greater_than=2
													[/variable]
												[/show_if]
											[/option]
											[option]
												message="Not now, I'll come back though."
												[command]
												[/command]
											[/option]
										[/message]
									[/event]
									
									[event]
										id=key_$register_event_id
										name=key_$register_event_id
										first_time_only=no
										delayed_variable_substitution=yes
										
										[message]
											id=$|unit.id
											message="A key? Where to? Hello?! Do I pick it up?"
											[option]
												message="Yes"
												[command]
													[modify_unit]
														[filter]
															id=$|unit.id
														[/filter]
														
														[object]
															id=qquws_temple_door_keykeeper
															take_only_once=no
															silent=yes

															[effect]
																apply_to=new_ability
																[abilities]
																	[dummy]
																		id=qquws_red_key
																		name="carries red key"
																		description="This unit carries a red key. No idea what it's for."
																	[/dummy]
																[/abilities]
															[/effect]
															[effect]
															    apply_to=overlay
															    add=misc/key.png
															[/effect]
														[/object]
													[/modify_unit]
											
													[remove_event]
														id=key_$register_event_id
													[/remove_event]
													
													{VARIABLE uws_event_consumed yes}
												[/command]
											[/option]
											[option]
												message="No"
												[command]
												[/command]
											[/option]
										[/message]
									[/event]
									
									{VARIABLE crystal_forest_consumed_$register_event_id yes}
								[/then]
								[else]
									[message]
										speaker=narrator
										caption="Gatekeeper of the Crystal Forest"
										image="portraits/humans/assassin.png"
										message="Who are you? Go away before I send my dogs after you!"
									[/message]
								[/else]
							[/if]
						[/else]
					[/if]
				[/event]
			[/case]
			
			[case]
				value="rfc_temple"
				
				[event]
					id=$register_event_id
					name=$register_event_name
					first_time_only=no
					delayed_variable_substitution=no
					
					[if]
						[have_unit]
							id=$|unit.id
							ability=qquws_red_key
							count=1
						[/have_unit]
						[then]
							[message]
								id=$|unit.id
								message="The key they gave us in the crystal forest fits in! Should I open the doors?"
								[option]
									message="Yes"
									[command]
										[message]
											speaker=narrator
											caption="Something..."
											message="HIHIHIHI HEHE HUHU WOOHOOHOO HIHIHEHOHUHOO FRESH HIHIHI MEATHIHI HOOHOOHOO"
										[/message]
										
										[message]
											id=$|unit.id
											message="What the..."
										[/message]

										{VARIABLE new_partial_data "{~add-ons/QQ_Ultimate_Wesnoth_Survival/maps/return_from_captivity_partial.map}"}
										{VARIABLE partial_location 68}
										{VARIABLE partial_length 9}
										 
										[if]
											[variable]
												name=unit.x
												less_than=$|uws_game.middle
											[/variable]
											[then]
												{VARIABLE substitution_mode left}
											[/then]
											[else]
												{VARIABLE substitution_mode right}
											[/else]
										[/if]
										
										[fire_event]
											name=substitute_mask_file
										[/fire_event]
										
										[remove_object]
											id=$|unit.id
						  					object_id=qquws_temple_door_keykeeper
										[/remove_object]

										{VARIABLE tormented_turn $|turn_number}
										{VARIABLE_OP tormented_turn add 1}
										{VARIABLE tormented_side 2}
										{VARIABLE affect_sides $uws_game.filter_west_human_sides}
										{VARIABLE tormented_x $|unit.x}
										{VARIABLE tormented_y $|unit.y}
										{VARIABLE_OP tormented_y sub 3}

										[if]
											[variable]
												name=unit.x
												less_than=$|uws_game.middle
											[/variable]
											[then]
												{VARIABLE_OP tormented_x sub 4}

												{VARIABLE unhide_item_id sacrificial_altar_left}
												[fire_event]
													name=unhide_item_on_map
												[/fire_event]
												
												{VARIABLE unhide_item_id temple_bones_left}
												[fire_event]
													name=unhide_item_on_map
												[/fire_event]
											[/then]
											[else]
												{VARIABLE tormented_side 5}
												{VARIABLE affect_sides $uws_game.filter_east_human_sides}
												{VARIABLE_OP tormented_x add 4}

												{VARIABLE unhide_item_id sacrificial_altar_right}
												[fire_event]
													name=unhide_item_on_map
												[/fire_event]
												
												{VARIABLE unhide_item_id temple_bones_right}
												[fire_event]
													name=unhide_item_on_map
												[/fire_event]
											[/else]
										[/if]
										
										[if]
											[variable]
												name=uws_game.mode
												equals=slash
											[/variable]
											[then]
												{VARIABLE affect_sides $uws_game.filter_human_sides}
											[/then]
										[/if]
										
										[unit]
											type=QQ_Tormented_Horror
											side=$|tormented_side
											to_variable=spawning_unit
											random_traits=no
											random_gender=no
											upkeep=loyal
											name="Long forgotten name"
											[status]
												invulnerable=yes
											[/status]
											[variables]
												has_item=no
												item_id=""
												has_gold=no
												gold_amount=0
												final_boss=no
												is_lava_safe=yes
												placement_y=$|unit.y
												is_stoic=no
												calls_for_help=no
												recruit_armored=0
												recruit_minion=""
											[/variables]
										[/unit]
										
										[unstore_unit]
											variable=spawning_unit
											find_vacant=yes
											x=$|tormented_x
											y=$|tormented_y
											fire_event=yes
										[/unstore_unit]
										
										{VARIABLE new_unit_spawn_id $|spawning_unit.id}
										{VARIABLE run_events_for_side $|tormented_side}
										{VARIABLE new_unit_spawn_champion "A12:B58:C63"}
										{VARIABLE new_unit_y $|tormented_side}
										{VARIABLE new_unit_spawn_quiet_bonus_id ""}
										{VARIABLE new_unit_bulky_value 0}
										{VARIABLE new_unit_beefy_value 0}
										{VARIABLE new_unit_armored_value 0}
										{VARIABLE new_unit_fast_value 0}
										{VARIABLE new_unit_agile_value 0}
										[fire_event]
											name=apply_new_unit_bonus
										[/fire_event]
										
										[set_variables]
											name=qquws_lasting_effect_information
											mode=append
											[value]
											    id=$|spawning_unit.id
											    side=$|tormented_side
											    end_of_effect_turn=$|tormented_turn
											    effect_type=invulnerability
											[/value]
										[/set_variables]

										[modify_unit]
											[filter]
												side=$|affect_sides
											[/filter]
											
											[status]
												slowed=yes
											[/status]
										[/modify_unit]
										
										{VARIABLE uws_event_consumed yes}
									[/command]
								[/option]
								[option]
									message="No"
									[command]
									[/command]
								[/option]
							[/message]
						[/then]
						[else]
							[message]
								id=$|unit.id
								message="The doors are locked and shut. I need the key to open."
							[/message]
						[/else]
					[/if]
				[/event]
			[/case]
			
			[case]
				value="rfc_altar"
				
				[event]
					id=$register_event_id
					name=$register_event_name
					first_time_only=no
					delayed_variable_substitution=no
					
					[message]
						id=$|unit.id
						message="This is the ancient sacrificial altar. You can sacrifice ONE of your units here. A sacrifice increases your leader's attributes by certain amount that depends on the sacrificed unit's level:

Level 1: +10% hp
Level 2: +20% hp, +10% dmg
Level 3: +30% hp, +20% dmg, +5 resistance
Level 4: +40% hp, +30% dmg, +10 resistance, +1 mp
Level 5: +50% hp, +40% dmg, +15 resistance, +2 mp, +5 defense

Do you want to sacrfice this unit?"
						[option]
							message="Yes"
							[command]
								[if]
									[variable]
										name=unit.canrecruit
										boolean_equals=yes
									[/variable]
									[then]
										[message]
											id=$|unit.id
											message="I don't think so..."
										[/message]
									[/then]
									[else]
										[store_unit]
											[filter]
												side=$|unit.side
												canrecruit=yes
											[/filter]
											
											variable=altar_side_leader
											mode=always_clear
										[/store_unit]
										
										{VARIABLE it_is_done no}
										
										[switch]
											variable=unit.level
											
											[case]
												value=0
												
												[message]
													speaker=narrator
													caption="Death"
													image="portraits/undead/spectre.png"
													message="Go away and don't waste my time."
												[/message]
											[/case]
											
											[case]
												value=1
												
												[modify_unit]
													[filter]
														id=$|altar_side_leader.id
													[/filter]
													
													[object]
														silent=yes
														
														[effect]
														    apply_to=hitpoints
														    increase=10%
														    increase_total=10%
														[/effect]
													[/object]
												[/modify_unit]
												
												{VARIABLE it_is_done yes}
											[/case]
											
											[case]
												value=2
												
												[modify_unit]
													[filter]
														id=$|altar_side_leader.id
													[/filter]
													
													[object]
														silent=yes
														
														[effect]
														    apply_to=attack
														    increase_damage=10%
														[/effect]
														
														[effect]
														    apply_to=hitpoints
														    increase=20%
														    increase_total=20%
														[/effect]
													[/object]
												[/modify_unit]
												
												{VARIABLE it_is_done yes}
											[/case]
											
											[case]
												value=3
												
												[modify_unit]
													[filter]
														id=$|altar_side_leader.id
													[/filter]
													
													[object]
														silent=yes
														
														[effect]
														    apply_to=attack
														    increase_damage=20%
														[/effect]
														
														[effect]
														    apply_to=hitpoints
														    increase=30%
														    increase_total=30%
														[/effect]
														
														[effect]
														    apply_to=capped_champion_resistance
														    [resistance]
															arcane=5
															cold=5
															fire=5
															blade=5
															impact=5
															pierce=5
														    [/resistance]
														[/effect]
													[/object]
												[/modify_unit]
												
												{VARIABLE it_is_done yes}
											[/case]
											
											[case]
												value=4
												
												[modify_unit]
													[filter]
														id=$|altar_side_leader.id
													[/filter]
													
													[object]
														silent=yes
														
														[effect]
														    apply_to=attack
														    increase_damage=30%
														[/effect]
														
														[effect]
														    apply_to=hitpoints
														    increase=40%
														    increase_total=40%
														[/effect]
														
														[effect]
														    apply_to=capped_champion_resistance
														    [resistance]
															arcane=10
															cold=10
															fire=10
															blade=10
															impact=10
															pierce=10
														    [/resistance]
														[/effect]
														
														[effect]
														    apply_to=movement
														    increase=1
														[/effect]
													[/object]
												[/modify_unit]
												
												{VARIABLE it_is_done yes}
											[/case]
											
											[case]
												value=5
												
												[modify_unit]
													[filter]
														id=$|altar_side_leader.id
													[/filter]
													
													[object]
														silent=yes
														
														[effect]
														    apply_to=attack
														    increase_damage=40%
														[/effect]
														
														[effect]
														    apply_to=hitpoints
														    increase=50%
														    increase_total=50%
														[/effect]
														
														[effect]
														    apply_to=capped_champion_resistance
														    [resistance]
															arcane=15
															cold=15
															fire=15
															blade=15
															impact=15
															pierce=15
														    [/resistance]
														[/effect]
														
														[effect]
														    apply_to=movement
														    increase=2
														[/effect]
														
														[effect]
														    apply_to=capped_champion_defense
														    [defense]
															flat=-5
															frozen=-5
															forest=-5
															village=-5
															swamp_water=-5
															cave=-5
															reef=-5
															shallow_water=-5
															deep_water=-5
															fungus=-5
															hills=-5
															mountains=-5
															castle=-5
															sand=-5
														    [/defense]
														[/effect]
													[/object]
												[/modify_unit]
												
												{VARIABLE it_is_done yes}
											[/case]
											
											[else]
												[message]
													speaker=narrator
													caption="Death"
													image="portraits/undead/spectre.png"
													message="This unit is too strong."
												[/message]
											[/else]
										[/switch]
										
										[if]
											[variable]
												name=it_is_done
												boolean_equals=yes
											[/variable]
											[then]
												[if]
													[variable]
														name=uws_game.mode
														equals=slash
													[/variable]
													[or]
														[variable]
															name=unit.side
															equals=8
														[/variable]
													[/or]
													[then]
														{VARIABLE unhide_item_id bloody_altar_left}
														[fire_event]
															name=unhide_item_on_map
														[/fire_event]
													[/then]
													[else]
														{VARIABLE unhide_item_id bloody_altar_right}
														[fire_event]
															name=unhide_item_on_map
														[/fire_event]
													[/else]
												[/if]

												[harm_unit]
													[filter]
														id=$|unit.id
													[/filter]

													amount=100000
													kill=yes
													fire_event=yes
													experience=no
													animate=yes
													delay=500
												[/harm_unit]
												
												[message]
													speaker=narrator
													caption="Death"
													image="portraits/undead/spectre.png"
													message="It is done!"
												[/message]
												
												{VARIABLE uws_event_consumed yes}
											[/then]
										[/if]
									[/else]
								[/if]
							[/command]
						[/option]
						[option]
							message="No"
							[command]
							[/command]
						[/option]
					[/message]
				[/event]
			[/case]
			
			[case]
				value="rfc_bones"
				
				{VARIABLE bones_consumed_$register_event_id no}
				[event]
					id=$register_event_id
					name=$register_event_name
					first_time_only=no
					delayed_variable_substitution=no
					
					[if]
						[variable]
							name=bones_consumed_$register_event_id
							boolean_equals=yes
						[/variable]
						[then]
							[message]
								id=$|unit.id
								message="No more scrolls in here!"
							[/message]
						[/then]
						[else]
							{VARIABLE item_y $|unit.y}
							{VARIABLE_OP item_y add 1}
							
							[item]
								x,y=$|unit.x,$|item_y
								image="items/uws/scroll.png"
							[/item]
							
							[message]
								id=$|unit.id
								message="Look! There's a scroll here!"
							[/message]
							
							[set_variables]
								name=scrollable_items
								mode=append
								[value]
									cat=event
									x=$|unit.x
									y=$|item_y
									image="items/uws/scroll.png"
									event="book2_$register_event_name"
									render=yes
								[/value]
							[/set_variables]
									
							{VARIABLE bones_consumed_$register_event_id yes}
							
							[event]
								id=book2_$register_event_id
								name=book2_$register_event_id
								first_time_only=no
								delayed_variable_substitution=no
								
								[message]
									id=$|unit.id
									message="There is some writing on this sroll, no idea what it means. Do I want to take it?"
									[option]
										message="Yes"
										[command]
											[modify_unit]
												[filter]
													id=$|unit.id
												[/filter]
												
												[object]
													id=qquws_temple_scrollkeeper
													take_only_once=no
													silent=yes

													[effect]
														apply_to=new_ability
														[abilities]
															[dummy]
																id=qquws_carries_scroll
																name="carries scroll"
																description="This unit carries a scroll with strange writing. No idea what it says."
															[/dummy]
														[/abilities]
													[/effect]
													[effect]
													    apply_to=overlay
													    add=halo/uws/scroll.png
													[/effect]
												[/object]
											[/modify_unit]
									
											[remove_event]
												id=book2_$register_event_id
											[/remove_event]
											
											{VARIABLE uws_event_consumed yes}
										[/command]
									[/option]
									[option]
										message="No"
										[command]
										[/command]
									[/option]
								[/message]
							[/event]
						[/else]
					[/if]
				[/event]
			[/case]
			
			[case]
				value=rfc_shop
				
				{VARIABLE show_extra_$register_event_id no}
				
				{VARIABLE shop_$register_event_id|_0_types "AE_agl_deep_Seeker,AE_agl_deep_Baroness_of_the_Night,AE_agl_deep_Shadow_Tyrhai"}
				{VARIABLE shop_$register_event_id|_0_default_types "Dune Wayfarer,Dune Sky Hunter,Dune Windbolt"}
				{VARIABLE shop_$register_event_id|_0_rank_kills_range "32..38"}
				{VARIABLE shop_$register_event_id|_0_is_extra no}
				{VARIABLE shop_$register_event_id|_0_is_available yes}
				{VARIABLE shop_$register_event_id|_0_cost_range "16..24"}
				
				{VARIABLE shop_$register_event_id|_1_types "AE_agl_dark_legion_War_Drone,AE_agl_dark_legion_Enforcer_Drone,AE_agl_dark_legion_Stormblade"}
				{VARIABLE shop_$register_event_id|_1_default_types "Dwarvish Sentinel,Dwarvish Runemaster,Dwarvish Explorer"}
				{VARIABLE shop_$register_event_id|_1_rank_kills_range "44..48"}
				{VARIABLE shop_$register_event_id|_1_is_extra no}
				{VARIABLE shop_$register_event_id|_1_is_available yes}
				{VARIABLE shop_$register_event_id|_1_cost_range "24..32"}
				
				{VARIABLE shop_$register_event_id|_2_types "AE_stf_eventide_Guardian_of_Noct,AE_stf_eventide_Eventide_Poisoner,AE_stf_eventide_Diu_Keenshot"}
				{VARIABLE shop_$register_event_id|_2_default_types "Paladin,Silver Mage,Royal Warrior"}
				{VARIABLE shop_$register_event_id|_2_rank_kills_range "50..54"}
				{VARIABLE shop_$register_event_id|_2_is_extra no}
				{VARIABLE shop_$register_event_id|_2_is_available yes}
				{VARIABLE shop_$register_event_id|_2_cost_range "32..40"}
				
				{VARIABLE shop_$register_event_id|_3_types "AE_rhy_fh_Ancient_Druid,AE_chs_sylvians_Elvish_Avatar,AE_rhy_lz_Seraph"}
				{VARIABLE shop_$register_event_id|_3_default_types "Armageddon Drake,Dune Paragon,Ancient Lich"}
				{VARIABLE shop_$register_event_id|_3_rank_kills_range "60..66"}
				{VARIABLE shop_$register_event_id|_3_is_extra yes}
				{VARIABLE shop_$register_event_id|_3_is_available no}
				{VARIABLE shop_$register_event_id|_3_cost_range "40..52"}
				
				{VARIABLE shop_$register_event_id|_4_types "QQ_abomination,QQ_terror_hulk,QQ_sunrise_guard"}
				{VARIABLE shop_$register_event_id|_4_default_types "QQ_abomination,QQ_terror_hulk,QQ_sunrise_guard"}
				{VARIABLE shop_$register_event_id|_4_rank_kills_range "72..76"}
				{VARIABLE shop_$register_event_id|_4_is_extra yes}
				{VARIABLE shop_$register_event_id|_4_is_available no}
				{VARIABLE shop_$register_event_id|_4_cost_range "52..64"}
				
				[for]
					variable=i
					start=0
					end=4
					step=1
					[do]
						{VARIABLE shop_unit_types $shop_$register_event_id|_$i|_types}
						[if]
							[variable]
								name=random_pool.allow_ae
								boolean_equals=no
							[/variable]
							[then]
								{VARIABLE shop_unit_types $shop_$register_event_id|_$i|_default_types}
							[/then]
						[/if]
						
						{VARIABLE_OP select_type rand $shop_unit_types}
						
						[store_unit_type]
							variable=shop_unit_type
							mode=always_clear
							type=$select_type
						[/store_unit_type]
						
						{VARIABLE shop_$register_event_id|_$i|_type $select_type}
						{VARIABLE shop_$register_event_id|_$i|_name $shop_unit_type.name}
						{VARIABLE shop_$register_event_id|_$i|_image $shop_unit_type.image}
						{VARIABLE shop_$register_event_id|_$i|_level $shop_unit_type.level}
						{VARIABLE_OP shop_unit_kills rand "$shop_$register_event_id|_$i|_rank_kills_range"}
						{VARIABLE shop_$register_event_id|_$i|_rank_kills $shop_unit_kills}
						{VARIABLE_OP shop_$register_event_id|_$i|_cost rand $shop_$register_event_id|_$i|_cost_range}
						
						[if]
							[variable]
								name=shop_unit_kills
								greater_than_equal_to=$threshold_notable
							[/variable]
							[then]
								{VARIABLE promotion_label notable}
								{VARIABLE promotion_colour $rank_notable_color}
								{VARIABLE promotion_rank 3}
								{VARIABLE promotion_dmg_bonus 33}
							[/then]
							[else]
								[if]
									[variable]
										name=shop_unit_kills
										greater_than_equal_to=$threshold_proven
									[/variable]
									[then]
										{VARIABLE promotion_label proven}
										{VARIABLE promotion_colour $rank_proven_color}
										{VARIABLE promotion_rank 2}
										{VARIABLE promotion_dmg_bonus 20}
									[/then]
									[else]
										[if]
											[variable]
												name=shop_unit_kills
												greater_than_equal_to=$threshold_initiated
											[/variable]
											[then]
												{VARIABLE promotion_label initiated}
												{VARIABLE promotion_colour $rank_initiated_color}
												{VARIABLE promotion_rank 1}
												{VARIABLE promotion_dmg_bonus 10}
											[/then]
										[/if]
									[/else]
								[/if]
							[/else]
						[/if]
						
						{VARIABLE shop_$register_event_id|_$i|_rank "<span color='$promotion_colour'>$promotion_label</span>"}
						{VARIABLE shop_$register_event_id|_$i|_rank_level $promotion_rank}
						{VARIABLE shop_$register_event_id|_$i|_dmg_bonus $promotion_dmg_bonus}
					[/do]
				[/for]
				
				[event]
					id=$register_event_id
					name=$register_event_name
					first_time_only=no
					delayed_variable_substitution=no
					
					{VARIABLE shop_units_available 0}
					[for]
						variable=i
						start=0
						end=4
						step=1
						[do]
							[if]
								[variable]
									name=shop_$register_event_id|_$|i|_is_available
									boolean_equals=yes
								[/variable]
								[then]
									[if]
										[variable]
											name=shop_$register_event_id|_$|i|_is_extra
											boolean_equals=yes
										[/variable]
										[then]
											[if]
												[variable]
													name=show_extra_$register_event_id
													boolean_equals=yes
												[/variable]
												[then]
													{VARIABLE_OP shop_units_available add 1}
												[/then]
											[/if]
										[/then]
										[else]
											{VARIABLE_OP shop_units_available add 1}
										[/else]
									[/if]
								[/then]
							[/if]
						[/do]
					[/for]
					
					[if]
						[variable]
							name=shop_units_available
							greater_than=0
						[/variable]
						[or]
							[have_unit]
								id=$|unit.id
								ability=qquws_carries_scroll
							[/have_unit]
						[/or]
						[then]
							[message]
								speaker=narrator
								caption="Business Owner"
								image="portraits/humans/ruffian.png"
								message="Welcome welcome my dear customers in the mercenaries' guild. What can I get you? What do you need? Brain or muscle? For a good fee we catter to all tastes and needs!"
							[/message]
							
							[if]
								[have_unit]
									id=$|unit.id
									ability=qquws_carries_scroll
								[/have_unit]
								[and]
									[variable]
										name=show_extra_$register_event_id
										boolean_equals=no
									[/variable]
								[/and]
								[then]
									[message]
										speaker=narrator
										caption="Business Owner"
										image="portraits/humans/ruffian.png"
										message="Do you mind if I have a look at this scroll that burdens you unnecessarily. Ah yes, yes, please, we normally don't offer our finest... assets to our customers, but for such a distinctive guest like you I believe an exception is in order. Please, make yourself comfortable."
									[/message]
									
									{VARIABLE show_extra_$register_event_id yes}
									
									[remove_object]
										id=$|unit.id
					  					object_id=qquws_temple_scrollkeeper
									[/remove_object]
									
									{VARIABLE "shop_$register_event_id|_3_is_available" yes}
									{VARIABLE "shop_$register_event_id|_4_is_available" yes}
								[/then]
							[/if]
							
							{VARIABLE inside_shop yes}
							[while]
								[variable]
									name=inside_shop
									boolean_equals=yes
								[/variable]
								[do]
									[store_gold]
										side=$|side_number
										variable=current_gold_amount
									[/store_gold]
									
									[message]
										speaker=narrator
										caption="Business Owner"
										image="portraits/humans/ruffian.png"
										message="Who would you like to hire?"
										
										{RFC5_MERCENARY_SHOP_OPTION 0}
										{RFC5_MERCENARY_SHOP_OPTION 1}
										{RFC5_MERCENARY_SHOP_OPTION 2}
										{RFC5_MERCENARY_SHOP_OPTION 3}
										{RFC5_MERCENARY_SHOP_OPTION 4}
										
										[option]
											message="exit the shop"
											[command]
												{VARIABLE inside_shop no}
											[/command]
										[/option]
									[/message]
								[/do]
							[/while]
							
							[if]
								[variable]
									name=show_extra_$register_event_id
									boolean_equals=yes
								[/variable]
								[then]
									[message]
										speaker=narrator
										caption="Business Owner"
										image="portraits/humans/ruffian.png"
										message="Thank you for your visit. Remember, we provide services for any job you need and your gold is always welcome!"
									[/message]
								[/then]
								[else]
									[message]
										speaker=narrator
										caption="Business Owner"
										image="portraits/humans/ruffian.png"
										message="Thank you for your visit. Remember, we provide services for any job you need and your gold is always welcome! By the way, we are looking for a piece of an old parchment, that one of our customers have ekhem... lost recently. If you happen to find it, please return it and I'm sure we will find a common language here."
									[/message]
								[/else]
							[/if]
						[/then]
						[else]
							[message]
								speaker=narrator
								caption="Business Owner"
								image="portraits/humans/ruffian.png"
								message="Welcome welcome my dear customers in the mercenaries' guild. I'm afraid though that at the moment we don't have any mercenaries to hire."
							[/message]
						[/else]
					[/if]
				[/event]
			[/case]

			[case]
				value=hand_over_dwarvish_key

				{VARIABLE dwarvish_key_consumed_$register_event_id no}
				[event]
					id=$register_event_id
					name=$register_event_name
					first_time_only=no
					delayed_variable_substitution=no
					
					[if]
						[variable]
							name=dwarvish_key_consumed_$register_event_id
							boolean_equals=yes
						[/variable]
						[then]
							[message]
								id=$|unit.id
								message="Go away and find the door!"
							[/message]
						[/then]
						[else]
							[message]
								speaker=narrator
								caption="Old man in the hut"
								image="portraits/dwarves/fighter-2.webp"
								message="G'day to you, wanderer in these accursed lands. I am an old and dying man, this lonely hut will soon become my grave. Once upon a time I was also a great traveller, just like you, but my breath is short these days. Long time ago I found this key that I would like to give you. I have never found out what door does it open, but maybe you'll be more lucky than me. Good luck."
							[/message]

							[modify_unit]
								[filter]
									id=$|unit.id
								[/filter]
								
								[object]
									id=qquws_dwarvish_door_keykeeper
									take_only_once=no
									silent=yes
									[effect]
										apply_to=new_ability
										[abilities]
											[dummy]
												id=qquws_carries_dwarvish_key
												name="key keeper"
												description="This unit carries the key that the old man gave. It must open something somewhere."
											[/dummy]
										[/abilities]
									[/effect]
									[effect]
									    apply_to=overlay
									    add=misc/key.png
									[/effect]
								[/object]
							[/modify_unit]

							{VARIABLE dwarvish_key_consumed_$register_event_id yes}
						[/else]
					[/if]
				[/event]
			[/case]

			[case]
				value=dwarvish_door

				[event]
					id=$register_event_id
					name=$register_event_name
					first_time_only=no
					delayed_variable_substitution=no
					
					[if]
						[have_unit]
							id=$|unit.id
							ability=qquws_carries_dwarvish_key
							count=1
						[/have_unit]
						[then]
							[message]
								id=$|unit.id
								message="The key the old man gave me in the hut can open this door! Should I?"
								[option]
									message="Yes"
									[command]
										{VARIABLE new_partial_data "{~add-ons/QQ_Ultimate_Wesnoth_Survival/maps/valley_partial_1.map}"}
										{VARIABLE partial_location 106}
										{VARIABLE partial_length 7}
										 
										[if]
											[variable]
												name=unit.x
												less_than=$|uws_game.middle
											[/variable]
											[then]
												{VARIABLE substitution_mode left}
											[/then]
											[else]
												{VARIABLE substitution_mode right}
											[/else]
										[/if]
										
										[fire_event]
											name=substitute_mask_file
										[/fire_event]

										[remove_object]
											id=$|unit.id
						  					object_id=qquws_dwarvish_door_keykeeper
										[/remove_object]

										[if]
											[variable]
												name=unit.x
												less_than=$|uws_game.middle
											[/variable]
											[then]
												{VARIABLE unhide_item_id von_dwarvish_secret_1_left}
												[fire_event]
													name=unhide_item_on_map
												[/fire_event]
												
												{VARIABLE unhide_item_id von_dwarvish_secret_2_left}
												[fire_event]
													name=unhide_item_on_map
												[/fire_event]
											[/then]
											[else]
												{VARIABLE unhide_item_id von_dwarvish_secret_1_right}
												[fire_event]
													name=unhide_item_on_map
												[/fire_event]
												
												{VARIABLE unhide_item_id von_dwarvish_secret_2_right}
												[fire_event]
													name=unhide_item_on_map
												[/fire_event]
											[/else]
										[/if]
										
										{VARIABLE uws_event_consumed yes}
									[/command]
								[/option]
								[option]
									message="No"
									[command]
									[/command]
								[/option]
							[/message]
						[/then]
						[else]
							[message]
								id=$|unit.id
								message="There is a secret door behind the throne, but the door is locked and shut. I need the key to open."
							[/message]
						[/else]
					[/if]
				[/event]
			[/case]
		[/switch]
	[/event]
#enddef

#define RFC5_MERCENARY_SHOP_OPTION ID
	[option]
		message="level $shop_$register_event_id|_{ID}_level $shop_$register_event_id|_{ID}_rank"
		image="$shop_$register_event_id|_{ID}_image"
		label="$shop_$register_event_id|_{ID}_name
$shop_$register_event_id|_{ID}_cost gold"
		[command]
			{VARIABLE unit_cost $shop_$register_event_id|_{ID}_cost}
			{VARIABLE shop_unit_type $shop_$register_event_id|_{ID}_type}
			
			[if]
				[variable]
					name=current_gold_amount
					greater_than_equal_to=$|unit_cost
				[/variable]
				[then]
					[unit]
						side=$|side_number
						type=$|shop_unit_type
						id=shop_$register_event_id|_{ID}
						x=$|unit.x
						y=$|unit.y
						passable=yes
						[variables]
							kills=$shop_$register_event_id|_{ID}_rank_kills
							promotion_level=$shop_$register_event_id|_{ID}_rank_level
							items_picked_up=""
						[/variables]
					[/unit]
					
					[modify_unit]
						[filter]
							id=shop_$register_event_id|_{ID}
						[/filter]
				
						[object]
							silent=yes

							[effect]
							    apply_to=attack
							    increase_damage="$shop_$register_event_id|_{ID}_dmg_bonus|%"
							[/effect]
						[/object]
					[/modify_unit]
					
					[fire_event]
						name=promote_unit
						[primary_unit]
						    id=shop_$register_event_id|_{ID}
						[/primary_unit]
					[/fire_event]

					[fire_event]
						name=apply_uws_amla_mod
						[primary_unit]
							id=shop_$register_event_id|_{ID}
						[/primary_unit]
					[/fire_event]
					
					{VARIABLE shop_$register_event_id|_{ID}_is_available no}
					
					[gold]
						side=$|side_number
						amount=-$|unit_cost
					[/gold]
					
					[message]
						speaker=narrator
						caption="Business Owner"
						image="portraits/humans/ruffian.png"
						message="Excellent choice!"
					[/message]
				[/then]
				[else]
					[message]
						speaker=narrator
						caption="Business Owner"
						image="portraits/humans/ruffian.png"
						message="Hey, we are not a charity alright? The price is final. Pay it or go away."
					[/message]
				[/else]
			[/if]
		[/command]
		[show_if]
			[variable]
				name=shop_$register_event_id|_{ID}_is_available
				boolean_equals=yes
			[/variable]
		[/show_if]
	[/option]
#enddef

