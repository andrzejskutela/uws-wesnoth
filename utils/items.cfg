#define INIT_ITEMS_DATA
	[set_variables]
		name=items_steps
		mode=replace
		[value] # steps
			magic_res="5/3/4/6/7/10"
			cold_res="10/10/10/10/20/25"
			phys_res="5/3/4/6/7/10"
			impact_res="10/10/10/10/20/25"
			fire_res="10/10/10/10/20/25"
			arcane_res="10/10/10/10/20/25"
			blade_res="10/10/10/10/20/25"
			pierce_res="10/10/10/10/20/25"
			hp_low="5/5/5/5/5/10"
			hp_med="10/5/5/10/10/10"
			hp_high="10/10/10/10/10/15"
			steadfast="25/40/50/50/60/75"
			regen="2/4/8/10/14/20"
			melee_dmg="10/10/10/10/10/15"
			ranged_dmg="10/10/10/10/10/15"
			ranged_acc="2/2/2/3/3/3"
			melee_parry="2/2/2/3/3/3"
			melee_poison="0/2/1/1/1/0"
			melee_slow="1/0/0/0/0/0"
			mp="1/0/1/0/1/2"
			feeding="1/1/1/1/1/2"
			leadership="15/20/25/30/40/65"
			drain="20/35/50/50/65/75"
			defense="0/1/1/1/1/1"
			skirm="1/0/0/0/0/0"
			first_strike="1/0/0/0/0/0"
			fear="1/0/0/0/0/0"
			discouragement="1/0/0/0/0/0"
			burns="2/4/8/12/20/32"
			golden_armor="4/3/3/4/4/7"
			heal="2/4/8/12/16/25"
			freezing_gem="0/1/2/3/4/5"
			field_disruption="5/10/15/20/25/35"
			armor_destruction="0/1/2/3/4/5"
			protection="5/10/15/20/25/30"
			double_attack="7/6/5/4/3/2"
			hitn_run="1/0/0/1/0/0"
			extra_strikes="40/50/60/70/80/100"
			rat_pack="6/5/4/3/2/1"
			icewind_aura="1/2/3/5/7/9"
			dragon_protection="10/20/30/50/85/999"
		[/value]
		[value] # name
			magic_res="Magic Mastery"
			cold_res="Cold Mastery"
			phys_res="Physical Mastery"
			impact_res="Impact Mastery"
			fire_res="Fire Mastery"
			arcane_res="Arcane Mastery"
			blade_res="Blade Mastery"
			pierce_res="Pierce Mastery"
			hp_low="Potion of Health"
			hp_med="Ring of Endurance"
			hp_high="Talisman of Vitality"
			steadfast="Amulet of Devotion"
			regen="Charm of Regeneration"
			melee_dmg="War Sword"
			ranged_dmg="Crystal Bow"
			ranged_acc="Elven Ring of Accuracy"
			melee_parry="Battle Staff"
			melee_poison="Assassin's Dagger"
			melee_slow="Chronomancer's Staff"
			mp="Potion of Swiftness"
			feeding="Necronomicon"
			leadership="Celestial Hammer"
			drain="Staff of Dark Sorcery"
			defense="Potion of Agility"
			skirm="Potion of Dexterity"
			first_strike="Ceremonial Spear"
			fear="Necromancer's Bane"
			discouragement="Potion of Hindrance"
			burns="Torch of the Secret Fire"
			golden_armor="Golden Armor"
			heal="Potion of Rejuvenation"
			freezing_gem="Gem of Hoarfrost"
			field_disruption="Sorcerer's Battle Armor"
			armor_destruction="The Scythe"
			protection="Talisman of Protection"
			double_attack="Elven Royal Bow"
			hitn_run="Hitman's Cloak"
			extra_strikes="Battle Gauntlets"
			rat_pack="Rodent Breeder"
			icewind_aura="IceLord's Protection"
			dragon_protection="Dragon's Protection"
		[/value]
		[value] # step labels for display
			magic_res="+5% magic res/+8% magic res/+12% magic res/+18% magic res, 5% negation/+25% magic res, 10% negation/+35% magic res, 20% negation" 
			cold_res="+10% cold/+20% cold/+30% cold/+40% cold + decent weapon/+60% cold + powerful weapon/+85% cold + mythical weapon"
			phys_res="+5% phys res/+8% phys res/+12% phys res/+18% phys res, 5% reduction/+25% phys res, 10% reduction/+35% phys res, 20% reduction"
			impact_res="+10% impact/+20% impact/+30% impact/+40% impact + decent weapon/+60% impact + powerful weapon/+85% impact + mythical weapon"
			fire_res="+10% fire/+20% fire/+30% fire/+40% fire + decent weapon/+60% fire + powerful weapon/+85% fire + mythical weapon"
			arcane_res="+10% arcane/+20% arcane/+30% arcane/+40% arcane + decent weapon and ability/+60% arcane + powerful weapon/+85% arcane + mythical ability"
			blade_res="+10% blade/+20% blade/+30% blade/+40% blade + decent weapon/+60% blade + powerful weapon/+85% blade + mythical weapon"
			pierce_res="+10% pierce/+20% pierce/+30% pierce/+40% pierce + decent weapon/+60% pierce + powerful weapon/+85% pierce + mythical weapon"
			hp_low="+5% hp/+10% hp/+15% hp/+20% hp, unpoisonable/+25% hp, unpoisonable/+35% hp, unpoisonable aura"
			hp_med="+10% hp/+15% hp/+20% hp/+30% hp, undrainable/+40% hp, undrainable/+50% hp, undrainable aura"
			hp_high="+10% hp/+20% hp/+30% hp/+40% hp, heals all +2/+50% hp, heals all +4/+65% hp, restores all +8"
			steadfast="x1.5 25% max/x1.75 40% max/x2 50% max/x2 50% max, adjacent x2 20% max/x2.25 60% max, adjacent x2 30% max/x2.5 75% max, adjacent x2 40% max"
			regen="+2/+4/+8/+10 (village +14)/+14 (village +20)/+20 (village +32)"
			melee_dmg="+10%/+20%/+30%/+40%, fury +1/+50%, fury +2/+65%, fearless, fury +3"
			ranged_dmg="+10%/+20%/+30%/+40% + ruthless/+50% + ruthless/+65% + merciless"
			ranged_acc="+2/+4/+6/+9, concentration +2/+12, concentration +3/+15, concentration +5"
			melee_parry="+2/+4/+6/+9 + 2% def/+12 + 3% def/+15 + 5% def"
			melee_poison="poison/+2 acc/+3 acc/+4 acc, 1.2x backstab/+5 acc, 1.5x backstab/+5 acc, 2x backstab"
			melee_slow="day only melee slow/day, dawn and dusk melee slow/melee slow/melee slow/melee slow, lesser chronosphere/melee slow, chronosphere"
			mp="+1 mp/+1 mp/+2 mp/+2 mp, immune to slow/+3 mp, immune to slow/+4 mp, unslowable aura"
			feeding="max+1/max+1/max+1/max+1, 15%(lvl0)/max+1, 15%(lvl1)/max+2, 20%(lvl2)"
			leadership="leadership 15%/leadership 20%/leadership 25%/leadership 30%/leadership 40%/leadership 65%, fearless"
			drain="20/35/50/50(wicked)/65(wicked)/75(unholy)"
			defense="+2% def/+3% def, -1mc/+4% def, -2mc/+5% def, -3mc/+7% def, -4mc/+10% def, -5mc, magic counter"
			skirm="nighttime only skirmisher/dawn, dusk and night skirmisher/skirmisher/skirmisher, +1 mp/skirmisher +2 mp, battle fervor +1/skirmisher, +2 mp, battle fervor +2, enemy control"
			first_strike="melee/melee/all attacks/all attacks/preemptive strike/initiative, eagerness aura"
			fear="5% attack, 0%(10%) lvl0(r1)/5% attack, 5%(10%) lvl1(r1)/10% attack, 5%(15%) lvl2(r2)/15% attack, 10%(20%) lvl3(r3), +1 heal on hit/20% attack, 10%(25%) lvl4(r4), +2 heal on hit/25% attack, 15%(30%) lvl5(r5), +3 heal on hit, fearless"
			discouragement="m/m/m/m+r/m+r +5% parry/m+r +5% parry, dishearten 20%"
			burns="2/4/8/12/20/32"
			golden_armor="+4% res/+7% res/+10% res/+14% res, reflects 10%/+18% res, reflects 20%/+25% res, reflects 35%"
			heal="+2/+4/+8/+12/+16/+25"
			freezing_gem="+5% cold/+5% cold, freezing touch -1/+5% cold, freezing touch -2/+15% cold, freezing touch -3/+15% cold, freezing touch -4/+25% cold, freezing touch -5"
			field_disruption="-5/-10/-15/-20/-25/-35"
			armor_destruction="+1 dmg/+1 dmg, -1 res per hit/+1 dmg, -2 res per hit/+2 dmg, -3 res per hit/+2 dmg, -4 res per hit/+3 dmg, -5 res per hit"
			protection="protection +5/protection +10/protection +15/protection +20, defensive wall 1.15/protection +25, defensive wall 1.3/protection +30, impenetrable wall 1.5"
			double_attack="7 to charge/6 to charge/5 to charge/4 to charge/3 to charge/2 to charge"
			hitn_run="nightstalk/nightstalk, kill +1/nightstalk, kill +1/nightstalk, hit +1/nightstalk, hit +2/nightstalk, hit +3, cover of the night"
			extra_strikes="below 50%/below 65% and 30%/always +1/always +1, extra below 50%, accuracy +2/always +1, extra below 65% and 30%, accuracy +3/always +2, extra below 50%, accuracy +5"
			rat_pack="every 6 turns/every 5 turns/every 4 turns/every 3 turns/every 2 turns/every turn, plague on melee"
			icewind_aura="1 radius/2 radius/3 radius, 1 cold damage/5 radius, 2 cold damage/7 radius, 3 cold damage/9 radius, 5 cold damage"
			dragon_protection="10hp(1hp)/20hp(5hp)/30hp(10hp)/50hp(15hp)/85hp(25hp)/always(35hp)"
		[/value]
		[value] # image
			magic_res="items/ball-magenta.png"
			cold_res="items/ball-blue.png"
			phys_res="items/ball-green.png"
			impact_res="scenery/trapdoor-closed.png"
			fire_res="items/ring-red.png"
			arcane_res="items/talisman-bone.png"
			blade_res="items/buckler.png"
			pierce_res="items/armor.png"
			hp_low="items/potion-red.png"
			hp_med="items/ring-brown.png"
			hp_high="items/ankh-necklace.png"
			steadfast="items/necklace-stone.png"
			regen="items/ankh-necklace2.png"
			melee_dmg="items/flame-sword-bare.png"
			ranged_dmg="items/bow-crystal-2.png"
			ranged_acc="items/ring-silver.png"
			melee_parry="items/staff-plain.png"
			melee_poison="items/dagger-poison.png"
			melee_slow="items/staff-magic-2.png"
			mp="items/potion-yellow.png"
			feeding="items/book5.png"
			leadership="items/hammer-runic.png"
			drain="items/staff.png"
			defense="items/potion-grey.png"
			skirm="items/potion-blue.png"
			first_strike="items/spear-fancy-2.png"
			fear="items/sword-wraith.png"
			discouragement="items/potion-poison.png"
			burns="items/torch.png"
			golden_armor="items/armor-golden.png"
			heal="items/holy-water.png"
			freezing_gem="items/uws/freezing_gem.png"
			field_disruption="items/uws/disruptor.png"
			armor_destruction="items/uws/cutter.png"
			protection="items/uws/protection.png"
			double_attack="items/bow-elven.png"
			hitn_run="items/uws/cloak.png"
			extra_strikes="items/uws/gauntlets.png"
			rat_pack="items/leather-pack.png"
			icewind_aura="items/uws/icewind.png"
			dragon_protection="items/uws/armor-dragon.png"
		[/value]
		[value] # short description for all items menu
			magic_res="Adds resistance to magical attack types.
			
<span color='#5b8742'>Negates Magic</span>: improves magical resistance of all allied units on the map by certain amount."

			cold_res="Adds cold resistance.

<span color='#7375e6'>Time Lock</span>: attack only, both the attacker and defender go into the time lock. For a duration of one turn the defender gets all defenses set to 25% and strikes on all weapons to 1. In addition to that, all adjacent enemies to the attacked unit receive 4 cold damage and get slowed. The attacker gets all defenses set to 25% and all weapons removed. Champions and The Butcher of Wesnoth are immune.

<span color='#7375e6'>Infinity Lock</span>: attack only, both the attacker and defender go into the infinity lock. For a duration of one turn the defender can't move, gets all defenses set to 15% and all weapons removed. In addition to that, all enemies within radius 5 from the attacked unit receive 8 cold damage and get slowed. The attacker gets all weapons removed. Champions and The Butcher of Wesnoth are immune."

			phys_res="Adds resistance to physical attack types.
			
<span color='#5b8742'>Armor Science</span>: reduces physical resistances of all enemies on the map by certain amount."

			impact_res="Adds impact resistance.

<span color='#7375e6'>Stun</span>: attack only, disrupts enemy's ZOC upon a hit.

<span color='#7375e6'>Crushing Blow</span>: attack only, upon a hit the enemy gets one strike removed from all weapons for a duration of one turn. Zone of Control is also disrupted. Can be applied only once per unit. Champions and The Butcher of Wesnoth are immune.

<span color='#7375e6'>Shatter the Bones</span>: attack only, upon a hit the enemy gets 50% of strikes removed from all weapons for a duration of one turn. Zone of Control is also disrupted. Can be applied only once per unit. Champions and The Butcher of Wesnoth are immune."

			fire_res="Adds fire resistance.

<span color='#7375e6'>Burning Passion</span>: attack only, after killing an enemy this unit gets possessed by burning passion, gets damage increased by 1 point and a chance to attack another enemy. After the turn is finished, all attacks get disabled and all resistances(except fire) and movement drop to 0 for a duration of one turn.

<span color='#7375e6'>Burning Possession</span>: attack only, after killing an enemy this unit gets possessed by infernal passion, receives extra 2 movement points, gets damage increased by 2 points and a chance to attack another enemy. After the turn is finished, all attacks get disabled, all resistances(except fire) drop to 0 and movement is reduced to 3 points for a duration of one turn."

			arcane_res="Adds arcane resistance.

<span color='#5b8742'>Mind Tricks</span>: once a fight is finished if both units are still alive then some percentage of the damage received is reflected back onto the enemy as arcane damage. Equally, the same amount is used to heal the wounds received during the fight. Champions and The Butcher of Wesnoth are immune. Active only on offense.

<span color='#7375e6'>Reversed Polarity</span>: attack only, upon a hit the attacker and the defender swap their locations. This stops the attack. Champions and The Butcher of Wesnoth are immune.

<span color='#7375e6'>Drains</span>: the unit can drain health from living units, healing itself for a percentage of the amount of damage it deals (rounded down)."

			blade_res="Adds blade resistance.

<span color='#7375e6'>Duel 2</span>: attack only, fight lasts for an extra round.

<span color='#7375e6'>Battle Trance</span>: attack only, each landing hit increases the damage by 1. Champions and The Butcher of Wesnoth are immune.

<span color='#7375e6'>Overwhelm</span>: attack only, each landing hit increases the damage by 1, while simultaneously decreases opponent's damage by 2(1) if current damage is above 67%(33%). After the attack, opponent's defense and attack accuracy are reduced by 10% for one turn. Champions and The Butcher of Wesnoth are immune."

			pierce_res="Adds pierce resistance.

<span color='#7375e6'>Impale</span>: attack only, ignores the enemy's pierce resistance. Upon successful hit, the opponent's damage and movement points are reduced by 33% for one turn.

<span color='#7375e6'>No Counter-Attack</span>: attack only, the opponent has a 0% chance of retaliation. Champions, the Butcher of Wesnoth and berserker frenzy units are immune."

			hp_low="Provides low hitpoints bonus.

<span color='#5b8742'>Immune to Poison</span>: the unit becomes unpoisonable (no effect on undead, mechanical and magical units, etc).

<span color='#5b8742'>Poison Immunity Aura</span>: all allies within 7 hexes from this unit become unpoisonable."

			hp_med="Provides medium hitpoints bonus.

<span color='#5b8742'>Immune to Drains</span>: the unit becomes undrainable (no effect on undead, mechanical and magical units, etc).

<span color='#5b8742'>Drains Immunity Aura</span>: all allies within 7 hexes from this unit become undrainable."

			hp_high="Provides high hitpoints bonus.

<span color='#5b8742'>Heals All</span> at the beginning of the turn, this unit heals all ally units on the map. Healing amount is 4 hitpoints.

<span color='#5b8742'>Restores All</span> at the beginning of the turn, this unit not only heals all ally units on the map, but also cures, removes slow and unpetrifies them. Healing amount is 8 hitpoins."

			steadfast="Adds steadfast and impenetrable wall abilities.

<span color='#5b8742'>Steadfast</span> the unitâ€™s resistances are multiplied by a specific factor, up to a maximum value when defending. Vulnerabilities are not affected.

<span color='#5b8742'>Impenetrable Wall</span> the unit helps adjacent allies to form an impenetrable wall by doubling their resistances up to specific value. Vulnerabilities are not affected."

			regen="Adds regenerates ability.

<span color='#5b8742'>Regenerates</span>: the unit will heal itself some HP amount each turn. If it is poisoned, it will remove the poison instead of healing."

			melee_dmg="Increases damage output on melee weapons.

<span color='#5b8742'>Fearless</span>: fights normally during unfavorable times of day/night.

<span color='#7375e6'>Battle Fury</span>: with each successful hit the damage increases by given amount. If the unit misses, the counter is reset. Attack only."

			ranged_dmg="Increases damage output on ranged weapons.

<span color='#7375e6'>Ruthless</span>: adds 1 ranged strike against enemies with no ranged attacks. Attack only.

<span color='#7375e6'>Merciless</span>: adds 3 ranged strikes against enemies with no ranged attacks. Attack only."

			ranged_acc="Increases accuracy of ranged weapons.
DOES NOT WORK on magical attacks.

<span color='#7375e6'>Concentration</span>: with each successful hit, the accuracy of the next shot improves by a certain amount. Attack only."

			melee_parry="Improves parry on melee weapons and defense on all terrain types."

			melee_poison="Adds poison, accuracy and backstab to melee weapons.

<span color='#7375e6'>Poison</span>: the attack poisons living targets. Poisoned units lose 8 HP every turn until they are cured or are reduced to 1 HP. Poison cannot, of itself, kill a unit.

<span color='#7375e6'>Backstab</span>: when used offensively, this attack deals more damage if there is an enemy of the target on the opposite side of the target."

			melee_slow="Adds slow and heal on hit on melee weapons.

<span color='#7375e6'>Slow</span>: the attack slows the target until it ends a turn. Slow halves the damage caused by attacks and the movement cost for a slowed unit is doubled.

<span color='#5b8742'>Lesser Chronosphere</span>: when defending against melee attacks, the opponent is slowed automatically before the first hit. Champions and The Butcher of Wesnoth are immune.

<span color='#5b8742'>Chronosphere</span>: when defending, the opponent is slowed automatically before the first hit. Champions and The Butcher of Wesnoth are immune."

			mp="Increases movement points.

<span color='#5b8742'>Immune to slow</span>: the unit becomes unslowable.

<span color='#5b8742'>Slow Immunity Aura</span>: all allies within 7 hexes from this unit become unslowable."

			feeding="Adds Magical Feeding and raises the undead abilities.

<span color='#5b8742'>Magical Feeding</span>: the unit gains extra hitpoints whenever it kills a unit, regardless of it's living status. The number of hitpoints added depends on the level of the unit killed capped with the maximum allowed.

<span color='#5b8742'>Raises the Undead</span>: at the beginning of the turn, this unit has a chance to summon an undead minion. The strength of the summoned units is somewhat random, while the level and the chance depend on the promotion rank."

			leadership="Adds leadership ability.

<span color='#5b8742'>Leadership</span>: the unit can lead ally units that are next to it, making them fight better. Affects units of the same or lower level increasing their damage by the same percentage regardless of their level difference.

<span color='#5b8742'>Fearless</span>: fights normally during unfavorable times of day/night."

			drain="Adds drains on ranged. Does not negatively impact xp mod costs.

<span color='#7375e6'>Drains</span>: the unit can drain health from living units, healing itself for a percentage of the amount of damage it deals (rounded down).

<span color='#7375e6'>Wicked</span>: when used offensively at nighttime, this attack deals 20% more damage to living units.

<span color='#7375e6'>Unholy</span>: when used at nighttime, this attack deals 35% more damage to living units."

			defense="Increases defense on all terrain types and improves movement costs.

<span color='#7375e6'>Magic Counter</span>: the attack reduces the opponent's magical chance to hit by 20% (down to 50%)."

			skirm="Adds skirmisher ability and movement points.

<span color='#5b8742'>Skirmisher</span>: the unit is skilled in moving past enemies quickly, and ignores all enemy Zones of Control.

<span color='#5b8742'>Battle Fervor</span>: increases the movement points of all ally units.

<span color='#5b8742'>Enemy Control</span>: all allied units learn how to ignore enemies' zones of control."

			first_strike="Adds first strike ability.

<span color='#7375e6'>First Strike</span>: always strikes first, even when defending.

<span color='#7375e6'>Preemptive Strike</span>: when attacking you strike twice before the enemy can retaliate. The first strike deals 75% normal damage, has always 60% chance to hit and all specials disabled. Champions and the Butcher of Wesnoth are immune.

<span color='#7375e6'>Initiative</span>: when attacking and defending you strike twice before the enemy. The first strike deals 125% normal damage, has always 70% chance to hit and all specials disabled. Champions and the Butcher of Wesnoth are immune.

<span color='#5b8742'>Eagerness Aura</span>: all surrounding allies gain first strike on all attacks."

			fear="Adds necromancer's bane ability.

<span color='#5b8742'>Necromancer's Bane</span>: when attacking, the defender retaliates with reduced damage. After the fight is over enemies up to a certain level within defined range have their damage reduced for one turn. The damage reduction is higher if the opponent dies during the fight. Champions, Butcher of Wesnoth, fearless units, and leaders receive half of the damage reduction.

<span color='#5b8742'>Fearless</span>: fights normally during unfavorable times of day/night.

<span color='#7375e6'>Heal on Hit</span>: each landing hit restores some small amount of hp."

			discouragement="Reduces the attacker's strikes by 1 when defending.

<span color='#7375e6'>Dishearten</span>: when used defensively this attack reduces the opponent's damage."

			burns="Deals damage to all surrounding enemies at the beginning of your turn.
Like poison, the damage dealt does not kill."

			golden_armor="Provides extra resistance.

<span color='#5b8742'>Reflects</span>: when defending, some percentage of received damage is reflected back to the attacker."

			heal="Heals and Cures surrounding allied units."

			freezing_gem="Improves cold resistance and adds freezing touch special for melee.

<span color='#7375e6'>Freezing Touch</span>: With each successful hit, opponent's defense is reduced by given amount for one turn. Minimum defense is 15%. Melee only."

			field_disruption="All surrounding enemies have their magic resistances reduced by given amount."

			armor_destruction="Improves melee damage and adds adds melee armor destruction special.

<span color='#7375e6'>Armor Destruction</span>: with each successful hit, opponent's resistance to the weapons type is permanently decreased by given amount. Melee only."

			protection="Adds protection, defensive wall and impenetrable wall abilities.

<span color='#5b8742'>protection</span>: surrounding allied units have their physical resistances improved by given amount.

<span color='#5b8742'>defensive wall</span>: surrounding allied units deal higher melee damage when defending.

<span color='#5b8742'>impenetrable wall</span>: surrounding allied units deal higher damage when defending."

			double_attack="Adds double attack on ranged.

<span color='#7375e6'>Double Attack</span>: the unit can fire ranged attacks twice in single turn, once the ability is charged. Each offensive use of double-attack weapon adds a single charge."

			hitn_run="Provides a chance to escape the front line after a successful kill, and with a higher rank, after an attack.

<span color='#5b8742'>Nighstalk</span>: the unit is invisible to the enemies during nighttime.

<span color='#7375e6'>Cover of the Night</span>: when used during the night against a distracted enemy then the damage is increased by 50% and the enemy cannot retaliate. Champions and the Butcher of Wesnoth are immune and so are opponents with berserker frenzy. This attack to be available requires the move points to be below the maximum move points."

			extra_strikes="Adds extra strikes and small non-magical accuracy bonus.

<span color='#7375e6'>extra strikes<span>: increases number of strikes based on the promotion rank and unit's hitpoints."

			rat_pack="Spawns an allied rat next to this unit once every n turns.
Maximum of 4 rats. Additional rats can be plagued."

			icewind_aura="At the beginning of your turn reduces mp of all enemies within radius by 30% and deals damage.
Applies only to units of the same or lower level as the unit wearing this item. Champions and The Butcher of Wesnoth are immune.
Movement points cannot drop below 3."

			dragon_protection="When this unit is dying the Dragon's Protection revives it, restoring some hitpoints. Because of how much magical energy this requires, this can only trigger when the unit's hp is below certain point. A unit can only be revived once per turn (the counter refreshes at the beginning of the player's turn). Passively increases resistance to all common weapon types by 10% and against the secret attacks by 25%."

		[/value]
		[value] # long description when unit picks the item
			magic_res="Provides extra resistance to magical attack types.
Adds Negates Magic ability."
			cold_res="Provides extra cold resistance.
Adds Time Dilation weapon."
			phys_res="Provides extra resistance to physical attack types.
Adds Armor Science ability."
			impact_res="Provides extra impact resistance.
Adds Crush Their Souls weapon."
			fire_res="Provides extra fire resistance.
Adds Wrath of Fire weapon."
			arcane_res="Provides extra arcane resistance.
Adds Unknown Force weapon.
Adds Mind Tricks ability."
			blade_res="Provides extra blade resistance.
Adds Berserker's Fury weapon."
			pierce_res="Provides extra pierce resistance.
Adds Atrocious Impalement weapon."
			hp_low="Provides low hitpoints bonus.
Adds poison immunity.
Adds poison immunity aura."
			hp_med="Provides medium hitpoints bonus.
Adds drains immunity.
Adds drains immunity aura."
			hp_high="Provides high hitpoints bonus.
Adds Heals All ability.
Adds Protects All ability."
			steadfast="Adds Steadfast ability.
Adds Impenetrable ability."
			regen="Adds Regenerates ability."
			melee_dmg="Increases damage output on melee weapons.
Adds Battle Fury on melee.
Adds Fearless trait."
			ranged_dmg="Increases damage output on ranged weapons.
Adds Ruthless on ranged.
Adds Merciless on ranged."
			ranged_acc="Increases accuracy of ranged weapons.
DOES NOT WORK on magical attacks.
Adds Concentration on ranged."
			melee_parry="Improves parry on melee weapons.
Improves defense."
			melee_poison="Adds poison, accuracy and backstab on melee."
			melee_slow="Adds slow on melee.
Adds Chronosphere ability."
			mp="Adds movement points.
Adds slow immunity.
Adds slow immunity aura."
			feeding="Adds Magical Feeding ability.
Adds Raises the Undead ability."
			leadership="Adds Leadership ability.
Adds Fearless trait."
			drain="Adds Drain on ranged.
Adds Wicked on ranged.
Adds Unholy on ranged."
			defense="Improves defense and movement costs.
Adds Magic Counter ability."
			skirm="Adds skirmisher ability.
Adds movement points.
Adds Battle Fervor ability.
Adds Enemy Control ability."
			first_strike="Adds First Strike special.
Adds Preemptive Strike special.
Adds Initive special.
Adds Eagerness Aura special."
			fear="Adds Necromancer's Bane ability.
Adds Fearless trait.
Adds Heal on Hit on melee."
			discouragement="Adds Discouragement ability and improves parry.
Adds Dishearten special."
			burns="Adds Burns Enemies ability."
			golden_armor="Provides extra resistance.
Adds Reflects ability."
			heal="Adds Heals and Cures abilities."
			freezing_gem="Adds Freezing Touch special for melee."
			field_disruption="Adds Field Disruption ability."
			armor_destruction="Adds Armor Destruction for melee."
			protection="Adds Protection ability.
Adds Defensive Wall ability.
Adds Impenetrable Wall ability."
			double_attack="Adds Double Attack ability for ranged."
			hitn_run="Adds Kill and Run ability on lower ranks.
Adds Hit and Run ability on higher ranks.
Adds Nighstalk ability.
Adds Cover of the Night weapon special."
			extra_strikes="Adds Extra Strikes ability."
			rat_pack="Adds Breeds Rats ability."
			icewind_aura="Adds Icewind Aura ability."
			dragon_protection="Adds Dragon's Protection ability"

		[/value]
		[value] # steps description when unit picks the item
			magic_res="$band_none_text +5 magic resistance
$band_initiated_text +8 magic resistance
$band_proven_text +12 magic resistance
$band_notable_text +18 magic resistance, <span color='#5b8742'>negates magic 5</span>
$band_significant_text +25 magic resistance, <span color='#5b8742'>negates magic 10</span>
$band_epic_text +35 magic resistance, <span color='#5b8742'>negates magic 20</span>"

			cold_res="$band_none_text +10 cold resistance
$band_initiated_text +20 cold resistance
$band_proven_text +30 cold resistance
$band_notable_text +40 cold resistance, 7x2 ranged weapon (<span color='#7375e6'>slow, magical</span>)
$band_significant_text +60 cold resistance, 9x3 ranged weapon (<span color='#7375e6'>slow, magical, time lock</span>)
$band_epic_text +85 cold resistance, 12x3 ranged weapon (<span color='#7375e6'>slow, magical, infinity lock</span>)"

			phys_res="$band_none_text +5 psysical resistance
$band_initiated_text +8 psysical resistance
$band_proven_text +12 psysical resistance
$band_notable_text +18 psysical resistance, <span color='#5b8742'>armor science 5</span>
$band_significant_text +25 psysical resistance, <span color='#5b8742'>armor science 10</span>
$band_epic_text +35 psysical resistance, <span color='#5b8742'>armor science 20</span>"

			impact_res="$band_none_text +10 impact resistance
$band_initiated_text +20 impact resistance
$band_proven_text +30 impact resistance
$band_notable_text +40 impact resistance, 20x2 melee weapon (<span color='#7375e6'>stun</span>)
$band_significant_text +60 impact resistance, 28x2 melee weapon (<span color='#7375e6'>crushing blow</span>)
$band_epic_text +85 impact resistance, 40x2 melee weapon (<span color='#7375e6'>shatter the bones</span>)"

			fire_res="$band_none_text +10 fire resistance
$band_initiated_text +20 fire resistance
$band_proven_text +30 fire resistance
$band_notable_text +40 fire resistance, 10x3 melee weapon (<span color='#7375e6'>magical</span>)
$band_significant_text +60 fire resistance, 11x4 melee weapon (<span color='#7375e6'>magical, burning passion</span>)
$band_epic_text +85 fire resistance, 12x5 melee weapon (<span color='#7375e6'>magical, burning possession</span>)"

			arcane_res="$band_none_text +10 arcane resistance
$band_initiated_text +20 arcane resistance
$band_proven_text +30 arcane resistance
$band_notable_text +40 arcane resistance, 12x2 melee weapon (<span color='#7375e6'>magical</span>), potent ability (<span color='#5b8742'>mind tricks 20%</span>)
$band_significant_text +60 arcane resistance, 15x2 melee weapon (<span color='#7375e6'>precission, reversed polarity, drains 50%</span>), strong ability (<span color='#5b8742'>mind tricks 35%</span>)
$band_epic_text +85 arcane resistance, 18x2 melee weapon (<span color='#7375e6'>unavoidable, reversed polarity, drains 100%</span>), powerful ability (<span color='#5b8742'>mind tricks 50%</span>)"

			blade_res="$band_none_text +10 blade resistance
$band_initiated_text +20 blade resistance
$band_proven_text +30 blade resistance
$band_notable_text +40 blade resistance, 7x4 melee weapon (<span color='#7375e6'>marksman, duel 2</span>)
$band_significant_text +60 blade resistance, 8x5 melee weapon (<span color='#7375e6'>marksman, duel 2, battle trance</span>)
$band_epic_text +85 blade resistance, 9x6 melee weapon (<span color='#7375e6'>marksman, duel 2, overwhelm</span>)"

			pierce_res="$band_none_text +10 pierce resistance
$band_initiated_text +20 pierce resistance
$band_proven_text +30 pierce resistance
$band_notable_text +40 pierce resistance, 13x2 melee weapon (<span color='#7375e6'>charge</span>)
$band_significant_text +60 pierce resistance, 16x2 melee weapon (<span color='#7375e6'>charge, impale</span>)
$band_epic_text +85 pierce resistance, 20x2 melee weapon (<span color='#7375e6'>charge, impale, no counter-attack</span>)"

			hp_low="$band_none_text +5%
$band_initiated_text +10%
$band_proven_text +15%
$band_notable_text +20%, <span color='#5b8742'>immune to poison</span>
$band_significant_text +25%, <span color='#5b8742'>immune to poison</span>
$band_epic_text +35%, <span color='#5b8742'>immune to poison, poison immunity aura</span>"

			hp_med="$band_none_text +10%
$band_initiated_text +15%
$band_proven_text +20%
$band_notable_text +30%, <span color='#5b8742'>immune to drains</span>
$band_significant_text +40%, <span color='#5b8742'>immune to drains</span>
$band_epic_text +50%, <span color='#5b8742'>immune to drains, drains immunity aura</span>"

			hp_high="$band_none_text +10%
$band_initiated_text +20%
$band_proven_text +30%
$band_notable_text +40%, <span color='#5b8742'>heals all +2</span>
$band_significant_text +50%, <span color='#5b8742'>heals all +4</span>
$band_epic_text +65%, <span color='#5b8742'>restores all +8</span>"

			steadfast="$band_none_text x1.5 25% max
$band_initiated_text x1.75 40% max
$band_proven_text x2 50% max
$band_notable_text x2 50% max, <span color='#5b8742'>impenetrable 20%</span> 
$band_significant_text x2.25 60% max, <span color='#5b8742'>impenetrable 30%</span> 
$band_epic_text x2.5 75% max, <span color='#5b8742'>impenetrable 40%</span>"

			regen="$band_none_text +2
$band_initiated_text +4
$band_proven_text +8
$band_notable_text +10 (village +14)
$band_significant_text +14 (village +20)
$band_epic_text +20 (village +32)"

			melee_dmg="$band_none_text +10%
$band_initiated_text +20%
$band_proven_text +30%
$band_notable_text +40%, <span color='#7375e6'>battle fury +1</span>
$band_significant_text +50%, <span color='#7375e6'>battle fury +2</span>
$band_epic_text +65%, <span color='#5b8742'>fearless</span>, <span color='#7375e6'>battle fury +3</span>"

			ranged_dmg="$band_none_text +10%
$band_initiated_text +20%
$band_proven_text +30%
$band_notable_text +40%, <span color='#7375e6'>ruthless</span>
$band_significant_text +50%, <span color='#7375e6'>ruthless</span>
$band_epic_text +65%, <span color='#7375e6'>merciless</span>"

			ranged_acc="$band_none_text +2
$band_initiated_text +4
$band_proven_text +6
$band_notable_text +9, <span color='#7375e6'>concentration +2</span>
$band_significant_text +12, <span color='#7375e6'>concentration +3</span>
$band_epic_text +15, <span color='#7375e6'>concentration +5</span>"

			melee_parry="$band_none_text +2
$band_initiated_text +4
$band_proven_text +6
$band_notable_text +9, defense everywhere +2
$band_significant_text +12, defense everywhere +3
$band_epic_text +15, defense everywhere +5"

			melee_poison="$band_none_text melee <span color='#7375e6'>poison</span>
$band_initiated_text melee accuracy +2, <span color='#7375e6'>poison</span>
$band_proven_text melee accuracy +3, <span color='#7375e6'>poison</span>
$band_notable_text melee accuracy +4, <span color='#7375e6'>poison, backstab x1.2</span>
$band_significant_text melee accuracy +5, <span color='#7375e6'>poison, backstab x1.5</span>
$band_epic_text melee accuracy +5, <span color='#7375e6'>poison, backstab x2</span>"

			melee_slow="$band_none_text melee <span color='#7375e6'>slow</span> (day only)
$band_initiated_text melee <span color='#7375e6'>slow</span> (day, dawn and dusk)
$band_proven_text melee <span color='#7375e6'>slow</span>
$band_notable_text melee <span color='#7375e6'>slow</span>
$band_significant_text melee <span color='#7375e6'>slow</span>, <span color='#5b8742'>lesser chronosphere</span>
$band_epic_text melee <span color='#7375e6'>slow</span>, <span color='#5b8742'>chronosphere</span>"

			mp="$band_none_text +1mp
$band_initiated_text +1mp
$band_proven_text +2mp
$band_notable_text +2mp, <span color='#5b8742'>immune to slow</span>
$band_significant_text +3mp, <span color='#5b8742'>immune to slow</span>
$band_epic_text +4mp, <span color='#5b8742'>immune to slow, slow immunity aura</span>"

			feeding="$band_none_text max +1hp
$band_initiated_text max +1hp
$band_proven_text max +1hp
$band_notable_text max +1hp, 15% to summon lvl0 undead
$band_significant_text max +1hp, 15% to summon lvl1 undead
$band_epic_text max +2hp, 20% to summon lvl2 undead"

			leadership="$band_none_text 15%
$band_initiated_text 20%
$band_proven_text 25%
$band_notable_text 30%
$band_significant_text 40%
$band_epic_text 65%, <span color='#5b8742'>fearless</span>"

			drain="$band_none_text drains 20%
$band_initiated_text drains 35%
$band_proven_text drains 50%
$band_notable_text drains 50%, <span color='#7375e6'>wicked</span>
$band_significant_text drains 65%, <span color='#7375e6'>wicked</span>
$band_epic_text drains 75%, <span color='#7375e6'>unholy</span>"

			defense="$band_none_text +2%
$band_initiated_text +3%, -1 movement cost
$band_proven_text +4%, -2 movement cost
$band_notable_text +5%, -3 movement cost
$band_significant_text +7%, -4 movement cost
$band_epic_text +10%, -5 movement cost, <span color='#7375e6'>magic counter</span>"

			skirm="$band_none_text nighttime only skirmisher
$band_initiated_text dawn, dusk and night skirmisher
$band_proven_text skirmisher
$band_notable_text skirmisher, +1mp
$band_significant_text skirmisher, +2mp, <span color='#5b8742'>battle fervor +1</span>
$band_epic_text skirmisher, +2mp, <span color='#5b8742'>battle fervor +2</span>, <span color='#5b8742'>enemy control</span>"

			first_strike="$band_none_text melee first strike
$band_initiated_text melee first strike
$band_proven_text first strike
$band_notable_text first strike
$band_significant_text first strike, <span color='#7375e6'>preemptive strike</span>
$band_epic_text first strike, <span color='#7375e6'>initiative</span>, <span color='#5b8742'>eagerness aura</span>"

			fear="$band_none_text 5% attack, 0%(10%) adjacent lvl0
$band_initiated_text 5% attack, 5%(10%) adjacent max lvl1
$band_proven_text 10% attack, 5%(15%) radius 2 max lvl2
$band_notable_text 15% attack, 10%(20%) radius 3 max lvl3, melee <span color='#7375e6'>+1 heal on hit</span>
$band_significant_text 20% attack, 10%(25%) radius 4 max lvl4, melee <span color='#7375e6'>+2 heal on hit</span>
$band_epic_text 25% attack, 15%(30%) radius 5 max lvl5, melee <span color='#7375e6'>+3 heal on hit</span>, <span color='#5b8742'>fearless</span>"

			discouragement="$band_none_text melee
$band_initiated_text melee
$band_proven_text melee
$band_notable_text melee and ranged
$band_significant_text melee and ranged, +5% parry
$band_epic_text melee and ranged, +5% parry, <span color='#7375e6'>dishearten 20%</span>"

			burns="$band_none_text -2
$band_initiated_text -4
$band_proven_text -8
$band_notable_text -12
$band_significant_text -20
$band_epic_text -32"

			golden_armor="$band_none_text +4
$band_initiated_text +7
$band_proven_text +10
$band_notable_text +14, <span color='#5b8742'>reflects 15%</span>
$band_significant_text +18, <span color='#5b8742'>reflects 25%</span>
$band_epic_text +25, <span color='#5b8742'>reflects 40%</span>"

			heal="$band_none_text +2
$band_initiated_text +4
$band_proven_text +8
$band_notable_text +12
$band_significant_text +16
$band_epic_text +25"

			freezing_gem="$band_none_text +5% cold resistance
$band_initiated_text +5% cold resistance, <span color='#7375e6'>freezing touch -1</span>
$band_proven_text +5% cold resistance, <span color='#7375e6'>freezing touch -2</span>
$band_notable_text +15% cold resistance, <span color='#7375e6'>freezing touch -3</span>
$band_significant_text +15% cold resistance, <span color='#7375e6'>freezing touch -4</span>
$band_epic_text +25% cold resistance, <span color='#7375e6'>freezing touch -5</span>"

			field_disruption="$band_none_text -5
$band_initiated_text -10
$band_proven_text -15
$band_notable_text -20
$band_significant_text -25 
$band_epic_text -35"

			armor_destruction="$band_none_text +1 melee damage
$band_initiated_text +1 melee damage, <span color='#7375e6'>armor destruction -1</span>
$band_proven_text +1 melee damage, <span color='#7375e6'>armor destruction -2</span>
$band_notable_text +2 melee damage, <span color='#7375e6'>armor destruction -3</span>
$band_significant_text +2 melee damage, <span color='#7375e6'>armor destruction -4</span>
$band_epic_text +3 melee damage, <span color='#7375e6'>armor destruction -5</span>"

			protection="$band_none_text protection +5
$band_initiated_text protection +10
$band_proven_text protection +15
$band_notable_text protection +20, <span color='#5b8742'>defensive wall 1.15</span>
$band_significant_text protection +25, <span color='#5b8742'>defensive wall 1.3</span>
$band_epic_text protection +30, <span color='#5b8742'>impenetrable wall 1.5</span>"

			double_attack="$band_none_text 7 to charge
$band_initiated_text 6 to charge
$band_proven_text 5 to charge
$band_notable_text 4 to charge
$band_significant_text 3 to charge
$band_epic_text 2 to charge"

			hitn_run="$band_none_text nightstalk
$band_initiated_text nightstalk, <span color='#5b8742'>kill and run +1</span>
$band_proven_text nightstalk, <span color='#5b8742'>kill and run +1</span>
$band_notable_text nightstalk, <span color='#5b8742'>hit and run +1</span>
$band_significant_text nightstalk, <span color='#5b8742'>hit and run +2</span>
$band_epic_text nightstalk, <span color='#5b8742'>hit and run +3</span>, <span color='#7375e6'>cover of the night</span>"

			extra_strikes="$band_none_text extra strike below 50% hp
$band_initiated_text extra strikes below 65% and 30% hp
$band_proven_text +1 strike
$band_notable_text +1 strike, extra below 50% hp, +2 accuracy
$band_significant_text +1 strike, extra below 65% and 30% hp, +3 accuracy
$band_epic_text +2 strikes, extra below 50%, +5 accuracy"

			rat_pack="$band_none_text a rat spawns every 6 turns
$band_initiated_text a rat spawns every 5 turns
$band_proven_text a rat spawns every 4 turns
$band_notable_text a rat spawns every 3 turns
$band_significant_text a rat spawns every 2 turns
$band_epic_text a rat spawns every turn, plague on melee"

			icewind_aura="$band_none_text adjacent units only
$band_initiated_text within 2 radius
$band_proven_text within 3 radius, passive 1 cold damage
$band_notable_text within 5 radius, passive 2 cold damage
$band_significant_text within 7 radius, passive 3 cold damage
$band_epic_text within 9 radius, passive 5 cold damage"

			dragon_protection="$band_none_text below 10hp to trigger, restores 1hp
$band_initiated_text below 20hp to trigger, restores 5hp
$band_proven_text below 30hp to trigger, restores 10hp
$band_notable_text below 50hp to trigger, restores 15hp
$band_significant_text below 85hp to trigger, restores 25hp
$band_epic_text always active, restores 35hp"
		[/value]
	[/set_variables]
#enddef

#define SHOW_ITEM_PICKUP_MESSAGE ITEM_ID IMAGE TEXT
	[message]
		speaker=narrator
		message={TEXT}
		image={IMAGE}

		[option]
			label="Yes"

			[command]
				{VARIABLE item_append_id {ITEM_ID}}

				[if]
					[variable]
						name=item_append_id
						not_equals=""
					[/variable]
					[then]
						[fire_event]
							name=append_item_variables
							[primary_unit]
								x,y=$x1,$y1
							[/primary_unit]
						[/fire_event]

						[fire_event]
							name=promote_unit
							[primary_unit]
								x,y=$x1,$y1
							[/primary_unit]
						[/fire_event]
					[/then]
				[/if]

				[remove_item]
					x,y=$x1,$y1
					image={IMAGE}
				[/remove_item]
				
				{VARIABLE allow_undo no}
				{CLEAR_VARIABLE scrollable_items[$item_list_key]}
				{VARIABLE_OP item_list_key sub 1}
			[/command]
		[/option]

		[option]
			label="No"

			[command][/command]
		[/option]
	[/message]
#enddef

#define QQUWS_ITEMS
	[event]
		name=drop_new_item
		first_time_only=no
		
		{VARIABLE drop_item_image $items_steps[3].$item_type_id}
		[if]
			[variable]
				name=overwrite_item_image
				not_equals=""
			[/variable]
			[then]
				{VARIABLE drop_item_image $overwrite_item_image}
			[/then]
		[/if]
		
		[if]
			[variable]
				name=render_new_item
				boolean_equals=yes
			[/variable]
			[then]
				[item]
					x,y=$item_x,$item_y
					image=$drop_item_image
				[/item]
			[/then]
		[/if]

		[set_variables]
			name=scrollable_items
			mode=append
			[value]
				cat=item
				x=$item_x
				y=$item_y
				image=$drop_item_image
				type=$item_type_id
				render=yes
			[/value]
		[/set_variables]
		
		{CLEAR_VARIABLE overwrite_item_image}
	[/event]
	
	[event]
		name=add_extra_item_gold
		first_time_only=no
		
		[store_gold]
			side=$side_number
			variable=gold
		[/store_gold]
		
		[if]
			[variable]
				name=gold
				less_than=0
			[/variable]
			[then]
				[set_variable]
					name=gold
					multiply=-1
				[/set_variable]
				[gold]
					side=$side_number
					amount=$gold
				[/gold]
			[/then]
		[/if]
		
	        [gold]
	     	   side=$side_number
	     	   amount=25
	        [/gold]
	[/event]
#enddef

#define QQUWS_PROMOTE_UNIT
	[event]
		name=generate_promotion_rank_variables
		first_time_only=no
		
		{VARIABLE promotion_label none}
		{VARIABLE promotion_level 0}
		{VARIABLE promotion_def_suffix "/$threshold_initiated"}
		{VARIABLE promotion_colour $rank_none_color}
		{VARIABLE next_promo_label "/ next level"}
		{VARIABLE promo_bonus_dmg 0}
		{VARIABLE unit_items_names ""}

		[if]
			[variable]
				name=unit.variables.kills
				greater_than_equal_to=$threshold_epic
			[/variable]
			[then]
				{VARIABLE promotion_label epic}
				{VARIABLE promotion_level 5}
				{VARIABLE promotion_def_suffix ""}
				{VARIABLE promotion_colour $rank_epic_color}
				{VARIABLE next_promo_label ""}
				{VARIABLE promo_bonus_dmg 60}
			[/then]
			[else]
				[if]
					[variable]
						name=unit.variables.kills
						greater_than_equal_to=$threshold_significant
					[/variable]
					[then]
						{VARIABLE promotion_label significant}
						{VARIABLE promotion_level 4}
						{VARIABLE promotion_def_suffix "/$threshold_epic"}
						{VARIABLE promotion_colour $rank_significant_color}
						{VARIABLE promo_bonus_dmg 45}
					[/then]
					[else]
						[if]
							[variable]
								name=unit.variables.kills
								greater_than_equal_to=$threshold_notable
							[/variable]
							[then]
								{VARIABLE promotion_label notable}
								{VARIABLE promotion_level 3}
								{VARIABLE promotion_def_suffix "/$threshold_significant"}
								{VARIABLE promotion_colour $rank_notable_color}
								{VARIABLE promo_bonus_dmg 33}
							[/then]
							[else]
								[if]
									[variable]
										name=unit.variables.kills
										greater_than_equal_to=$threshold_proven
									[/variable]
									[then]
										{VARIABLE promotion_label proven}
										{VARIABLE promotion_level 2}
										{VARIABLE promotion_def_suffix "/$threshold_notable"}
										{VARIABLE promotion_colour $rank_proven_color}
										{VARIABLE promo_bonus_dmg 20}
									[/then]
									[else]
										[if]
											[variable]
												name=unit.variables.kills
												greater_than_equal_to=$threshold_initiated
											[/variable]
											[then]
												{VARIABLE promotion_label initiated}
												{VARIABLE promotion_level 1}
												{VARIABLE promotion_def_suffix "/$threshold_proven"}
												{VARIABLE promotion_colour $rank_initiated_color}
												{VARIABLE promo_bonus_dmg 10}
											[/then]
										[/if]
									[/else]
								[/if]
							[/else]
						[/if]
					[/else]
				[/if]
			[/else]
		[/if]
		
		[if]
			[variable]
				name=promotion_level
				greater_than=0
			[/variable]
			[or]
				[variable]
					name=unit.variables.items_picked_up
					not_equals=""
				[/variable]
			[/or]
			[then]
				{VARIABLE current_promotion_level $unit.variables.promotion_level}
				{VARIABLE unit_items_info ": none"}
				{VARIABLE items_count "No"}
				[if]
					[variable]
						name=unit.variables.items_picked_up
						not_equals=""
					[/variable]
					[then]
						{VARIABLE unit_items_info " (<span color='$promotion_colour'>$promotion_label</span> $next_promo_label|):"}
						
						[set_variables]
							name=unit_items_ids
							mode=replace
							[split]
								list=$unit.variables.items_picked_up
								key=item
								separator=","
							[/split]
						[/set_variables]
						
						{VARIABLE items_count "$unit_items_ids.length|/$uws_game.max_items_per_unit"}
						
						[for]
							variable=i
							array=unit_items_ids
							[do]
								{VARIABLE array_key $unit_items_ids[$i].item}
								
								[set_variables]
									name=steps_readable
									mode=replace
									[split]
										list=$items_steps[2].$array_key
										key=step
										separator="/"
									[/split]
								[/set_variables]
								
								{VARIABLE step_value_now $steps_readable[$promotion_level].step}
								{VARIABLE step_value_next ""}
								
								[if]
									[variable]
										name=promotion_level
										less_than=5
									[/variable]
									[then]
										{VARIABLE tmp_next_level $promotion_level}
										{VARIABLE_OP tmp_next_level add 1}
										{VARIABLE step_value_next "/ $steps_readable[$tmp_next_level].step"}
									[/then]
								[/if]
								
								{VARIABLE unit_items_names "$items_steps[1].$array_key|, $unit_items_names"}
								{VARIABLE unit_items_info "$unit_items_info
$items_steps[1].$array_key|: <span color='$promotion_colour|'>$step_value_now|</span> $step_value_next"}
							[/do]
						[/for]
					[/then]
				[/if]
				
				{VARIABLE unit_kills_info $unit.variables.kills}
				[if]
					[variable]
						name=unit_kills_info
						equals=""
					[/variable]
					[then]
						{VARIABLE unit_kills_info 0}
					[/then]
				[/if]
				
				{VARIABLE display_rank_info yes}
			[/then]
		[/if]
	[/event]
	
	[event]
		name=promote_unit
		first_time_only=no
		
		{VARIABLE display_rank_info no}
		
		[fire_event]
			name=generate_promotion_rank_variables
			[primary_unit]
				id=$unit.id
			[/primary_unit]
		[/fire_event]
		
		[if]
			[variable]
				name=display_rank_info
				boolean_equals=yes
			[/variable]
			[then]
				[modify_unit]
					[filter]
						id=$unit.id
					[/filter]
					
					[variables]
						promotion_level=$promotion_level
					[/variables]
						
					[object]
						silent=yes
						[effect]
							apply_to=remove_ability
							[abilities]
								[dummy]
									id=qqas_promotion_indicator
								[/dummy]
							[/abilities]
						[/effect]
						
						[effect]
						    apply_to=new_ability
						    [abilities]
						    	[dummy]
						    		id=qqas_promotion_indicator
								name="<span color='$promotion_colour'>$promotion_label</span>"
								description="Promotion rank, provides +$promo_bonus_dmg|% dmg and affects item specials ($unit_kills_info|$promotion_def_suffix| kills)
								
$items_count items picked up $unit_items_info"
						    	[/dummy]
						    [/abilities]
						[/effect]
					[/object]
				[/modify_unit]
				
				[if]
					[variable]
						name=promotion_level
						greater_than=$current_promotion_level
					[/variable]
					[then]
						[fire_event]
							name=upgrade_item_specials
							[primary_unit]
							    id=$second_unit.id
							[/primary_unit]
						[/fire_event]
					[/then]
				[/if]
			[/then]
		[/if]
	[/event]
	
	[event]
		name=recalculate_items_count_for_unit
		first_time_only=no
		
		{VARIABLE items_count 0}
		{VARIABLE unit_item_list ""}
		[if]
			[variable]
				name=unit.variables.items_picked_up
				not_equals=""
			[/variable]
			[then]
				[set_variables]
					name=tmp_unit_items_array
					mode=replace
					[split]
						list=$unit.variables.items_picked_up
						key=item
						separator=","
					[/split]
				[/set_variables]
				
				{VARIABLE items_count $tmp_unit_items_array.length}
				{VARIABLE unit_item_list $unit.variables.items_picked_up}
			[/then]
		[/if]
	[/event]
	
	[event]
		name=append_item_variables
		first_time_only=no
		
		{VARIABLE already_applied ""}
		{VARIABLE current_promotion_level $unit.variables.promotion_level}
		[if]
			[variable]
				name=unit.variables.items_picked_up
				not_equals=""
			[/variable]
			[then]
				{VARIABLE already_applied "$unit.variables.items_picked_up|,"}
			[/then]
		[/if]
		
		{VARIABLE items_count $unit_items_ids.length}
		
		[if]
			[variable]
				name=unit.variables.promotion_level
				equals=""
			[/variable]
			[then]
				{VARIABLE current_promotion_level 0}
			[/then]
		[/if]
		
		[modify_unit]
			[filter]
				id=$unit.id
			[/filter]
			
			[variables]
				items_picked_up="$already_applied|$item_append_id"
				promotion_level=$current_promotion_level
			[/variables]
		[/modify_unit]
		
		{VARIABLE item_key $item_append_id}
		[set_variables]
			name=current_item_steps
			mode=replace
			[split]
				list=$items_steps[0].$item_key
				key=step_value
				separator="/"
			[/split]
		[/set_variables]
		
		[for]
			variable=use_promotion_level
			start=0
			end=$current_promotion_level
			step=1
			[do]
				{VARIABLE item_step $current_item_steps[$use_promotion_level].step_value}
				
				[fire_event]
					name=upgrade_single_item_promotion
					[primary_unit]
					    id=$unit.id
					[/primary_unit]
				[/fire_event]
			[/do]
		[/for]
	[/event]
	
	[event]
		name=upgrade_item_specials
		first_time_only=no
		
		# upgrade dmg by 10% for each rank promotion
		[object]
			silent=yes

			[effect]
			    apply_to=attack
			    increase_damage=10%
			[/effect]
		[/object]
		
		[if]
			[variable]
				name=unit.variables.items_picked_up
				not_equals=""
			[/variable]
			[then]
				[set_variables]
					name=current_unit_items_set
					mode=replace
					[split]
						list=$unit.variables.items_picked_up
						key=item_id
						separator=","
					[/split]
				[/set_variables]
				
				[for]
					variable=i
					array=current_unit_items_set
					[do]
						{VARIABLE item_key $current_unit_items_set[$i].item_id}
						[set_variables]
							name=current_item_steps
							mode=replace
							[split]
								list=$items_steps[0].$item_key
								key=step_value
								separator="/"
							[/split]
						[/set_variables]
						
						{VARIABLE item_step $current_item_steps[$unit.variables.promotion_level].step_value}
						{VARIABLE use_promotion_level $unit.variables.promotion_level}
						[fire_event]
							name=upgrade_single_item_promotion
							[primary_unit]
							    id=$unit.id
							[/primary_unit]
						[/fire_event]
					[/do]
				[/for]
			[/then]
		[/if]
	[/event]
	
	[event]
		name=upgrade_single_item_promotion
		first_time_only=no
		
		[switch]
			variable=item_key
			[case]
				value=magic_res
				[object]
					 silent=yes

					 [effect]
					    apply_to=resistance
					    replace=no
					    [resistance]
						arcane=-$item_step
						cold=-$item_step
						fire=-$item_step
					    [/resistance]
					[/effect]
				[/object]
				
				[switch]
					variable=use_promotion_level
					
					[case]
						value=3
						{VARIABLE negates_magic_value 5}
					[/case]
					[case]
						value=4
						{VARIABLE negates_magic_value 10}
					[/case]
					[case]
						value=5
						{VARIABLE negates_magic_value 20}
					[/case]
				[/switch]
				
				[if]
					[variable]
						name=negates_magic_value
						greater_than=0
					[/variable]
					[then]
						[modify_unit]
							[filter]
								id=$unit.id
							[/filter]
							
							[variables]
								negates_magic_value=$negates_magic_value
							[/variables]
						[/modify_unit]
					
						[object]
							silent=yes

							[effect]
								apply_to=remove_ability
								[abilities]
									[dummy]
										id=qquws_negates_magic
									[/dummy]
								[/abilities]
							[/effect]
							[effect]
								apply_to=new_ability
								[abilities]
									[dummy]
										id=qquws_negates_magic
										name="negates magic $negates_magic_value"
										description="All allied units receive $negates_magic_value|% bonus to magic resistances."
									[/dummy]
								[/abilities]
							[/effect]
						[/object]
						
						{VARIABLE apply_to_side $unit.side}
						[fire_event]
							name=apply_magic_negation
						[/fire_event]
					[/then]
				[/if]
			[/case]
			[case]
				value=cold_res
				[object]
					 silent=yes

					 [effect]
					    apply_to=resistance
					    replace=no
					    [resistance]
						cold=-$item_step
					    [/resistance]
					[/effect]
				[/object]
				
				[switch]
					variable=use_promotion_level
					
					[case]
						value=3
						
						[object]
							 silent=yes

							[effect]
								apply_to=new_attack
								name=qquws_w_time_dilation
								description="time dilation"
								type=cold
								range=ranged
								icon="attacks/staff-magic.png"
								damage=7
								number=2
								[specials]
									{WEAPON_SPECIAL_SLOW}
									{WEAPON_SPECIAL_MAGICAL}
								[/specials]
							[/effect]
						[/object]
					[/case]
					[case]
						value=4
						
						[object]
							 silent=yes

							 [effect]
								apply_to=attack
								name=qquws_w_time_dilation
								increase_damage=2
								increase_attacks=1
								[set_specials]
									mode=append
									[dummy]
										id=qquws_time_lock
										name="time lock"
										description="When this weapon is used on offense, upon successful hit, both the attacker and defender go into the time lock. For a duration of one turn the defender gets all defenses set to 25% and strikes on all weapons to 1. In addition to that, all adjacent enemies to the attacked unit receive 4 cold damage and get slowed. The attacker gets all defenses set to 25% and all weapons removed. Champions and The Butcher of Wesnoth are immune."
										active_on=offense
									[/dummy]
								[/set_specials]
							[/effect]
						[/object]
					[/case]
					[case]
						value=5
						
						[object]
							 silent=yes

							 [effect]
								apply_to=attack
								name=qquws_w_time_dilation
								increase_damage=3
								remove_specials=qquws_time_lock
								[set_specials]
									mode=append
									[dummy]
										id=qquws_infinity_lock
										name="infinity lock"
										description="When this weapon is used on offense, upon successful hit, both the attacker and defender go into the infinity lock. For a duration of one turn the defender can't move, gets all defenses set to 15% and all weapons removed. In addition to that, all enemies within radius 5 from the attacked unit receive 8 cold damage and get slowed. The attacker gets all weapons removed. Champions and The Butcher of Wesnoth are immune."
										active_on=offense
									[/dummy]
								[/set_specials]
							[/effect]
						[/object]
					[/case]
				[/switch]
			[/case]
			[case]
				value=phys_res
				[object]
					 silent=yes

					 [effect]
					    apply_to=resistance
					    replace=no
					    [resistance]
						blade=-$item_step
						impact=-$item_step
						pierce=-$item_step
					    [/resistance]
					[/effect]
				[/object]
				
				[switch]
					variable=use_promotion_level
					
					[case]
						value=3
						{VARIABLE res_reduction_value 5}
					[/case]
					[case]
						value=4
						{VARIABLE res_reduction_value 10}
					[/case]
					[case]
						value=5
						{VARIABLE res_reduction_value 20}
					[/case]
				[/switch]
				
				[if]
					[variable]
						name=res_reduction_value
						greater_than=0
					[/variable]
					[then]
						[modify_unit]
							[filter]
								id=$unit.id
							[/filter]
							
							[variables]
								armor_science_value=$res_reduction_value
							[/variables]
						[/modify_unit]
					
						[object]
							silent=yes

							[effect]
								apply_to=remove_ability
								[abilities]
									[dummy]
										id=qquws_armor_science
									[/dummy]
								[/abilities]
							[/effect]
							[effect]
								apply_to=new_ability
								[abilities]
									[dummy]
										id=qquws_armor_science
										name="armor science $res_reduction_value"
										description="Reduces physical resistances of all enemies by $res_reduction_value|%."
									[/dummy]
								[/abilities]
							[/effect]
						[/object]
					[/then]
				[/if]
			[/case]
			[case]
				value=impact_res
				[object]
					 silent=yes

					 [effect]
					    apply_to=resistance
					    replace=no
					    [resistance]
						impact=-$item_step
					    [/resistance]
					[/effect]
				[/object]
				
				[switch]
					variable=use_promotion_level
					
					[case]
						value=3
						
						[object]
							 silent=yes
							 
							 [effect]
								apply_to=new_attack
								name=qquws_w_crush_their_souls
								description="crush their souls"
								type=impact
								range=melee
								icon="attacks/hammer-troll.png"
								damage=20
								number=2
								[specials]
									[dummy]
										id=qquws_stun
										name="stun"
										description="This attack puts enormous pressure on the enemy, disrupting his ZOC if a hit is landed. Not active on defense."
										active_on=offense
									[/dummy]
								[/specials]
							[/effect]
						[/object]
					[/case]
					[case]
						value=4
						
						[object]
							 silent=yes

							 [effect]
								apply_to=attack
								name=qquws_w_crush_their_souls
								increase_damage=8
								remove_specials=qquws_stun
								[set_specials]
									mode=append
									[dummy]
										id=qquws_crushing_blow
										name="crushing blow"
										description="When this weapon is used on offense and a hit lands, the enemy gets one strike removed from all weapons for a duration of one turn. Zone of Control is also disrupted. Can be applied only once per unit. Champions and The Butcher of Wesnoth are immune."
										active_on=offense
									[/dummy]
								[/set_specials]
							[/effect]
						[/object]
					[/case]
					[case]
						value=5
						
						[object]
							 silent=yes

							 [effect]
								apply_to=attack
								name=qquws_w_crush_their_souls
								increase_damage=12
								remove_specials=qquws_crushing_blow
								[set_specials]
									mode=append
									[dummy]
										id=qquws_shatter_the_bones
										name="shatter the bones"
										description="When this weapon is used on offense and a hit lands, the enemy gets 50% of strikes removed from all weapons for a duration of one turn. Zone of Control is also disrupted. Can be applied only once per unit. Champions and The Butcher of Wesnoth are immune."
										active_on=offense
									[/dummy]
								[/set_specials]
							[/effect]
						[/object]
					[/case]
				[/switch]
			[/case]
			[case]
				value=fire_res
				[object]
					 silent=yes

					 [effect]
					    apply_to=resistance
					    replace=no
					    [resistance]
						fire=-$item_step
					    [/resistance]
					[/effect]
				[/object]
				
				[switch]
					variable=use_promotion_level
					
					[case]
						value=3
						
						[object]
							 silent=yes
							 
							 [effect]
								apply_to=new_attack
								name=qquws_w_wrath_of_fire
								description="wrath of fire"
								type=fire
								range=melee
								icon="attacks/claws-fire-elemental.png"
								damage=10
								number=3
								[specials]
									[chance_to_hit]
										id=magical
										name="magical"
										description="This attack has a 70% chance to hit regardless of the defensive ability of the unit being attacked."
										value=70
										cumulative=no
									[/chance_to_hit]
								[/specials]
							[/effect]
						[/object]
					[/case]
					[case]
						value=4
						
						[object]
							 silent=yes

							 [effect]
								apply_to=attack
								name=qquws_w_wrath_of_fire
								increase_damage=1
								increase_attacks=1
								[set_specials]
									mode=append
									[dummy]
										id=qquws_burning_passion
										name="burning passion"
										description="When this weapon is used on offense, after killing an enemy this unit gets possessed by burning passion, gets damage increased by 1 points and a chance to attack another enemy. After the turn is finished, all attacks get disabled and all resistances(except fire) and movement drop to 0 for a duration of one turn."
										active_on=offense
									[/dummy]
								[/set_specials]
							[/effect]
						[/object]
					[/case]
					[case]
						value=5
						
						[object]
							 silent=yes

							 [effect]
								apply_to=attack
								name=qquws_w_wrath_of_fire
								increase_damage=1
								increase_attacks=1
								remove_specials=qquws_burning_passion
								[set_specials]
									mode=append
									[dummy]
										id=qquws_burning_possession
										name="burning possession"
										description="When this weapon is used on offense, after killing an enemy this unit gets possessed by infernal passion, receives extra 2 movement points, gets damage increased by 2 points and a chance to attack another enemy. After the turn is finished, all attacks get disabled, all resistances(except fire) drop to 0 and movement is reduced to 3 points for a duration of one turn."
										active_on=offense
									[/dummy]
								[/set_specials]
							[/effect]
						[/object]
					[/case]
				[/switch]
			[/case]
			[case]
				value=arcane_res
				[object]
					 silent=yes

					 [effect]
					    apply_to=resistance
					    replace=no
					    [resistance]
						arcane=-$item_step
					    [/resistance]
					[/effect]
				[/object]
				
				[switch]
					variable=use_promotion_level
					
					[case]
						value=3
						
						[modify_unit]
							[filter]
								id=$unit.id
							[/filter]
							
							[variables]
								mind_tricks_factor=0.2
							[/variables]
							
							[object]
								silent=yes
								
								[effect]
									apply_to=new_attack
									name=qquws_w_unknown_force
									description="unknown force"
									type=arcane
									range=melee
									icon="attacks/touch-faerie.png"
									damage=12
									number=2
									[specials]
										[chance_to_hit]
											id=magical
											name="magical (attack-only)"
											description="This attack has a 70% chance to hit offensively regardless of the defensive ability of the unit being attacked."
											value=70
											cumulative=no
											active_on=offense
										[/chance_to_hit]
									[/specials]
								[/effect]
								
								[effect]
								    apply_to=new_ability
								    [abilities]
									[dummy]
										id=qquws_mind_tricks
										name="mind tricks 20%"
										description="Once a fight is finished if both units are still alive then 20% of the damage received is reflected back onto the enemy as arcane damage and 20% of the wounds are healed up. Champions and The Butcher of Wesnoth are immune. Active only on offense."
									[/dummy]
								    [/abilities]
								[/effect]
							[/object]
						[/modify_unit]
					[/case]
					[case]
						value=4
						
						[modify_unit]
							[filter]
								id=$unit.id
							[/filter]
							
							[variables]
								mind_tricks_factor=0.35
							[/variables]
							
							[object]
								silent=yes
								
								[effect]
									apply_to=attack
									name=qquws_w_unknown_force
									increase_damage=3
									remove_specials=magical
									[set_specials]
										mode=append
										[dummy]
											id=qquws_reversed_polarity
											name="reversed polarity"
											description="When this weapon is used on offense, once a successful hit lands, the attacker and the defender swap their locations. This stops the attack. Champions and The Butcher of Wesnoth are immune."
											active_on=offense
										[/dummy]
										[chance_to_hit]
											id=magical
											name="precision (attack-only)"
											description="This attack has a 80% chance to hit offensively regardless of the defensive ability of the unit being attacked."
											value=80
											cumulative=no
											active_on=offense
										[/chance_to_hit]
										[drains]
											id=drains
											name="drains 50%"
											description="This unit drains health from living units, healing itself for 50% the amount of damage it deals (rounded down)."
											value=50
										[/drains]
									[/set_specials]
								[/effect]
								
								[effect]
								    apply_to=remove_ability
								    [abilities]
									[dummy]
										id=qquws_mind_tricks
									[/dummy]
								    [/abilities]
								[/effect]
								[effect]
								    apply_to=new_ability
								    [abilities]
									[dummy]
										id=qquws_mind_tricks
										name="mind tricks 35%"
										description="Once a fight is finished if both units are still alive then 35% of the damage received is reflected back onto the enemy as arcane damage and 35% of the wounds are healed up. Champions and The Butcher of Wesnoth are immune. Active only on offense."
									[/dummy]
								    [/abilities]
								[/effect]
							[/object]
						[/modify_unit]
					[/case]
					[case]
						value=5
						
						[modify_unit]
							[filter]
								id=$unit.id
							[/filter]
							
							[variables]
								mind_tricks_factor=0.5
							[/variables]
							
							[object]
								silent=yes
								
								[effect]
									apply_to=attack
									name=qquws_w_unknown_force
									increase_damage=3
									remove_specials=magical,drains
									[set_specials]
										mode=append
										[chance_to_hit]
											id=magical
											name="unavoidable (attack-only)"
											description="This attack has a 90% chance to hit offensively regardless of the defensive ability of the unit being attacked."
											value=90
											cumulative=no
											active_on=offense
										[/chance_to_hit]
										[drains]
											id=drains
											name="drains 100%"
											description="This unit drains health from living units, healing itself for 100% the amount of damage it deals."
											value=100
										[/drains]
									[/set_specials]
								[/effect]
								
								[effect]
								    apply_to=remove_ability
								    [abilities]
									[dummy]
										id=qquws_mind_tricks
									[/dummy]
								    [/abilities]
								[/effect]
								[effect]
								    apply_to=new_ability
								    [abilities]
									[dummy]
										id=qquws_mind_tricks
										name="mind tricks 50%"
										description="Once a fight is finished if both units are still alive then 50% of the damage received is reflected back onto the enemy as arcane damage and 50% of the wounds are healed up. Champions and The Butcher of Wesnoth are immune. Active only on offense."
									[/dummy]
								    [/abilities]
								[/effect]
							[/object]
						[/modify_unit]
					[/case]
				[/switch]
			[/case]
			[case]
				value=blade_res
				[object]
					 silent=yes

					 [effect]
					    apply_to=resistance
					    replace=no
					    [resistance]
						blade=-$item_step
					    [/resistance]
					[/effect]
				[/object]
				
				[switch]
					variable=use_promotion_level
					
					[case]
						value=3
						
						[object]
							 silent=yes
							 
							 [effect]
								apply_to=new_attack
								name=qquws_w_berserkers_fury
								description="berserker's fury"
								type=blade
								range=melee
								icon="attacks/battleaxe-undead.png"
								damage=7
								number=4
								[specials]
									{WEAPON_SPECIAL_MARKSMAN}
									[berserk]
										id=berserk_duel2
										name="duel 2"
										description="When attacking this unit presses the engagement and can fight for an extra round."
										value=2
										active_on=offense
									[/berserk]
								[/specials]
							[/effect]
						[/object]
					[/case]
					[case]
						value=4
						
						[object]
							 silent=yes

							 [effect]
								apply_to=attack
								name=qquws_w_berserkers_fury
								increase_damage=1
								increase_attacks=1
								[set_specials]
									mode=append
									[dummy]
										id=qquws_battle_trance
										name="battle trance"
										description="When this weapon is used on offense each landing hit increases the damage by 1. Champions and The Butcher of Wesnoth are immune."
										active_on=offense
									[/dummy]
								[/set_specials]
							[/effect]
						[/object]
					[/case]
					[case]
						value=5
						
						[object]
							 silent=yes

							 [effect]
								apply_to=attack
								name=qquws_w_berserkers_fury
								increase_damage=1
								increase_attacks=1
								remove_specials=qquws_battle_trance
								[set_specials]
									mode=append
									[dummy]
										id=qquws_overwhelm
										name="overwhelm"
										description="When this weapon is used on offense each landing hit increases the damage by 1, while simultaneously decreases opponent's damage by 2(1) if current damage is above 67%(33%). After the attack, opponent's defense and attack accuracy are reduced by 10% for one turn. Champions and The Butcher of Wesnoth are immune."
										active_on=offense
									[/dummy]
								[/set_specials]
							[/effect]
						[/object]
					[/case]
				[/switch]
			[/case]
			[case]
				value=pierce_res
				[object]
					 silent=yes

					 [effect]
					    apply_to=resistance
					    replace=no
					    [resistance]
						pierce=-$item_step
					    [/resistance]
					[/effect]
				[/object]
				
				[switch]
					variable=use_promotion_level
					
					[case]
						value=3
						
						[object]
							 silent=yes
							 
							 [effect]
								apply_to=new_attack
								name=qquws_w_atrocious_impalement
								description="atrocious impalement"
								type=pierce
								range=melee
								icon="attacks/trident2-pierce.png"
								damage=13
								number=2
								[specials]
									[damage]
										id=charge
										name="charge"
										description="When used offensively, this attack deals double damage to the target. It also causes this unit to take double damage from the targetâ€™s counterattack."
										multiply=2
										apply_to=both
										active_on=offense
									[/damage]
								[/specials]
							[/effect]
						[/object]
					[/case]
					[case]
						value=4
						
						[modify_unit]
							[filter]
								id=$unit.id
							[/filter]
							
							[variables]
								impale_armor_reduce=25
							[/variables]
							
							[object]
								 silent=yes
								 
								 [effect]
									apply_to=attack
									name=qquws_w_atrocious_impalement
									increase_damage=3
									[set_specials]
										mode=append
										[dummy]
											id=qquws_impale
											name="impale"
											description="When this weapon is used on offense and a hit lands, it permanently decreases enemy's pierce resistance by 25 once per engagement. Furthermore the opponent's damage and movement points are reduced by 33% for one turn. Champions and The Butcher of Wesnoth are immune. Reduced resistance cannot go below -15%."
											active_on=offense
										[/dummy]
									[/set_specials]
								[/effect]
							[/object]
						[/modify_unit]
					[/case]
					[case]
						value=5
						
						[object]
							 silent=yes

							 [effect]
								apply_to=attack
								name=qquws_w_atrocious_impalement
								increase_damage=4
								[set_specials]
									mode=append
									[attacks]
										id=AE_mag_nocounter
										name="no counter-attack"
										description="The opponent has a 0% chance of retaliation when this unit is attacking. Champions and The Butcher of Wesnoth are immune and so are opponents with berserker frenzy."
										value=0
										cumulative=no
										active_on=offense
										apply_to=opponent

										[filter_opponent]
											[filter_weapon]
												[not]
													special=berserk
												[/not]
											[/filter_weapon]
			
											[not]
												[filter_wml]
													[variables]
														is_immune_to_specials=yes
													[/variables]
												[/filter_wml]
											[/not]
										[/filter_opponent]
									[/attacks]
								[/set_specials]
							[/effect]
						[/object]
					[/case]
				[/switch]
			[/case]
			[case]
				value=hp_low
				[object]
					 silent=yes

					 [effect]
					    apply_to=hitpoints
					    increase=$item_step|%
					    increase_total=$item_step|%
					[/effect]
				[/object]
				
				[switch]
					variable=use_promotion_level
					
					[case]
						value=3
						
						[modify_unit]
							[filter]
								id=$unit.id
							[/filter]

							[status]
							     unpoisonable=yes
							[/status]
						[/modify_unit]
						
						[object]
				 			silent=yes
				 			
							[effect]
								apply_to=new_ability
								[abilities]
									[dummy]
										id=qquws_unpoisonable
										name="unpoisonable"
										description="This unit cannot be poisoned."
									[/dummy]
								[/abilities]
							[/effect]
						[/object]
					[/case]
					[case]
						value=5
						
						[object]
				 			silent=yes
				 			
							[effect]
								apply_to=new_ability
								[abilities]
									[dummy]
										id=qquws_unpoisonable_aura
										name="poison immunity aura"
										description="All allied units within range 7 receive poison immunity at the beginning of their turn."
									[/dummy]
								[/abilities]
							[/effect]
						[/object]
					[/case]
				[/switch]
			[/case]
			[case]
				value=hp_med
				[object]
					 silent=yes

					 [effect]
					    apply_to=hitpoints
					    increase=$item_step|%
					    increase_total=$item_step|%
					[/effect]
				[/object]
				
				[switch]
					variable=use_promotion_level
					
					[case]
						value=3
						
						[modify_unit]
							[filter]
								id=$unit.id
							[/filter]

							[status]
							     undrainable=yes
							[/status]
						[/modify_unit]
						
						[object]
				 			silent=yes
				 			
							[effect]
								apply_to=new_ability
								[abilities]
									[dummy]
										id=qquws_undrainable
										name="undrainable"
										description="This unit's health cannot be drained."
									[/dummy]
								[/abilities]
							[/effect]
						[/object]
					[/case]
					[case]
						value=5
						
						[object]
				 			silent=yes
				 			
							[effect]
								apply_to=new_ability
								[abilities]
									[dummy]
										id=qquws_undrainable_aura
										name="drains immunity aura"
										description="All allied units within range 7 receive drains immunity at the beginning of their turn."
									[/dummy]
								[/abilities]
							[/effect]
						[/object]
					[/case]
				[/switch]
			[/case]
			[case]
				value=hp_high
				[object]
					 silent=yes

					 [effect]
					    apply_to=hitpoints
					    increase=$item_step|%
					    increase_total=$item_step|%
					[/effect]
				[/object]
				
				[switch]
					variable=use_promotion_level
					
					[case]
						value=3
						
						[modify_unit]
							[filter]
								id=$unit.id
							[/filter]
							
							[status]
							     heals_all=yes
							[/status]
							
							[variables]
								heals_all_amount=2
								heals_restore_statuses=no
							[/variables]
						[/modify_unit]
						
						[object]
				 			silent=yes
				 			
				 			[effect]
							    apply_to=remove_ability
							    [abilities]
								[dummy]
									id=qquws_global_heals
								[/dummy]
							    [/abilities]
							[/effect]
							[effect]
								apply_to=new_ability
								[abilities]
									[dummy]
										id=qquws_global_heals
										name="heals all +2"
										description="At the beginning of it's turn, this unit heals all ally units on the map. Healing amount is 2 hitpoints."
									[/dummy]
								[/abilities]
							[/effect]
						[/object]
					[/case]
					[case]
						value=4
						
						[modify_unit]
							[filter]
								id=$unit.id
							[/filter]
							
							[status]
							     heals_all=yes
							[/status]
							
							[variables]
								heals_all_amount=4
								heals_restore_statuses=no
							[/variables]
						[/modify_unit]
						
						[object]
				 			silent=yes
				 			
				 			[effect]
							    apply_to=remove_ability
							    [abilities]
								[dummy]
									id=qquws_global_heals
								[/dummy]
							    [/abilities]
							[/effect]
							[effect]
								apply_to=new_ability
								[abilities]
									[dummy]
										id=qquws_global_heals
										name="heals all +4"
										description="At the beginning of it's turn, this unit heals all ally units on the map. Healing amount is 4 hitpoints."
									[/dummy]
								[/abilities]
							[/effect]
						[/object]
					[/case]
					[case]
						value=5
						
						[modify_unit]
							[filter]
								id=$unit.id
							[/filter]
							
							[status]
							     heals_all=yes
							[/status]
							
							[variables]
								heals_all_amount=8
								heals_restore_statuses=yes
							[/variables]
						[/modify_unit]
						
						[object]
				 			silent=yes
				 			
				 			[effect]
							    apply_to=remove_ability
							    [abilities]
								[dummy]
									id=qquws_global_heals
								[/dummy]
							    [/abilities]
							[/effect]
							[effect]
								apply_to=new_ability
								[abilities]
									[dummy]
										id=qquws_global_heals
										name="restores all +8"
										description="At the beginning of it's turn, this unit not only heals all ally units on the map, but also cures, removes slow and unpetrifies them. Healing amount is 8 hitpoins."
									[/dummy]
								[/abilities]
							[/effect]
						[/object]
					[/case]
				[/switch]
			[/case]
			[case]
				value=steadfast
				
				{VARIABLE impenetrable_value 0}
				[switch]
					variable=use_promotion_level
					[case]
						value=0
						{VARIABLE steadfast_factor 1.5}
					[/case]
					[case]
						value=1
						{VARIABLE steadfast_factor 1.75}
					[/case]
					[case]
						value=2
						{VARIABLE steadfast_factor 2}
					[/case]
					[case]
						value=3
						{VARIABLE steadfast_factor 2}
						{VARIABLE impenetrable_value 20}
					[/case]
					[case]
						value=4
						{VARIABLE steadfast_factor 2.25}
						{VARIABLE impenetrable_value 30}
					[/case]
					[case]
						value=5
						{VARIABLE steadfast_factor 2.5}
						{VARIABLE impenetrable_value 40}
					[/case]
				[/switch]
				
				[object]
					 silent=yes

					[effect]
					    apply_to=remove_ability
					    [abilities]
						[resistance]
							id=steadfast
						[/resistance]
					    [/abilities]
					[/effect]
					 [effect]
					    apply_to=new_ability
					    [abilities]
						[resistance]
							id=steadfast
							multiply=$steadfast_factor
							max_value=$item_step
							[filter_base_value]
							    greater_than=0
							    less_than=$item_step
							[/filter_base_value]
							name="steadfast"
							description="This unitâ€™s resistances are multiplied by a factor of $steadfast_factor|, up to a maximum of $item_step|%, when defending. Vulnerabilities are not affected."
							affect_self=yes
							active_on=defense
						[/resistance]
					    [/abilities]
					[/effect]
				[/object]
				
				[if]
					[variable]
						name=impenetrable_value
						greater_than=0
					[/variable]
					[then]
						[object]
							 silent=yes

							[effect]
							    apply_to=remove_ability
							    [abilities]
								[resistance]
									id=qquws_impenetrable
								[/resistance]
							    [/abilities]
							[/effect]
							 [effect]
							    apply_to=new_ability
							    [abilities]
								[resistance]
									id=qquws_impenetrable
									multiply=2
									max_value=$impenetrable_value
									[filter_base_value]
									    greater_than=0
									    less_than=$impenetrable_value
									[/filter_base_value]
									name="impenetrable wall"
									description="This unit helps adjacent allies to form an impenetrable wall by doubling their resistances up to specific value. Vulnerabilities are not affected."
									affect_enemies=no
									affect_allies=yes
									affect_self=no
									[affect_adjacent]
									[/affect_adjacent]
									active_on=defense
								[/resistance]
							    [/abilities]
							[/effect]
						[/object]
					[/then]
				[/if]
			[/case]
			[case]
				value=regen
				
				{VARIABLE village_regen 0}
				{VARIABLE extra_description ""}
				{VARIABLE extra_info ""}
				[switch]
					variable=use_promotion_level
					
					[case]
						value=3
						{VARIABLE village_regen 14}
						{VARIABLE extra_info "/14"}
						{VARIABLE extra_description " (14hp when stationing in a village)"}
					[/case]
					[case]
						value=4
						{VARIABLE village_regen 20}
						{VARIABLE extra_info "/20"}
						{VARIABLE extra_description " (20hp when stationing in a village)"}
					[/case]
					[case]
						value=5
						{VARIABLE village_regen 32}
						{VARIABLE extra_info "/32"}
						{VARIABLE extra_description " (32hp when stationing in a village)"}
					[/case]
				[/switch]
				
				[object]
					 silent=yes

					[effect]
					    apply_to=remove_ability
					    [abilities]
						[regenerate]
							id=regenerates
						[/regenerate]
					    [/abilities]
					[/effect]
					 [effect]
					    apply_to=new_ability
					    [abilities]
						[regenerate]
							value=$item_step
							id=regenerates
							name="regenerates $item_step|$extra_info"
							description="The unit will heal itself $item_step HP per turn$extra_description|. If it is poisoned, it will remove the poison instead of healing."
							affect_self=yes
							poison=cured
						[/regenerate]
					    [/abilities]
					[/effect]
				[/object]
				
				[if]
					[variable]
						name=village_regen
						greater_than=0
					[/variable]
					[then]
						[modify_unit]
							[filter]
								id=$unit.id
							[/filter]
							
							[object]
								silent=yes

								[effect]
								    apply_to=remove_ability
								    [abilities]
									[regenerate]
										id=village_regen
									[/regenerate]
								    [/abilities]
								[/effect]
								[effect]
								    apply_to=new_ability
								    [abilities]
									[regenerate]
										value=$village_regen
										id=village_regen
										affect_self=yes
										poison=cured
										[filter_self]
											[filter_location]
												terrain=*^V*
											[/filter_location]
										[/filter_self]
									[/regenerate]
								    [/abilities]
								[/effect]
							[/object]
						[/modify_unit]
					[/then]
				[/if]
				
				{CLEAR_VARIABLE extra_description,extra_info,village_regen}
			[/case]
			[case]
				value=melee_dmg
				[object]
					 silent=yes

					[effect]
					    apply_to=attack
					    range=melee
					    increase_damage=$item_step|%
					[/effect]
				[/object]
				
				{VARIABLE fury_amount 0}
				[switch]
					variable=use_promotion_level
					
					[case]
						value=3
						{VARIABLE fury_amount 1}
					[/case]
					[case]
						value=4
						{VARIABLE fury_amount 2}
					[/case]
					[case]
						value=5
						{VARIABLE fury_amount 3}
						
						[modify_unit]
							[filter]
								id=$unit.id
								
								[not]
									trait=fearless
								[/not]
							[/filter]
							
							{TRAIT_FEARLESS}
						[/modify_unit]
					[/case]
				[/switch]
				
				[if]
					[variable]
						name=fury_amount
						greater_than=0
					[/variable]
					[then]
						[modify_unit]
							[filter]
								id=$unit.id
							[/filter]
							
							[variables]
								fury_amount=$fury_amount
							[/variables]
								
							[object]
								silent=yes

								[effect]
								    apply_to=attack
								    range=melee
								    remove_specials=qquws_battle_fury
								    [set_specials]
								    	mode=append
									[dummy]
										id=qquws_battle_fury
										name="battle fury +$fury_amount"
										description="With each successful hit the damage increases by $fury_amount|. If the unit misses, the counter is reset. Attack only."
										active_on=offense
									[/dummy]
								    [/set_specials]
								[/effect]
							[/object]
						[/modify_unit]
					[/then]
				[/if]
			[/case]
			[case]
				value=ranged_dmg
				[object]
					 silent=yes

					[effect]
					    apply_to=attack
					    range=ranged
					    increase_damage=$item_step|%
					[/effect]
				[/object]
				
				[switch]
					variable=use_promotion_level
					
					[case]
						value=3
						
						[modify_unit]
							[filter]
								id=$unit.id
							[/filter]
							
							[object]
								silent=yes

								[effect]
								    apply_to=attack
								    range=ranged
								    [set_specials]
								    	mode=append
									[attacks]
										id=qquws_ruthless
										name="ruthless"
										description="Adds 1 strike against enemies with no ranged attacks. Attack only."
										active_on=offense
										add=1
										[filter_opponent]
											[not]
												[has_attack]
													range=ranged
												[/has_attack]
											[/not]
										[/filter_opponent]
									[/attacks]
								    [/set_specials]
								[/effect]
							[/object]
						[/modify_unit]
					[/case]
					[case]
						value=5
						
						[modify_unit]
							[filter]
								id=$unit.id
							[/filter]
							
							[object]
								silent=yes

								[effect]
								    apply_to=attack
								    range=ranged
								    remove_specials=qquws_ruthless
								    [set_specials]
								    	mode=append
									[attacks]
										id=qquws_merciless
										name="merciless"
										description="Adds 3 strikes against enemies with no ranged attacks. Attack only."
										active_on=offense
										add=3
										[filter_opponent]
											[not]
												[has_attack]
													range=ranged
												[/has_attack]
											[/not]
										[/filter_opponent]
									[/attacks]
								    [/set_specials]
								[/effect]
							[/object]
						[/modify_unit]
					[/case]
				[/switch]
			[/case]
			[case]
				value=ranged_acc
				[object]
					 silent=yes

					[effect]
					    apply_to=attack
					    range=ranged
					    increase_accuracy=$item_step
					[/effect]
				[/object]
				
				{VARIABLE concentration 0}
				[switch]
					variable=use_promotion_level
					
					[case]
						value=3
						{VARIABLE concentration 2}
					[/case]
					[case]
						value=4
						{VARIABLE concentration 3}
					[/case]
					[case]
						value=5
						{VARIABLE concentration 5}
					[/case]
				[/switch]
				
				[if]
					[variable]
						name=concentration
						greater_than=0
					[/variable]
					[then]
						[modify_unit]
							[filter]
								id=$unit.id
							[/filter]
							
							[variables]
								concentration_amount=$concentration
							[/variables]
								
							[object]
								silent=yes

								[effect]
								    apply_to=attack
								    range=ranged
								    remove_specials=qquws_concentration
								    [set_specials]
								    	mode=append
									[dummy]
										id=qquws_concentration
										name="concentration +$concentration"
										description="With each successful hit, the accuracy of the next shot improves by $concentration|%. Attack only."
										active_on=offense
									[/dummy]
								    [/set_specials]
								[/effect]
							[/object]
						[/modify_unit]
					[/then]
				[/if]
			[/case]
			[case]
				value=melee_parry
				[object]
					 silent=yes

					[effect]
					    apply_to=attack
					    range=melee
					    increase_parry=$item_step
					[/effect]
				[/object]
				
				{VARIABLE improve_defense 0}
				[switch]
					variable=use_promotion_level
					
					[case]
						value=3
						{VARIABLE improve_defense 2}
					[/case]
					[case]
						value=4
						{VARIABLE improve_defense 1}
					[/case]
					[case]
						value=5
						{VARIABLE improve_defense 2}
					[/case]
				[/switch]
				
				[if]
					[variable]
						name=improve_defense
						greater_than=0
					[/variable]
					[then]
						[object]
							silent=yes

							[effect]
								apply_to=defense
								replace=no
								[defense]
									flat=-$improve_defense
									frozen=-$improve_defense
									forest=-$improve_defense
									hills=-$improve_defense
									mountains=-$improve_defense
									village=-$improve_defense
									swamp_water=-$improve_defense
									shallow_water=-$improve_defense
									deep_water=-$improve_defense
									reef=-$improve_defense
									castle=-$improve_defense
									cave=-$improve_defense
									sand=-$improve_defense
									fungus=-$improve_defense
								[/defense]
							[/effect]
						[/object]
					[/then]
				[/if]
			[/case]
			[case]
				value=melee_poison
				[object]
					 silent=yes

					[effect]
					    apply_to=attack
					    range=melee
					    increase_accuracy=$item_step
					[/effect]
					[effect]
					    apply_to=attack
					    range=melee
					    remove_specials=poison
					    [set_specials]
					    	mode=append
					    	{WEAPON_SPECIAL_POISON}
					    [/set_specials]
					[/effect]
				[/object]
				
				{VARIABLE backstab_factor 0}
				[switch]
					variable=use_promotion_level
					
					[case]
						value=3
						{VARIABLE backstab_factor 1.2}
					[/case]
					[case]
						value=4
						{VARIABLE backstab_factor 1.5}
					[/case]
					[case]
						value=5
						{VARIABLE backstab_factor 2}
					[/case]
				[/switch]
				
				[if]
					[variable]
						name=backstab_factor
						greater_than=0
					[/variable]
					[then]
						[object]
							silent=yes

							[effect]
							    apply_to=attack
							    range=melee
							    remove_specials=backstab
							    [set_specials]
							    	mode=append
							        [damage]
									id=backstab
									name="backstab"
									description="When used offensively, this attack deals x$backstab_factor damage if there is an enemy of the target on the opposite side of the target."
									multiply=$backstab_factor
									active_on=offense
									[filter_opponent]
									    formula="
										enemy_of(self, flanker) and not flanker.petrified
									    where
										flanker = unit_at(direction_from(loc, other.facing))
									    "
									[/filter_opponent]
								[/damage]
							    [/set_specials]
							[/effect]
						[/object]
					[/then]
				[/if]
			[/case]
			[case]
				value=melee_slow
				
				[switch]
					variable=use_promotion_level
					
					[case]
						value=0
						
						[object]
							silent=yes

							[effect]
							    apply_to=attack
							    range=melee
							    remove_specials=slow
							    [set_specials]
							    	mode=append
							    	[slow]
									id=slow
									name="slows (day only)"
									description="This attack slows the target until it ends a turn. Active only during a day."
									[filter_self]
										[filter_location]
											time_of_day_id=morning,midday,afternoon
										[/filter_location]
									[/filter_self]
								[/slow]
							    [/set_specials]
							[/effect]
						[/object]
					[/case]
					[case]
						value=1
						
						[object]
							silent=yes

							[effect]
							    apply_to=attack
							    range=melee
							    remove_specials=slow
							    [set_specials]
							    	mode=append
							    	[slow]
									id=slow
									name="slows (day, dawn and dusk)"
									description="This attack slows the target until it ends a turn. Active only during a day, dawn and dusk."
									[filter_self]
										[filter_location]
											time_of_day_id=dawn,morning,midday,afternoon,dusk
										[/filter_location]
									[/filter_self]
								[/slow]
							    [/set_specials]
							[/effect]
						[/object]
					[/case]
					[case]
						value=2
						
						[object]
							silent=yes

							[effect]
							    apply_to=attack
							    range=melee
							    remove_specials=slow
							    [set_specials]
							    	mode=append
							    	[slow]
									id=slow
									name="slows"
									description="This attack slows the target until it ends a turn."
								[/slow]
							    [/set_specials]
							[/effect]
						[/object]
					[/case]
					
					[case]
						value=4
						
						[object]
							silent=yes
							
							[effect]
							    apply_to=new_ability
							    [abilities]
								[dummy]
									id=qquws_lesser_chronosphere
									name="lesser chronosphere"
									description="When defending against melee attacks, the opponent is slowed automatically before the first hit. Champions and The Butcher of Wesnoth are immune."
								[/dummy]
							    [/abilities]
							[/effect]
						[/object]
					[/case]
					[case]
						value=5
						
						[object]
							silent=yes
							
							[effect]
							    apply_to=remove_ability
							    [abilities]
								[dummy]
									id=qquws_lesser_chronosphere
								[/dummy]
							    [/abilities]
							[/effect]
							[effect]
							    apply_to=new_ability
							    [abilities]
								[dummy]
									id=qquws_chronosphere
									name="chronosphere"
									description="When defending, the opponent is slowed automatically before the first hit. Champions and The Butcher of Wesnoth are immune."
								[/dummy]
							    [/abilities]
							[/effect]
						[/object]
					[/case]
				[/switch]
			[/case]
			[case]
				value=mp
				[object]
					 silent=yes

					[effect]
					    apply_to=movement
					    increase=$item_step
					[/effect]
				[/object]
				
				[switch]
					variable=use_promotion_level
					
					[case]
						value=3
						
						[modify_unit]
							[filter]
								id=$unit.id
							[/filter]

							[status]
							     unslowable=yes
							[/status]
						[/modify_unit]
						
						[object]
				 			silent=yes
				 			
							[effect]
								apply_to=new_ability
								[abilities]
									[dummy]
										id=qquws_unslowable
										name="unslowable"
										description="This unit cannot be slowed."
									[/dummy]
								[/abilities]
							[/effect]
						[/object]
					[/case]
					[case]
						value=5
						
						[object]
				 			silent=yes
				 			
							[effect]
								apply_to=new_ability
								[abilities]
									[dummy]
										id=qquws_unslowable_aura
										name="slow immunity aura"
										description="All allied units within range 7 receive slow immunity at the beginning of their turn."
									[/dummy]
								[/abilities]
							[/effect]
						[/object]
					[/case]
				[/switch]
			[/case]
			[case]
				value=feeding
				
				[switch]
					variable=use_promotion_level
					[case]
						value=0
						{VARIABLE summons_enabled no}
					[/case]
					[case]
						value=1
						{VARIABLE summons_enabled no}
					[/case]
					[case]
						value=2
						{VARIABLE summons_enabled no}
					[/case]
					[case]
						value=3
						{VARIABLE summons_enabled yes}
						{VARIABLE summons_chance 15}
						{VARIABLE summons_lvl 0}
						{VARIABLE summons_ageless "Walking Corpse,AE_arc_phantom_Mummy,AE_arc_despair_Wisp"}
						{VARIABLE summons_default "Walking Corpse"}
					[/case]
					[case]
						value=4
						{VARIABLE summons_enabled yes}
						{VARIABLE summons_chance 15}
						{VARIABLE summons_lvl 1}
						{VARIABLE summons_ageless "Skeleton,Ghost,QQ_enslaved_soul,AE_arc_despair_Spearman,AE_arc_despair_Fright,AE_mrc_Blight_Charred_Zombie"}
						{VARIABLE summons_default "Skeleton,Ghost,QQ_enslaved_soul"}
					[/case]
					[case]
						value=5
						{VARIABLE summons_enabled yes}
						{VARIABLE summons_chance 20}
						{VARIABLE summons_lvl 2}
						{VARIABLE summons_ageless "Shadow,Wraith,Revenant,AE_mrc_Blight_Dismembered,AE_arc_despair_Black_Shadow"}
						{VARIABLE summons_default "Shadow,Wraith,Revenant"}
					[/case]
				[/switch]
				
				{VARIABLE summons_list $summons_default}
				[if]
					[variable]
						name=random_pool.allow_ae
						boolean_equals=yes
					[/variable]
					[then]
						{VARIABLE summons_list $summons_ageless}
					[/then]
				[/if]
				
				[modify_unit]
					[filter]
						id=$unit.id
					[/filter]
					
					[variables]
						feeding_cap=$item_step
						summons_chance=$summons_chance
						summons_list=$summons_list
					[/variables]
						
					[object]
						silent=yes
						[effect]
						    apply_to=remove_ability
						    [abilities]
							[dummy]
								id=qqas_feeding
							[/dummy]
						    [/abilities]
						[/effect]
						[effect]
						    apply_to=new_ability
						    [abilities]
							[dummy]
								id=qqas_feeding
								name="magical feeding"
								description="This unit gains extra hitpoints whenever it kills a unit. The number added depends on the level of the unit killed (cap $item_step|)."
							[/dummy]
						    [/abilities]
						[/effect]
					[/object]
				[/modify_unit]
				
				[if]
					[variable]
						name=summons_enabled
						boolean_equals=yes
					[/variable]
					[then]
						[object]
							silent=yes
							[effect]
							    apply_to=remove_ability
							    [abilities]
								[dummy]
									id=qquws_raises_undead
								[/dummy]
							    [/abilities]
							[/effect]
							[effect]
							    apply_to=new_ability
							    [abilities]
								[dummy]
									id=qquws_raises_undead
									name="raises the undead"
									description="At the beginning of it's turn, this unit has $summons_chance|% chance to summon a level $summons_lvl undead minion. The strength of the summoned units varies."
								[/dummy]
							    [/abilities]
							[/effect]
						[/object]
					[/then]
				[/if]
			[/case]
			[case]
				value=leadership
				[object]
					 silent=yes

					[effect]
					    apply_to=remove_ability
					    [abilities]
						[leadership]
							id=leadership
						[/leadership]
					    [/abilities]
					[/effect]
					[effect]
					    apply_to=new_ability
					    [abilities]
						[leadership]
							id=leadership
							value=$item_step
							cumulative=no
							name="leadership"
							description="This unit can lead your own units that are next to it, making them fight better. Affects units of the same or lower level increasing their damage by $item_step|% regardless of their level difference."
							affect_self=no
							affect_allies=yes
							[affect_adjacent]
							    [filter]
								formula="level <= other.level"
							    [/filter]
							[/affect_adjacent]
						[/leadership]
					    [/abilities]
					[/effect]
				[/object]
				
				[switch]
					variable=use_promotion_level
					
					[case]
						value=5
						
						[modify_unit]
							[filter]
								id=$unit.id
								
								[not]
									trait=fearless
								[/not]
							[/filter]
							
							{TRAIT_FEARLESS}
						[/modify_unit]
					[/case]
				[/switch]
			[/case]
			[case]
				value=drain
				[object]
					 silent=yes

					[effect]
					    apply_to=attack
					    range=ranged
					    remove_specials=drains,qquws_drains
					    [set_specials]
					    	mode=append
					    	[drains]
							id=qquws_drains
							name="drains $item_step|%"
							description="This unit drains health from living units, healing itself for $item_step|% the amount of damage it deals (rounded down)."
							value=$item_step
						[/drains]
					    [/set_specials]
					[/effect]
				[/object]
				
				[switch]
					variable=use_promotion_level
					
					[case]
						value=3
						
						[object]
							silent=yes

							[effect]
								apply_to=attack
								range=ranged
								[set_specials]
									 mode=append
									 [damage]
										id=qquws_evil
										name="wicked"
										description="When used offensively at nighttime, this attack deals 20% more damage to living units."
										multiply=1.2
										active_on=offense
										apply_to=self
										[filter_opponent]
											[filter_location]
												time_of_day=chaotic
											[/filter_location]
											
											[not]
												status=not_living
										        [/not]
										[/filter_opponent]
									[/damage]
								[/set_specials]
							[/effect]
						[/object]
					[/case]
					[case]
						value=5
						
						[object]
							silent=yes

							[effect]
								apply_to=attack
								range=ranged
								remove_specials=qquws_evil
								[set_specials]
									 mode=append
									 [damage]
										id=qquws_evil
										name="unholy"
										description="When used at nighttime, this attack deals 35% more damage to living units."
										multiply=1.35
										apply_to=self
										[filter_opponent]
											[filter_location]
												time_of_day=chaotic
											[/filter_location]
											
											[not]
												status=not_living
										        [/not]
										[/filter_opponent]
									[/damage]
								[/set_specials]
							[/effect]
						[/object]
					[/case]
				[/switch]
			[/case]
			[case]
				value=defense
				[object]
					 silent=yes

					[effect]
					    apply_to=movement_costs
					    replace=no
					    [movement_costs]
						flat=-$item_step
						frozen=-$item_step
						forest=-$item_step
						hills=-$item_step
						mountains=-$item_step
						village=-$item_step
						swamp_water=-$item_step
						shallow_water=-$item_step
						deep_water=-$item_step
						reef=-$item_step
						castle=-$item_step
						cave=-$item_step
						sand=-$item_step
						fungus=-$item_step
					    [/movement_costs]
					[/effect]
				[/object]
				
				{VARIABLE improve_defense 0}
				[switch]
					variable=use_promotion_level
					
					[case]
						value=0
						{VARIABLE improve_defense 2}
					[/case]
					[case]
						value=1
						{VARIABLE improve_defense 1}
					[/case]
					[case]
						value=2
						{VARIABLE improve_defense 1}
					[/case]
					[case]
						value=3
						{VARIABLE improve_defense 1}
					[/case]
					[case]
						value=4
						{VARIABLE improve_defense 2}
					[/case]
					[case]
						value=5
						{VARIABLE improve_defense 3}
						
						[object]
							silent=yes

							[effect]
								apply_to=attack
								# remove AE and EoMa magic counter
								remove_specials=AE_mag_magic_counter,eoma_magic_counter
								[set_specials]
									 mode=append
									  [chance_to_hit]
										id=qquws_magic_counter
										name="magic counter"
										description="This attack reduces magical chance to hit of opponents by 20% (down to 50%)."
										add=-20
										apply_to=opponent
										[filter_opponent]
										    [filter_weapon]
											special_id=magical,AE_mag_magical_defensive,AE_mag_magical_offensive
										    [/filter_weapon]
										[/filter_opponent]
									    [/chance_to_hit]
								[/set_specials]
							[/effect]
						[/object]
					[/case]
				[/switch]
				
				[if]
					[variable]
						name=improve_defense
						greater_than=0
					[/variable]
					[then]
						[object]
							silent=yes

							[effect]
								apply_to=defense
								replace=no
								[defense]
									flat=-$improve_defense
									frozen=-$improve_defense
									forest=-$improve_defense
									hills=-$improve_defense
									mountains=-$improve_defense
									village=-$improve_defense
									swamp_water=-$improve_defense
									shallow_water=-$improve_defense
									deep_water=-$improve_defense
									reef=-$improve_defense
									castle=-$improve_defense
									cave=-$improve_defense
									sand=-$improve_defense
									fungus=-$improve_defense
								[/defense]
							[/effect]
						[/object]
					[/then]
				[/if]
			[/case]
			[case]
				value=skirm
				
				[switch]
					variable=use_promotion_level
					[case]
						value=0
						
						[object]
							silent=yes

							[effect]
								apply_to=remove_ability
								[abilities]
									[skirmisher]
										id=skirmisher
									[/skirmisher]
								[/abilities]
							[/effect]
							[effect]
								apply_to=new_ability
								[abilities]
									[skirmisher]
										id=skirmisher
										name="skirmisher (nighttime only)"
										description="This unit is skilled in moving past enemies quickly, and ignores all enemy Zones of Control. Active only during nighttime."
										affect_self=yes
										[filter_self]
											[filter_location]
												time_of_day_id=first_watch,midnight,second_watch
											[/filter_location]
										[/filter_self]
									[/skirmisher]
								[/abilities]
							[/effect]
						[/object]
					[/case]
					[case]
						value=1
						
						[object]
							silent=yes

							[effect]
								apply_to=remove_ability
								[abilities]
									[skirmisher]
										id=skirmisher
									[/skirmisher]
								[/abilities]
							[/effect]
							[effect]
								apply_to=new_ability
								[abilities]
									[skirmisher]
										id=skirmisher
										name="skirmisher (dusk, nighttime and dawn)"
										description="This unit is skilled in moving past enemies quickly, and ignores all enemy Zones of Control. Active only during dusk, nighttime and dawn."
										affect_self=yes
										[filter_self]
											[filter_location]
												time_of_day_id=dusk,first_watch,midnight,second_watch,dawn
											[/filter_location]
										[/filter_self]
									[/skirmisher]
								[/abilities]
							[/effect]
						[/object]
					[/case]
					[case]
						value=2
						
						[object]
							silent=yes

							[effect]
								apply_to=remove_ability
								[abilities]
									[skirmisher]
										id=skirmisher
									[/skirmisher]
								[/abilities]
							[/effect]
							[effect]
								apply_to=new_ability
								[abilities]
									[skirmisher]
										id=skirmisher
										name="skirmisher"
										description="This unit is skilled in moving past enemies quickly, and ignores all enemy Zones of Control."
										affect_self=yes
									[/skirmisher]
								[/abilities]
							[/effect]
						[/object]
					[/case]
					[case]
						value=3
						
						[object]
							silent=yes

							[effect]
							    apply_to=movement
							    increase=1
							[/effect]
						[/object]
					[/case]
					[case]
						value=4
						
						[modify_unit]
							[filter]
								id=$unit.id
							[/filter]
							
							[variables]
								battle_fervor_mp=1
							[/variables]
							
							[object]
								silent=yes

								[effect]
								    apply_to=movement
								    increase=1
								[/effect]
								[effect]
									apply_to=new_ability
									[abilities]
										[dummy]
											id=qquws_battle_fervor
											name="battle fervor +1"
											description="Increases movement points of all ally units by 1."
										[/dummy]
									[/abilities]
								[/effect]
							[/object]
						[/modify_unit]
						
						[fire_event]
							name=apply_battle_fervor_to_all_allies
						[/fire_event]
					[/case]
					[case]
						value=5
						
						[modify_unit]
							[filter]
								id=$unit.id
							[/filter]
							
							[variables]
								battle_fervor_mp=2
							[/variables]
							
							[object]
								silent=yes

								[effect]
									apply_to=remove_ability
									[abilities]
										[dummy]
											id=qquws_battle_fervor
										[/dummy]
									[/abilities]
								[/effect]
								[effect]
									apply_to=new_ability
									[abilities]
										[dummy]
											id=qquws_battle_fervor
											name="battle fervor +2"
											description="Increases movement points of all ally units by 2."
										[/dummy]
										[dummy]
											id=qquws_enemy_control
											name="enemy control"
											description="All allied units learn how to ignore enemies' zones of control."
										[/dummy]
									[/abilities]
								[/effect]
							[/object]
						[/modify_unit]
						
						[fire_event]
							name=apply_battle_fervor_to_all_allies
						[/fire_event]
						
						[fire_event]
							name=apply_enemy_control_to_all_allies
						[/fire_event]
					[/case]
				[/switch]
			[/case]
			[case]
				value=first_strike
				
				[switch]
					variable=use_promotion_level
					[case]
						value=0
						[object]
							silent=yes

							[effect]
								apply_to=attack
								range=melee
								remove_specials=firststrike
								[set_specials]
									 mode=append
									 {WEAPON_SPECIAL_FIRSTSTRIKE}
								[/set_specials]
							[/effect]
						[/object]
					[/case]
					[case]
						value=2
						[object]
							silent=yes

							[effect]
								apply_to=attack
								remove_specials=firststrike
								[set_specials]
									 mode=append
									 {WEAPON_SPECIAL_FIRSTSTRIKE}
								[/set_specials]
							[/effect]
						[/object]
					[/case]
					[case]
						value=4
						[object]
							silent=yes

							[effect]
								apply_to=attack
								[set_specials]
									 mode=append
									 
									 [dummy]
									 	id=qquws_preemptive_strike
										name="preemptive strike"
										description="When attacking you strike twice before the enemy can retaliate. The first strike deals 75% normal damage, has always 60% chance to hit and all specials disabled. Champions and the Butcher of Wesnoth are immune."
										active_on=offense
									 [/dummy]
								[/set_specials]
							[/effect]
						[/object]
					[/case]
					[case]
						value=5
						[object]
							silent=yes

							[effect]
								apply_to=attack
								remove_specials=qquws_preemptive_strike
								[set_specials]
									 mode=append
									 [dummy]
									 	id=qquws_initiative
										name="initiative"
										description="when attacking and defending you strike twice before the enemy. The first strike deals 125% normal damage, has always 70% chance to hit and all specials disabled. Champions and the Butcher of Wesnoth are immune."
									 [/dummy]
								[/set_specials]
							[/effect]
							[effect]
							    apply_to=new_ability
							    [abilities]
							    	[firststrike]
									id=qquws_eagerness_aura
									name="eagerness aura"
									description="All surrounding allies gain first strike on all weapons."
									affect_enemies=no
									affect_allies=yes
									affect_self=no
									[affect_adjacent]
									[/affect_adjacent]
								[/firststrike]
							    [/abilities]
							[/effect]
						[/object]
					[/case]
				[/switch]
			[/case]
			[case]
				value=fear

				{VARIABLE fear_reduction 0}
				{VARIABLE fear_radius 0}
				{VARIABLE fear_heal_on_hit 0}
				{VARIABLE fear_max_lvl 0}
				
				[switch]
					variable=use_promotion_level
					[case]
						value=0
						{VARIABLE fear_reduction 0}
						{VARIABLE fear_kill_reduction 10}
						{VARIABLE fear_attack_reduction 5}
						{VARIABLE fear_radius 1}
						{VARIABLE fear_heal_on_hit 0}
						{VARIABLE fear_max_lvl 0}
					[/case]
					[case]
						value=1
						{VARIABLE fear_reduction 5}
						{VARIABLE fear_kill_reduction 5}
						{VARIABLE fear_attack_reduction 5}
						{VARIABLE fear_radius 1}
						{VARIABLE fear_heal_on_hit 0}
						{VARIABLE fear_max_lvl 1}
					[/case]
					[case]
						value=2
						{VARIABLE fear_reduction 5}
						{VARIABLE fear_kill_reduction 10}
						{VARIABLE fear_attack_reduction 10}
						{VARIABLE fear_radius 2}
						{VARIABLE fear_heal_on_hit 0}
						{VARIABLE fear_max_lvl 2}
					[/case]
					[case]
						value=3
						{VARIABLE fear_reduction 10}
						{VARIABLE fear_kill_reduction 10}
						{VARIABLE fear_attack_reduction 15}
						{VARIABLE fear_radius 3}
						{VARIABLE fear_heal_on_hit 1}
						{VARIABLE fear_max_lvl 3}
					[/case]
					[case]
						value=4
						{VARIABLE fear_reduction 10}
						{VARIABLE fear_kill_reduction 15}
						{VARIABLE fear_attack_reduction 20}
						{VARIABLE fear_radius 4}
						{VARIABLE fear_heal_on_hit 2}
						{VARIABLE fear_max_lvl 4}
					[/case]
					[case]
						value=5
						{VARIABLE fear_reduction 15}
						{VARIABLE fear_kill_reduction 15}
						{VARIABLE fear_attack_reduction 25}
						{VARIABLE fear_radius 5}
						{VARIABLE fear_heal_on_hit 3}
						{VARIABLE fear_max_lvl 5}
						
						[modify_unit]
							[filter]
								id=$unit.id
								
								[not]
									trait=fearless
								[/not]
							[/filter]
							
							{TRAIT_FEARLESS}
						[/modify_unit]
					[/case]
				[/switch]
				
				{VARIABLE fear_kill_total_reduction $fear_reduction}
				{VARIABLE_OP fear_kill_total_reduction add $fear_kill_reduction}
				
				[modify_unit]
					[filter]
						id=$unit.id
					[/filter]
					
					[variables]
						fear_reduction=$fear_reduction
						fear_kill_reduction=$fear_kill_reduction
						fear_radius=$fear_radius
						fear_max_lvl=$fear_max_lvl
					[/variables]
					
					[object]
						silent=yes

						[effect]
							apply_to=remove_ability
							[abilities]
								[dummy]
									id=qquws_necromancers_bane
								[/dummy]
							[/abilities]
						[/effect]
						[effect]
							apply_to=new_ability
							[abilities]
								[dummy]
									id=qquws_necromancers_bane
									name="necromancer's bane"
									description="Each time this unit attacks, the defender retaliates with $fear_attack_reduction|% damage reduction. Furthermore all enemies level $fear_max_lvl and less, within range $fear_radius from this unit receive $fear_reduction|% damage reduction ($fear_kill_total_reduction|% if the unit is killed) at the end of the fight for a duration of one turn. Champions, Butcher of Wesnoth, fearless units, and leaders receive half of the reduction."
								[/dummy]
							[/abilities]
						[/effect]
						[effect]
						     apply_to=attack
						     remove_specials=qquws_necro_bane_dmg
						     [set_specials]
						    	  	mode=append
						     		 [damage]
									id=qquws_necro_bane_dmg
									name=""
									description=""
									active_on=offense
									apply_to=opponent
									multiply="( (100.0 - if(defender.variables.is_immune_to_specials or defender.traits.fearless or defender.canrecruit, $fear_attack_reduction / 2.0, $fear_attack_reduction)) / 100.0 )"
								[/damage]
						     [/set_specials]
						 [/effect]
					[/object]
				[/modify_unit]
				
				[if]
					[variable]
						name=fear_heal_on_hit
						greater_than=0
					[/variable]
					[then]
						[object]
							silent=yes

							[effect]
							     apply_to=attack
							     range=melee
							     remove_specials=qquws_heals_on_hit
							     [set_specials]
							    	  mode=append
							     	  [heal_on_hit]
									id=qquws_heals_on_hit
									name="heals on hit +$fear_heal_on_hit"
									description="Each landing hit causes this unit to heal $fear_heal_on_hit hitpoint(s)."
									value=$fear_heal_on_hit
									apply_to=self
								  [/heal_on_hit] 
							     [/set_specials]
							 [/effect]
						[/object]
					[/then]
				[/if]
			[/case]
			[case]
				value=discouragement
				[switch]
					variable=use_promotion_level
					[case]
						value=0
						[object]
							silent=yes

							[effect]
							     apply_to=attack
							     range=melee
							     [set_specials]
							    	  mode=append
							     	  [attacks]
									id=qqas_discouragement
									name= _ "discouragement"
									description= _ "When used in defense, this attack reduces the opponent's number of strikes by 1."
									sub=1
									active_on=defense
									apply_to=opponent
								  [/attacks]
							     [/set_specials]
							 [/effect]
						[/object]
					[/case]
					[case]
						value=3
						[object]
							silent=yes

							[effect]
							     apply_to=attack
							     remove_specials=qqas_discouragement
							     [set_specials]
							    	  mode=append
							     	  [attacks]
									id=qqas_discouragement
									name= _ "discouragement"
									description= _ "When used in defense, this attack reduces the opponent's number of strikes by 1."
									sub=1
									active_on=defense
									apply_to=opponent
								  [/attacks]
							     [/set_specials]
							 [/effect]
						[/object]
					[/case]
					[case]
						value=4
						[object]
							silent=yes

							[effect]
							     apply_to=attack
							     increase_parry=5
							[/effect]
						[/object]
					[/case]
					[case]
						value=5
						[object]
							silent=yes

							[effect]
							     apply_to=attack
							     [set_specials]
							    	mode=append
								    [damage]
									id=qquws_dishearten
									name="dishearten 20%"
									description="When used defensively this attack reduces the opponent's damage by 20%."
									multiply=0.8
									apply_to=opponent
									active_on=defense
								    [/damage]
							     [/set_specials]
							 [/effect]
						[/object]
					[/case]
				[/switch]
			[/case]
			[case]
				value=burns
				[object]
					 silent=yes

					[effect]
					    apply_to=remove_ability
					    [abilities]
						[heals]
							id=qqas_burns_enemies
						[/heals]
					    [/abilities]
					[/effect]
					[effect]
					    apply_to=new_ability
					    [abilities]
						[heals]
							id=qqas_burns_enemies
							name= _ "burns enemies"
							description=  _ "Burns adjacent enemies at the beginning of each turn for $item_step|hp (does not kill)."
							value=-$item_step
							affect_enemies=yes
							affect_allies=no
							affect_self=no
							[affect_adjacent]
							[/affect_adjacent]
						[/heals]
					    [/abilities]
					[/effect]
					[effect]
					    apply_to=halo
					    halo="halo/uws/burns.png"
					[/effect]
				[/object]
			[/case]
			[case]
				value=golden_armor
				
				{VARIABLE reflects_value 0}
				[switch]
					variable=use_promotion_level
					[case]
						value=3
						{VARIABLE reflects_value 15}
						{VARIABLE golden_armour_value 14}
					[/case]
					[case]
						value=4
						{VARIABLE reflects_value 25}
						{VARIABLE golden_armour_value 18}
					[/case]
					[case]
						value=5
						{VARIABLE reflects_value 40}
						{VARIABLE golden_armour_value 25}
					[/case]
				[/switch]

				[object]
					 silent=yes

					 [effect]
					    apply_to=resistance
					    replace=no
					    [resistance]
						blade=-$item_step
						impact=-$item_step
						pierce=-$item_step
						arcane=-$item_step
						cold=-$item_step
						fire=-$item_step
					    [/resistance]
					[/effect]
				[/object]
				
				[if]
					[variable]
						name=reflects_value
						greater_than=0
					[/variable]
					[then]
						[object]
							 silent=yes

							[effect]
							    apply_to=remove_ability
							    [abilities]
								[dummny]
									id=qquws_reflects_damage
								[/dummny]
							    [/abilities]
							[/effect]
							[effect]
							    apply_to=new_ability
							    [abilities]
								[dummny]
									id=qquws_reflects_damage
									name="reflects damage"
									description="When defending, $reflects_value|% of received damage is reflected back to the attacker. Passively increases all resistances by $golden_armour_value|%."
								[/dummny]
							    [/abilities]
							[/effect]
						[/object]
						
						{VARIABLE_OP reflects_value divide 100}
						
						[modify_unit]
							[filter]
								id=$unit.id
							[/filter]
							
							[variables]
								reflects_factor=$reflects_value
							[/variables]
						[/modify_unit]
					[/then]
				[/if]
			[/case]
			[case]
				value=heal
				[object]
					 silent=yes

					[effect]
					    apply_to=remove_ability
					    [abilities]
						[heals]
							id=healing
						[/heals]
						[heals]
							id=curing
						[/heals]
					    [/abilities]
					[/effect]
					[effect]
					    apply_to=new_ability
					    [abilities]
						[heals]
							value=$item_step
							id=healing
							affect_allies=yes
							name="heals +$item_step"
							description="This unit combines herbal remedies with magic to heal units more quickly than is normally possible on the battlefield."
							affect_self=no
							poison=cured
							[affect_adjacent]
								adjacent=n,ne,se,s,sw,nw
							[/affect_adjacent]
						[/heals]
					    [/abilities]
					[/effect]
				[/object]
			[/case]
			[case]
				value=freezing_gem
				
				{VARIABLE freezing_touch_amount 0}
				{VARIABLE freezing_touch_cold 5}
				
				[switch]
					variable=use_promotion_level
					[case]
						value=0
						{VARIABLE freezing_touch_amount 0}
						{VARIABLE freezing_touch_cold 5}
						
						[object]
							 silent=yes

							 [effect]
							    apply_to=resistance
							    replace=no
							    [resistance]
								cold=-5
							    [/resistance]
							[/effect]
						[/object]
					[/case]
					[case]
						value=1
						{VARIABLE freezing_touch_amount 1}
						{VARIABLE freezing_touch_cold 5}
					[/case]
					[case]
						value=2
						{VARIABLE freezing_touch_amount 2}
						{VARIABLE freezing_touch_cold 5}
					[/case]
					[case]
						value=3
						{VARIABLE freezing_touch_amount 3}
						{VARIABLE freezing_touch_cold 15}
						
						[object]
							 silent=yes

							 [effect]
							    apply_to=resistance
							    replace=no
							    [resistance]
								cold=-10
							    [/resistance]
							[/effect]
						[/object]
					[/case]
					[case]
						value=4
						{VARIABLE freezing_touch_amount 4}
						{VARIABLE freezing_touch_cold 15}
					[/case]
					[case]
						value=5
						{VARIABLE freezing_touch_amount 5}
						{VARIABLE freezing_touch_cold 25}
						
						[object]
							 silent=yes

							 [effect]
							    apply_to=resistance
							    replace=no
							    [resistance]
								cold=-10
							    [/resistance]
							[/effect]
						[/object]
					[/case]
				[/switch]
				
				[if]
					[variable]
						name=freezing_touch_amount
						greater_than=0
					[/variable]
					[then]
						[object]
							silent=yes

							[effect]
							     apply_to=attack
							     range=melee
							     remove_specials=qqas_freezing_gem
							     [set_specials]
							    	  mode=append
							     	  [dummy]
									id=qqas_freezing_gem
									name="freezing touch $freezing_touch_amount"
									description="Each landing hit of this weapon decreases enemy's defense ability by $freezing_touch_amount for 1 turn. Passively increases cold resistance by $freezing_touch_cold"
								  [/dummy]
							     [/set_specials]
							 [/effect]
						[/object]
						
						[modify_unit]
							[filter]
								id=$unit.id
							[/filter]
							
							[variables]
								freezing_touch_amount=$freezing_touch_amount
							[/variables]
						[/modify_unit]
					[/then]
				[/if]
			[/case]
			[case]
				value=field_disruption
				
				[object]
					 silent=yes

					[effect]
					    apply_to=remove_ability
					    [abilities]
						[resistance]
							id=qquws_field_disruption
						[/resistance]
					    [/abilities]
					[/effect]
					 [effect]
					    apply_to=new_ability
					    [abilities]
						[resistance]
							id=qquws_field_disruption
							sub=$item_step
							max_value=100
							apply_to=arcane,cold,fire
							name="field disruption"
							description="Enemies standing next to this unit have their arcane, cold and fire resistances reduced by $item_step"
							affect_self=no
							affect_allies=no
							affect_enemies=yes
							[affect_adjacent]
								adjacent="n,ne,se,s,sw,nw"
							[/affect_adjacent]
						[/resistance]
					    [/abilities]
					[/effect]
				[/object]
			[/case]
			[case]
				value=armor_destruction

				{VARIABLE damage_increase_txt 1}
				
				[switch]
					variable=use_promotion_level
					[case]
						value=0
						
						{VARIABLE damage_increase_txt 1}
						
						[object]
							 silent=yes

							 [effect]
							     apply_to=attack
							     range=melee
							     increase_damage=1
							[/effect]
						[/object]
					[/case]
					[case]
						value=1
						
						{VARIABLE damage_increase_txt 1}
					[/case]
					[case]
						value=2
						
						{VARIABLE damage_increase_txt 1}
					[/case]
					[case]
						value=3
						
						{VARIABLE damage_increase_txt 2}
						
						[object]
							 silent=yes

							 [effect]
							     apply_to=attack
							     range=melee
							     increase_damage=1
							[/effect]
						[/object]
					[/case]
					[case]
						value=4
						
						{VARIABLE damage_increase_txt 2}
					[/case]
					[case]
						value=5
						
						{VARIABLE damage_increase_txt 3}
						
						[object]
							 silent=yes

							 [effect]
							     apply_to=attack
							     range=melee
							     increase_damage=1
							[/effect]
						[/object]
					[/case]
				[/switch]
				
				[if]
					[variable]
						name=item_step
						greater_than=0
					[/variable]
					[then]
						[object]
							silent=yes

							[effect]
							     apply_to=attack
							     range=melee
							     remove_specials=qquws_armor_destruction
							     [set_specials]
							    	  mode=append
							     	  [dummy]
									id=qquws_armor_destruction
									name="armor destruction $item_step"
									description="Each landing hit permanently decreases enemy's resistance to this weapon's damage type by $item_step|. Resistance cannot go lower than -15. Works only on offense. Passively increases melee damage by $damage_increase_txt"
									active_on=offense
								  [/dummy]
							     [/set_specials]
							 [/effect]
						[/object]
						
						[modify_unit]
							[filter]
								id=$unit.id
							[/filter]
							
							[variables]
								armor_destruction_amount=$item_step
							[/variables]
						[/modify_unit]
					[/then]
				[/if]
			[/case]
			[case]
				value=protection
				
				[object]
					 silent=yes

					[effect]
					    apply_to=remove_ability
					    [abilities]
						[resistance]
							id=qquws_protection
						[/resistance]
					    [/abilities]
					[/effect]
					 [effect]
					    apply_to=new_ability
					    [abilities]
						[resistance]
							id=qquws_protection
							add=$item_step
							max_value=75
							apply_to=blade,impact,pierce
							name="protection"
							description="Friendly warriors standing next to this unit have their blade, impact and pierce resistances increased by $item_step up to maximum of 75."
							affect_self=no
							affect_allies=yes
							[affect_adjacent]
								adjacent="n,ne,se,s,sw,nw"
							[/affect_adjacent]
						[/resistance]
					    [/abilities]
					[/effect]
				[/object]

				[switch]
					variable=use_promotion_level

					[case]
						value=3
						
						[object]
							silent=yes

							[effect]
								apply_to=remove_ability
								[abilities]
									[damage]
										id=qquws_defensive_wall
									[/damage]
								[/abilities]
							[/effect]
							[effect]
								apply_to=new_ability
								[abilities]
									[damage]
										id=qquws_defensive_wall
										multiply=1.15
										active_on=defense
										name="defensive wall"
										description="Friendly warriors standing next to this unit deal 15% more melee damage when defending."
										affect_self=no
										affect_allies=yes
										[affect_adjacent]
											adjacent="n,ne,se,s,sw,nw"
										[/affect_adjacent]
										[filter_defender]
											[filter_weapon]
												range=melee
											[/filter_weapon]
										[/filter_defender]
									[/damage]
								[/abilities]
							[/effect]
						[/object]
					[/case]
					[case]
						value=4
						
						[object]
							silent=yes

							[effect]
								apply_to=remove_ability
								[abilities]
									[damage]
										id=qquws_defensive_wall
									[/damage]
								[/abilities]
							[/effect]
							[effect]
								apply_to=new_ability
								[abilities]
									[damage]
										id=qquws_defensive_wall
										multiply=1.3
										active_on=defense
										name="defensive wall"
										description="Friendly warriors standing next to this unit deal 30% more melee damage when defending."
										affect_self=no
										affect_allies=yes
										[affect_adjacent]
											adjacent="n,ne,se,s,sw,nw"
										[/affect_adjacent]
										[filter_defender]
											[filter_weapon]
												range=melee
											[/filter_weapon]
										[/filter_defender]
									[/damage]
								[/abilities]
							[/effect]
						[/object]
					[/case]
					[case]
						value=5
						
						[object]
							silent=yes

							[effect]
								apply_to=remove_ability
								[abilities]
									[damage]
										id=qquws_defensive_wall
									[/damage]
								[/abilities]
							[/effect]
							[effect]
								apply_to=new_ability
								[abilities]
									[damage]
										id=qquws_impenetrable_wall
										multiply=1.5
										active_on=defense
										name="impenetrable wall"
										description="Friendly warriors standing next to this unit deal 50% more damage when defending."
										affect_self=no
										affect_allies=yes
										[affect_adjacent]
											adjacent="n,ne,se,s,sw,nw"
										[/affect_adjacent]
									[/damage]
								[/abilities]
							[/effect]
						[/object]
					[/case]
				[/switch]
			[/case]
			[case]
				value=double_attack
				
				{VARIABLE attacks_done $unit.variables.double_attack_bank}
				{VARIABLE is_second_attack $unit.variables.is_second_attack}
				[if]
					[variable]
						name=attacks_done
						equals=""
					[/variable]
					[then]
						{VARIABLE attacks_done 0}
						{VARIABLE is_second_attack no}
					[/then]
				[/if]
				
				[object]
					silent=yes

					[effect]
					    apply_to=attack
					    range=ranged
					    remove_specials=qqas_double_attack
					    [set_specials]
					    	mode=append
					     	[dummy]
								id=qqas_double_attack
								name="double attack"
								description="When charged, this unit can attack twice in a single turn."
								active_on=offense
						 	[/dummy]
					    [/set_specials]
					[/effect]
					[effect]
					    apply_to=remove_ability
					    [abilities]
							[dummy]
								id=qquws_can_do_double_attack
							[/dummy]
					    [/abilities]
					[/effect]
					[effect]
					    apply_to=new_ability
					    [abilities]
							[dummy]
								id=qquws_can_do_double_attack
								name="quick on ranged ($attacks_done|\$item_step|)"
								description="This unit can fire ranged attacks twice in single turn, once the ability is charged."
							[/dummy]
					    [/abilities]
					[/effect]
				[/object]
				
				[modify_unit]
					[filter]
						id=$unit.id
					[/filter]
					
					[variables]
						double_attack_required=$item_step
						double_attack_bank=$attacks_done
						is_second_attack=$is_second_attack
					[/variables]
				[/modify_unit]
			[/case]
			[case]
				value=hitn_run
				
				[switch]
					variable=use_promotion_level
					[case]
						value=0

						[object]
							 silent=yes

							[effect]
								apply_to=remove_ability
								[abilities]
									[dummy]
										id=nightstalk
									[/dummy]
								[/abilities]
							[/effect]
							[effect]
								apply_to=new_ability
								[abilities]
									{ABILITY_NIGHTSTALK}
								[/abilities]
							[/effect]
						[/object]

						{VARIABLE hit_and_run no}
						{VARIABLE kill_and_run no}
						{VARIABLE hit_and_run_amount 0}
					[/case]
					[case]
						value=1
						{VARIABLE hit_and_run no}
						{VARIABLE kill_and_run yes}
						{VARIABLE hit_and_run_amount 1}
					[/case]
					[case]
						value=2
						{VARIABLE hit_and_run no}
						{VARIABLE kill_and_run yes}
						{VARIABLE hit_and_run_amount 1}
					[/case]
					[case]
						value=3
						{VARIABLE hit_and_run yes}
						{VARIABLE kill_and_run no}
						{VARIABLE hit_and_run_amount 1}
					[/case]
					[case]
						value=4
						{VARIABLE hit_and_run yes}
						{VARIABLE kill_and_run no}
						{VARIABLE hit_and_run_amount 2}
					[/case]
					[case]
						value=5
						{VARIABLE hit_and_run yes}
						{VARIABLE kill_and_run no}
						{VARIABLE hit_and_run_amount 3}
						
						[object]
							silent=yes

							[effect]
							    apply_to=attack
							    [set_specials]
							    	mode=append
							    	[attacks]
										id=qq_cover_of_the_night
										name="cover of the night"
										description="If used during the night against a distracted enemy, then the damage is increased by 50% and the enemy cannot retaliate. Champions and the Butcher of Wesnoth are immune and so are opponents with berserker frenzy. This attack to be available requires the move points to be below the maximum move points."
										value=0
										cumulative=no
										active_on=offense
										apply_to=opponent
										
										[filter_self]
											[filter_location]
												time_of_day_id=first_watch,midnight,second_watch
											[/filter_location]
											
											formula="moves < max_moves"
										[/filter_self]
										[filter_opponent]
											formula="
												enemy_of(self, flanker) and not flanker.petrified
											where
												flanker = unit_at(direction_from(loc, other.facing))
											"

											[filter_weapon]
												[not]
													special=berserk
												[/not]
											[/filter_weapon]

											[not]
												[filter_wml]
													[variables]
														is_immune_to_specials=yes
													[/variables]
												[/filter_wml]
											[/not]
										[/filter_opponent]
									[/attacks]
									[damage]
										id=qq_cover_of_the_night_dmg
										multiply=1.5
										active_on=offense
										apply_to=self
										
										[filter_self]
											[filter_location]
												time_of_day_id=first_watch,midnight,second_watch
											[/filter_location]
											
											formula="moves < max_moves"
										[/filter_self]
										[filter_opponent]
											formula="
												enemy_of(self, flanker) and not flanker.petrified
											where
												flanker = unit_at(direction_from(loc, other.facing))
											"

											[filter_weapon]
												[not]
													special=berserk
												[/not]
											[/filter_weapon]

											[not]
												[filter_wml]
													[variables]
														is_immune_to_specials=yes
													[/variables]
												[/filter_wml]
											[/not]
										[/filter_opponent]
									[/damage]
							    [/set_specials]
							[/effect]
						[/object]
					[/case]
				[/switch]
				
				[if]
					[variable]
						name=hit_and_run
						boolean_equals=yes
					[/variable]
					[or]
						[variable]
							name=kill_and_run
							boolean_equals=yes
						[/variable]
					[/or]
					[then]
						[if]
							[variable]
								name=hit_and_run
								boolean_equals=yes
							[/variable]
							[then]
								{VARIABLE ability_id "qquws_hit_and_run"}
								{VARIABLE ability_name "hit and run +$hit_and_run_amount"}
								{VARIABLE ability_description "This unit gains additional moves back after attacking, but cannot attack again."}
							[/then]
							[else]
								{VARIABLE ability_id "qquws_kill_and_run"}
								{VARIABLE ability_name "kill and run +$hit_and_run_amount"}
								{VARIABLE ability_description "This unit gains additional moves back after eliminating an opponent, but cannot attack again."}
							[/else]
						[/if]
						
						[modify_unit]
							[filter]
								id=$unit.id
							[/filter]
							
							[variables]
								hit_and_run=$hit_and_run
								kill_and_run=$kill_and_run
								hit_and_run_amount=$hit_and_run_amount
							[/variables]
							
							moves=1 # fixes issue when kill and run gets replaced with hit and run
						[/modify_unit]
						
						[object]
							 silent=yes

							[effect]
								apply_to=remove_ability
								[abilities]
									[dummy]
										id=qquws_hit_and_run
									[/dummy]
									[dummy]
										id=qquws_kill_and_run
									[/dummy]
								[/abilities]
							[/effect]
							[effect]
								apply_to=new_ability
								[abilities]
									[dummy]
										id=$ability_id
										name=$ability_name
										description=$ability_description
									[/dummy]
								[/abilities]
							[/effect]
						[/object]
					[/then]
				[/if]
			[/case]
			[case]
				value=extra_strikes

				[switch]
					variable=use_promotion_level
					
					[case]
						value=0
						
						[object]
							silent=yes

							[effect]
							     apply_to=attack
							     remove_specials=qquws_extra_strikes
							     [set_specials]
							    	  mode=append
							     	  [attacks]
										id=qquws_extra_strikes
										name="extra strikes"
										description="This unit gains 1 strike when it's hp drops below 50%."
										add="( if(hitpoints < 0.5 * max_hitpoints, 1, 0) )"
										apply_to=self
										cumulative=yes
										[filter_self]
											formula="if(hitpoints < 0.5 * max_hitpoints, 1, 0)"
										[/filter_self]
									 [/attacks]
							     [/set_specials]
							 [/effect]
						[/object]
					[/case]
					[case]
						value=1
						
						[object]
							silent=yes

							[effect]
							     apply_to=attack
							     remove_specials=qquws_extra_strikes
							     [set_specials]
							    	  mode=append
							     	  [attacks]
										id=qquws_extra_strikes
										name="extra strikes"
										description="This unit gains 1 strike when it's hp drops below 65% and another one below 30%."
										add="( if(hitpoints < 0.65 * max_hitpoints, if(hitpoints < 0.3 * max_hitpoints, 2, 1), 0) )"
										apply_to=self
										cumulative=yes
										[filter_self]
											formula="if(hitpoints < 0.65 * max_hitpoints, 1, 0)"
										[/filter_self]
									 [/attacks]
							     [/set_specials]
							 [/effect]
						[/object]
					[/case]
					[case]
						value=2
						
						[object]
							silent=yes

							[effect]
							     apply_to=attack
							     increase_attacks=1
							     remove_specials=qquws_extra_strikes
							 [/effect]
						[/object]
					[/case]
					[case]
						value=3
						
						[object]
							silent=yes

							[effect]
							     apply_to=attack
							     increase_accuracy=2
							     remove_specials=qquws_extra_strikes
							     [set_specials]
							    	  mode=append
							     	  [attacks]
										id=qquws_extra_strikes
										name="extra strikes"
										description="This unit gains 1 strike when it's hp drops below 50%. Passively increases strikes by 1 and non-magical accuracy by 2."
										add="( if(hitpoints < 0.5 * max_hitpoints, 1, 0) )"
										apply_to=self
										cumulative=yes
										[filter_self]
											formula="if(hitpoints < 0.5 * max_hitpoints, 1, 0)"
										[/filter_self]
									 [/attacks]
							     [/set_specials]
							 [/effect]
						[/object]
					[/case]
					[case]
						value=4
						
						[object]
							silent=yes

							[effect]
							     apply_to=attack
							     increase_accuracy=1
							     remove_specials=qquws_extra_strikes
							     [set_specials]
							    	  mode=append
							     	  [attacks]
										id=qquws_extra_strikes
										name="extra strikes"
										description="This unit gains 1 strike when it's hp drops below 65% and another one below 30%. Passively increases strikes by 1 and non-magical accuracy by 3."
										add="( if(hitpoints < 0.65 * max_hitpoints, if(hitpoints < 0.3 * max_hitpoints, 2, 1), 0) )"
										apply_to=self
										cumulative=yes
										[filter_self]
											formula="if(hitpoints < 0.65 * max_hitpoints, 1, 0)"
										[/filter_self]
									 [/attacks]
							     [/set_specials]
							 [/effect]
						[/object]
					[/case]
					[case]
						value=5
						
						[object]
							silent=yes

							[effect]
							     apply_to=attack
							     increase_accuracy=2
							     increase_attacks=1
							     remove_specials=qquws_extra_strikes
							     [set_specials]
							    	  mode=append
							     	  [attacks]
										id=qquws_extra_strikes
										name="extra strikes"
										description="This unit gains 1 strike when it's hp drops below 50%. Passively increases strikes by 2 and non-magical accuracy by 5."
										add="( if(hitpoints < 0.5 * max_hitpoints, 1, 0) )"
										apply_to=self
										cumulative=yes
										[filter_self]
											formula="if(hitpoints < 0.5 * max_hitpoints, 1, 0)"
										[/filter_self]
									 [/attacks]
							     [/set_specials]
							 [/effect]
						[/object]
					[/case]
				[/switch]
			[/case]
			[case]
				value=rat_pack
				
				[switch]
					variable=use_promotion_level
					[case]
						value=0
						{VARIABLE rats_frequency 6}
					[/case]
					[case]
						value=1
						{VARIABLE rats_frequency 5}
					[/case]
					[case]
						value=2
						{VARIABLE rats_frequency 4}
					[/case]
					[case]
						value=3
						{VARIABLE rats_frequency 3}
					[/case]
					[case]
						value=4
						{VARIABLE rats_frequency 2}
					[/case]
					[case]
						value=5
						{VARIABLE rats_frequency 1}
						
						[object]
							silent=yes
							
							[effect]
								apply_to=attack
								range=melee
								[set_specials]
									mode=append
									[plague]
										id=qquws_rats
										name="pet rat"
										description="When a unit is killed by a Plague attack, that unit is replaced with a unit on the same side as the unit with the Plague attack. This doesnâ€™t work on Undead or units in villages."
										type="Giant Rat"
									[/plague]
								[/set_specials]
							[/effect]
						[/object]
					[/case]
				[/switch]
				
				[modify_unit]
					[filter]
						id=$unit.id
					[/filter]
					
					[status]
					     spawns_rats=yes
					[/status]
					
					[variables]
						rats_frequency=$rats_frequency
					[/variables]
				[/modify_unit]
				
				[object]
					silent=yes

					[effect]
						apply_to=remove_ability
						[abilities]
							[dummy]
								id=qquws_breeds_rats
							[/dummy]
						[/abilities]
					[/effect]
					[effect]
						apply_to=new_ability
						[abilities]
							[dummy]
								id=qquws_breeds_rats
								name="breeds rats"
								description="This unit is able to breed tasty rats once every $rats_frequency turn(s) (max 4 bred rats)."
							[/dummy]
						[/abilities]
					[/effect]
				[/object]
			[/case]
			[case]
				value=icewind_aura
				
				[switch]
					variable=use_promotion_level
					[case]
						value=0
						{VARIABLE icewind_radius 1}
						{VARIABLE icewind_damage 0}
					[/case]
					[case]
						value=1
						{VARIABLE icewind_radius 2}
						{VARIABLE icewind_damage 0}
					[/case]
					[case]
						value=2
						{VARIABLE icewind_radius 3}
						{VARIABLE icewind_damage 1}
					[/case]
					[case]
						value=3
						{VARIABLE icewind_radius 5}
						{VARIABLE icewind_damage 2}
					[/case]
					[case]
						value=4
						{VARIABLE icewind_radius 7}
						{VARIABLE icewind_damage 3}
					[/case]
					[case]
						value=5
						{VARIABLE icewind_radius 9}
						{VARIABLE icewind_damage 5}
					[/case]
				[/switch]
				
				[modify_unit]
					[filter]
						id=$unit.id
					[/filter]
					
					[variables]
						icewind_radius=$icewind_radius
						icewind_damage=$icewind_damage
					[/variables]
				[/modify_unit]
			
				[object]
					silent=yes

					[effect]
						apply_to=remove_ability
						[abilities]
							[dummy]
								id=qquws_icewind_aura
							[/dummy]
						[/abilities]
					[/effect]
					[effect]
						apply_to=new_ability
						[abilities]
							[dummy]
								id=qquws_icewind_aura
								name="icewind aura $icewind_damage|/$icewind_radius"
								description="At the beginning of your turn all enemies within $icewind_radius radius from this unit get their mp reduced by 30% and receive $icewind_damage cold damage. Affects units of the same or lower level as the item keeper. Champions and The Butcher of Wesnoth are immune."
							[/dummy]
						[/abilities]
					[/effect]
				[/object]
			[/case]
			[case]
				value=dragon_protection
				
				[switch]
					variable=use_promotion_level
					[case]
						value=0
						
						[object]
							 silent=yes

							 [effect]
							    apply_to=resistance
							    replace=no
							    [resistance]
								blade=-10
								impact=-10
								pierce=-10
								arcane=-10
								cold=-10
								fire=-10
								secret=-25
							    [/resistance]
							[/effect]
						[/object]
						
						{VARIABLE dragon_protection_restore_amount 1}
					[/case]
					[case]
						value=1
						
						{VARIABLE dragon_protection_restore_amount 5}
					[/case]
					[case]
						value=2
						
						{VARIABLE dragon_protection_restore_amount 10}
					[/case]
					[case]
						value=3
						
						{VARIABLE dragon_protection_restore_amount 15}
					[/case]
					[case]
						value=4
						
						{VARIABLE dragon_protection_restore_amount 25}
					[/case]
					[case]
						value=5
						
						{VARIABLE dragon_protection_restore_amount 35}
					[/case]
				[/switch]
				
				[modify_unit]
					[filter]
						id=$unit.id
					[/filter]
					
					[variables]
						dragon_protection_threshold=$item_step
						dragon_protection_counter=1
						dragon_restore_amount=$dragon_protection_restore_amount
					[/variables]
				[/modify_unit]
			
				[object]
					silent=yes

					[effect]
						apply_to=remove_ability
						[abilities]
							[dummy]
								id=qquws_dragon_protection
							[/dummy]
						[/abilities]
					[/effect]
					[effect]
						apply_to=new_ability
						[abilities]
							[dummy]
								id=qquws_dragon_protection
								name="dragon's protection"
								description="When this unit is dying the Dragon's Protection revives it, restoring $dragon_protection_restore_amount|hp. Because of how much magical energy this requires, this can only trigger when the unit's hp is below certain point. A unit can only be revived once per turn (the counter refreshes at the beginning of the player's turn). Passively increases resistance to all common weapon types by 10% and against the secret attacks by 25%."
							[/dummy]
						[/abilities]
					[/effect]
				[/object]
			[/case]
		[/switch]
	[/event]
#enddef

